<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#C30A14">
<link rel="manifest" href="manifest.json">
<title>Syntoniqa Tecnico v2.0</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="white_label_config.js"></script>
<script>
/* ============================================================
   WHITE-LABEL BOOT â€” Syntoniqa Tecnico v2.0
   ============================================================ */
;(function(){
  var cfg = window.SYNTONIQA_CONFIG;
  if(!cfg) return;
  var r = document.documentElement.style;
  var co = cfg.colors||{};
  if(co.primary)       r.setProperty('--c1', co.primary);
  if(co.primary2)      r.setProperty('--c1h', co.primary2);
  if(co.secondary)     r.setProperty('--c3', co.secondary);
  if(co.bg)            r.setProperty('--dark', co.bg);
  var mt = document.querySelector('meta[name="theme-color"]');
  if(mt && co.primary) mt.content = co.primary;
  var br = cfg.brand||{};
  if(br.nome) document.title = br.nome + ' Tecnico';
  if(br.favicon_url){
    var lk=document.createElement('link'); lk.rel='icon'; lk.href=br.favicon_url;
    document.head.appendChild(lk);
  }
  function applyBrand(){
    var nome = br.nome || 'Syntoniqa';
    var bn=document.getElementById('brandName'); if(bn) bn.textContent=nome;
    var bs=document.getElementById('brandSub'); if(bs) bs.textContent='Portale Tecnico';
    var logoDiv=document.getElementById('loginLogo');
    if(logoDiv){
      if(br.logo_url){
        logoDiv.innerHTML='<img src="'+br.logo_url+'" style="height:48px;max-width:180px;object-fit:contain" alt="'+nome+'">';
      } else {
        var ini=(br.initiali||nome.replace(/[^A-Z0-9]/gi,'').substring(0,3)).toUpperCase();
        var col=(co.primary||'#C30A14');
        logoDiv.innerHTML='<div style="width:64px;height:64px;background:'+col+';border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto;box-shadow:0 6px 20px '+col+'55"><span style="font-size:1.25rem;font-weight:900;color:#fff">'+ini+'</span></div>';
      }
    }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', applyBrand);
  else applyBrand();
})();
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
:root{
  --font:'DM Sans',system-ui,sans-serif;
  --c1:#C30A14; --c1h:#A00810; --c3:#3B7EF7;
  --ok:#10B981; --warn:#F59E0B; --err:#EF4444;
  --gray:#6B7280; --gray2:#9CA3AF; --gray3:#D1D5DB; --gray4:#F3F4F6; --gray5:#F9FAFB;
  --dark:#050505; --white:#FFFFFF;
  --hh:56px; --nh:70px;
  --shadow:0 1px 3px rgba(0,0,0,.08);
  --shadow-lg:0 8px 24px rgba(0,0,0,.12);
  --radius:12px; --radius-sm:8px;
  --safe-b:env(safe-area-inset-bottom,0px);
}
[data-theme="dark"]{
  --gray:#9CA3AF; --gray2:#6B7280; --gray3:#374151; --gray4:#1F2937; --gray5:#111827;
  --dark:#F9FAFB; --white:#1F2937;
  --shadow:0 1px 3px rgba(0,0,0,.3);
  --shadow-lg:0 8px 24px rgba(0,0,0,.4);
}
[data-theme="dark"] body{background:#111827}
[data-theme="dark"] .login{background:linear-gradient(160deg,#0F172A,var(--c1))}
[data-theme="dark"] .card{border-color:#374151}
[data-theme="dark"] .card-head{border-color:#374151}
[data-theme="dark"] .bnav{background:#1F2937;border-color:#374151}
[data-theme="dark"] .hdr{box-shadow:0 2px 8px rgba(0,0,0,.4)}
[data-theme="dark"] .sheet-overlay{background:rgba(0,0,0,.6)}
[data-theme="dark"] .sheet-content{background:#1F2937}
[data-theme="dark"] .badge{opacity:.9}
[data-theme="dark"] .field input,[data-theme="dark"] .field select,[data-theme="dark"] .field textarea{background:#111827;border-color:#374151;color:#F9FAFB}
[data-theme="dark"] .btn-outline{background:#1F2937;border-color:#374151;color:#F9FAFB}
[data-theme="dark"] .list-item{border-color:#374151}
[data-theme="dark"] .stat-card{background:#1F2937}
[data-theme="dark"] .kpi-box{background:#1F2937;border-color:#374151}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:var(--font);background:var(--gray5);color:var(--dark);min-height:100vh;min-height:100dvh;line-height:1.5;font-size:14px;overflow-x:hidden}
::-webkit-scrollbar{display:none}

/* LOGIN */
.login{position:fixed;inset:0;background:linear-gradient(160deg,var(--dark),var(--c1));display:flex;justify-content:center;align-items:center;padding:24px;z-index:9000}
.login.hidden{display:none}
.login-box{background:var(--white);padding:40px 28px;border-radius:20px;width:100%;max-width:360px;box-shadow:var(--shadow-lg)}
.login-box h1{font-size:1.375rem;font-weight:700;color:var(--dark);text-align:center;margin-bottom:4px}
.login-box .sub{color:var(--gray);text-align:center;font-size:.8125rem;margin-bottom:28px}
.login-box .loading{text-align:center;padding:32px}
.spin{display:inline-block;width:28px;height:28px;border:3px solid var(--gray3);border-top-color:var(--c1);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* FORM */
.field{margin-bottom:14px}
.field label{display:block;font-size:.6875rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--gray);margin-bottom:5px}
.field input,.field select,.field textarea{width:100%;padding:11px 14px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.875rem;font-family:var(--font);color:var(--dark);background:var(--white);transition:border-color .2s;-webkit-appearance:none}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--c1);outline:none;box-shadow:0 0 0 3px rgba(195,10,20,.1)}
.field textarea{resize:vertical;min-height:70px}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:11px 20px;border:none;border-radius:var(--radius-sm);font-size:.875rem;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s;-webkit-appearance:none}
.btn:active{transform:scale(.97);opacity:.9}
.btn-primary{background:var(--c1);color:var(--white)}
.btn-ok{background:var(--ok);color:var(--white)}
.btn-warn{background:var(--warn);color:var(--white)}
.btn-err{background:var(--err);color:var(--white)}
.btn-outline{background:var(--white);border:1.5px solid var(--gray3);color:var(--dark)}
.btn-ghost{background:transparent;color:var(--gray);padding:8px}
.btn-sm{padding:8px 14px;font-size:.8125rem}
.btn-block{width:100%}

/* HEADER */
.hdr{position:fixed;top:0;left:0;right:0;height:var(--hh);background:var(--c1);color:var(--white);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.hdr h1{font-size:.9375rem;font-weight:700;letter-spacing:-.02em}
.hdr button{background:none;border:none;color:var(--white);font-size:1.25rem;cursor:pointer;padding:6px}

/* BOTTOM NAV */
.bnav{position:fixed;bottom:0;left:0;right:0;height:var(--nh);background:var(--white);border-top:1px solid #E5E7EB;display:flex;justify-content:space-around;align-items:center;z-index:100;padding-bottom:var(--safe-b)}
.bnav button{display:flex;flex-direction:column;align-items:center;gap:2px;background:none;border:none;color:var(--gray2);font-size:.625rem;font-family:var(--font);font-weight:500;cursor:pointer;padding:6px 12px;transition:.15s;position:relative}
.bnav button .ico{font-size:1.25rem}
.bnav button.active{color:var(--c1);font-weight:600}
.bnav button .nbadge{position:absolute;top:0;right:4px;background:var(--err);color:var(--white);font-size:.5625rem;font-weight:700;padding:1px 5px;border-radius:8px;min-width:14px;text-align:center}

/* CONTENT */
.app{display:none;padding-top:var(--hh);padding-bottom:calc(var(--nh) + 8px)}
.page{display:none;padding:12px 16px}
.page.active{display:block}

/* PULL TO REFRESH */
.ptr{position:fixed;top:var(--hh);left:0;right:0;display:flex;justify-content:center;align-items:center;height:0;overflow:hidden;transition:height .2s;z-index:50;background:var(--gray5)}
.ptr.active{height:50px}
.ptr .ptr-spin{width:24px;height:24px;border:3px solid var(--gray3);border-top-color:var(--c1);border-radius:50%;animation:spin .7s linear infinite}

/* SKELETON LOADING */
.skel{background:linear-gradient(90deg,var(--gray4) 25%,var(--gray3) 50%,var(--gray4) 75%);background-size:200% 100%;animation:skelShimmer 1.5s ease-in-out infinite;border-radius:var(--radius-sm)}
@keyframes skelShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skel-card{height:80px;margin-bottom:12px;border-radius:var(--radius)}
.skel-text{height:14px;margin-bottom:8px;width:80%}
.skel-text.short{width:50%}

/* CARDS */
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:12px;border:1px solid #E5E7EB}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #E5E7EB}
.card-head h3{font-size:.875rem;font-weight:600}
.card-body{padding:14px 16px}
.card-body.np{padding:0}

/* INTERVENTION ITEM */
.int-item{padding:14px 16px;border-bottom:1px solid #E5E7EB;display:flex;gap:12px;align-items:flex-start;cursor:pointer;transition:background .1s}
.int-item:active{background:var(--gray5)}
.int-item .time-block{min-width:48px;text-align:center}
.int-item .time-block .time{font-size:1rem;font-weight:700;color:var(--c1)}
.int-item .time-block .date{font-size:.625rem;color:var(--gray);text-transform:uppercase}
.int-item .info{flex:1;min-width:0}
.int-item .info h4{font-size:.875rem;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.int-item .info p{font-size:.75rem;color:var(--gray);margin-bottom:4px}
.int-item .arrow{color:var(--gray3);font-size:1rem;align-self:center}

/* TAGS */
.tag{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:16px;font-size:.6875rem;font-weight:600}
.tag-ok{background:#D1FAE5;color:#065F46}
.tag-warn{background:#FEF3C7;color:#92400E}
.tag-err{background:#FEE2E2;color:#991B1B}
.tag-info{background:#DBEAFE;color:#1E40AF}
.tag-gray{background:var(--gray4);color:#374151}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.kpi-mini{background:var(--white);border-radius:var(--radius-sm);padding:12px;text-align:center;box-shadow:var(--shadow);border:1px solid #E5E7EB}
.kpi-mini .val{font-size:1.375rem;font-weight:700;letter-spacing:-.02em}
.kpi-mini .lbl{font-size:.625rem;color:var(--gray);text-transform:uppercase;margin-top:2px}
.kpi-box{background:var(--white);border-radius:var(--radius-sm);padding:12px 8px;text-align:center;box-shadow:var(--shadow);border:1px solid #E5E7EB}
.kpi-val{font-size:1.5rem;font-weight:700;letter-spacing:-.02em}
.kpi-lbl{font-size:.6rem;color:var(--gray);text-transform:uppercase;margin-top:2px}

/* BOTTOM SHEET */
.sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:5000;opacity:0;pointer-events:none;transition:opacity .2s}
.sheet-overlay.show{opacity:1;pointer-events:auto}
.sheet{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-radius:20px 20px 0 0;max-height:88vh;display:flex;flex-direction:column;z-index:5001;transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1)}
.sheet-overlay.show .sheet{transform:translateY(0)}
.sheet .handle{width:36px;height:4px;border-radius:2px;background:var(--gray3);margin:10px auto 0}
.sheet-head{padding:14px 20px 10px;display:flex;align-items:center;justify-content:space-between}
.sheet-head h2{font-size:1rem;font-weight:700}
.sheet-head button{background:none;border:none;font-size:1.125rem;color:var(--gray);cursor:pointer;padding:4px 8px}
.sheet-body{padding:0 20px 24px;overflow-y:auto;flex:1;padding-bottom:calc(24px + var(--safe-b))}

/* TOAST */
.toast-c{position:fixed;top:calc(var(--hh) + 8px);left:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:6px}
.toast{padding:12px 16px;border-radius:var(--radius-sm);color:var(--white);font-size:.8125rem;font-weight:500;box-shadow:var(--shadow-lg);animation:tIn .3s ease}
.toast.ok{background:var(--ok)}.toast.err{background:var(--err)}.toast.warn{background:var(--warn)}.toast.info{background:var(--c3)}
@keyframes tIn{from{opacity:0;transform:translateY(-16px)}to{opacity:1;transform:translateY(0)}}

/* MAP */
#mapTec{height:calc(100vh - var(--hh) - var(--nh) - 60px);min-height:300px;border-radius:var(--radius);z-index:1}

/* EMPTY */
.empty{text-align:center;padding:40px 20px;color:var(--gray)}
.empty .ico{font-size:2.5rem;margin-bottom:8px;opacity:.5}

/* MENU GRID */
.menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.menu-item{padding:16px;background:var(--white);border:1px solid #E5E7EB;border-radius:var(--radius);text-align:center;cursor:pointer;transition:all .15s}
.menu-item:active{background:var(--gray5);transform:scale(.95)}
.menu-item .ico{font-size:1.75rem;margin-bottom:6px;display:block}
.menu-item .lbl{font-size:.8125rem;font-weight:600;color:var(--dark)}

/* NOTIF ITEM */
.notif-item{padding:14px 16px;border-bottom:1px solid #E5E7EB;display:flex;gap:12px}
.notif-item.unread{background:#FEF3C7}
.notif-item .dot-n{width:10px;height:10px;border-radius:50%;background:var(--c1);flex-shrink:0;margin-top:4px}
.notif-item .dot-n.read{background:var(--gray3)}
.notif-item .n-info{flex:1}

/* WORKFLOW */
.wf-mini{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
.wf-dot{width:8px;height:8px;border-radius:50%;background:var(--gray3)}
.wf-dot.done{background:var(--ok)}
.wf-dot.active{background:var(--c1);box-shadow:0 0 0 3px rgba(195,10,20,.2)}

/* Calendar dot */
.cal-dot{width:5px;height:5px;border-radius:50%;background:var(--c1);margin:2px auto 0;display:block}

/* CHAT */
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - var(--hh) - var(--nh) - 24px)}
.chat-channels{display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
.chat-ch-btn{padding:6px 14px;border-radius:20px;border:1.5px solid var(--gray3);background:var(--white);font-size:.75rem;font-weight:600;cursor:pointer;white-space:nowrap;font-family:var(--font);transition:.15s}
.chat-ch-btn.active{background:var(--c1);color:var(--white);border-color:var(--c1)}
.chat-msgs{flex:1;overflow-y:auto;padding:8px 0;display:flex;flex-direction:column;gap:6px}
.chat-msg{max-width:85%;padding:10px 14px;border-radius:16px;font-size:.8125rem;line-height:1.4;word-break:break-word}
.chat-msg.mine{align-self:flex-end;background:var(--c1);color:var(--white);border-bottom-right-radius:4px}
.chat-msg.other{align-self:flex-start;background:var(--white);border:1px solid #E5E7EB;border-bottom-left-radius:4px}
.chat-msg .sender{font-size:.6875rem;font-weight:600;opacity:.8;margin-bottom:2px}
.chat-msg .meta{font-size:.625rem;opacity:.6;text-align:right;margin-top:2px}
.chat-msg.tg{border-left:3px solid #0088cc}
.chat-input-bar{display:flex;gap:8px;padding:8px 0 4px;border-top:1px solid #E5E7EB;margin-top:auto}
.chat-input-bar input{flex:1;padding:10px 14px;border:1.5px solid var(--gray3);border-radius:24px;font-size:.875rem;font-family:var(--font)}
.chat-input-bar input:focus{border-color:var(--c1);outline:none}
.chat-input-bar button{width:44px;height:44px;border-radius:50%;background:var(--c1);border:none;color:var(--white);font-size:1.1rem;cursor:pointer}

/* ROUTE MAP */
.map-controls{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
.route-num{width:24px;height:24px;border-radius:50%;background:var(--c1);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.3)}
</style>
</head>
<body>
<div class="toast-c" id="toasts"></div>
<!-- Global loading overlay -->
<div id="globalLoad" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,12,20,.35);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(2px)">
  <div style="background:#fff;padding:24px 32px;border-radius:16px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.2)">
    <div style="width:36px;height:36px;border:3px solid #E5E7EB;border-top-color:var(--c1);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto"></div>
    <p style="margin:12px 0 0;font-size:.8125rem;color:#6B7280">Operazione in corso...</p>
  </div>
</div>

<!-- LOGIN -->
<div class="login" id="loginScreen">
<div class="login-box">
<div id="loginLogo" style="display:flex;justify-content:center;margin-bottom:6px;font-size:2.5rem"></div>
<h1 id="brandName">Syntoniqa</h1>
<p class="sub" id="brandSub">Portale Tecnico v2.0</p>
<div id="loginLoad" class="loading"><div class="spin"></div><p style="margin-top:10px;font-size:.8125rem;color:var(--gray)">Connessione...</p></div>
<form id="loginForm" onsubmit="return doLogin(event)" style="display:none">
<div class="field"><label>Username</label><input type="text" id="inpUser" required placeholder="nome.cognome" autocomplete="username"></div>
<div class="field"><label>Password</label><input type="password" id="inpPwd" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
<div id="loginErr" style="color:var(--err);font-size:.8125rem;margin-bottom:10px;display:none"></div>
<button class="btn btn-primary btn-block" id="btnLogin" type="submit">Accedi</button>
</form>
<div id="forgotPwdSection" style="display:none;text-align:center;margin-top:16px">
<a href="#" onclick="showForgotPwd();return false" style="font-size:.8125rem;color:var(--c1);text-decoration:none">ğŸ”‘ Password dimenticata?</a>
</div>
<div id="forgotPwdForm" style="display:none;margin-top:16px;padding:16px;background:#F3F4F6;border-radius:12px">
<p style="font-size:.8125rem;color:var(--gray);margin-bottom:12px">Inserisci il tuo username. L'admin riceverÃ  una notifica per resettare la tua password.</p>
<div class="field"><label>Username</label><input type="text" id="forgotUsername" placeholder="nome.cognome"></div>
<div id="forgotMsg" style="font-size:.8125rem;margin-bottom:8px;display:none"></div>
<button class="btn btn-primary btn-block btn-sm" onclick="sendForgotPwd()">ğŸ“¤ Invia richiesta reset</button>
<a href="#" onclick="hideForgotPwd();return false" style="display:block;text-align:center;margin-top:8px;font-size:.8125rem;color:var(--gray)">â† Torna al login</a>
</div>
</div>
</div>

<!-- HEADER -->
<header class="hdr" id="hdr" style="display:none">
<h1 id="hdrTitle">Home</h1>
<div style="display:flex;gap:6px;align-items:center">
<span id="hdrDate" style="font-size:.6875rem;opacity:.7"></span>
<button onclick="goPage('notifiche')" id="btnNotHdr" style="position:relative">ğŸ””</button>
</div>
</header>

<!-- MAIN -->
<div class="ptr" id="ptr"><div class="ptr-spin"></div></div>
<main class="app" id="app">

<!-- PAGE: HOME -->
<div class="page active" id="pgHome">
<div class="kpi-row" id="homeKpi"></div>
<div class="card">
<div class="card-head"><h3>ğŸ“‹ Interventi Oggi</h3></div>
<div class="card-body np" id="homeList"></div>
</div>
<div class="card" id="homeUrgBox" style="display:none">
<div class="card-head"><h3>ğŸš¨ Urgenze Attive</h3></div>
<div class="card-body np" id="homeUrg"></div>
</div>
<div class="card" id="homeRepBox" style="display:none">
<div class="card-head"><h3>ğŸ“ ReperibilitÃ  Attiva</h3></div>
<div class="card-body" id="homeRep"></div>
</div>
</div>

<!-- PAGE: INTERVENTI -->
<div class="page" id="pgInterventi">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openCreaInt()">ğŸ“‹ + Richiedi Intervento</button>
<div style="font-size:.7rem;color:var(--warn);margin:-8px 0 12px;padding:0 4px">âš ï¸ Gli interventi richiesti dal tecnico richiedono approvazione admin per essere confermati in calendario</div>
<div style="display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;-webkit-overflow-scrolling:touch">
<button class="btn btn-sm btn-primary" onclick="filtInt('')" id="fAll">Tutti</button>
<button class="btn btn-sm btn-outline" onclick="filtInt('pianificato')" id="fPian">ğŸ“… Pianif.</button>
<button class="btn btn-sm btn-outline" onclick="filtInt('in_corso')" id="fCorso">âš¡ In Corso</button>
<button class="btn btn-sm btn-outline" onclick="filtInt('completato')" id="fComp">âœ… Fatti</button>
</div>
<div style="display:flex;gap:6px;margin-bottom:12px;align-items:center;font-size:.8125rem">
  <span style="color:var(--gray)">ğŸ“…</span>
  <input type="date" id="intDateFrom" onchange="renderInt()" style="flex:1;padding:6px 8px;border:1px solid var(--gray3);border-radius:8px;font-size:.8125rem">
  <span style="color:var(--gray)">â†’</span>
  <input type="date" id="intDateTo" onchange="renderInt()" style="flex:1;padding:6px 8px;border:1px solid var(--gray3);border-radius:8px;font-size:.8125rem">
  <button onclick="clearDateFilter()" class="btn btn-sm btn-outline" style="padding:4px 8px;font-size:.75rem">âœ•</button>
</div>
<div class="card"><div class="card-body np" id="intList"></div></div>
</div>

<!-- PAGE: URGENZE -->
<div class="page" id="pgUrgenze">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openCreaUrg()">ğŸš¨ + Crea Urgenza</button>
<div style="font-size:.7rem;color:var(--warn);margin:-8px 0 12px;padding:0 4px">âš ï¸ Le urgenze create dal tecnico richiedono approvazione del caposquadra/admin</div>
<div style="display:flex;gap:6px;margin-bottom:12px;overflow-x:auto">
<button id="fUrgAll" class="btn btn-primary btn-xs" onclick="filtUrg('')">Tutte</button>
<button id="fUrgAss" class="btn btn-outline btn-xs" onclick="filtUrg('assegnata')">Assegnate</button>
<button id="fUrgCorso" class="btn btn-outline btn-xs" onclick="filtUrg('in_corso')">In Corso</button>
<button id="fUrgRis" class="btn btn-outline btn-xs" onclick="filtUrg('risolta')">Risolte</button>
</div>
<div id="urgList"></div>
</div>

<!-- PAGE: ORDINI -->
<div class="page" id="pgOrdini">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openSheet('shOrdine')">+ Nuovo Ordine Ricambi</button>
<div id="ordList"></div>
</div>

<!-- PAGE: CHAT TELEGRAM -->
<div class="page" id="pgChat">
<div class="chat-wrap">
<div class="chat-channels" id="chatChannels"></div>
<div class="chat-msgs" id="chatMsgs">
<div class="empty"><div class="ico">ğŸ’¬</div><p>Seleziona un canale</p></div>
</div>
<div id="chatCmdBar" style="display:none;padding:6px 10px;background:#F0F9FF;border-top:1px solid #BAE6FD;font-size:.75rem;overflow-x:auto;white-space:nowrap">
<span style="color:#0369A1;font-weight:600">Comandi Bot TG:</span>
<button class="btn btn-xs btn-outline" onclick="insertCmd('/stato')" style="margin:0 2px;font-size:.7rem">/stato</button>
<button class="btn btn-xs btn-outline" onclick="insertCmd('/oggi')" style="margin:0 2px;font-size:.7rem">/oggi</button>
<button class="btn btn-xs btn-outline" onclick="insertCmd('/settimana')" style="margin:0 2px;font-size:.7rem">/settimana</button>
<button class="btn btn-xs btn-outline" onclick="insertCmd('/vado')" style="margin:0 2px;font-size:.7rem">/vado</button>
<button class="btn btn-xs btn-outline" onclick="insertCmd('/incorso')" style="margin:0 2px;font-size:.7rem">/incorso</button>
<button class="btn btn-xs btn-outline" onclick="insertCmd('/risolto ')" style="margin:0 2px;font-size:.7rem">/risolto</button>
<button class="btn btn-xs btn-outline" onclick="insertCmd('/ordine ')" style="margin:0 2px;font-size:.7rem">/ordine</button>
</div>
<div id="chatAllegatoPreview" style="display:none;padding:6px 10px;background:var(--gray5);border-top:1px solid #E5E7EB"></div>
<div class="chat-input-bar">
<label style="cursor:pointer;font-size:1.2rem;padding:0 4px;display:flex;align-items:center" title="Allega foto/file">ğŸ“<input type="file" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx" style="display:none" onchange="chatAllegatoChange(this)"></label>
<input type="text" id="chatInput" placeholder="Scrivi messaggio..." onkeydown="if(event.key==='Enter')sendChatMsg()" onfocus="showChatCmds()" style="flex:1">
<button onclick="sendChatMsg()">â¤</button>
</div>
</div>
</div>

<!-- PAGE: MENU -->
<div class="page" id="pgMenu">
<div class="menu-grid">
<div class="menu-item" onclick="goPage('notifiche')"><span class="ico">ğŸ””</span><span class="lbl">Notifiche</span></div>
<div class="menu-item" onclick="goPage('richieste')"><span class="ico">ğŸ“</span><span class="lbl">Richieste</span></div>
<div class="menu-item" onclick="goPage('reperibilita')"><span class="ico">ğŸ“</span><span class="lbl">ReperibilitÃ </span></div>
<div class="menu-item" onclick="goPage('trasferte')"><span class="ico">ğŸ§³</span><span class="lbl">Trasferte</span></div>
<div class="menu-item" onclick="goPage('installazioni')"><span class="ico">ğŸ”§</span><span class="lbl">Installazioni</span></div>
<div class="menu-item" onclick="goPage('clienti')"><span class="ico">ğŸ¢</span><span class="lbl">Clienti</span></div>
<div class="menu-item" onclick="goPage('macchine')"><span class="ico">âš™ï¸</span><span class="lbl">Macchine</span></div>
<div class="menu-item" onclick="goPage('documenti')"><span class="ico">ğŸ“</span><span class="lbl">Documenti</span></div>
<div class="menu-item" onclick="goPage('mappa')"><span class="ico">ğŸ—ºï¸</span><span class="lbl">Mappa Giro</span></div>
<div class="menu-item" onclick="goPage('calendario')"><span class="ico">ğŸ“…</span><span class="lbl">Calendario</span></div>
<div class="menu-item" onclick="goPage('kpi')"><span class="ico">ğŸ“Š</span><span class="lbl">Le mie KPI</span></div>
<div class="menu-item" onclick="goPage('catalogomob')"><span class="ico">ğŸ”</span><span class="lbl">Catalogo Parti</span></div>
<div class="menu-item" onclick="goPage('profilo')"><span class="ico">ğŸ‘¤</span><span class="lbl">Profilo</span></div>
</div>
</div>

<!-- PAGE: NOTIFICHE -->
<div class="page" id="pgNotifiche">
<div class="card"><div class="card-head"><h3>ğŸ”” Notifiche</h3><div style="display:flex;gap:6px"><button class="btn btn-ghost btn-sm" onclick="markAllRead()">âœ… Tutte lette</button><button class="btn btn-ghost btn-sm" style="color:var(--err)" onclick="deleteAllNot()">ğŸ—‘ï¸ Elimina lette</button></div></div><div class="card-body np" id="notList"></div></div>
</div>

<!-- PAGE: RICHIESTE -->
<div class="page" id="pgRichieste">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openSheet('shRichiesta')">+ Nuova Richiesta</button>
<div id="richList"></div>
</div>

<!-- PAGE: REPERIBILITA -->
<div class="page" id="pgReperibilita">
<div id="repList"></div>
</div>

<!-- PAGE: TRASFERTE -->
<div class="page" id="pgTrasferte">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openSheet('shTrasferta')">+ Nuova Trasferta</button>
<div id="trasfList"></div>
</div>

<!-- PAGE: INSTALLAZIONI -->
<div class="page" id="pgInstallazioni">
<div id="instList"></div>
</div>

<!-- PAGE: CLIENTI -->
<div class="page" id="pgClienti">
<div class="field" style="margin-bottom:12px"><input type="text" id="srcCliMob" placeholder="ğŸ” Cerca cliente..." oninput="renderCliMob()" style="width:100%"></div>
<div id="cliMobList"></div>
</div>

<!-- PAGE: MACCHINE -->
<div class="page" id="pgMacchine">
<div class="field" style="margin-bottom:12px"><input type="text" id="srcMacMob" placeholder="ğŸ” Cerca macchina..." oninput="renderMacMob()" style="width:100%"></div>
<div id="macMobList"></div>
</div>

<!-- PAGE: DOCUMENTI -->
<div class="page" id="pgDocumenti">
<div class="field" style="margin-bottom:12px"><input type="text" id="srcDocMob" placeholder="ğŸ” Cerca documento..." oninput="renderDocMob()" style="width:100%"></div>
<div id="docMobList"></div>
</div>

<!-- PAGE: MAPPA -->
<div class="page" id="pgMappa">
<div class="map-controls">
<button class="btn btn-sm btn-primary" id="mapFAll" onclick="mapFilter('all')">ğŸ“ Tutti</button>
<button class="btn btn-sm btn-outline" id="mapFToday" onclick="mapFilter('today')">ğŸ“‹ Oggi</button>
<button class="btn btn-sm btn-outline" id="mapFWeek" onclick="mapFilter('week')">ğŸ“… Settimana</button>
<button class="btn btn-sm btn-outline" id="mapFExport" onclick="exportGoogleMaps()" style="margin-left:auto">ğŸ—ºï¸ Google Maps</button>
</div>
<div class="card">
<div class="card-head"><h3>ğŸ—ºï¸ Mappa Giro Visite</h3><span id="mapInfo" style="font-size:.75rem;color:var(--gray)"></span></div>
<div class="card-body np"><div id="mapTec"></div></div>
</div>
</div>

<!-- PAGE: CALENDARIO -->
<div class="page" id="pgCalendario">
<div class="card" style="margin-bottom:12px">
<div class="card-head">
<button onclick="calMobileNav(-1)" style="background:none;border:none;font-size:1.2rem;cursor:pointer">â—€</button>
<h3 id="calMobTitle" style="flex:1;text-align:center;font-size:.9375rem">â€”</h3>
<button onclick="calMobileNav(1)" style="background:none;border:none;font-size:1.2rem;cursor:pointer">â–¶</button>
</div>
<div class="card-body">
<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;font-size:.75rem" id="calMobGrid"></div>
</div>
</div>
<div id="calMobDetail"></div>
</div>

<!-- PAGE: PROFILO -->
<div class="page" id="pgProfilo">
<div style="text-align:center;padding:24px 0 16px">
<div style="width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--dark),var(--c1));display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:1.5rem;font-weight:700;color:var(--white)" id="profAvatar">MC</div>
<h2 style="font-size:1.125rem;font-weight:700" id="profName">â€”</h2>
<p style="font-size:.8125rem;color:var(--gray)" id="profRole">â€”</p>
</div>
<div class="kpi-row" id="profKpi"></div>
<div class="card" id="profCard"></div>
<div class="card" id="pushCard" style="display:none">
<div class="card-head"><h3>ğŸ”” Notifiche Push</h3></div>
<div class="card-body">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<span style="font-size:.85rem">Ricevi notifiche urgenze e interventi</span>
<label style="position:relative;display:inline-block;width:48px;height:26px;cursor:pointer">
<input type="checkbox" id="pushToggle" onchange="togglePush()" style="opacity:0;width:0;height:0">
<span style="position:absolute;inset:0;background:#ccc;border-radius:26px;transition:.3s"></span>
<span id="pushSlider" style="position:absolute;height:20px;width:20px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s"></span>
</label>
</div>
<div id="pushStatus" style="font-size:.75rem;color:var(--gray)"></div>
</div>
</div>
<div class="card">
<div class="card-head"><h3>ğŸ¨ Aspetto</h3></div>
<div class="card-body">
<div style="display:flex;align-items:center;justify-content:space-between">
<span style="font-size:.85rem">ModalitÃ  scura</span>
<label style="position:relative;display:inline-block;width:48px;height:26px;cursor:pointer">
<input type="checkbox" id="darkToggle" onchange="toggleDarkMode()" style="opacity:0;width:0;height:0">
<span style="position:absolute;inset:0;background:#ccc;border-radius:26px;transition:.3s"></span>
<span id="darkSlider" style="position:absolute;height:20px;width:20px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s"></span>
</label>
</div>
</div>
</div>
<div class="card">
<div class="card-head"><h3>ğŸŒ Lingua</h3></div>
<div class="card-body">
<div style="display:flex;gap:8px">
<button class="btn btn-sm" id="langIt" onclick="switchLang('it')" style="flex:1">ğŸ‡®ğŸ‡¹ Italiano</button>
<button class="btn btn-sm" id="langEn" onclick="switchLang('en')" style="flex:1">ğŸ‡¬ğŸ‡§ English</button>
</div>
</div>
</div>
<div class="card" style="margin-bottom:0">
<div class="card-head"><h3>ğŸ”‘ Cambia Password</h3></div>
<div class="card-body">
<div class="field"><label>Password attuale</label><input type="password" id="cpOld" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
<div class="field"><label>Nuova password</label><input type="password" id="cpNew" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
<div class="field"><label>Conferma nuova password</label><input type="password" id="cpConf" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
<button class="btn btn-primary btn-block btn-sm" onclick="doChangePassword()">ğŸ”‘ Cambia Password</button>
</div>
</div>
<div style="padding:16px"><button class="btn btn-outline btn-block" onclick="logout()">ğŸšª Esci</button></div>
</div>

<!-- PAGE: CATALOGO PARTI MOBILE -->
<div class="page" id="pgCatalogomob">
<div class="card"><div class="card-head"><h3>ğŸ” Catalogo Ricambi</h3></div>
<div class="card-body">
<div class="field" style="margin-bottom:8px"><input type="text" id="catMobSearch" placeholder="ğŸ” Codice, nome o descrizione..." style="width:100%;padding:10px 12px;border:1.5px solid var(--gray3);border-radius:var(--radius);font-size:.85rem" onkeyup="if(event.key==='Enter')searchCatalogMob()"></div>
<div style="display:flex;gap:8px;margin-bottom:12px">
<select id="catMobModello" style="flex:1;padding:8px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem">
<option value="">Tutti modelli</option><option value="ASTRONAUT">Astronaut</option><option value="VECTOR">Vector</option><option value="JUNO">Juno</option><option value="DISCOVERY">Discovery</option></select>
<button class="btn btn-primary btn-sm" onclick="searchCatalogMob()">ğŸ”</button>
</div>
<div id="catMobResults"></div>
</div></div>
</div>

<!-- PAGE: LE MIE KPI -->
<div class="page" id="pgKpi">
<div class="card"><div class="card-head"><h3>ğŸ“Š Le mie KPI</h3><select id="kpiPeriodo" class="btn btn-ghost btn-sm" onchange="renderKpi()" style="font-size:.75rem"><option value="7">Ultimi 7 giorni</option><option value="30">Ultimo mese</option><option value="90">Ultimo trimestre</option></select></div>
<div class="card-body">
<div class="kpi-row" id="kpiCards" style="grid-template-columns:repeat(2,1fr)"></div>
<div id="kpiCharts" style="margin-top:16px"></div>
</div></div>
<div class="card"><div class="card-head"><h3>ğŸ“‹ Dettaglio Interventi</h3></div>
<div class="card-body np"><table class="tbl"><thead><tr><th>Data</th><th>Cliente</th><th>Tipo</th><th>Stato</th><th>Durata</th></tr></thead><tbody id="kpiIntervList"></tbody></table></div></div>
</div>

</main>

<!-- BOTTOM NAV -->
<nav class="bnav" id="bnav" style="display:none">
<button class="active" onclick="goPage('home')" data-p="home"><span class="ico">ğŸ </span>Home</button>
<button onclick="goPage('interventi')" data-p="interventi"><span class="ico">ğŸ“‹</span>Interventi</button>
<button onclick="goPage('urgenze')" data-p="urgenze"><span class="ico">ğŸš¨</span>Urgenze</button>
<button onclick="goPage('chat')" data-p="chat" id="navChat" style="position:relative"><span class="ico">ğŸ’¬</span>Chat TG<span id="chatBadge" style="display:none;position:absolute;top:2px;right:4px;background:var(--err);color:#fff;border-radius:50%;font-size:.55rem;min-width:14px;height:14px;line-height:14px;text-align:center;padding:0 3px"></span></button>
<button onclick="goPage('menu')" data-p="menu"><span class="ico">â‹¯</span>Menu</button>
</nav>

<!-- ==================== SHEETS ==================== -->

<!-- Sheet: Intervento Detail -->
<div class="sheet-overlay" id="shInt" onclick="if(event.target===this)closeSheet('shInt')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2 id="siTitle">Intervento</h2><button onclick="closeSheet('shInt')">âœ•</button></div>
<div class="sheet-body" id="siBody"></div>
</div>
</div>

<!-- Sheet: Complete Intervento -->
<div class="sheet-overlay" id="shCompleta" onclick="if(event.target===this)closeSheet('shCompleta')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>âœ… Completa Intervento</h2><button onclick="closeSheet('shCompleta')">âœ•</button></div>
<div class="sheet-body">
<input type="hidden" id="scId">
<div class="field-row">
<div class="field"><label>Km Percorsi</label><input type="number" id="scKm" placeholder="0" min="0" inputmode="decimal"></div>
<div class="field"><label>Ore Lavorate</label><input type="number" id="scOre" placeholder="0" step="0.5" min="0" inputmode="decimal"></div>
</div>
<div class="field"><label>Valutazione Cliente (1-10)</label><input type="number" id="scVoto" placeholder="â€”" min="1" max="10" inputmode="numeric"></div>
<div class="field"><label>Note Completamento</label><textarea id="scNote" rows="3" placeholder="Descrivi il lavoro svolto..."></textarea></div>
<div style="margin-top:12px">
<label style="font-weight:600;font-size:.8125rem;margin-bottom:8px;display:block">ğŸ“ Allegati</label>
<div style="display:flex;gap:8px;margin-bottom:8px">
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“· Foto<input type="file" accept="image/*" capture="environment" style="display:none" onchange="addAllegatoFile(this)"></label>
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“ File<input type="file" style="display:none" onchange="addAllegatoFile(this)"></label>
</div>
<div id="scAllegatiPreview" style="display:flex;flex-direction:column;gap:6px"></div>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shCompleta')" style="flex:1">Annulla</button>
<button class="btn btn-ok" onclick="completaInt()" style="flex:1">âœ… Conferma</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Urgenza Detail -->
<div class="sheet-overlay" id="shUrg" onclick="if(event.target===this)closeSheet('shUrg')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2 id="suTitle">Urgenza</h2><button onclick="closeSheet('shUrg')">âœ•</button></div>
<div class="sheet-body" id="suBody"></div>
</div>
</div>

<!-- Sheet: Nuovo Ordine -->
<div class="sheet-overlay" id="shOrdine" onclick="if(event.target===this)closeSheet('shOrdine')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸ“¦ Nuovo Ordine</h2><button onclick="closeSheet('shOrdine')">âœ•</button></div>
<div class="sheet-body">
<div class="field"><label>Codice Ricambio</label><input type="text" id="soCodice" placeholder="LY-12345"></div>
<div class="field"><label>Descrizione</label><input type="text" id="soDesc" placeholder="Descrizione pezzo"></div>
<div class="field-row">
<div class="field"><label>QuantitÃ </label><input type="number" id="soQta" value="1" min="1" inputmode="numeric"></div>
<div class="field"><label>Cliente</label><select id="soCliente"><option value="">â€”</option></select></div>
</div>
<div class="field"><label>Note</label><textarea id="soNote" rows="2"></textarea></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shOrdine')" style="flex:1">Annulla</button>
<button class="btn btn-warn" onclick="saveOrdine()" style="flex:1">ğŸ“¦ Crea</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Nuova Richiesta -->
<div class="sheet-overlay" id="shRichiesta" onclick="if(event.target===this)closeSheet('shRichiesta')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸ“ Nuova Richiesta</h2><button onclick="closeSheet('shRichiesta')">âœ•</button></div>
<div class="sheet-body">
<div class="field"><label>Tipo</label><select id="srTipo"><option value="ferie">Ferie</option><option value="permesso">Permesso</option><option value="cambio_turno">Cambio Turno</option><option value="malattia">Malattia</option><option value="generico">Generico</option></select></div>
<div class="field-row">
<div class="field"><label>Dal</label><input type="date" id="srDal"></div>
<div class="field"><label>Al</label><input type="date" id="srAl"></div>
</div>
<div class="field"><label>Motivo</label><textarea id="srMotivo" rows="3" placeholder="Motivo della richiesta..."></textarea></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shRichiesta')" style="flex:1">Annulla</button>
<button class="btn btn-primary" onclick="saveRichiesta()" style="flex:1">ğŸ“¤ Invia</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Nuova Trasferta -->
<div class="sheet-overlay" id="shTrasferta" onclick="if(event.target===this)closeSheet('shTrasferta')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸ§³ Nuova Trasferta</h2><button onclick="closeSheet('shTrasferta')">âœ•</button></div>
<div class="sheet-body">
<div class="field"><label>Destinazione (Cliente)</label><select id="stCliente"></select></div>
<div class="field"><label>Automezzo</label><select id="stAutomezzo"></select></div>
<div class="field-row">
<div class="field"><label>Dal</label><input type="date" id="stDal"></div>
<div class="field"><label>Al</label><input type="date" id="stAl"></div>
</div>
<div class="field"><label>Motivo</label><textarea id="stMotivo" rows="3" placeholder="Motivo della trasferta..."></textarea></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shTrasferta')" style="flex:1">Annulla</button>
<button class="btn btn-primary" onclick="saveTrasferta()" style="flex:1">ğŸ“¤ Invia</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Crea Urgenza (tecnico) -->
<div class="sheet-overlay" id="shCreaUrg" onclick="if(event.target===this)closeSheet('shCreaUrg')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸš¨ Crea Urgenza</h2><button onclick="closeSheet('shCreaUrg')">âœ•</button></div>
<div class="sheet-body">
<div style="background:#FEF3C7;padding:10px 14px;border-radius:var(--radius-sm);font-size:.8125rem;color:#92400E;margin-bottom:16px">âš ï¸ Le urgenze create dal tecnico vengono inviate con stato <strong>IN ATTESA</strong> di approvazione admin/caposquadra</div>
<div class="field"><label>Cliente</label><select id="suCliUrg"><option value="">â€” Seleziona â€”</option></select></div>
<div class="field"><label>Macchina</label><select id="suMacUrg"><option value="">â€” Seleziona â€”</option></select></div>
<div class="field"><label>PrioritÃ </label><select id="suPriUrg"></select></div>
<div class="field"><label>Problema</label><textarea id="suProbUrg" rows="4" placeholder="Descrivi il problema in dettaglio..."></textarea></div>
<div class="field"><label>Note aggiuntive</label><textarea id="suNoteUrg" rows="2" placeholder="Es. codice errore, foto fatta, etc."></textarea></div>
<div style="margin-top:12px">
<label style="font-weight:600;font-size:.8125rem;margin-bottom:8px;display:block">ğŸ“ Allegato (opzionale)</label>
<div style="display:flex;gap:8px">
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“· Foto<input type="file" accept="image/*" capture="environment" style="display:none" onchange="urgAllegatoChange(this)"></label>
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“ File<input type="file" style="display:none" onchange="urgAllegatoChange(this)"></label>
</div>
<div id="urgAllegatoPreview" style="margin-top:8px"></div>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shCreaUrg')" style="flex:1">Annulla</button>
<button class="btn btn-err" onclick="saveUrgenzaTecnico()" style="flex:1">ğŸš¨ Invia Urgenza</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Modifica Intervento -->
<div class="sheet-overlay" id="shEditInt" onclick="if(event.target===this)closeSheet('shEditInt')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>âœï¸ Modifica Intervento</h2><button onclick="closeSheet('shEditInt')">âœ•</button></div>
<div class="sheet-body">
<input type="hidden" id="eiId">
<div id="eiOwnNotice" style="display:none;background:#FEF3C7;padding:10px 14px;border-radius:var(--radius-sm);font-size:.8125rem;color:#92400E;margin-bottom:12px">âš ï¸ Non Ã¨ il tuo intervento â€” la modifica richiede approvazione admin</div>
<div class="field"><label>Note</label><textarea id="eiNote" rows="3" placeholder="Aggiorna le note..."></textarea></div>
<div class="field"><label>Stato</label><select id="eiStato"><option value="pianificato">ğŸ“… Pianificato</option><option value="in_corso">âš¡ In Corso</option></select></div>
<div class="field-row">
<div class="field"><label>Data</label><input type="date" id="eiData"></div>
<div class="field"><label>Ora Inizio</label><input type="time" id="eiOra"></div>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shEditInt')" style="flex:1">Annulla</button>
<button class="btn btn-primary" onclick="saveEditInt()" style="flex:1">ğŸ’¾ Salva</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Crea/Richiedi Intervento (tecnico) -->
<div class="sheet-overlay" id="shCreaInt" onclick="if(event.target===this)closeSheet('shCreaInt')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸ“‹ Richiedi Intervento</h2><button onclick="closeSheet('shCreaInt')">âœ•</button></div>
<div class="sheet-body">
<div style="background:#FEF3C7;padding:10px 14px;border-radius:var(--radius-sm);font-size:.8125rem;color:#92400E;margin-bottom:16px">âš ï¸ L'intervento verrÃ  proposto in calendario con stato <strong>PIANIFICATO</strong>. L'admin riceverÃ  notifica per conferma.</div>
<div class="field"><label>Cliente *</label><select id="ciCliente"><option value="">â€” Seleziona â€”</option></select></div>
<div class="field"><label>Macchina</label><select id="ciMacchina"><option value="">â€” Seleziona â€”</option></select></div>
<div class="field"><label>Tipo Intervento</label><select id="ciTipo"></select></div>
<div class="field"><label>PrioritÃ </label><select id="ciPriorita"></select></div>
<div class="field-row">
<div class="field"><label>Data proposta</label><input type="date" id="ciData"></div>
<div class="field"><label>Ora proposta</label><input type="time" id="ciOra" value="08:00"></div>
</div>
<div class="field"><label>Durata stimata (ore)</label><input type="number" id="ciDurata" value="2" min="0.5" max="24" step="0.5"></div>
<div class="field"><label>Descrizione / Motivo *</label><textarea id="ciNote" rows="4" placeholder="Descrivi il motivo dell'intervento, cosa va fatto..."></textarea></div>
<div style="margin-top:12px">
<label style="font-weight:600;font-size:.8125rem;margin-bottom:8px;display:block">ğŸ“ Allegato (opzionale)</label>
<div style="display:flex;gap:8px">
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“· Foto<input type="file" accept="image/*" capture="environment" style="display:none" onchange="intAllegatoChange(this)"></label>
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“ File<input type="file" style="display:none" onchange="intAllegatoChange(this)"></label>
</div>
<div id="intAllegatoPreview" style="margin-top:8px"></div>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shCreaInt')" style="flex:1">Annulla</button>
<button class="btn btn-primary" onclick="saveCreaInt()" style="flex:1">ğŸ“‹ Invia Richiesta</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Installazione Detail -->
<div class="sheet-overlay" id="shInstDet" onclick="if(event.target===this)closeSheet('shInstDet')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2 id="instDetTitle">ğŸ”§ Installazione</h2><button onclick="closeSheet('shInstDet')">âœ•</button></div>
<div class="sheet-body" id="instDetBody"></div>
</div>
</div>

<script>
/* ============================================================
   SYNTONIQA TECNICO v2.0 â€” FULL JS
   Coerente 1:1 con admin_v1.html (API, nomi, strutture dati)
   ============================================================ */

// ============ STATE ============
let DATA={}, USER=null, intF='', urgF='', scAllegatiFiles=[], mapTec=null;

// ============ CONFIG (da white_label_config.js) ============
const API_URL = (window.SYNTONIQA_CONFIG&&window.SYNTONIQA_CONFIG.api&&window.SYNTONIQA_CONFIG.api.url)
  || 'https://syntoniqa-api.YOUR_SUBDOMAIN.workers.dev';
const API_TOKEN = (window.SYNTONIQA_CONFIG&&window.SYNTONIQA_CONFIG.api&&window.SYNTONIQA_CONFIG.api.token)
  || 'FF_TOKEN_CAMBIA_QUESTO_IN_PRODUZIONE';

// ============ i18n ============
const I18N = {
  it: {
    // Nav
    home:'Home', piano:'Piano', urgenze:'Urgenze', mappa:'Mappa', profilo:'Profilo', kpi:'Le mie KPI',
    // Common
    oggi:'Oggi', domani:'Domani', ieri:'Ieri', tutti:'Tutti', cerca:'Cerca...', salva:'Salva',
    annulla:'Annulla', conferma:'Conferma', elimina:'Elimina', carica:'Carica', invia:'Invia',
    nessun_risultato:'Nessun risultato', caricamento:'Caricamento...', errore:'Errore',
    // Status
    pianificato:'Pianificato', in_corso:'In corso', completato:'Completato', annullato:'Annullato',
    aperta:'Aperta', assegnata:'Assegnata', schedulata:'Schedulata', risolta:'Risolta', chiusa:'Chiusa',
    // Interventi
    interventi_oggi:'Interventi di oggi', interventi:'Interventi', urgenze_aperte:'Urgenze aperte',
    cliente:'Cliente', tecnico:'Tecnico', data:'Data', ora_inizio:'Ora inizio', ora_fine:'Ora fine',
    tipo_intervento:'Tipo intervento', note:'Note', note_completamento:'Note completamento',
    // Urgenze
    priorita:'PrioritÃ ', alta:'Alta', media:'Media', bassa:'Bassa', critica:'Critica',
    descrizione:'Descrizione', segnalato_da:'Segnalato da',
    // Profile
    cambia_password:'Cambia Password', password_attuale:'Password attuale',
    nuova_password:'Nuova password', conferma_password:'Conferma nuova password',
    notifiche_push:'Notifiche Push', aspetto:'Aspetto', modalita_scura:'ModalitÃ  scura',
    esci:'Esci',
    // KPI
    completati:'Completati', ore_lavorate:'Ore lavorate', sla_rispettato:'SLA rispettato',
    tempo_medio:'Tempo medio',
    // Foto
    foto_intervento:'Foto intervento', scatta_foto:'Scatta foto', galleria:'Galleria',
    analisi_ai:'Analisi AI foto', diagnosi:'Diagnosi', gravita:'GravitÃ ',
    ricambio_suggerito:'Ricambio suggerito', ordina_ricambio:'Ordina ricambio',
  },
  en: {
    home:'Home', piano:'Schedule', urgenze:'Emergencies', mappa:'Map', profilo:'Profile', kpi:'My KPIs',
    oggi:'Today', domani:'Tomorrow', ieri:'Yesterday', tutti:'All', cerca:'Search...', salva:'Save',
    annulla:'Cancel', conferma:'Confirm', elimina:'Delete', carica:'Upload', invia:'Send',
    nessun_risultato:'No results', caricamento:'Loading...', errore:'Error',
    pianificato:'Scheduled', in_corso:'In progress', completato:'Completed', annullato:'Cancelled',
    aperta:'Open', assegnata:'Assigned', schedulata:'Scheduled', risolta:'Resolved', chiusa:'Closed',
    interventi_oggi:'Today\'s interventions', interventi:'Interventions', urgenze_aperte:'Open emergencies',
    cliente:'Customer', tecnico:'Technician', data:'Date', ora_inizio:'Start time', ora_fine:'End time',
    tipo_intervento:'Intervention type', note:'Notes', note_completamento:'Completion notes',
    priorita:'Priority', alta:'High', media:'Medium', bassa:'Low', critica:'Critical',
    descrizione:'Description', segnalato_da:'Reported by',
    cambia_password:'Change Password', password_attuale:'Current password',
    nuova_password:'New password', conferma_password:'Confirm new password',
    notifiche_push:'Push Notifications', aspetto:'Appearance', modalita_scura:'Dark mode',
    esci:'Log out',
    completati:'Completed', ore_lavorate:'Hours worked', sla_rispettato:'SLA compliance',
    tempo_medio:'Average time',
    foto_intervento:'Intervention photo', scatta_foto:'Take photo', galleria:'Gallery',
    analisi_ai:'AI Photo Analysis', diagnosi:'Diagnosis', gravita:'Severity',
    ricambio_suggerito:'Suggested spare part', ordina_ricambio:'Order spare part',
  }
};
let LANG = localStorage.getItem('sq2_lang') || 'it';
function t(key){ return (I18N[LANG] && I18N[LANG][key]) || (I18N.it[key]) || key; }
function setLang(lang){ LANG = lang; localStorage.setItem('sq2_lang', lang); }

// ============ HELPERS (coerenti con admin_v1) ============
const $=id=>document.getElementById(id);
const esc=s=>{if(!s)return'';const d=document.createElement('div');d.textContent=String(s);return d.innerHTML;};
const today=()=>new Date().toISOString().split('T')[0];
const fmtDate=d=>{if(!d)return'â€”';const p=String(d).substring(0,10).split('-');return p.length===3?p[2]+'/'+p[1]+'/'+p[0]:'â€”'};
const fmtDateTime=d=>{if(!d)return'â€”';try{return new Date(d).toLocaleString('it-IT',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}catch{return'â€”'}};
const fmtTime=d=>d?(d+'').substring(0,5):'â€”';

// getName â€” identica ad admin_v1
const getName=(list,id,field='Nome')=>{
  const o=(list||[]).find(x=>x.ID===id||x.CodiceM3===id);
  if(!o)return id||'â€”';
  if(field!=='Nome'&&o[field])return o[field];
  return(o.NomeInterno||o.NomeAccount||o.Nome||o.Descrizione||'')+(o.Cognome?' '+o.Cognome:'');
};
const getColor=(list,id)=>{const o=(list||[]).find(x=>x.ID===id);return o?.Colore||'#6B7280'};

// statusTag â€” identica ad admin_v1
function statusTag(stato){
  const m={'pianificato':['tag-info','ğŸ“…'],'in_corso':['tag-warn','âš¡'],'completato':['tag-ok','âœ…'],
    'aperta':['tag-err','ğŸ”´'],'assegnata':['tag-warn','ğŸ‘¤'],'schedulata':['tag-info','ğŸ“…'],'risolta':['tag-ok','âœ…'],
    'richiesto':['tag-info','ğŸ“'],'preso_in_carico':['tag-warn','ğŸ“‹'],'ordinato':['tag-warn','ğŸ“¦'],'in_arrivo':['tag-info','ğŸšš'],'arrivato':['tag-ok','âœ…'],
    'attiva':['tag-ok','âœ…'],'in_attesa':['tag-warn','â³'],'approvata':['tag-ok','âœ…'],'rifiutata':['tag-err','âŒ'],
    'chiuso':['tag-gray','ğŸ”’'],'da_rivedere':['tag-warn','âš ï¸'],'annullato':['tag-err','âŒ'],'da_approvare':['tag-warn','â³']};
  const x=m[stato]||['tag-gray',''];
  return'<span class="tag '+x[0]+'">'+x[1]+' '+(stato||'â€”')+'</span>';
}

function toast(m,t){const d=document.createElement('div');d.className='toast '+(t||'info');d.textContent=m;$('toasts').appendChild(d);setTimeout(()=>d.remove(),3500)}
function openSheet(id){$(id).classList.add('show')}
function closeSheet(id){$(id).classList.remove('show')}

// ============ NAVIGATION ============
function goPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav button').forEach(b=>b.classList.remove('active'));
  const pg=$('pg'+name.charAt(0).toUpperCase()+name.slice(1));
  if(pg)pg.classList.add('active');
  const btn=document.querySelector('.bnav button[data-p="'+name+'"]');
  if(btn)btn.classList.add('active');
  const t={'home':'ğŸ  Home','interventi':'ğŸ“‹ Interventi','urgenze':'ğŸš¨ Urgenze','ordini':'ğŸ“¦ Ordini','menu':'â‹¯ Menu',
    'chat':'ğŸ’¬ Chat Telegram','notifiche':'ğŸ”” Notifiche','richieste':'ğŸ“ Richieste','reperibilita':'ğŸ“ ReperibilitÃ ','trasferte':'ğŸ§³ Trasferte',
    'installazioni':'ğŸ”§ Installazioni','clienti':'ğŸ¢ Clienti','macchine':'âš™ï¸ Macchine','documenti':'ğŸ“ Documenti',
    'mappa':'ğŸ—ºï¸ Mappa Giro','calendario':'ğŸ“… Calendario','profilo':'ğŸ‘¤ Profilo','kpi':'ğŸ“Š Le mie KPI'};
  $('hdrTitle').textContent=t[name]||name;
  window.scrollTo(0,0);
  if(name==='calendario')renderCalMobile();
  if(name==='mappa')setTimeout(initMap,200);
  if(name==='chat')initChat();
  if(name==='kpi')renderKpi();
}

// ============ API (identica ad admin_v1) ============
let _apiActive=0;
function showGlobalLoad(show){const el=$('globalLoad');if(el)el.style.display=show?'flex':'none'}
async function apiCall(action,data,method){
  let url=API_URL,opts={};
  if(!method||method==='GET'){
    url+='?'+new URLSearchParams({action,token:API_TOKEN,...(data||{})});
  }else{
    opts={method:'POST',headers:{'Content-Type':'application/json','X-Token':API_TOKEN},body:JSON.stringify({action,userId:USER?.ID||'',...(data||{})})};
  }
  _apiActive++;if(_apiActive===1)showGlobalLoad(true);
  try{
    const controller=new AbortController();
    const timeout=setTimeout(()=>controller.abort(),30000);
    opts.signal=controller.signal;
    const r=await fetch(url,opts);
    clearTimeout(timeout);
    const json=await r.json();
    if(!json.success)throw new Error(json.error||'Errore API');
    return json.data!==undefined?json.data:json;
  }catch(e){
    if(e.name==='AbortError')throw new Error('Timeout: il server non risponde. Riprova.');
    throw e;
  }finally{
    _apiActive--;if(_apiActive<=0){_apiActive=0;showGlobalLoad(false)}
  }
}

async function refreshData(silent){
  if(silent){
    // Refresh silenzioso senza loading overlay
    try{
      let url=API_URL+'?'+new URLSearchParams({action:'getAll',token:API_TOKEN,userId:USER?.ID||''});
      const r=await fetch(url,{signal:AbortSignal.timeout(15000)});
      const json=await r.json();
      if(json.success&&json.data){DATA=json.data;if(USER&&USER.ID){const fresh=(DATA.utenti||[]).find(x=>x.ID===USER.ID);if(fresh)USER={...fresh}}renderAll()}
    }catch(e){console.warn('[SILENT-REFRESH]',e.message)}
    return;
  }
  try{
    DATA=await apiCall('getAll',{userId:USER?.ID||''});
    if(USER&&USER.ID){const fresh=(DATA.utenti||[]).find(x=>x.ID===USER.ID);if(fresh)USER={...fresh}}
    renderAll();
    loadChatUnread();
  }catch(e){toast('Errore: '+e.message,'err')}
}

// ============ AUTH ============
document.addEventListener('DOMContentLoaded',init);
async function init(){
  showGlobalLoad(false);
  try{
    DATA=await apiCall('getAll');
    $('loginLoad').style.display='none';
    $('loginForm').style.display='block';
    $('forgotPwdSection').style.display='block';
    const s=localStorage.getItem('sq2tec');
    if(s){const o=JSON.parse(s);const u=(DATA.utenti||[]).find(x=>x.ID===o.id);if(u){USER=u;enterApp()}}
  }catch(e){
    showGlobalLoad(false);
    console.error('[INIT]',e);
    $('loginLoad').innerHTML='<div style="color:var(--err)">Errore connessione: '+e.message+'</div><br><button class="btn btn-primary btn-sm" onclick="location.reload()">Riprova</button>';
  }
}

async function doLogin(e){
  e.preventDefault();
  $('btnLogin').disabled=true;$('loginErr').style.display='none';
  try{
    const r=await apiCall('login',{username:$('inpUser').value.trim(),password:$('inpPwd').value},'POST');
    if(!r.user)throw new Error('Credenziali non valide');
    USER=r.user;
    localStorage.setItem('sq2tec',JSON.stringify({id:USER.ID}));
    enterApp();
  }catch(e){$('loginErr').textContent=e.message;$('loginErr').style.display='block'}
  finally{$('btnLogin').disabled=false}
  return false;
}

function logout(){localStorage.removeItem('sq2tec');location.reload()}

/* â”€â”€â”€ DARK MODE â”€â”€â”€ */
function initDarkMode(){
  const saved = localStorage.getItem('sq2_theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme:dark)').matches;
  if(saved === 'dark' || (!saved && prefersDark)){
    document.documentElement.setAttribute('data-theme','dark');
    const t = $('darkToggle'); if(t) t.checked = true;
    updateDarkSlider(true);
  }
}
function toggleDarkMode(){
  const on = $('darkToggle').checked;
  if(on){
    document.documentElement.setAttribute('data-theme','dark');
    localStorage.setItem('sq2_theme','dark');
  } else {
    document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('sq2_theme','light');
  }
  updateDarkSlider(on);
}
function updateDarkSlider(on){
  const s = $('darkSlider');
  if(!s) return;
  s.style.transform = on ? 'translateX(22px)' : 'translateX(0)';
  s.parentElement.previousElementSibling.style.background = on ? 'var(--c1)' : '#ccc';
}
initDarkMode();

function switchLang(lang){
  setLang(lang);
  updateLangButtons();
  // Re-render current page titles
  const titles = {
    'home':'ğŸ  '+t('home'), 'piano':'ğŸ“‹ '+t('piano'), 'urgenze':'ğŸš¨ '+t('urgenze'),
    'mappa':'ğŸ—ºï¸ '+t('mappa'), 'calendario':'ğŸ“… Calendario', 'profilo':'ğŸ‘¤ '+t('profilo'), 'kpi':'ğŸ“Š '+t('kpi')
  };
  if(typeof NAV_LABELS!=='undefined') Object.assign(NAV_LABELS, titles);
  toast('âœ… '+(lang==='it'?'Lingua aggiornata':'Language updated'));
}
function updateLangButtons(){
  const it=$('langIt'), en=$('langEn');
  if(it) it.style.background = LANG==='it'?'var(--c1)':'var(--gray4)';
  if(it) it.style.color = LANG==='it'?'#fff':'var(--dark)';
  if(en) en.style.background = LANG==='en'?'var(--c1)':'var(--gray4)';
  if(en) en.style.color = LANG==='en'?'#fff':'var(--dark)';
}
setTimeout(updateLangButtons, 500);

function enterApp(){
  if(USER&&USER.ID){const full=(DATA.utenti||[]).find(x=>x.ID===USER.ID);if(full)USER={...full,...USER}}
  $('loginScreen').classList.add('hidden');
  $('hdr').style.display='flex';$('app').style.display='block';$('bnav').style.display='flex';
  $('hdrDate').textContent=new Date().toLocaleDateString('it-IT',{weekday:'short',day:'numeric',month:'short'});
  fillSelects();
  renderAll();
  // Auto-refresh silenzioso ogni 5 min (senza overlay)
  if(window._autoRefreshTimer) clearInterval(window._autoRefreshTimer);
  window._autoRefreshTimer = setInterval(()=>{refreshData(true)},300000);
  // Init push notifications
  setTimeout(()=>PushMgr.init().catch(()=>{}),2000);
  // Init pull-to-refresh
  initPullToRefresh();
}

/* â”€â”€â”€ PULL TO REFRESH â”€â”€â”€ */
function initPullToRefresh(){
  let startY=0, pulling=false, triggered=false;
  const app=$('app'), ptr=$('ptr');
  if(!app||!ptr) return;
  app.addEventListener('touchstart',e=>{
    if(window.scrollY===0 && e.touches.length===1){
      startY=e.touches[0].clientY; pulling=true; triggered=false;
    }
  },{passive:true});
  app.addEventListener('touchmove',e=>{
    if(!pulling) return;
    const dy=e.touches[0].clientY - startY;
    if(dy>60 && !triggered){
      ptr.classList.add('active'); triggered=true;
    }
  },{passive:true});
  app.addEventListener('touchend',()=>{
    if(triggered){
      refreshData(true).then(()=>{
        ptr.classList.remove('active');
        toast('Aggiornato','ok');
      }).catch(()=>ptr.classList.remove('active'));
    } else { ptr.classList.remove('active'); }
    pulling=false; triggered=false;
  },{passive:true});
}

/* â”€â”€â”€ SKELETON LOADING â”€â”€â”€ */
function showSkeleton(containerId, count=3){
  const el=$(containerId); if(!el) return;
  el.innerHTML = Array(count).fill('<div class="skel skel-card"></div>').join('');
}

function fillSelects(){
  const cls=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
  const furgoni=(DATA.automezzi||[]).filter(f=>!f.Obsoleto);
  // Ordine - cliente
  const s=$('soCliente');if(s){s.innerHTML='<option value="">â€”</option>';cls.forEach(c=>{const o=document.createElement('option');o.value=c.CodiceM3||c.ID;o.textContent=getName(DATA.clienti,c.ID);s.appendChild(o)})}
  // Trasferta - cliente
  const st=$('stCliente');if(st){st.innerHTML='<option value="">â€”</option>';cls.forEach(c=>{const o=document.createElement('option');o.value=c.CodiceM3||c.ID;o.textContent=getName(DATA.clienti,c.ID);st.appendChild(o)})}
  // Trasferta - automezzo
  const sa=$('stAutomezzo');if(sa){sa.innerHTML='<option value="">â€”</option>';furgoni.forEach(f=>{const o=document.createElement('option');o.value=f.ID;o.textContent=f.Descrizione||f.Targa||f.ID;sa.appendChild(o)})}
}

// ============ FILTRO MIEI ITEMS ============
function my(list){
  const isAdmin=USER?.Ruolo==='admin';
  return(list||[]).filter(p=>!p.Obsoleto&&(isAdmin||p.TecnicoID===USER?.ID||p.TecnicoAssegnato===USER?.ID||(p.TecniciIDs||'').includes(USER?.ID)));
}

// ============ RENDER ALL ============
function renderAll(){
  renderHome();renderInt();renderUrg();renderOrd();renderNot();renderRep();renderRich();renderTrasf();renderInst();renderCliMob();renderMacMob();renderDocMob();renderProf();updateBadges();
}

function updateBadges(){
  const nu=my(DATA.urgenze).filter(u=>u.Stato!=='risolta'&&u.Stato!=='chiusa').length;
  const nn=(DATA.notifiche||[]).filter(n=>!n.Obsoleto&&n.Stato==='inviata'&&(n.DestinatarioID===USER?.ID||(n.DestinatariIDs||'').includes(USER?.ID))).length;
  const no=my(DATA.ordini).filter(o=>o.Stato!=='arrivato').length;
  document.querySelectorAll('.bnav .nbadge').forEach(b=>b.remove());
  if(nu>0){const b=document.querySelector('[data-p=urgenze]');if(b){const s=document.createElement('span');s.className='nbadge';s.textContent=nu;b.appendChild(s)}}
  if(no>0){const b=document.querySelector('[data-p=ordini]');if(b){const s=document.createElement('span');s.className='nbadge';s.textContent=no;b.appendChild(s)}}
  // Notifiche badge su header bell
  const nh=$('btnNotHdr');
  if(nh){nh.querySelectorAll('.nbadge').forEach(b=>b.remove());if(nn>0){const s=document.createElement('span');s.className='nbadge';s.style.cssText='position:absolute;top:-2px;right:-2px';s.textContent=nn;nh.appendChild(s)}}
}

// ============ HOME ============
function renderHome(){
  const d=today();
  const miei=my(DATA.piano);
  const oggi=miei.filter(p=>p.Data===d).sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||''));
  const urgA=my(DATA.urgenze).filter(u=>u.Stato!=='risolta'&&u.Stato!=='chiusa');
  // ReperibilitÃ  attiva: data oggi Ã¨ nell'intervallo (indipendentemente dallo Stato)
  const reps=(DATA.reperibilita||[]).filter(r=>!r.Obsoleto&&r.TecnicoID===USER?.ID&&r.DataInizio<=d&&(r.DataFine||'9999')>=d);

  // Stats settimanali
  const d7ago=new Date();d7ago.setDate(d7ago.getDate()-6);const d7=d7ago.toISOString().split('T')[0];
  const settimana=miei.filter(p=>p.Data>=d7&&p.Data<=d);
  const settComp=settimana.filter(p=>p.Stato==='completato').length;
  const ordArr=my(DATA.ordini).filter(o=>o.Stato==='arrivato'||o.Stato==='in_arrivo').length;
  // Prossimo intervento
  const prossimo=miei.filter(p=>p.Data>=d&&p.Stato==='pianificato').sort((a,b)=>(a.Data+a.OraInizio).localeCompare(b.Data+b.OraInizio))[0];
  const prossTxt=prossimo?fmtTime(prossimo.OraInizio)+' '+getName(DATA.clienti,prossimo.ClienteID).substring(0,15):'â€”';

  $('homeKpi').innerHTML=
    '<div class="kpi-mini"><div class="val" style="color:var(--c3)">'+oggi.length+'</div><div class="lbl">ğŸ“‹ Oggi</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:'+(oggi.filter(p=>p.Stato==='completato').length===oggi.length&&oggi.length>0?'var(--ok)':'var(--warn)')+'">'+oggi.filter(p=>p.Stato==='completato').length+'/'+oggi.length+'</div><div class="lbl">âœ… Fatti</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:'+(urgA.length>0?'var(--err)':'var(--ok)')+'">'+urgA.length+'</div><div class="lbl">ğŸš¨ Urgenze</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:var(--c1)">'+settComp+'/'+settimana.length+'</div><div class="lbl">ğŸ“Š Settimana</div></div>';
  // Barra progresso giornata
  const pctOggi=oggi.length>0?Math.round(oggi.filter(p=>p.Stato==='completato').length/oggi.length*100):0;
  const inCorso=oggi.filter(p=>p.Stato==='in_corso').length;
  $('homeKpi').innerHTML+='<div style="grid-column:1/-1;margin-top:4px">'+
    '<div style="display:flex;justify-content:space-between;font-size:.7rem;color:var(--gray);margin-bottom:4px"><span>Progresso giornata</span><span>'+pctOggi+'%'+(inCorso?' Â· '+inCorso+' in corso':'')+'</span></div>'+
    '<div style="height:6px;background:var(--gray3);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pctOggi+'%;background:linear-gradient(90deg,var(--c1),var(--ok));border-radius:3px;transition:width .5s"></div></div>'+
    (prossimo?'<div style="font-size:.75rem;margin-top:8px;color:var(--c3)">â¡ï¸ Prossimo: <strong>'+prossTxt+'</strong></div>':'')+
    (ordArr?'<div style="font-size:.75rem;margin-top:4px;color:var(--warn)">ğŸ“¦ '+ordArr+' ordini in arrivo</div>':'')+
    (reps.length?'<div style="font-size:.75rem;margin-top:4px;color:var(--err)">ğŸ“ ReperibilitÃ  attiva</div>':'')+
    '</div>';

  $('homeList').innerHTML=oggi.length?oggi.map(p=>intItem(p)).join(''):'<div class="empty"><div class="ico">â˜€ï¸</div><p>Nessun intervento oggi</p></div>';

  if(urgA.length>0){
    $('homeUrgBox').style.display='';
    $('homeUrg').innerHTML=urgA.slice(0,3).map(u=>{
      const pc=getColor(DATA.priorita,u.PrioritaID);
      const actionBtn=u.Stato==='assegnata'||u.Stato==='schedulata'?
        '<button class="btn btn-xs" style="background:var(--warn);color:#fff;margin-top:6px;font-size:.7rem;padding:4px 10px" onclick="event.stopPropagation();startUrg(\''+u.ID+'\')">âš¡ Inizia</button>':
        u.Stato==='in_corso'?
        '<button class="btn btn-xs" style="background:var(--ok);color:#fff;margin-top:6px;font-size:.7rem;padding:4px 10px" onclick="event.stopPropagation();resolveUrg(\''+u.ID+'\')">âœ… Risolvi</button>':'';
      return '<div style="padding:10px 16px;border-bottom:1px solid #E5E7EB;cursor:pointer" onclick="showUrg(\''+u.ID+'\')">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:2px"><span class="tag" style="background:'+pc+'20;color:'+pc+'">'+getName(DATA.priorita,u.PrioritaID)+'</span>'+statusTag(u.Stato)+'</div>'+
        '<div style="font-weight:600;font-size:.875rem">'+getName(DATA.clienti,u.ClienteID)+'</div>'+
        '<div style="font-size:.75rem;color:var(--gray)">'+(u.Problema||'').substring(0,60)+'</div>'+actionBtn+'</div>';
    }).join('');
  }else{$('homeUrgBox').style.display='none'}

  if(reps.length>0){
    $('homeRepBox').style.display='';
    $('homeRep').innerHTML=reps.map(r=>'<div style="font-size:.875rem"><strong>ğŸ“ ReperibilitÃ  attiva</strong> Â· '+(r.Turno||'24h')+'<br><span style="font-size:.75rem;color:var(--gray)">'+fmtDate(r.DataInizio)+' â†’ '+fmtDate(r.DataFine)+'</span></div>').join('');
  }else{$('homeRepBox').style.display='none'}
}

// ============ INTERVENTI ============
function intItem(p){
  const cli=getName(DATA.clienti,p.ClienteID);
  const tipo=getName(DATA.tipiIntervento,p.TipoInterventoID);
  const tc=getColor(DATA.tipiIntervento,p.TipoInterventoID);
  const furg=getName(DATA.automezzi||[],p.AutomezzoID,'Descrizione');
  return '<div class="int-item" onclick="showInt(\''+p.ID+'\')">'+
    '<div class="time-block"><div class="time">'+fmtTime(p.OraInizio)+'</div><div class="date">'+fmtDate(p.Data).substring(0,5)+'</div></div>'+
    '<div class="info"><h4>'+cli+'</h4>'+
    '<p><span class="tag" style="background:'+tc+'20;color:'+tc+'">'+tipo+'</span>'+(furg&&furg!=='â€”'?' <span style="font-size:.65rem;color:var(--gray)">ğŸš '+furg+'</span>':'')+'</p>'+
    statusTag(p.Stato)+'</div><div class="arrow">â€º</div></div>';
}

function filtInt(s){
  intF=s;renderInt();
  ['fAll','fPian','fCorso','fComp'].forEach(id=>{const b=$(id);if(b)b.className=b.className.replace('btn-primary','btn-outline')});
  if(!s)$('fAll').className=$('fAll').className.replace('btn-outline','btn-primary');
  else if(s==='pianificato')$('fPian').className=$('fPian').className.replace('btn-outline','btn-primary');
  else if(s==='in_corso')$('fCorso').className=$('fCorso').className.replace('btn-outline','btn-primary');
  else if(s==='completato')$('fComp').className=$('fComp').className.replace('btn-outline','btn-primary');
}

function renderInt(){
  let items=my(DATA.piano);
  if(intF)items=items.filter(p=>p.Stato===intF);
  // Filtro per data
  const df=$('intDateFrom')?.value;
  const dt=$('intDateTo')?.value;
  if(df)items=items.filter(p=>(p.Data||'')>=df);
  if(dt)items=items.filter(p=>(p.Data||'')<=dt);
  items.sort((a,b)=>(b.Data||'').localeCompare(a.Data||'')||(a.OraInizio||'').localeCompare(b.OraInizio||''));
  const cnt=items.length;
  $('intList').innerHTML=cnt?'<div style="padding:8px 16px;font-size:.75rem;color:var(--gray);border-bottom:1px solid var(--gray3)">'+cnt+' intervento'+(cnt>1?'i':'')+(df||dt?' nel periodo':'')+' trovato'+(cnt>1?'i':'')+'</div>'+items.map(p=>intItem(p)).join(''):'<div class="empty"><div class="ico">ğŸ“‹</div><p>Nessun intervento'+(df||dt?' nel periodo':'')+'</p></div>';
}
function clearDateFilter(){$('intDateFrom').value='';$('intDateTo').value='';renderInt()}

function showInt(id){
  const p=(DATA.piano||[]).find(x=>x.ID===id);if(!p)return;
  const cli=getName(DATA.clienti,p.ClienteID);
  const cObj=(DATA.clienti||[]).find(c=>c.ID===p.ClienteID||c.CodiceM3===p.ClienteID);
  const mac=(DATA.macchine||[]).find(m=>m.ID===p.MacchinaID);
  const furg=getName(DATA.automezzi||[],p.AutomezzoID,'Descrizione');
  $('siTitle').textContent=cli;
  $('siBody').innerHTML=
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'+
    '<span style="font-size:1.5rem;font-weight:700;color:var(--c1)">'+fmtTime(p.OraInizio)+'</span>'+statusTag(p.Stato)+'</div>'+
    '<div style="font-size:.9375rem;font-weight:600;margin-bottom:4px">'+fmtDate(p.Data)+'</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0;font-size:.8125rem">'+
    '<div><span style="color:var(--gray)">Tipo</span><br><strong>'+getName(DATA.tipiIntervento,p.TipoInterventoID)+'</strong></div>'+
    '<div><span style="color:var(--gray)">PrioritÃ </span><br><strong>'+getName(DATA.priorita,p.PrioritaID)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Macchina</span><br><strong>'+(mac?mac.Tipo+' '+mac.Modello:'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Furgone</span><br><strong>'+furg+'</strong></div>'+
    '<div><span style="color:var(--gray)">Km / Ore</span><br><strong>'+(p.KmPercorsi||'â€”')+' / '+(p.OreLavorate||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Durata stimata</span><br><strong>'+(p.DurataOre||'â€”')+'h</strong></div>'+
    '</div>'+
    (p.Note?'<div style="margin-bottom:12px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm);font-size:.8125rem">'+p.Note+'</div></div>':'')+
    (p.NoteCompletamento?'<div style="margin-bottom:12px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note completamento</div><div style="background:#D1FAE5;padding:12px;border-radius:var(--radius-sm);font-size:.8125rem">'+p.NoteCompletamento+'</div></div>':'')+
    (p.Stato==='in_corso'?'<div style="border:1px dashed var(--border);border-radius:8px;padding:12px;margin-bottom:12px"><strong style="font-size:.85rem">ğŸ“· Foto Intervento</strong><div style="display:flex;gap:8px;margin-top:8px"><label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer;font-size:.8rem">ğŸ“¸ Scatta<input type="file" accept="image/*" capture="environment" style="display:none" onchange="uploadFotoInt(this,\''+id+'\')"></label><label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer;font-size:.8rem">ğŸ“ Galleria<input type="file" accept="image/*" style="display:none" onchange="uploadFotoInt(this,\''+id+'\')"></label></div><div id="fotoIntPrev_'+id+'" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px"></div></div>':'')+
    (p.Stato==='in_corso'||p.Stato==='completato'?buildChecklistUI(id, p):'') +
    '<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">'+
    (cObj?.Telefono?'<a href="tel:'+cObj.Telefono+'" class="btn btn-outline">ğŸ“ Chiama '+cObj.Telefono+'</a>':'')+
    (cObj?.Latitudine&&cObj?.Longitudine?'<a href="https://www.google.com/maps/dir/?api=1&destination='+cObj.Latitudine+','+cObj.Longitudine+'&travelmode=driving" target="_blank" class="btn btn-outline">ğŸ“ Naviga</a>':'')+
    (p.Stato==='pianificato'?'<button class="btn btn-warn" onclick="startInt(\''+id+'\')">âš¡ Inizia Intervento</button>':'')+
    (p.Stato==='in_corso'?'<button class="btn btn-ok" onclick="closeSheet(\'shInt\');openCompleta(\''+id+'\')">âœ… Completa Intervento</button>':'')+
    (p.Stato!=='completato'?'<button class="btn btn-outline" onclick="openEditInt(\''+id+'\')">âœï¸ Modifica Intervento</button>':'')+
    '</div>';
  openSheet('shInt');
  // Load checklist state if in_corso
  if(p.Stato==='in_corso') loadChecklistState(id);
}

/* â”€â”€â”€ CHECKLIST INTERVENTO â”€â”€â”€ */
function buildChecklistUI(intId, p){
  const templates = DATA.checklistTemplate || DATA.ChecklistTemplate || [];
  if(!templates.length) return '';
  const readonly = p.Stato === 'completato';
  let html = '<div style="border:1px solid var(--gray3);border-radius:var(--radius);padding:12px;margin-bottom:12px">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">' +
    '<strong style="font-size:.85rem">âœ… Checklist</strong>' +
    '<span id="clProgress_'+intId+'" style="font-size:.75rem;color:var(--gray)"></span></div>';
  if(!readonly){
    html += '<select id="clTemplate_'+intId+'" onchange="applyChecklistTemplate(\''+intId+'\')" style="width:100%;padding:8px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem;margin-bottom:10px">' +
      '<option value="">â€” Seleziona template â€”</option>' +
      templates.filter(t=>t.Attivo!==false&&t.Attivo!=='false').map(t=>'<option value="'+t.ID+'">'+t.Nome+'</option>').join('') +
      '</select>';
  }
  html += '<div id="clItems_'+intId+'"></div></div>';
  return html;
}

function applyChecklistTemplate(intId){
  const sel = $('clTemplate_'+intId);
  if(!sel) return;
  const tplId = sel.value;
  if(!tplId){ $('clItems_'+intId).innerHTML=''; return; }
  const tpl = (DATA.checklistTemplate||DATA.ChecklistTemplate||[]).find(t=>t.ID===tplId);
  if(!tpl) return;
  let voci = [];
  try { voci = typeof tpl.Voci === 'string' ? JSON.parse(tpl.Voci) : (tpl.Voci||[]); } catch(e){ voci = []; }
  if(!voci.length){ $('clItems_'+intId).innerHTML='<div style="font-size:.8rem;color:var(--gray)">Template vuoto</div>'; return; }
  const state = voci.map((v,i)=>({text: typeof v==='string'?v:v.testo||v.text||v, checked:false}));
  localStorage.setItem('cl_'+intId, JSON.stringify({templateId:tplId, items:state}));
  renderChecklistItems(intId, state, false);
}

function loadChecklistState(intId){
  const saved = localStorage.getItem('cl_'+intId);
  if(!saved) return;
  try{
    const data = JSON.parse(saved);
    const items = data.items||[];
    if(items.length) renderChecklistItems(intId, items, false);
    if(data.templateId){
      const sel = $('clTemplate_'+intId);
      if(sel) sel.value = data.templateId;
    }
  }catch(e){}
}

function renderChecklistItems(intId, items, readonly){
  const el = $('clItems_'+intId);
  if(!el) return;
  const done = items.filter(i=>i.checked).length;
  const total = items.length;
  const pct = total?Math.round(done/total*100):0;
  const progEl = $('clProgress_'+intId);
  if(progEl) progEl.textContent = done+'/'+total+' ('+pct+'%)';
  el.innerHTML = items.map((item,i) =>
    '<label style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--gray4);cursor:'+(readonly?'default':'pointer')+';font-size:.8125rem">' +
    '<input type="checkbox" '+(item.checked?'checked ':'')+
    (readonly?'disabled ':'onchange="toggleChecklistItem(\''+intId+'\','+i+')" ') +
    'style="width:18px;height:18px;accent-color:var(--ok)">' +
    '<span style="'+(item.checked?'text-decoration:line-through;color:var(--gray2)':'')+'">'+item.text+'</span></label>'
  ).join('');
}

function toggleChecklistItem(intId, idx){
  const saved = localStorage.getItem('cl_'+intId);
  if(!saved) return;
  try{
    const data = JSON.parse(saved);
    data.items[idx].checked = !data.items[idx].checked;
    localStorage.setItem('cl_'+intId, JSON.stringify(data));
    renderChecklistItems(intId, data.items, false);
  }catch(e){}
}

async function startInt(id){
  try{await apiCall('updatePiano',{id,data:{Stato:'in_corso'},operatoreId:USER?.ID},'POST');toast('Intervento iniziato','ok');closeSheet('shInt');await refreshData()}catch(e){toast(e.message,'err')}
}

function openCompleta(id){
  $('scId').value=id;$('scKm').value='';$('scOre').value='';$('scVoto').value='';$('scNote').value='';scAllegatiFiles=[];$('scAllegatiPreview').innerHTML='';
  openSheet('shCompleta');
}

async function completaInt(){
  try{
    const interventoId=$('scId').value;
    const voto=parseInt($('scVoto').value)||null;
    if(voto&&(voto<1||voto>10)){toast('Voto deve essere tra 1 e 10','warn');return}
    const data={Stato:'completato',KmPercorsi:parseFloat($('scKm').value)||0,OreLavorate:parseFloat($('scOre').value)||0,NoteCompletamento:$('scNote').value,ValutazioneCliente:voto};
    await apiCall('updatePiano',{id:interventoId,data,operatoreId:USER?.ID},'POST');
    for(const af of scAllegatiFiles){
      if(!af)continue;
      try{
        const up=await apiCall('uploadFile',{base64:af.base64,mimeType:af.type,fileName:af.name,userId:USER?.ID},'POST');
        if(up&&up.fileUrl) await apiCall('createAllegato',{Nome:af.name,FileURL:up.fileUrl,FileID:up.fileId,MimeType:af.type,DimensioneKB:af.sizeKB,RiferimentoTipo:'piano',RiferimentoID:interventoId},'POST');
      }catch(e){}
    }
    toast('Intervento completato!','ok');closeSheet('shCompleta');await refreshData();
  }catch(e){toast(e.message,'err')}
}

function addAllegatoFile(input){
  const file=input.files[0];if(!file)return;
  if(file.size>20*1024*1024){toast('File troppo grande (max 20MB)','err');input.value='';return}
  const reader=new FileReader();
  reader.onload=function(){
    const base64=reader.result.split(',')[1];
    const idx=scAllegatiFiles.length;
    scAllegatiFiles.push({base64,type:file.type,name:file.name,sizeKB:Math.round(file.size/1024)});
    const isImg=file.type.startsWith('image/');
    const prev=document.createElement('div');
    prev.style.cssText='display:flex;align-items:center;gap:8px;padding:8px 10px;background:#F9FAFB;border-radius:8px';
    prev.innerHTML=(isImg?'<img src="'+reader.result+'" style="width:40px;height:40px;border-radius:6px;object-fit:cover">':'<span>ğŸ“„</span>')+
      '<div style="flex:1;min-width:0"><div style="font-size:.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+file.name+'</div><div style="font-size:.7rem;color:var(--gray)">'+Math.round(file.size/1024)+' KB</div></div>'+
      '<button onclick="rmAllegato('+idx+',this.parentElement)" style="background:none;border:none;color:var(--err);cursor:pointer">âœ•</button>';
    $('scAllegatiPreview').appendChild(prev);
    input.value='';
  };
  reader.readAsDataURL(file);
}
function rmAllegato(idx,el){scAllegatiFiles[idx]=null;el.remove()}

// ============ URGENZE ============
function filtUrg(s){
  urgF=s;renderUrg();
  ['fUrgAll','fUrgAss','fUrgCorso','fUrgRis'].forEach(id=>{const b=$(id);if(b)b.className=b.className.replace('btn-primary','btn-outline')});
  if(!s)$('fUrgAll').className=$('fUrgAll').className.replace('btn-outline','btn-primary');
  else if(s==='assegnata')$('fUrgAss').className=$('fUrgAss').className.replace('btn-outline','btn-primary');
  else if(s==='in_corso')$('fUrgCorso').className=$('fUrgCorso').className.replace('btn-outline','btn-primary');
  else if(s==='risolta')$('fUrgRis').className=$('fUrgRis').className.replace('btn-outline','btn-primary');
}
function renderUrg(){
  let items=my(DATA.urgenze).sort((a,b)=>{const o={'breach':0,'critical':1,'warning':2,'ok':3,'':4};return(o[a.SLAStatus]||4)-(o[b.SLAStatus]||4)});
  if(urgF){items=items.filter(u=>u.Stato===urgF)}
  const aperte=items.filter(u=>u.Stato!=='risolta'&&u.Stato!=='chiusa');
  const risolte=items.filter(u=>u.Stato==='risolta'||u.Stato==='chiusa').slice(0,5);
  let h='';
  if(aperte.length){
    h+=aperte.map(u=>{
      const pc=getColor(DATA.priorita,u.PrioritaID);
      return '<div class="card" style="border-left:4px solid '+pc+'" onclick="showUrg(\''+u.ID+'\')"><div class="card-body">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span class="tag" style="background:'+pc+'20;color:'+pc+'">'+getName(DATA.priorita,u.PrioritaID)+'</span>'+statusTag(u.Stato)+'</div>'+
        '<div style="font-weight:600;margin-bottom:2px">'+getName(DATA.clienti,u.ClienteID)+'</div>'+
        '<div style="font-size:.8125rem;color:var(--gray);margin-bottom:4px">'+(u.Problema||'').substring(0,80)+'</div>'+
        (u.SLAStatus&&u.SLAStatus!=='ok'?'<div style="font-size:.7rem;color:var(--err)">SLA: '+u.SLAStatus+'</div>':'')+
        '</div></div>';
    }).join('');
  }else{h+='<div class="empty"><div class="ico">ğŸ‰</div><p>Nessuna urgenza aperta</p></div>'}
  if(risolte.length){
    h+='<div style="font-size:.75rem;color:var(--gray);font-weight:600;margin:16px 0 8px">Risolte di recente</div>';
    h+=risolte.map(u=>'<div class="card" style="opacity:.7" onclick="showUrg(\''+u.ID+'\')"><div class="card-body" style="padding:10px 16px;display:flex;justify-content:space-between"><span>'+getName(DATA.clienti,u.ClienteID)+'</span>'+statusTag(u.Stato)+'</div></div>').join('');
  }
  $('urgList').innerHTML=h;
}

function showUrg(id){
  const u=(DATA.urgenze||[]).find(x=>x.ID===id);if(!u)return;
  const cObj=(DATA.clienti||[]).find(c=>c.ID===u.ClienteID||c.CodiceM3===u.ClienteID);
  $('suTitle').textContent='ğŸš¨ '+getName(DATA.clienti,u.ClienteID);
  $('suBody').innerHTML=
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem;margin-bottom:16px">'+
    '<div><span style="color:var(--gray)">PrioritÃ </span><br><span class="tag" style="background:'+getColor(DATA.priorita,u.PrioritaID)+'20;color:'+getColor(DATA.priorita,u.PrioritaID)+'">'+getName(DATA.priorita,u.PrioritaID)+'</span></div>'+
    '<div><span style="color:var(--gray)">Stato</span><br>'+statusTag(u.Stato)+'</div>'+
    '<div><span style="color:var(--gray)">Macchina</span><br><strong>'+getName(DATA.macchine,u.MacchinaID)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Segnalata</span><br><strong>'+fmtDateTime(u.DataSegnalazione)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Data Prevista</span><br><strong>'+fmtDate(u.DataPrevista)+'</strong></div>'+
    '<div><span style="color:var(--gray)">SLA</span><br><strong style="color:'+(u.SLAStatus==='ok'?'var(--ok)':'var(--err)')+'">'+( u.SLAStatus||'â€”')+'</strong></div>'+
    '</div>'+
    '<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Problema</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+(u.Problema||'â€”')+'</div></div>'+
    (u.Note?'<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+u.Note+'</div></div>':'')+
    (u.NoteAi?'<div style="margin-bottom:16px;background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);border-radius:8px;padding:12px"><strong>ğŸ¤– Analisi AI:</strong><br>'+u.NoteAi+(u.AiConfidence?' <span style="color:var(--gray);font-size:.8em">('+Math.round((u.AiConfidence||0)*100)+'%)</span>':'')+'</div>':'')+
    '<div style="margin-bottom:16px;border:1px dashed rgba(124,58,237,0.4);border-radius:8px;padding:12px;background:rgba(124,58,237,0.05)">'+
    '<strong>ğŸ“· Analisi Guasto AI</strong><br>'+
    '<input type="file" id="aiVisionFileTec_'+u.ID+'" accept="image/*" capture="environment" style="display:none" onchange="previewAIPhotoTec(\''+u.ID+'\')">'+
    '<button class="btn btn-outline" style="margin-top:8px;font-size:.8rem" onclick="document.getElementById(\'aiVisionFileTec_'+u.ID+'\').click()">ğŸ“¸ Scatta Foto</button>'+
    '<div id="aiVisionPreviewTec_'+u.ID+'" style="display:none;margin-top:8px"><img id="aiVisionImgTec_'+u.ID+'" style="max-width:100%;max-height:200px;border-radius:8px"><div style="margin-top:6px;display:flex;gap:8px"><button class="btn btn-primary" style="flex:1;font-size:.8rem" onclick="runAIVisionTec(\''+u.ID+'\')">ğŸ¤– Analizza</button><button class="btn btn-ghost" style="font-size:.8rem" onclick="cancelAIPhotoTec(\''+u.ID+'\')">âœ•</button></div></div>'+
    '<div id="aiVisionLoadingTec_'+u.ID+'" style="display:none;margin-top:8px;text-align:center"><span class="spinner"></span> Analisi...</div>'+
    '<div id="aiVisionResultTec_'+u.ID+'" style="display:none;margin-top:8px"></div>'+
    '</div>'+
    '<div style="display:flex;flex-direction:column;gap:8px">'+
    (u.Stato==='assegnata'||u.Stato==='schedulata'?'<button class="btn" style="background:var(--warn);color:#fff" onclick="startUrg(\''+u.ID+'\')">âš¡ Inizia Urgenza</button><button class="btn" style="background:var(--err);color:#fff" onclick="rejectUrg(\''+u.ID+'\')">âŒ Rifiuta Urgenza</button>':'')+
    (u.Stato==='in_corso'?'<button class="btn" style="background:var(--ok);color:#fff" onclick="resolveUrg(\''+u.ID+'\')">âœ… Risolvi Urgenza</button>':'')+
    (cObj?.Telefono?'<a href="tel:'+cObj.Telefono+'" class="btn btn-outline">ğŸ“ Chiama '+cObj.Telefono+'</a>':'')+
    (cObj?.Latitudine&&cObj?.Longitudine?'<a href="https://www.google.com/maps/dir/?api=1&destination='+cObj.Latitudine+','+cObj.Longitudine+'&travelmode=driving" target="_blank" class="btn btn-outline">ğŸ“ Naviga</a>':'')+
    '<button class="btn btn-outline" onclick="closeSheet(\'shUrg\')">Chiudi</button></div>';
  openSheet('shUrg');
}

async function startUrg(id){
  try{
    await apiCall('startUrgenza',{id,operatoreId:USER?.ID},'POST');
    toast('Urgenza iniziata!','ok');closeSheet('shUrg');
    await refreshData();
  }catch(e){toast(e.message,'err')}
}
async function resolveUrg(id){
  const note=prompt('Note di risoluzione (opzionale):');
  if(note===null)return;
  try{
    await apiCall('resolveUrgenza',{id,noteRisoluzione:note,operatoreId:USER?.ID},'POST');
    toast('Urgenza risolta!','ok');closeSheet('shUrg');
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

async function rejectUrg(id){
  const motivo=prompt('Motivo del rifiuto:');
  if(!motivo)return;
  try{
    await apiCall('rejectUrgenza',{id,motivo,operatoreId:USER?.ID},'POST');
    toast('Urgenza rifiutata â€” admin notificato','ok');closeSheet('shUrg');
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ AI VISION (Tecnico) ============
function previewAIPhotoTec(urgId){
  const file=document.getElementById('aiVisionFileTec_'+urgId)?.files?.[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    document.getElementById('aiVisionImgTec_'+urgId).src=e.target.result;
    document.getElementById('aiVisionPreviewTec_'+urgId).style.display='block';
  };
  reader.readAsDataURL(file);
}
function cancelAIPhotoTec(urgId){
  document.getElementById('aiVisionPreviewTec_'+urgId).style.display='none';
  document.getElementById('aiVisionFileTec_'+urgId).value='';
  document.getElementById('aiVisionResultTec_'+urgId).style.display='none';
}
async function runAIVisionTec(urgId){
  const file=document.getElementById('aiVisionFileTec_'+urgId)?.files?.[0];
  if(!file){toast('Seleziona una foto','err');return}
  const compressed=await compressImageTec(file,800,0.7);
  const base64=compressed.split(',')[1];
  document.getElementById('aiVisionLoadingTec_'+urgId).style.display='block';
  document.getElementById('aiVisionResultTec_'+urgId).style.display='none';
  const urg=(DATA.urgenze||[]).find(u=>u.ID===urgId);
  const macchina=urg?getName(DATA.macchine,urg.MacchinaID):'';
  const cliente=urg?getName(DATA.clienti,urg.ClienteID):'';
  try{
    const res=await apiCall('analyzeImage',{
      image_base64:base64,urgenza_id:urgId,
      contesto:`${macchina||'macchina agricola Lely'} - ${cliente||''} - ${urg?.Problema||''}`
    },'POST');
    document.getElementById('aiVisionLoadingTec_'+urgId).style.display='none';
    const r=document.getElementById('aiVisionResultTec_'+urgId);
    r.style.display='block';
    const gc=res.gravita==='alta'?'#DC2626':res.gravita==='media'?'#F59E0B':'#10B981';
    r.innerHTML='<div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px">'+
      '<div style="font-weight:600;margin-bottom:6px">ğŸ” '+( res.diagnosi||'N/D')+'</div>'+
      '<div style="margin-bottom:4px"><strong>GravitÃ :</strong> <span style="background:'+gc+'20;color:'+gc+';padding:2px 8px;border-radius:4px;font-weight:600">'+(res.gravita||'?').toUpperCase()+'</span></div>'+
      (res.ricambio_suggerito?'<div style="margin-bottom:4px"><strong>Ricambio:</strong> '+res.ricambio_suggerito+(res.codice_ricambio?' ('+res.codice_ricambio+')':'')+'</div>':'')+
      (res.azione_consigliata?'<div style="margin-bottom:4px"><strong>Azione:</strong> '+res.azione_consigliata+'</div>':'')+
      '<div><strong>Confidenza:</strong> '+Math.round((res.confidence||0)*100)+'%</div></div>';
    toast('Analisi completata!','ok');
  }catch(e){
    document.getElementById('aiVisionLoadingTec_'+urgId).style.display='none';
    document.getElementById('aiVisionResultTec_'+urgId).style.display='block';
    document.getElementById('aiVisionResultTec_'+urgId).innerHTML='<div style="color:var(--err)">âŒ '+e.message+'</div>';
  }
}
function compressImageTec(file,maxSize,quality){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement('canvas');
        let w=img.width,h=img.height;
        if(w>maxSize||h>maxSize){if(w>h){h=Math.round(h*maxSize/w);w=maxSize}else{w=Math.round(w*maxSize/h);h=maxSize}}
        canvas.width=w;canvas.height=h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        resolve(canvas.toDataURL('image/jpeg',quality));
      };
      img.onerror=reject;img.src=e.target.result;
    };
    reader.onerror=reject;reader.readAsDataURL(file);
  });
}

// ============ ORDINI ============
function renderOrd(){
  const items=my(DATA.ordini).sort((a,b)=>(b.DataRichiesta||'').localeCompare(a.DataRichiesta||''));
  $('ordList').innerHTML=items.length?items.map(o=>{
    const sts=['richiesto','preso_in_carico','ordinato','in_arrivo','arrivato'];
    const ix=sts.indexOf(o.Stato);
    const wf='<div style="display:flex;gap:4px;margin:6px 0">'+sts.map((s,i)=>'<div class="wf-dot'+(i<ix?' done':i===ix?' active':'')+'"></div>').join('')+'</div>';
    return '<div class="card"><div class="card-body">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+(o.Codice||'â€”')+'</strong>'+statusTag(o.Stato)+'</div>'+
      '<div style="font-size:.8125rem;color:var(--gray)">'+(o.Descrizione||'â€”')+' Â· Q: '+(o.Quantita||1)+'</div>'+wf+
      '<div style="font-size:.75rem;color:var(--gray)">Richiesto: '+fmtDate(o.DataRichiesta)+'</div>'+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ“¦</div><p>Nessun ordine</p></div>';
}

async function saveOrdine(){
  try{
    const data={Codice:$('soCodice').value,Descrizione:$('soDesc').value||$('soCodice').value||'Ordine ricambio',Quantita:parseInt($('soQta').value)||1,ClienteID:$('soCliente').value,Note:$('soNote').value,TecnicoID:USER?.ID};
    if(!data.Codice){toast('Inserisci codice ricambio','warn');return}
    await apiCall('createOrdine',{data},'POST');
    toast('Ordine creato!','ok');closeSheet('shOrdine');
    $('soCodice').value='';$('soDesc').value='';$('soNote').value='';
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ NOTIFICHE ============
function renderNot(){
  const items=(DATA.notifiche||[]).filter(n=>!n.Obsoleto&&(n.DestinatarioID===USER?.ID||(n.DestinatariIDs||'').includes(USER?.ID))).sort((a,b)=>(b.DataInvio||'').localeCompare(a.DataInvio||''));
  $('notList').innerHTML=items.length?items.map(n=>{
    const unread=n.Stato==='inviata';
    return '<div class="notif-item'+(unread?' unread':'')+'"><div class="dot-n'+(unread?'':' read')+'"></div><div class="n-info">'+
      '<div style="display:flex;justify-content:space-between"><strong style="font-size:.875rem">'+(n.Oggetto||n.Tipo||'Notifica')+'</strong><span style="font-size:.6875rem;color:var(--gray)">'+fmtDateTime(n.DataInvio)+'</span></div>'+
      '<div style="font-size:.8125rem;color:var(--gray);margin-top:2px">'+(n.Testo||'').substring(0,100)+'</div>'+
      (unread?'<button class="btn btn-sm btn-ok" style="margin-top:8px" onclick="markNot(\''+n.ID+'\')">âœ… Ricevuta</button>':'')+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ””</div><p>Nessuna notifica</p></div>';
}

async function markNot(id){try{await apiCall('markNotifica',{id,azione:'presa_in_carico'},'POST');toast('Notifica confermata','ok');await refreshData()}catch(e){toast(e.message,'err')}}
async function markAllRead(){try{await apiCall('markAllRead',{userId:USER?.ID},'POST');toast('Tutte lette','ok');await refreshData()}catch(e){toast(e.message,'err')}}
async function deleteAllNot(){if(!confirm('Eliminare tutte le notifiche lette?'))return;try{await apiCall('deleteAllNotifiche',{userId:USER?.ID},'POST');toast('Notifiche eliminate','ok');await refreshData()}catch(e){toast(e.message,'err')}}

// ============ REPERIBILITA ============
function renderRep(){
  const d=today();
  const items=(DATA.reperibilita||[]).filter(r=>!r.Obsoleto&&r.TecnicoID===USER?.ID).sort((a,b)=>{
    // Attive prima, poi per data
    const aAct=(a.DataInizio<=d&&(a.DataFine||'9999')>=d)?1:0;
    const bAct=(b.DataInizio<=d&&(b.DataFine||'9999')>=d)?1:0;
    if(bAct!==aAct)return bAct-aAct;
    return (b.DataInizio||'').localeCompare(a.DataInizio||'');
  });
  $('repList').innerHTML=items.length?items.map(r=>{
    // Attiva se la data di oggi Ã¨ nell'intervallo, indipendentemente dallo Stato DB
    const inCourse=r.DataInizio<=d&&(r.DataFine||'9999')>=d;
    const past=(r.DataFine||'9999')<d;
    return '<div class="card" style="'+(inCourse?'border-left:4px solid var(--ok)':past?'opacity:.6':'')+'"><div class="card-body">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+(r.Turno||'24h')+'</strong>'+
      (inCourse?'<span class="tag tag-ok">ğŸŸ¢ ATTIVA</span>':past?'<span class="tag tag-gray">ğŸ“ Archivio</span>':statusTag(r.Stato))+'</div>'+
      '<div style="font-size:.875rem">ğŸ“… '+fmtDate(r.DataInizio)+' â†’ '+fmtDate(r.DataFine)+'</div>'+
      (inCourse?'<div style="margin-top:6px;font-size:.75rem;color:var(--ok)">ğŸ“ ReperibilitÃ  in corso ora</div>':'')+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ“</div><p>Nessun turno</p></div>';
}

// ============ RICHIESTE ============
function renderRich(){
  const items=(DATA.richieste||[]).filter(r=>!r.Obsoleto&&r.TecnicoID===USER?.ID).sort((a,b)=>(b.DataRichiesta||'').localeCompare(a.DataRichiesta||''));
  $('richList').innerHTML=items.length?items.map(r=>'<div class="card"><div class="card-body">'+
    '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+(r.Tipo||'â€”')+'</strong>'+statusTag(r.Stato)+'</div>'+
    '<div style="font-size:.875rem">ğŸ“… '+fmtDate(r.DataInizio)+(r.DataFine?' â†’ '+fmtDate(r.DataFine):'')+'</div>'+
    '<div style="font-size:.8125rem;color:var(--gray);margin-top:4px">'+(r.Motivo||'â€”')+'</div>'+
    '</div></div>').join(''):'<div class="empty"><div class="ico">ğŸ“</div><p>Nessuna richiesta</p></div>';
}

async function saveRichiesta(){
  try{
    const data={TecnicoID:USER?.ID,Tipo:$('srTipo').value,DataInizio:$('srDal').value,DataFine:$('srAl').value,Motivo:$('srMotivo').value};
    if(!data.DataInizio){toast('Inserisci data inizio','warn');return}
    await apiCall('createRichiesta',{data},'POST');
    toast('Richiesta inviata!','ok');closeSheet('shRichiesta');
    $('srDal').value='';$('srAl').value='';$('srMotivo').value='';
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ TRASFERTE ============
function renderTrasf(){
  const items=(DATA.trasferte||[]).filter(t=>!t.Obsoleto&&(t.TecnicoID===USER?.ID||(t.TecniciIDs||'').includes(USER?.ID))).sort((a,b)=>(b.DataInizio||'').localeCompare(a.DataInizio||''));
  $('trasfList').innerHTML=items.length?items.map(t=>{
    const active=t.Stato!=='completata'&&t.DataInizio<=today()&&(t.DataFine||'9999')>=today();
    return '<div class="card" '+(active?'style="border-left:4px solid var(--c1)"':'')+'><div class="card-body">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+getName(DATA.clienti,t.ClienteID)+'</strong>'+statusTag(t.Stato)+'</div>'+
      '<div style="font-size:.875rem">ğŸ“… '+fmtDate(t.DataInizio)+' â†’ '+fmtDate(t.DataFine)+'</div>'+
      (t.Motivo?'<div style="font-size:.8125rem;color:var(--gray);margin-top:4px">'+t.Motivo+'</div>':'')+
      (active?'<div style="margin-top:6px"><span class="tag tag-warn">ğŸ§³ In trasferta adesso</span></div>':'')+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ§³</div><p>Nessuna trasferta</p></div>';
}

async function saveTrasferta(){
  try{
    const data={TecnicoID:USER?.ID,ClienteID:$('stCliente').value,AutomezzoID:$('stAutomezzo').value,DataInizio:$('stDal').value,DataFine:$('stAl').value,Motivo:$('stMotivo').value};
    if(!data.DataInizio){toast('Inserisci data inizio','warn');return}
    await apiCall('createTrasferta',{data},'POST');
    toast('Trasferta inviata!','ok');closeSheet('shTrasferta');
    $('stDal').value='';$('stAl').value='';$('stMotivo').value='';
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ INSTALLAZIONI ============
function renderInst(){
  const items=(DATA.installazioni||[]).filter(i=>!i.Obsoleto).sort((a,b)=>(b.DataInizio||'').localeCompare(a.DataInizio||''));
  const el=$('instList');if(!el)return;
  el.innerHTML=items.length?items.map(i=>{
    const cli=getName(DATA.clienti,i.ClienteID);
    const mac=getName(DATA.macchine,i.MacchinaID);
    const avz=i.Avanzamento||0;
    return '<div class="card" style="cursor:pointer" onclick="showInstDetail(\''+i.ID+'\')"><div class="card-body">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+cli+'</strong>'+statusTag(i.Stato)+'</div>'+
      '<div style="font-size:.8125rem;color:var(--gray)">'+mac+'</div>'+
      '<div style="display:flex;align-items:center;gap:8px;margin-top:6px"><div style="flex:1;height:6px;background:var(--gray4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+avz+'%;background:var(--ok);border-radius:3px"></div></div><span style="font-size:.7rem;font-weight:600;color:var(--gray)">'+avz+'%</span></div>'+
      '<div style="font-size:.75rem;color:var(--gray);margin-top:4px">ğŸ“… '+fmtDate(i.DataInizio)+(i.DataFine?' â†’ '+fmtDate(i.DataFine):'')+' <span style="color:var(--gray3)">â€º</span></div>'+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ”§</div><p>Nessuna installazione</p></div>';
}

// ============ CLIENTI ============
function renderCliMob(){
  const q=($('srcCliMob')?.value||'').toLowerCase();
  const items=(DATA.clienti||[]).filter(c=>!c.Obsoleto&&(!q||(c.NomeInterno||c.NomeAccount||c.Nome||'').toLowerCase().includes(q)||(c.Citta||'').toLowerCase().includes(q)));
  $('cliMobList').innerHTML=items.length?items.map(c=>'<div class="card" onclick="showCliDetail(\''+c.ID+'\')"><div class="card-body" style="padding:12px 16px"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+getName(DATA.clienti,c.ID)+'</strong><div style="font-size:.8125rem;color:var(--gray)">'+(c.Citta||'')+(c.Prov?' ('+c.Prov+')':'')+'</div></div><span style="color:var(--gray3)">â€º</span></div></div></div>').join(''):'<div class="empty"><div class="ico">ğŸ¢</div><p>Nessun cliente</p></div>';
}

function showCliDetail(id){
  const c=(DATA.clienti||[]).find(x=>x.ID===id||x.CodiceM3===id);if(!c)return;
  const interventi=(DATA.piano||[]).filter(p=>!p.Obsoleto&&p.ClienteID===id).sort((a,b)=>(b.Data||'').localeCompare(a.Data||'')).slice(0,5);
  $('suTitle').textContent='ğŸ¢ '+getName(DATA.clienti,c.ID);
  $('suBody').innerHTML=
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem;margin-bottom:16px">'+
    '<div><span style="color:var(--gray)">CittÃ </span><br><strong>'+(c.Citta||'â€”')+(c.Prov?' ('+c.Prov+')':'')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Telefono</span><br><strong>'+(c.Telefono||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Email</span><br><strong>'+(c.Email||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Contratto</span><br><strong>'+(c.Contratto||'â€”')+'</strong></div>'+
    '</div>'+
    (c.Note?'<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+c.Note+'</div></div>':'')+
    '<div style="font-weight:600;font-size:.8125rem;margin-bottom:8px">Ultimi interventi</div>'+
    (interventi.length?interventi.map(p=>'<div style="padding:8px 12px;border-left:3px solid '+getColor(DATA.tipiIntervento,p.TipoInterventoID)+';margin-bottom:6px;background:var(--gray5);border-radius:0 var(--radius-sm) var(--radius-sm) 0;font-size:.8125rem"><strong>'+fmtDate(p.Data)+'</strong> '+getName(DATA.tipiIntervento,p.TipoInterventoID)+' '+statusTag(p.Stato)+'</div>').join(''):'<div style="font-size:.8125rem;color:var(--gray)">Nessun intervento</div>')+
    '<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">'+
    (c.Telefono?'<a href="tel:'+c.Telefono+'" class="btn btn-outline">ğŸ“ Chiama</a>':'')+
    (c.Latitudine&&c.Longitudine?'<a href="https://www.google.com/maps/dir/?api=1&destination='+c.Latitudine+','+c.Longitudine+'&travelmode=driving" target="_blank" class="btn btn-outline">ğŸ“ Naviga</a>':'')+
    '<button class="btn btn-outline" onclick="closeSheet(\'shUrg\')">Chiudi</button></div>';
  openSheet('shUrg');
}

// ============ MACCHINE ============
function renderMacMob(){
  const q=($('srcMacMob')?.value||'').toLowerCase();
  const items=(DATA.macchine||[]).filter(m=>!m.Obsoleto&&(!q||(m.Tipo||'').toLowerCase().includes(q)||(m.Modello||'').toLowerCase().includes(q)||(m.Seriale||'').toLowerCase().includes(q)||getName(DATA.clienti,m.ClienteID).toLowerCase().includes(q)));
  $('macMobList').innerHTML=items.length?items.map(m=>{
    const gar=m.GaranziaFino&&m.GaranziaFino>=today();
    return '<div class="card" onclick="showMacDetail(\''+m.ID+'\')"><div class="card-body" style="padding:12px 16px"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+(m.Tipo||'â€”')+' '+(m.Modello||'')+'</strong><div style="font-size:.8125rem;color:var(--gray)">S/N: '+(m.Seriale||'â€”')+' Â· '+getName(DATA.clienti,m.ClienteID)+'</div></div>'+(gar?'<span class="tag tag-ok">âœ… Garanzia</span>':'')+'</div></div></div>';
  }).join(''):'<div class="empty"><div class="ico">âš™ï¸</div><p>Nessuna macchina</p></div>';
}

function showMacDetail(id){
  const m=(DATA.macchine||[]).find(x=>x.ID===id);if(!m)return;
  const cli=(DATA.clienti||[]).find(c=>c.ID===m.ClienteID||c.CodiceM3===m.ClienteID);
  const allIntMac=(DATA.piano||[]).filter(p=>!p.Obsoleto&&p.MacchinaID===id);
  const interventi=allIntMac.sort((a,b)=>(b.Data||'').localeCompare(a.Data||'')).slice(0,5);
  const totInt=allIntMac.length;
  const compInt=allIntMac.filter(p=>p.Stato==='completato').length;
  // Garanzia
  const garFino=m.GaranziaFino||'';
  const isInGar=garFino&&garFino>=today();
  const garDays=garFino?Math.ceil((new Date(garFino)-new Date())/86400000):0;
  const garTag=isInGar?(garDays<=30?'<span class="tag" style="background:#FEF3C7;color:#D97706">âš ï¸ Scade tra '+garDays+'gg</span>':'<span class="tag tag-ok">âœ… In garanzia</span>'):(garFino?'<span class="tag" style="background:#FEE2E2;color:#DC2626">âŒ Scaduta</span>':'<span class="tag" style="background:var(--gray3);color:var(--gray)">â€”</span>');
  // Prossimo intervento
  const prossimoInt=allIntMac.filter(p=>p.Data>=today()&&p.Stato==='pianificato').sort((a,b)=>(a.Data||'').localeCompare(b.Data||''))[0];
  // Urgenze attive su questa macchina
  const urgMac=(DATA.urgenze||[]).filter(u=>u.MacchinaID===id&&u.Stato!=='risolta'&&u.Stato!=='chiusa');

  $('suTitle').textContent='âš™ï¸ '+(m.Tipo||'')+' '+(m.Modello||'');
  $('suBody').innerHTML=
    '<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">'+garTag+
    '<span class="tag" style="background:var(--c1)10;color:var(--c1)">ğŸ”§ '+totInt+' interventi ('+compInt+' completati)</span>'+
    (urgMac.length?'<span class="tag" style="background:#FEE2E2;color:#DC2626">ğŸš¨ '+urgMac.length+' urgenz'+(urgMac.length>1?'e':'a')+' attiv'+(urgMac.length>1?'e':'a')+'</span>':'')+
    '</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem;margin-bottom:16px">'+
    '<div><span style="color:var(--gray)">Tipo</span><br><strong>'+(m.Tipo||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Modello</span><br><strong>'+(m.Modello||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Seriale</span><br><strong>'+(m.Seriale||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Anno</span><br><strong>'+(m.AnnoInstallazione||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Cliente</span><br><strong>'+(cli?getName(DATA.clienti,cli.ID):'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Garanzia fino</span><br><strong>'+(garFino?fmtDate(garFino):'â€”')+'</strong></div>'+
    '</div>'+
    (m.Note?'<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+m.Note+'</div></div>':'')+
    (prossimoInt?'<div style="margin-bottom:16px;padding:10px 14px;background:#EFF6FF;border-radius:10px;font-size:.8125rem"><strong>â¡ï¸ Prossimo:</strong> '+fmtDate(prossimoInt.Data)+' '+fmtTime(prossimoInt.OraInizio)+' Â· '+getName(DATA.tipiIntervento,prossimoInt.TipoInterventoID)+'</div>':'')+
    '<div style="font-weight:600;font-size:.8125rem;margin-bottom:8px">Ultimi interventi</div>'+
    (interventi.length?interventi.map(p=>'<div style="padding:8px 12px;border-left:3px solid '+getColor(DATA.tipiIntervento,p.TipoInterventoID)+';margin-bottom:6px;background:var(--gray5);border-radius:0 var(--radius-sm) var(--radius-sm) 0;font-size:.8125rem"><strong>'+fmtDate(p.Data)+'</strong> '+getName(DATA.tipiIntervento,p.TipoInterventoID)+' '+statusTag(p.Stato)+'</div>').join(''):'<div style="font-size:.8125rem;color:var(--gray)">Nessun intervento</div>')+
    '<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">'+
    (cli?.Telefono?'<a href="tel:'+cli.Telefono+'" class="btn btn-outline">ğŸ“ Chiama cliente</a>':'')+
    '<button class="btn" style="background:var(--err);color:#fff" onclick="closeSheet(\'shUrg\');creaUrgMacchina(\''+id+'\',\''+(cli?.ID||'')+'\')">ğŸš¨ Segnala urgenza</button>'+
    '<button class="btn btn-outline" onclick="closeSheet(\'shUrg\')">Chiudi</button></div>';
  openSheet('shUrg');
}

function creaUrgMacchina(macId,cliId){
  const prob=prompt('Descrivi il problema:');
  if(!prob)return;
  apiCall('createUrgenza',{MacchinaID:macId,ClienteID:cliId,Problema:prob,PrioritaID:2,Stato:'aperta',operatoreId:USER?.ID},'POST')
    .then(()=>{toast('Urgenza creata!','ok');refreshData()})
    .catch(e=>toast(e.message,'err'));
}

// ============ DOCUMENTI ============
function renderDocMob(){
  const docs=(DATA.documenti||[]).filter(d=>!d.Obsoleto&&(d.Pubblico===true||d.Pubblico==='true'));
  const q=($('srcDocMob')?.value||'').toLowerCase();
  const filtered=docs.filter(d=>!q||(d.Nome||'').toLowerCase().includes(q)||(d.Tags||'').toLowerCase().includes(q)).sort((a,b)=>(b.DataCaricamento||'').localeCompare(a.DataCaricamento||''));
  $('docMobList').innerHTML=filtered.length?filtered.map(d=>'<div class="card"><div class="card-body"><div style="display:flex;justify-content:space-between;align-items:center"><div style="flex:1"><strong>'+(d.Nome||'â€”')+'</strong><div style="font-size:.75rem;color:var(--gray)">ğŸ“… '+fmtDate(d.DataCaricamento)+(d.DimensioneKB?' Â· '+d.DimensioneKB+'KB':'')+'</div></div><a href="'+(d.FileURL||'#')+'" target="_blank" style="color:var(--c1);text-decoration:none;font-size:1.25rem;padding:8px">â†“</a></div></div></div>').join(''):'<div class="empty"><div class="ico">ğŸ“</div><p>Nessun documento</p></div>';
}

// ============ MAPPA GIRO VISITE (Leaflet) ============
let mapFilterMode='today', mapMarkers=[], mapRouteLine=null, mapRouteStops=[];

function initMap(){
  if(mapTec){mapTec.invalidateSize();renderMapMarkers();return}
  const el=$('mapTec');if(!el)return;
  mapTec=L.map('mapTec').setView([44.65,10.92],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(mapTec);
  renderMapMarkers();
}

function mapFilter(mode){
  mapFilterMode=mode;
  ['mapFAll','mapFToday','mapFWeek'].forEach(id=>{const b=$(id);if(b)b.className=b.className.replace('btn-primary','btn-outline')});
  const btn=$('mapF'+mode.charAt(0).toUpperCase()+mode.slice(1));
  if(btn)btn.className=btn.className.replace('btn-outline','btn-primary');
  renderMapMarkers();
}

function renderMapMarkers(){
  if(!mapTec)return;
  // Pulisci
  mapMarkers.forEach(m=>mapTec.removeLayer(m));mapMarkers=[];
  if(mapRouteLine){mapTec.removeLayer(mapRouteLine);mapRouteLine=null}
  mapRouteStops=[];

  const todayStr=today();
  const miei=my(DATA.piano);
  let pianoFiltered=[];

  if(mapFilterMode==='today'){
    pianoFiltered=miei.filter(p=>p.Data===todayStr);
  }else if(mapFilterMode==='week'){
    const d=new Date();const weekStart=new Date(d);weekStart.setDate(d.getDate()-d.getDay()+1);
    const ws=weekStart.toISOString().split('T')[0];
    const we=new Date(weekStart);we.setDate(we.getDate()+6);const wes=we.toISOString().split('T')[0];
    pianoFiltered=miei.filter(p=>p.Data>=ws&&p.Data<=wes);
  }else{
    pianoFiltered=miei;
  }

  // Ordina per ora
  pianoFiltered.sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||''));

  // Raccogli coordinate con info
  const stops=[];
  pianoFiltered.forEach((p,idx)=>{
    const c=(DATA.clienti||[]).find(c=>c.ID===p.ClienteID||c.CodiceM3===p.ClienteID);
    if(c&&c.Latitudine&&c.Longitudine){
      stops.push({lat:c.Latitudine,lng:c.Longitudine,name:getName(DATA.clienti,c.ID),piano:p,num:stops.length+1,cliente:c});
    }
  });

  // Anche clienti senza interventi filtrati (solo in "tutti")
  if(mapFilterMode==='all'){
    const clientiConInt=new Set(stops.map(s=>s.cliente.ID));
    const altriClienti=(DATA.clienti||[]).filter(c=>!c.Obsoleto&&c.Latitudine&&c.Longitudine&&!clientiConInt.has(c.ID));
    altriClienti.forEach(c=>{
      const m=L.circleMarker([c.Latitudine,c.Longitudine],{radius:4,fillColor:'#9CA3AF',color:'#9CA3AF',weight:1,fillOpacity:.5}).addTo(mapTec);
      m.bindPopup('<strong>'+getName(DATA.clienti,c.ID)+'</strong><br><span style="color:var(--gray)">'+(c.Citta||'')+'</span>');
      mapMarkers.push(m);
    });
  }

  // Markers numerati per le tappe
  stops.forEach(s=>{
    const icon=L.divIcon({
      className:'',
      html:'<div class="route-num">'+s.num+'</div>',
      iconSize:[24,24],iconAnchor:[12,12]
    });
    const m=L.marker([s.lat,s.lng],{icon}).addTo(mapTec);
    const p=s.piano;
    m.bindPopup(
      '<div style="min-width:160px"><strong>'+s.num+'. '+s.name+'</strong><br>'+
      '<span style="font-size:.8rem">ğŸ• '+(p.OraInizio||'â€”')+' Â· '+getName(DATA.tipiIntervento,p.TipoInterventoID)+'</span><br>'+
      statusTag(p.Stato)+
      '<br><a href="https://www.google.com/maps/dir/?api=1&destination='+s.lat+','+s.lng+'&travelmode=driving" target="_blank" style="color:#C30A14;font-size:.8rem;font-weight:600">ğŸ“ Naviga qui</a></div>'
    );
    mapMarkers.push(m);
  });

  // Polyline route
  if(stops.length>=2){
    const coords=stops.map(s=>[s.lat,s.lng]);
    mapRouteLine=L.polyline(coords,{color:'#C30A14',weight:3,opacity:.7,dashArray:'8,8'}).addTo(mapTec);
    mapMarkers.push(mapRouteLine);
  }

  mapRouteStops=stops;

  // Info
  $('mapInfo').textContent=stops.length+' tappe'+(mapFilterMode==='today'?' oggi':mapFilterMode==='week'?' settimana':'');

  // Fit bounds
  const allPts=stops.map(s=>[s.lat,s.lng]);
  if(allPts.length){mapTec.fitBounds(allPts,{padding:[30,30]})}
  else if(mapFilterMode!=='all'){
    // Nessuna tappa, mostra tutti i clienti
    const allCli=(DATA.clienti||[]).filter(c=>!c.Obsoleto&&c.Latitudine&&c.Longitudine);
    if(allCli.length){mapTec.fitBounds(allCli.map(c=>[c.Latitudine,c.Longitudine]),{padding:[20,20]})}
  }
}

function exportGoogleMaps(){
  if(!mapRouteStops.length){toast('Nessuna tappa da esportare','warn');return}
  // Google Maps directions URL (max ~10 waypoints)
  const stops=mapRouteStops.slice(0,10);
  const dest=stops[stops.length-1];
  const waypoints=stops.slice(0,-1).map(s=>s.lat+','+s.lng).join('|');
  let url='https://www.google.com/maps/dir/?api=1&destination='+dest.lat+','+dest.lng+'&travelmode=driving';
  if(waypoints)url+='&waypoints='+encodeURIComponent(waypoints);
  window.open(url,'_blank');
}

// ============ CALENDARIO ============
let calMobDate=new Date();
function renderCalMobile(){
  const y=calMobDate.getFullYear(),m=calMobDate.getMonth();
  $('calMobTitle').textContent=new Date(y,m).toLocaleDateString('it-IT',{month:'long',year:'numeric'});
  const piano=my(DATA.piano).filter(p=>p.Data);
  const todayStr=today();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  const startDay=(first.getDay()+6)%7;
  const days=['L','M','M','G','V','S','D'];
  let html=days.map(d=>'<div style="font-weight:600;color:var(--gray);padding:4px;font-size:.625rem;text-transform:uppercase;text-align:center">'+d+'</div>').join('');
  const prevLast=new Date(y,m,0).getDate();
  for(let i=startDay-1;i>=0;i--)html+='<div style="padding:8px 4px;color:var(--gray3);text-align:center;font-size:.75rem">'+(prevLast-i)+'</div>';
  for(let d=1;d<=last.getDate();d++){
    const ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const dayItems=piano.filter(p=>p.Data===ds);
    const isToday=ds===todayStr;
    const bg=isToday?'background:var(--c1);color:var(--white);font-weight:700':'';
    html+='<div style="padding:6px 4px;border-radius:var(--radius-sm);cursor:pointer;text-align:center;font-size:.75rem;'+bg+'" onclick="showCalMobDay(\''+ds+'\')">'+d+(dayItems.length>0?'<span class="cal-dot"></span>':'')+'</div>';
  }
  const rem=7-((startDay+last.getDate())%7);
  if(rem<7)for(let i=1;i<=rem;i++)html+='<div style="padding:8px 4px;color:var(--gray3);text-align:center;font-size:.75rem">'+i+'</div>';
  $('calMobGrid').innerHTML=html;
  $('calMobDetail').innerHTML='';
}

function calMobileNav(dir){calMobDate.setMonth(calMobDate.getMonth()+dir);renderCalMobile()}

function showCalMobDay(ds){
  const items=my(DATA.piano).filter(p=>p.Data===ds).sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||''));
  const urgs=my(DATA.urgenze).filter(u=>(u.DataPrevista||'').split('T')[0]===ds);
  const label=new Date(ds+'T00:00:00').toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long'});
  if(!items.length&&!urgs.length){$('calMobDetail').innerHTML='<div class="card"><div class="card-body" style="text-align:center;color:var(--gray);padding:20px">Nessun impegno per '+label+'</div></div>';return}
  let h='<div style="font-weight:600;font-size:.8125rem;margin-bottom:8px;padding:0 4px">'+label+' â€” '+items.length+' interventi'+(urgs.length?', '+urgs.length+' urgenze':'')+'</div>';
  h+=items.map(p=>{
    const tc=getColor(DATA.tipiIntervento,p.TipoInterventoID);
    return '<div class="card" onclick="showInt(\''+p.ID+'\')" style="border-left:3px solid '+tc+'"><div class="card-body" style="padding:10px 14px"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><strong>'+(p.OraInizio||'â€”')+'</strong>'+statusTag(p.Stato)+'</div><div style="font-size:.8125rem">'+getName(DATA.clienti,p.ClienteID)+'</div><div style="font-size:.75rem;color:var(--gray)">'+getName(DATA.tipiIntervento,p.TipoInterventoID)+'</div></div></div>';
  }).join('');
  if(urgs.length){
    h+=urgs.map(u=>'<div class="card" style="border-left:3px solid var(--err)" onclick="showUrg(\''+u.ID+'\')"><div class="card-body" style="padding:10px 14px"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><strong>ğŸš¨ Urgenza</strong>'+statusTag(u.Stato)+'</div><div style="font-size:.8125rem">'+getName(DATA.clienti,u.ClienteID)+'</div></div></div>').join('');
  }
  $('calMobDetail').innerHTML=h;
}

// ============ CHAT TELEGRAM ============
let chatCanale='CH_GENERALE', chatMsgCache=[], chatPollTimer=null;

function initChat(){
  loadChatUnread();
  renderChatChannels();
  loadChatMessages();
  // Polling ogni 5 sec
  if(chatPollTimer)clearInterval(chatPollTimer);
  chatPollTimer=setInterval(()=>{
    const pg=$('pgChat');
    if(pg&&pg.classList.contains('active')){loadChatMessages(true);loadChatUnread()}
  },5000);
}

let chatUnread={};
function renderChatChannels(){
  const canali=[
    {id:'CH_GENERALE',nome:'ğŸ’¬ Generale'},
    {id:'CH_URGENZE',nome:'ğŸš¨ Urgenze'},
    {id:'CH_ADMIN',nome:'ğŸ‘‘ Admin & Capi'}
  ];
  $('chatChannels').innerHTML=canali.map(c=>{
    const nr=chatUnread[c.id]||0;
    return '<button class="chat-ch-btn'+(c.id===chatCanale?' active':'')+'" onclick="switchChatCh(\''+c.id+'\')">'+c.nome+(nr>0&&c.id!==chatCanale?' <span style="background:var(--err);color:#fff;border-radius:50%;font-size:.65rem;padding:1px 6px;margin-left:4px;min-width:16px;text-align:center;display:inline-block">'+nr+'</span>':'')+'</button>';
  }).join('');
}
async function loadChatUnread(){
  try{
    const res=await apiCall('getChatCanali',{userId:USER?.ID},'POST');
    const srv=(res?.canali||res||[]);
    srv.forEach(c=>{const id=c.ID||c.Id;if(id)chatUnread[id]=c.NonLetti||c.nonLetti||0});
    renderChatChannels();
    // Badge globale nella nav
    const totalUnread=Object.values(chatUnread).reduce((a,b)=>a+b,0);
    const badge=$('chatBadge');
    if(badge){
      if(totalUnread>0){badge.textContent=totalUnread>99?'99+':totalUnread;badge.style.display=''}
      else{badge.style.display='none'}
    }
  }catch(e){}
}

function switchChatCh(id){
  chatCanale=id;
  chatUnread[id]=0; // Reset badge subito per UX
  renderChatChannels();
  loadChatMessages();
}

async function loadChatMessages(silent){
  try{
    const msgs=await apiCall('getChatMessaggi',{canale_id:chatCanale,limit:'50'},'POST');
    chatMsgCache=Array.isArray(msgs)?msgs:(msgs?.messaggi||[]);
    renderChatMsgs();
  }catch(e){if(!silent)toast('Errore chat: '+e.message,'err')}
}

function renderChatMsgs(){
  const el=$('chatMsgs');if(!el)return;
  if(!chatMsgCache||!chatMsgCache.length){el.innerHTML='<div class="empty"><div class="ico">ğŸ’¬</div><p>Nessun messaggio</p></div>';return}
  const sorted=[...chatMsgCache].sort((a,b)=>(a.CreatedAt||'').localeCompare(b.CreatedAt||''));
  el.innerHTML=sorted.map(m=>{
    const isMine=m.MittenteID===USER?.ID;
    const isTg=m.MittenteID==='TELEGRAM'||(m.Testo||'').startsWith('ğŸ“±');
    const sender=isMine?'':(getName(DATA.utenti||[],m.MittenteID)||(m.MittenteID==='TELEGRAM'?'Telegram':'?'));
    const time=(m.CreatedAt||'').substring(11,16);
    const edited=m.Modificato?' <span style="font-size:.65rem;opacity:.6">(modificato)</span>':'';
    let msgHtml=(m.Testo||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    msgHtml=msgHtml.replace(/(https?:\/\/[^\s]+)/g,function(url){
      if(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(url))return '<a href="'+url+'" target="_blank"><img src="'+url+'" style="max-width:200px;max-height:150px;border-radius:8px;margin:4px 0;display:block" onerror="this.outerHTML=\'<a href=\\\'\'+this.src+\'\\\' target=_blank>ğŸ“ File</a>\'"></a>';
      return '<a href="'+url+'" target="_blank" style="color:inherit;text-decoration:underline">ğŸ”— Link</a>';
    });
    msgHtml=msgHtml.replace(/\n/g,'<br>');
    // Azioni messaggio (solo per messaggi propri)
    const actions=isMine?'<div class="chat-actions" style="display:none;position:absolute;top:-28px;right:4px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);padding:2px;font-size:.75rem;z-index:10"><button onclick="editChatMsg(\''+m.ID+'\',\''+encodeURIComponent(m.Testo||'')+'\')" style="background:none;border:none;cursor:pointer;padding:4px 8px" title="Modifica">âœï¸</button><button onclick="deleteChatMsg(\''+m.ID+'\')" style="background:none;border:none;cursor:pointer;padding:4px 8px" title="Elimina">ğŸ—‘ï¸</button></div>':'';
    return '<div class="chat-msg'+(isMine?' mine':' other')+(isTg?' tg':'')+'" style="position:relative" '+(isMine?'onclick="toggleChatActions(this)"':'')+'>'+
      actions+
      (!isMine&&sender?'<div class="sender">'+(isTg?'ğŸ“± ':'')+sender+'</div>':'')+
      '<div>'+msgHtml+'</div>'+
      '<div class="meta">'+time+edited+'</div></div>';
  }).join('');
  el.scrollTop=el.scrollHeight;
}

function toggleChatActions(el){
  // Chiudi tutti gli altri
  document.querySelectorAll('.chat-actions').forEach(a=>a.style.display='none');
  const a=el.querySelector('.chat-actions');
  if(a)a.style.display=a.style.display==='none'?'flex':'none';
}

async function editChatMsg(id,encodedText){
  const oldText=decodeURIComponent(encodedText);
  const newText=prompt('Modifica messaggio:',oldText);
  if(!newText||newText===oldText)return;
  try{
    await apiCall('editChatMessage',{id,testo:newText},'POST');
    toast('Messaggio modificato','ok');
    loadChatMessages();
  }catch(e){toast(e.message,'err')}
}

async function deleteChatMsg(id){
  if(!confirm('Eliminare questo messaggio?'))return;
  try{
    await apiCall('deleteChatMessage',{id},'POST');
    toast('Messaggio eliminato','ok');
    loadChatMessages();
  }catch(e){toast(e.message,'err')}
}

let chatAllegatoFile=null;

function showChatCmds(){$('chatCmdBar').style.display='block'}
function insertCmd(cmd){$('chatInput').value=cmd;$('chatInput').focus()}

function chatAllegatoChange(input){
  const file=input.files[0];if(!file)return;
  if(file.size>20*1024*1024){toast('File troppo grande (max 20MB)','err');input.value='';return}
  const reader=new FileReader();
  reader.onload=function(){
    chatAllegatoFile={base64:reader.result.split(',')[1],type:file.type,name:file.name,sizeKB:Math.round(file.size/1024)};
    $('chatAllegatoPreview').style.display='block';
    $('chatAllegatoPreview').innerHTML='<div style="display:flex;align-items:center;gap:8px;font-size:.8rem"><span>'+(file.type.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„')+'</span><span style="flex:1">'+file.name+' ('+chatAllegatoFile.sizeKB+'KB)</span><button onclick="removeChatAllegato()" style="background:none;border:none;color:var(--err);cursor:pointer;font-size:.9rem">âœ•</button></div>';
    input.value='';
  };
  reader.readAsDataURL(file);
}

function removeChatAllegato(){chatAllegatoFile=null;$('chatAllegatoPreview').style.display='none';$('chatAllegatoPreview').innerHTML=''}

async function sendChatMsg(){
  const inp=$('chatInput');
  const txt=(inp.value||'').trim();
  if(!txt&&!chatAllegatoFile)return;
  inp.value='';
  try{
    // Upload allegato prima, se presente
    let allegatoUrl=null,allegatoName='';
    if(chatAllegatoFile){
      allegatoName=chatAllegatoFile.name;
      try{
        const up=await apiCall('uploadFile',{base64Data:chatAllegatoFile.base64,mimeType:chatAllegatoFile.type,fileName:chatAllegatoFile.name,uploaderId:USER?.ID,riferimentoTipo:'chat',riferimentoId:chatCanale},'POST');
        allegatoUrl=up.url;
      }catch(e){toast('Errore upload: '+e.message,'err')}
      removeChatAllegato();
    }
    // Componi messaggio con link allegato
    let finalTxt=txt||'';
    if(allegatoUrl){
      finalTxt=(finalTxt?finalTxt+'\n':'')+'ğŸ“ Allegato: '+allegatoName+'\n'+allegatoUrl;
    }
    if(!finalTxt)return;
    await apiCall('sendChatMessage',{canale_id:chatCanale,testo:finalTxt,userId:USER?.ID},'POST');
    chatMsgCache.push({MittenteID:USER?.ID,Testo:finalTxt,CreatedAt:new Date().toISOString()});
    renderChatMsgs();
    setTimeout(()=>loadChatMessages(true),1000);
  }catch(e){toast('Errore invio: '+e.message,'err')}
}

// ============ CREA URGENZA (tecnico) ============
let urgAllegatoFile=null;

function openCreaUrg(){
  // Popola selects â€” value=ID per match con macchine.ClienteID
  const cls=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
  const s=$('suCliUrg');
  s.innerHTML='<option value="">â€” Seleziona â€”</option>';
  cls.forEach(c=>{const o=document.createElement('option');o.value=c.ID;o.dataset.codm3=c.CodiceM3||'';o.textContent=getName(DATA.clienti,c.ID);s.appendChild(o)});
  // Macchine (si aggiornano on change cliente)
  $('suMacUrg').innerHTML='<option value="">â€” Tutte â€”</option>';
  s.onchange=function(){
    const cid=this.value;
    const codM3=this.selectedOptions[0]?.dataset?.codm3||'';
    // Match per ID oppure CodiceM3
    const macs=(DATA.macchine||[]).filter(m=>!m.Obsoleto&&(m.ClienteID===cid||m.ClienteID===codM3));
    const ms=$('suMacUrg');ms.innerHTML='<option value="">â€” Seleziona â€”</option>';
    macs.forEach(m=>{const o=document.createElement('option');o.value=m.ID;o.textContent=(m.Tipo||'')+' '+(m.Modello||'')+' (S/N: '+(m.Seriale||'â€”')+')';ms.appendChild(o)});
  };
  // PrioritÃ 
  const ps=$('suPriUrg');
  ps.innerHTML='';
  (DATA.priorita||[]).forEach(p=>{const o=document.createElement('option');o.value=p.ID;o.textContent=p.Nome||p.ID;ps.appendChild(o)});
  // Reset
  $('suProbUrg').value='';$('suNoteUrg').value='';urgAllegatoFile=null;$('urgAllegatoPreview').innerHTML='';
  openSheet('shCreaUrg');
}

function urgAllegatoChange(input){
  const file=input.files[0];if(!file)return;
  if(file.size>20*1024*1024){toast('File troppo grande (max 20MB)','err');input.value='';return}
  const reader=new FileReader();
  reader.onload=function(){
    urgAllegatoFile={base64:reader.result.split(',')[1],type:file.type,name:file.name,sizeKB:Math.round(file.size/1024)};
    $('urgAllegatoPreview').innerHTML='<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--gray5);border-radius:8px"><span>'+(file.type.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„')+'</span><span style="flex:1;font-size:.8rem">'+file.name+' ('+urgAllegatoFile.sizeKB+'KB)</span><button onclick="urgAllegatoFile=null;this.parentElement.remove()" style="background:none;border:none;color:var(--err);cursor:pointer">âœ•</button></div>';
    input.value='';
  };
  reader.readAsDataURL(file);
}

async function saveUrgenzaTecnico(){
  try{
    const clienteID=$('suCliUrg').value;
    const problema=$('suProbUrg').value.trim();
    if(!clienteID){toast('Seleziona un cliente','warn');return}
    if(!problema){toast('Descrivi il problema','warn');return}

    const priId=$('suPriUrg').value;
    const priObj=(DATA.priorita||[]).find(p=>p.ID===priId);
    const priLivello=priObj?.Livello||1;
    const priNome=priObj?.Nome||'Urgente';

    // Calcola data scheduling in base alla prioritÃ  (stessa logica interventi)
    let dataInt;
    const d=new Date();
    if(priLivello<=2){ dataInt=today(); }
    else if(priLivello===3){ d.setDate(d.getDate()+1); dataInt=d.toISOString().slice(0,10); }
    else if(priLivello===4){ d.setDate(d.getDate()+2); dataInt=d.toISOString().slice(0,10); }
    else{ d.setDate(d.getDate()+3); dataInt=d.toISOString().slice(0,10); }

    // Automezzo dall'ultimo intervento del tecnico
    let autoId=null;
    const mieiInt=(DATA.piano||[]).filter(p=>p.TecnicoID===USER?.ID&&p.AutomezzoID).sort((a,b)=>(b.Data||'').localeCompare(a.Data||''));
    if(mieiInt.length) autoId=mieiInt[0].AutomezzoID;

    // 1. Crea urgenza
    const data={
      ClienteID:clienteID,
      MacchinaID:$('suMacUrg').value||null,
      PrioritaID:priId,
      Problema:problema,
      Note:$('suNoteUrg').value||null,
      Stato:'aperta',
      TecnicoID:USER?.ID,
      SegnalatoDa:USER?.ID,
      DataSegnalazione:new Date().toISOString()
    };
    const urgResult=await apiCall('createUrgenza',{data},'POST');

    // 2. Crea anche intervento nel piano (scheduling automatico)
    const oraInt=priLivello<=2?new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit',hour12:false}):'08:00';
    const durataUrg=priLivello<=2?4:2;
    try{
      await apiCall('createPiano',{data:{
        TecnicoID:USER?.ID,
        ClienteID:clienteID,
        MacchinaID:$('suMacUrg').value||null,
        PrioritaID:priId,
        AutomezzoID:autoId,
        Data:dataInt,
        OraInizio:oraInt,
        OraFine:calcOraFine(oraInt,durataUrg),
        DurataOre:durataUrg,
        Note:'[URGENZA - DA CONFERMARE]\nğŸš¨ PrioritÃ : '+priNome+'\n'+problema,
        Stato:'pianificato'
      }},'POST');
    }catch(e){console.warn('Piano da urgenza non creato:',e)}

    // 3. Upload allegato se presente
    if(urgAllegatoFile){
      try{
        await apiCall('uploadFile',{base64Data:urgAllegatoFile.base64,mimeType:urgAllegatoFile.type,fileName:urgAllegatoFile.name,uploaderId:USER?.ID,riferimentoTipo:'urgenza',riferimentoId:urgResult?.id||''},'POST');
      }catch(e){}
    }

    // 4. Notifiche
    const tecNome=((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim();
    const cliNome=getName(DATA.clienti,clienteID);
    const priIcon=priObj?.Icona||'ğŸš¨';
    const msgTesto=priIcon+' URGENZA ('+priNome+')\nğŸ‘¤ Da: '+tecNome+'\nğŸ¢ Cliente: '+cliNome+'\nğŸ“… Schedulata: '+fmtDate(dataInt)+' '+oraInt+'\nğŸ“ '+problema+'\n\nâ³ In attesa approvazione';

    // Chat CH_URGENZE + CH_ADMIN
    try{await apiCall('sendChatMessage',{canale_id:'CH_URGENZE',testo:msgTesto,userId:USER?.ID},'POST')}catch(e){}
    try{await apiCall('sendChatMessage',{canale_id:'CH_ADMIN',testo:msgTesto,userId:USER?.ID},'POST')}catch(e){}

    // Notifica push a caposquadra + admin
    const capoSq=(DATA.utenti||[]).filter(u=>u.Ruolo==='caposquadra'&&u.Attivo);
    const admins=(DATA.utenti||[]).filter(u=>u.Ruolo==='admin'&&u.Attivo);
    for(const cs of capoSq){
      try{await apiCall('createNotifica',{data:{Tipo:'urgenza',Oggetto:priIcon+' Urgenza â€” '+priNome,Testo:tecNome+' segnala urgenza per '+cliNome+': '+problema,DestinatarioID:cs.ID,Priorita:'alta'}},'POST')}catch(e){}
    }
    for(const adm of admins){
      try{await apiCall('createNotifica',{data:{Tipo:'urgenza',Oggetto:'ğŸš¨ URGENZA â€” '+priNome,Testo:tecNome+' segnala urgenza per '+cliNome+': '+problema+'\nSchedulata: '+fmtDate(dataInt)+' '+oraInt,DestinatarioID:adm.ID,Priorita:'alta'}},'POST')}catch(e){}
    }

    toast('Urgenza inviata + schedulata il '+fmtDate(dataInt)+'! In attesa approvazione.','ok');
    closeSheet('shCreaUrg');
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ MODIFICA INTERVENTO ============
function openEditInt(id){
  const p=(DATA.piano||[]).find(x=>x.ID===id);if(!p)return;
  closeSheet('shInt');
  $('eiId').value=id;
  $('eiNote').value=p.Note||'';
  $('eiStato').value=p.Stato==='completato'?'in_corso':p.Stato;
  $('eiData').value=p.Data||'';
  $('eiOra').value=p.OraInizio||'';
  // Mostra avviso se non Ã¨ il proprio intervento
  const isOwn=p.TecnicoID===USER?.ID||p.TecnicoAssegnato===USER?.ID||(p.TecniciIDs||'').includes(USER?.ID);
  $('eiOwnNotice').style.display=isOwn?'none':'block';
  openSheet('shEditInt');
}

async function saveEditInt(){
  try{
    const id=$('eiId').value;
    const p=(DATA.piano||[]).find(x=>x.ID===id);if(!p)return;
    const isOwn=p.TecnicoID===USER?.ID||p.TecnicoAssegnato===USER?.ID||(p.TecniciIDs||'').includes(USER?.ID);
    const data={Note:$('eiNote').value,Stato:$('eiStato').value,Data:$('eiData').value,OraInizio:$('eiOra').value};
    await apiCall('updatePiano',{id,data},'POST');
    // Se non Ã¨ il proprio intervento, notifica admin
    if(!isOwn){
      try{
        await apiCall('sendChatMessage',{canale_id:'CH_ADMIN',testo:'âœï¸ MODIFICA INTERVENTO (da '+((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim()+'):\nIntervento '+id+' di '+getName(DATA.clienti,p.ClienteID)+'\nâš ï¸ Richiede approvazione â€” l\'intervento non Ã¨ assegnato a questo tecnico',userId:USER?.ID},'POST');
      }catch(e){}
      toast('Modifica inviata â€” attendi approvazione admin','warn');
    }else{
      // Notifica admin della modifica
      try{
        await apiCall('createNotifica',{data:{Tipo:'modifica_intervento',Oggetto:'Intervento modificato dal tecnico',Testo:((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim()+' ha modificato l\'intervento '+id+' ('+getName(DATA.clienti,p.ClienteID)+')',DestinatarioID:'ADMIN',Priorita:'media'}},'POST');
      }catch(e){}
      toast('Intervento aggiornato!','ok');
    }
    closeSheet('shEditInt');
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ CREA INTERVENTO (tecnico â†’ approvazione) ============
let intAllegatoFile=null;

function openCreaInt(){
  // Popola clienti
  const cls=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
  const s=$('ciCliente');
  s.innerHTML='<option value="">â€” Seleziona â€”</option>';
  cls.forEach(c=>{const o=document.createElement('option');o.value=c.ID;o.dataset.codm3=c.CodiceM3||'';o.textContent=getName(DATA.clienti,c.ID);s.appendChild(o)});
  // Macchine (on change)
  $('ciMacchina').innerHTML='<option value="">â€” Opzionale â€”</option>';
  s.onchange=function(){
    const cid=this.value;
    const codM3=this.selectedOptions[0]?.dataset?.codm3||'';
    const macs=(DATA.macchine||[]).filter(m=>!m.Obsoleto&&(m.ClienteID===cid||m.ClienteID===codM3));
    const ms=$('ciMacchina');ms.innerHTML='<option value="">â€” Opzionale â€”</option>';
    macs.forEach(m=>{const o=document.createElement('option');o.value=m.ID;o.textContent=(m.Tipo||'')+' '+(m.Modello||'')+' (S/N: '+(m.Seriale||'â€”')+')';ms.appendChild(o)});
  };
  // Tipi intervento
  const ts=$('ciTipo');ts.innerHTML='';
  (DATA.tipiIntervento||[]).forEach(t=>{const o=document.createElement('option');o.value=t.ID;o.textContent=t.Nome||t.ID;ts.appendChild(o)});
  // PrioritÃ 
  const ps=$('ciPriorita');ps.innerHTML='';
  (DATA.priorita||[]).forEach(p=>{const o=document.createElement('option');o.value=p.ID;o.textContent=p.Nome||p.ID;ps.appendChild(o)});
  // Default data = domani
  const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
  $('ciData').value=tomorrow.toISOString().slice(0,10);
  $('ciOra').value='08:00';$('ciDurata').value='2';$('ciNote').value='';
  intAllegatoFile=null;$('intAllegatoPreview').innerHTML='';
  openSheet('shCreaInt');
}

function intAllegatoChange(input){
  const file=input.files[0];if(!file)return;
  if(file.size>20*1024*1024){toast('File troppo grande (max 20MB)','err');input.value='';return}
  const reader=new FileReader();
  reader.onload=function(){
    intAllegatoFile={base64:reader.result.split(',')[1],type:file.type,name:file.name,sizeKB:Math.round(file.size/1024)};
    $('intAllegatoPreview').innerHTML='<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--gray5);border-radius:8px"><span>'+(file.type.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„')+'</span><span style="flex:1;font-size:.8rem">'+file.name+' ('+intAllegatoFile.sizeKB+'KB)</span><button onclick="intAllegatoFile=null;this.parentElement.remove()" style="background:none;border:none;color:var(--err);cursor:pointer">âœ•</button></div>';
    input.value='';
  };
  reader.readAsDataURL(file);
}

async function saveCreaInt(){
  try{
    const clienteID=$('ciCliente').value;
    const note=$('ciNote').value.trim();
    if(!clienteID){toast('Seleziona un cliente','warn');return}
    if(!note){toast('Descrivi il motivo dell\'intervento','warn');return}

    const priId=$('ciPriorita').value;
    const priObj=(DATA.priorita||[]).find(p=>p.ID===priId);
    const priLivello=priObj?.Livello||5;
    const priNome=priObj?.Nome||'Programmata';

    // Calcola data scheduling in base alla prioritÃ 
    let dataInt=$('ciData').value;
    const ora=$('ciOra').value||'08:00';
    const d=new Date();
    if(priLivello===1){ // Urgente - Subito â†’ oggi, primo slot
      dataInt=today();
    }else if(priLivello===2){ // Oggi â†’ oggi
      dataInt=today();
    }else if(priLivello===3){ // Domani â†’ domani
      d.setDate(d.getDate()+1);
      dataInt=d.toISOString().slice(0,10);
    }else if(priLivello===4){ // Entro la settimana â†’ primo giorno libero
      if(!dataInt||dataInt<today()){
        d.setDate(d.getDate()+2);
        dataInt=d.toISOString().slice(0,10);
      }
    }
    // Livello 5 = usa data selezionata dall'utente
    if(!dataInt){toast('Seleziona una data','warn');return}

    const durata=parseFloat($('ciDurata').value)||2;
    const oraFine=calcOraFine(ora,durata);

    // Automezzo: usa l'ultimo usato dal tecnico
    let autoId=null;
    const mieiInt=(DATA.piano||[]).filter(p=>p.TecnicoID===USER?.ID&&p.AutomezzoID).sort((a,b)=>(b.Data||'').localeCompare(a.Data||''));
    if(mieiInt.length)autoId=mieiInt[0].AutomezzoID;

    const data={
      TecnicoID:USER?.ID,
      ClienteID:clienteID,
      MacchinaID:$('ciMacchina').value||null,
      TipoInterventoID:$('ciTipo').value||null,
      PrioritaID:priId,
      AutomezzoID:autoId,
      Data:dataInt,
      OraInizio:ora,
      OraFine:oraFine,
      DurataOre:durata,
      Note:'[RICHIESTA TECNICO - DA CONFERMARE]\nğŸ”´ PrioritÃ : '+priNome+'\n'+note,
      Stato:'pianificato'
    };
    const result=await apiCall('createPiano',{data},'POST');

    // Upload allegato
    if(intAllegatoFile){
      try{
        await apiCall('uploadFile',{base64Data:intAllegatoFile.base64,mimeType:intAllegatoFile.type,fileName:intAllegatoFile.name,uploaderId:USER?.ID,riferimentoTipo:'piano',riferimentoId:result?.id||result?.intervento?.ID||''},'POST');
      }catch(e){}
    }

    // Destinatario notifica in base alla prioritÃ :
    // PrioritÃ  1-2 (Urgente/Oggi) â†’ notifica ANCHE admin
    // Tutte â†’ notifica caposquadra
    const tecNome=((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim();
    const cliNome=getName(DATA.clienti,clienteID);
    const priIcon=priObj?.Icona||'ğŸ“‹';

    // Trova caposquadra
    const capoSq=(DATA.utenti||[]).filter(u=>u.Ruolo==='caposquadra'&&u.Attivo);
    const admins=(DATA.utenti||[]).filter(u=>u.Ruolo==='admin'&&u.Attivo);

    // Messaggio per chat
    const msgTesto=priIcon+' RICHIESTA INTERVENTO ('+priNome+')\nğŸ‘¤ Da: '+tecNome+'\nğŸ¢ Cliente: '+cliNome+'\nğŸ“… '+fmtDate(dataInt)+' '+ora+' ('+durata+'h)\nğŸ“ '+note+'\n\nâ³ In attesa approvazione '+(priLivello<=2?'ADMIN':'caposquadra');

    // 1. Notifica su chat CH_ADMIN
    try{await apiCall('sendChatMessage',{canale_id:'CH_ADMIN',testo:msgTesto,userId:USER?.ID},'POST')}catch(e){}

    // 2. Notifica push al caposquadra
    for(const cs of capoSq){
      try{await apiCall('createNotifica',{data:{Tipo:'richiesta_intervento',Oggetto:priIcon+' Richiesta intervento â€” '+priNome,Testo:tecNome+' richiede intervento per '+cliNome+' il '+fmtDate(dataInt)+'. Motivo: '+note,DestinatarioID:cs.ID,Priorita:priLivello<=2?'alta':'media'}},'POST')}catch(e){}
    }

    // 3. Se prioritÃ  1-2, notifica anche admin
    if(priLivello<=2){
      for(const adm of admins){
        try{await apiCall('createNotifica',{data:{Tipo:'richiesta_intervento_urgente',Oggetto:'ğŸš¨ Intervento URGENTE richiesto â€” '+priNome,Testo:tecNome+' richiede intervento URGENTE per '+cliNome+' â€” '+note+'\nData: '+fmtDate(dataInt)+' '+ora,DestinatarioID:adm.ID,Priorita:'alta'}},'POST')}catch(e){}
      }
    }

    toast('Richiesta intervento inviata! PrioritÃ : '+priNome+'. In attesa approvazione.','ok');
    closeSheet('shCreaInt');
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

function calcOraFine(oraInizio,durata){
  const [h,m]=(oraInizio||'08:00').split(':').map(Number);
  const totMin=h*60+m+Math.round(durata*60);
  const fh=Math.floor(totMin/60)%24;
  const fm=totMin%60;
  return String(fh).padStart(2,'0')+':'+String(fm).padStart(2,'0');
}

// ============ INSTALLAZIONI (detail) ============
function showInstDetail(id){
  const i=(DATA.installazioni||[]).find(x=>x.ID===id);if(!i)return;
  const cli=getName(DATA.clienti,i.ClienteID);
  const mac=getName(DATA.macchine,i.MacchinaID);
  const mObj=(DATA.macchine||[]).find(m=>m.ID===i.MacchinaID);
  const cObj=(DATA.clienti||[]).find(c=>c.ID===i.ClienteID||c.CodiceM3===i.ClienteID);
  // Fasi installazione
  const fasi=i.Fasi||i.FasiCompletate||'';
  $('instDetTitle').textContent='ğŸ”§ '+cli;
  $('instDetBody').innerHTML=
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem;margin-bottom:16px">'+
    '<div><span style="color:var(--gray)">Cliente</span><br><strong>'+cli+'</strong></div>'+
    '<div><span style="color:var(--gray)">Stato</span><br>'+statusTag(i.Stato)+'</div>'+
    '<div><span style="color:var(--gray)">Macchina</span><br><strong>'+mac+'</strong></div>'+
    '<div><span style="color:var(--gray)">S/N</span><br><strong>'+(mObj?.Seriale||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Data Inizio</span><br><strong>'+fmtDate(i.DataInizio)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Data Fine</span><br><strong>'+fmtDate(i.DataFine)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Responsabile</span><br><strong>'+getName(DATA.utenti||[],i.ResponsabileID)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Avanzamento</span><br><strong>'+(i.Avanzamento||0)+'%</strong></div>'+
    '</div>'+
    (i.Avanzamento!=null?'<div style="margin-bottom:16px"><div style="height:8px;background:var(--gray4);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+(i.Avanzamento||0)+'%;background:var(--ok);border-radius:4px;transition:width .3s"></div></div></div>':'')+
    (i.Note?'<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+i.Note+'</div></div>':'')+
    '<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">'+
    (cObj?.Telefono?'<a href="tel:'+cObj.Telefono+'" class="btn btn-outline">ğŸ“ Chiama cliente</a>':'')+
    (cObj?.Latitudine&&cObj?.Longitudine?'<a href="https://www.google.com/maps/dir/?api=1&destination='+cObj.Latitudine+','+cObj.Longitudine+'&travelmode=driving" target="_blank" class="btn btn-outline">ğŸ“ Naviga</a>':'')+
    '<button class="btn btn-outline" onclick="closeSheet(\'shInstDet\')">Chiudi</button></div>';
  openSheet('shInstDet');
}

// ============ PROFILO (con KPI personali) ============
function renderProf(){
  if(!USER)return;
  const abb=((USER.Nome||'').charAt(0)+(USER.Cognome||'').charAt(0)).toUpperCase()||'??';
  $('profAvatar').textContent=abb;
  $('profName').textContent=(USER.NomeInterno||USER.Nome||'')+(USER.Cognome?' '+USER.Cognome:'');
  $('profRole').textContent=USER.Ruolo||'Tecnico';

  // KPI personali
  const miei=my(DATA.piano);
  const meseCorrente=today().substring(0,7);
  const mese=miei.filter(p=>p.Data&&p.Data.startsWith(meseCorrente));
  const completati=mese.filter(p=>p.Stato==='completato').length;
  const totOre=mese.reduce((s,p)=>s+(parseFloat(p.OreLavorate)||0),0);
  const totKm=mese.reduce((s,p)=>s+(parseFloat(p.KmPercorsi)||0),0);
  $('profKpi').innerHTML=
    '<div class="kpi-mini"><div class="val" style="color:var(--ok)">'+completati+'</div><div class="lbl">âœ… Completati (mese)</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:var(--c3)">'+totOre.toFixed(1)+'</div><div class="lbl">â±ï¸ Ore lavorate</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:var(--warn)">'+Math.round(totKm)+'</div><div class="lbl">ğŸš Km percorsi</div></div>';

  $('profCard').innerHTML='<div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem">'+
    '<div><span style="color:var(--gray)">ID</span><br><strong>'+(USER.ID||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Email</span><br><strong>'+(USER.Email||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Telefono</span><br><strong>'+(USER.Telefono||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Ruolo</span><br><strong>'+(USER.Ruolo||'â€”')+'</strong></div>'+
    '</div></div>';
}

// ============ PASSWORD: FORGOT + CHANGE ============
function showForgotPwd(){$('loginForm').style.display='none';$('forgotPwdForm').style.display='block';$('forgotPwdSection').style.display='none';$('forgotMsg').style.display='none'}
function hideForgotPwd(){$('loginForm').style.display='block';$('forgotPwdForm').style.display='none';$('forgotPwdSection').style.display='block'}

async function sendForgotPwd(){
  const username=$('forgotUsername').value.trim();
  if(!username){$('forgotMsg').textContent='Inserisci il tuo username';$('forgotMsg').style.color='var(--err)';$('forgotMsg').style.display='block';return}
  try{
    const r=await apiCall('requestPasswordReset',{username},'POST');
    $('forgotMsg').textContent=r?.message||'Richiesta inviata! L\'admin ti contatterÃ .';
    $('forgotMsg').style.color='var(--ok)';$('forgotMsg').style.display='block';
  }catch(e){$('forgotMsg').textContent=e.message;$('forgotMsg').style.color='var(--err)';$('forgotMsg').style.display='block'}
}

async function doChangePassword(){
  const oldPwd=$('cpOld').value;const newPwd=$('cpNew').value;const confPwd=$('cpConf').value;
  if(!oldPwd||!newPwd){toast('Compila tutti i campi','warn');return}
  if(newPwd!==confPwd){toast('Le password non coincidono','warn');return}
  if(newPwd.length<6){toast('La password deve avere almeno 6 caratteri','warn');return}
  try{
    await apiCall('changePassword',{userId:USER?.ID,old_password:oldPwd,new_password:newPwd},'POST');
    toast('âœ… Password cambiata con successo!','ok');
    $('cpOld').value='';$('cpNew').value='';$('cpConf').value='';
  }catch(e){toast(e.message,'err')}
}

// Mostra "Password dimenticata?" dopo che il login form Ã¨ visibile
document.addEventListener('DOMContentLoaded',()=>{
  const obs=new MutationObserver(()=>{
    if($('loginForm')&&$('loginForm').style.display!=='none')$('forgotPwdSection').style.display='block';
  });
  if($('loginForm'))obs.observe($('loginForm'),{attributes:true,attributeFilter:['style']});
});

// ============ FOTO INTERVENTO (in corso) ============
async function uploadFotoInt(input,intId){
  const file=input.files?.[0];if(!file)return;
  if(file.size>10*1024*1024){toast('Max 10MB','err');input.value='';return}
  toast('ğŸ“¤ Caricamento foto...','info');
  try{
    const compressed=await compressImageTec(file,1200,0.8);
    const base64=compressed.split(',')[1];
    const res=await apiCall('uploadFile',{
      base64Data:base64,
      mimeType:'image/jpeg',
      fileName:'foto_'+intId+'_'+Date.now()+'.jpg',
      riferimentoTipo:'piano',
      riferimentoId:intId,
      uploaderId:USER?.ID
    },'POST');
    const prev=document.getElementById('fotoIntPrev_'+intId);
    if(prev&&res?.url){
      const thumb=document.createElement('img');
      thumb.src=compressed;
      thumb.style.cssText='width:60px;height:60px;border-radius:6px;object-fit:cover;border:1px solid var(--border)';
      thumb.onclick=()=>window.open(res.url,'_blank');
      prev.appendChild(thumb);
    }
    toast('ğŸ“· Foto caricata!','ok');
  }catch(e){toast('Errore upload: '+e.message,'err')}
  input.value='';
}

// ============ PUSH NOTIFICATIONS ============
const PushMgr={
  vapidKey:null,
  async init(){
    if(!('PushManager' in window)||!('serviceWorker' in navigator)){$('pushCard').style.display='none';return}
    $('pushCard').style.display='block';
    try{
      const r=await apiCall('getVapidPublicKey',{});
      if(!r?.vapidPublicKey){$('pushStatus').textContent='Push non configurato sul server';return}
      this.vapidKey=r.vapidPublicKey;
      const sub=await this.isSubscribed();
      $('pushToggle').checked=sub;
      this.updateSlider(sub);
      $('pushStatus').textContent=sub?'Notifiche attive':'Notifiche disattivate';
    }catch(e){$('pushStatus').textContent='Errore: '+e.message}
  },
  async subscribe(){
    if(!this.vapidKey){toast('Push non configurato','warn');return false}
    try{
      if(Notification.permission==='denied'){toast('Notifiche bloccate dal browser','err');return false}
      const perm=await Notification.requestPermission();
      if(perm!=='granted'){toast('Permesso negato','warn');return false}
      const reg=await navigator.serviceWorker.ready;
      const sub=await reg.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:this.urlB64(this.vapidKey)});
      const j=sub.toJSON();
      await apiCall('subscribePush',{userId:USER?.ID,subscription:{endpoint:j.endpoint,keys:j.keys},userAgent:navigator.userAgent},'POST');
      toast('Notifiche attivate!','ok');return true;
    }catch(e){toast('Errore: '+e.message,'err');return false}
  },
  async unsubscribe(){
    try{
      const reg=await navigator.serviceWorker.ready;
      const sub=await reg.pushManager.getSubscription();
      if(sub){const ep=sub.endpoint;await sub.unsubscribe();await apiCall('unsubscribePush',{userId:USER?.ID,endpoint:ep},'POST')}
      toast('Notifiche disattivate','ok');
    }catch(e){toast('Errore: '+e.message,'err')}
  },
  async isSubscribed(){
    try{const reg=await navigator.serviceWorker.ready;return!!(await reg.pushManager.getSubscription())}catch{return false}
  },
  updateSlider(on){
    const s=$('pushSlider');if(!s)return;
    s.style.transform=on?'translateX(22px)':'translateX(0)';
    s.parentElement.querySelector('span').style.background=on?'var(--ok)':'#ccc';
  },
  urlB64(b){const p='='.repeat((4-b.length%4)%4);const r=atob((b+p).replace(/-/g,'+').replace(/_/g,'/'));return Uint8Array.from([...r].map(c=>c.charCodeAt(0)))}
};
async function togglePush(){
  const on=$('pushToggle').checked;
  if(on){const ok=await PushMgr.subscribe();if(!ok)$('pushToggle').checked=false;PushMgr.updateSlider(ok)}
  else{await PushMgr.unsubscribe();PushMgr.updateSlider(false)}
  $('pushStatus').textContent=$('pushToggle').checked?'Notifiche attive':'Notifiche disattivate';
}

// ============ KPI DASHBOARD TECNICO ============
// ============ CATALOGO PARTI MOBILE ============
async function searchCatalogMob(){
  const search=$('catMobSearch')?.value?.trim()||'';
  const modello=$('catMobModello')?.value||'';
  if(!search&&!modello){toast('Inserisci un termine di ricerca');return}
  const el=$('catMobResults');
  el.innerHTML='<div style="text-align:center;padding:20px;color:var(--gray)">ğŸ” Cercando...</div>';
  try{
    const r=await apiCall('searchParts',{search:search||undefined,modello:modello||undefined,limit:15,userId:USER?.ID},'POST');
    const items=Array.isArray(r)?r:[];
    if(!items.length){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--gray)">Nessun risultato</div>';return}
    let html='';
    items.forEach(p=>{
      html+=`<div style="padding:12px;border-bottom:1px solid var(--gray2)">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <code style="background:#EEF2FF;color:#4338CA;padding:3px 8px;border-radius:6px;font-size:.75rem;font-weight:600">${p.Codice||'â€”'}</code>
          <span style="font-size:.65rem;color:var(--gray);background:var(--gray1);padding:2px 6px;border-radius:8px">${p.ModelloMacchina||'â€”'}</span>
        </div>
        <div style="font-weight:500;margin-top:4px;font-size:.85rem">${p.Nome||'â€”'}</div>
        ${p.Descrizione?'<div style="font-size:.75rem;color:var(--gray);margin-top:2px">'+p.Descrizione.substring(0,80)+'</div>':''}
        ${p.Gruppo?'<span style="display:inline-block;margin-top:4px;padding:2px 8px;border-radius:10px;font-size:.65rem;background:#F0FDF4;color:#15803D">'+p.Gruppo+'</span>':''}
      </div>`;
    });
    el.innerHTML=html;
  }catch(e){
    el.innerHTML='<div style="text-align:center;padding:20px;color:var(--err)">âŒ '+e.message+'</div>';
  }
}

function renderKpi(){
  if(!USER||!DATA) return;
  const days=parseInt($('kpiPeriodo')?.value||'7');
  const now=new Date();
  const from=new Date(now);from.setDate(now.getDate()-days);
  const fromStr=from.toISOString().split('T')[0];
  const uid=USER.ID;

  // Filter my piano
  const myPiano=(DATA.piano||[]).filter(p=>p.TecnicoID===uid&&!p.Obsoleto);
  const period=myPiano.filter(p=>(p.Data||'')>=fromStr);
  const completati=period.filter(p=>p.Stato==='completato');
  const inCorso=period.filter(p=>p.Stato==='in_corso');
  const pianificati=period.filter(p=>p.Stato==='pianificato');

  // My urgenze
  const myUrg=(DATA.urgenze||[]).filter(u=>u.TecnicoAssegnato===uid);
  const urgPeriod=myUrg.filter(u=>(u.DataSegnalazione||'').substring(0,10)>=fromStr);
  const urgRisolte=urgPeriod.filter(u=>u.Stato==='risolta'||u.Stato==='chiusa');

  // Hours worked (sum DurataOre from completed piano)
  const orelavorate=completati.reduce((s,p)=>s+(parseFloat(p.DurataOre)||0),0);

  // SLA compliance
  const urgConSla=urgPeriod.filter(u=>u.SLAStatus);
  const slaOk=urgConSla.filter(u=>u.SLAStatus==='ok'||u.SLAStatus==='warning');
  const slaPerc=urgConSla.length?Math.round(slaOk.length/urgConSla.length*100):100;

  // Average resolution time
  let avgResH=0;
  const resolved=urgPeriod.filter(u=>u.DataRisoluzione&&u.DataSegnalazione);
  if(resolved.length){
    const totalH=resolved.reduce((s,u)=>{
      const d1=new Date(u.DataSegnalazione),d2=new Date(u.DataRisoluzione);
      return s+(d2-d1)/3600000;
    },0);
    avgResH=Math.round(totalH/resolved.length*10)/10;
  }

  // KPI cards
  $('kpiCards').innerHTML=`
    <div class="kpi-box"><div class="kpi-val" style="color:var(--ok)">${completati.length}</div><div class="kpi-lbl">Completati</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--warn)">${inCorso.length}</div><div class="kpi-lbl">In Corso</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:var(--c1)">${urgRisolte.length}</div><div class="kpi-lbl">Urgenze Risolte</div></div>
    <div class="kpi-box"><div class="kpi-val">${orelavorate.toFixed(1)}h</div><div class="kpi-lbl">Ore Lavorate</div></div>
    <div class="kpi-box"><div class="kpi-val" style="color:${slaPerc>=80?'var(--ok)':slaPerc>=60?'var(--warn)':'var(--err)'}">${slaPerc}%</div><div class="kpi-lbl">SLA Compliance</div></div>
    <div class="kpi-box"><div class="kpi-val">${avgResH}h</div><div class="kpi-lbl">Tempo Medio Risoluzione</div></div>
  `;

  // Chart: interventi per giorno (ultimi N giorni)
  const byDay={};
  for(let i=0;i<Math.min(days,30);i++){
    const d=new Date(now);d.setDate(now.getDate()-i);
    byDay[d.toISOString().split('T')[0]]={completati:0,pianificati:0,urgenze:0};
  }
  completati.forEach(p=>{const d=p.Data;if(byDay[d])byDay[d].completati++});
  pianificati.forEach(p=>{const d=p.Data;if(byDay[d])byDay[d].pianificati++});
  urgRisolte.forEach(u=>{const d=(u.DataRisoluzione||'').substring(0,10);if(byDay[d])byDay[d].urgenze++});

  const labels=Object.keys(byDay).sort();
  const maxVal=Math.max(1,...labels.map(d=>byDay[d].completati+byDay[d].pianificati+byDay[d].urgenze));

  $('kpiCharts').innerHTML=`
    <div style="font-weight:600;font-size:.8rem;margin-bottom:8px">ğŸ“ˆ AttivitÃ  per giorno</div>
    <div style="overflow-x:auto">
    <div style="display:flex;align-items:flex-end;gap:2px;height:120px;min-width:${labels.length*24}px">
    ${labels.map(d=>{
      const v=byDay[d];
      const tot=v.completati+v.pianificati+v.urgenze;
      const h=Math.max(4,Math.round(tot/maxVal*100));
      const day=d.substring(8,10)+'/'+d.substring(5,7);
      return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;min-width:20px" title="${day}: ${tot} attivitÃ ">
        <div style="font-size:.55rem;color:var(--gray);margin-bottom:2px">${tot||''}</div>
        <div style="width:100%;display:flex;flex-direction:column;justify-content:flex-end;height:100px">
          ${v.urgenze?`<div style="background:var(--err);height:${Math.round(v.urgenze/maxVal*100)}px;border-radius:2px 2px 0 0;min-height:3px"></div>`:''}
          ${v.completati?`<div style="background:var(--ok);height:${Math.round(v.completati/maxVal*100)}px;min-height:3px"></div>`:''}
          ${v.pianificati?`<div style="background:var(--warn);height:${Math.round(v.pianificati/maxVal*100)}px;border-radius:0 0 2px 2px;min-height:3px"></div>`:''}
          ${!tot?`<div style="background:var(--border);height:4px;border-radius:2px"></div>`:''}
        </div>
        <div style="font-size:.5rem;color:var(--gray);margin-top:2px;writing-mode:vertical-rl;transform:rotate(180deg);height:30px;overflow:hidden">${day}</div>
      </div>`;
    }).join('')}
    </div></div>
    <div style="display:flex;gap:12px;font-size:.65rem;color:var(--gray);margin-top:6px;justify-content:center">
      <span><span style="display:inline-block;width:8px;height:8px;background:var(--ok);border-radius:2px;margin-right:3px"></span>Completati</span>
      <span><span style="display:inline-block;width:8px;height:8px;background:var(--warn);border-radius:2px;margin-right:3px"></span>Pianificati</span>
      <span><span style="display:inline-block;width:8px;height:8px;background:var(--err);border-radius:2px;margin-right:3px"></span>Urgenze</span>
    </div>
  `;

  // Interventi list
  const recentInt=period.sort((a,b)=>(b.Data||'').localeCompare(a.Data||'')).slice(0,20);
  $('kpiIntervList').innerHTML=recentInt.length?recentInt.map(p=>`<tr>
    <td>${fmtDate(p.Data)}</td>
    <td>${getName(DATA.clienti,p.ClienteID)}</td>
    <td>${getName(DATA.tipiIntervento||[],p.TipoInterventoID)}</td>
    <td>${statusTag(p.Stato)}</td>
    <td>${p.DurataOre?p.DurataOre+'h':'â€”'}</td>
  </tr>`).join(''):'<tr><td colspan="5" class="empty">Nessun intervento nel periodo</td></tr>';
}

// ============ SERVICE WORKER + OFFLINE ============
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(reg=>{
    console.log('[SW] Registrato, scope:',reg.scope);
    // Check for updates
    reg.addEventListener('updatefound',()=>{
      const newSW=reg.installing;
      newSW.addEventListener('statechange',()=>{
        if(newSW.state==='installed'&&navigator.serviceWorker.controller){
          // New version available â€” show update banner
          showOfflineBanner('ğŸ”„ Nuova versione disponibile!','Aggiorna',()=>{
            newSW.postMessage('SKIP_WAITING');
            location.reload();
          });
        }
      });
    });
  }).catch(e=>console.warn('[SW] Errore registrazione:',e));

  // Listen for messages from SW
  navigator.serviceWorker.addEventListener('message',event=>{
    if(event.data.type==='ACTION_QUEUED'){
      toast('ğŸ“¡ '+event.data.message,'warn');
      updateOfflineBadge();
    }
    if(event.data.type==='SYNC_COMPLETE'){
      toast('âœ… '+event.data.message,'ok');
      updateOfflineBadge();
      refreshData();
    }
    if(event.data.type==='PENDING_COUNT'){
      const badge=document.getElementById('offlineBadge');
      if(badge)badge.textContent=event.data.count>0?event.data.count:'';
      if(badge)badge.style.display=event.data.count>0?'inline-block':'none';
    }
  });
}

// Offline/online status
window.addEventListener('online',()=>{
  toast('âœ… Sei di nuovo online!','ok');
  hideOfflineBanner();
  if(navigator.serviceWorker?.controller){
    navigator.serviceWorker.controller.postMessage('ONLINE');
  }
  refreshData();
});
window.addEventListener('offline',()=>{
  showOfflineBanner('ğŸ“¡ Sei offline â€” le azioni verranno sincronizzate quando torni online');
});

function showOfflineBanner(msg,btnText,btnAction){
  let banner=document.getElementById('offlineBanner');
  if(!banner){
    banner=document.createElement('div');
    banner.id='offlineBanner';
    banner.style.cssText='position:fixed;top:0;left:0;right:0;background:#FEF3C7;color:#92400E;padding:8px 16px;font-size:.8rem;text-align:center;z-index:10000;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 2px 8px rgba(0,0,0,.15)';
    document.body.prepend(banner);
  }
  banner.innerHTML=`<span>${msg}</span>`;
  if(btnText&&btnAction){
    const btn=document.createElement('button');
    btn.textContent=btnText;
    btn.style.cssText='background:#C30A14;color:#fff;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:.8rem';
    btn.onclick=btnAction;
    banner.appendChild(btn);
  }
  banner.style.display='flex';
}
function hideOfflineBanner(){
  const b=document.getElementById('offlineBanner');
  if(b)b.style.display='none';
}
function updateOfflineBadge(){
  if(navigator.serviceWorker?.controller){
    navigator.serviceWorker.controller.postMessage({type:'GET_PENDING_COUNT'});
  }
}

</script>
</body>
</html>
