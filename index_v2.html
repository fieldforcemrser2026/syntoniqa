<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#C30A14">
<link rel="manifest" href="manifest.json">
<title>Syntoniqa Tecnico v2.0</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="white_label_config.js"></script>
<script>
/* ============================================================
   WHITE-LABEL BOOT â€” Syntoniqa Tecnico v2.0
   ============================================================ */
;(function(){
  var cfg = window.SYNTONIQA_CONFIG;
  if(!cfg) return;
  var r = document.documentElement.style;
  var co = cfg.colors||{};
  if(co.primary)       r.setProperty('--c1', co.primary);
  if(co.primary2)      r.setProperty('--c1h', co.primary2);
  if(co.secondary)     r.setProperty('--c3', co.secondary);
  if(co.bg)            r.setProperty('--dark', co.bg);
  var mt = document.querySelector('meta[name="theme-color"]');
  if(mt && co.primary) mt.content = co.primary;
  var br = cfg.brand||{};
  if(br.nome) document.title = br.nome + ' Tecnico';
  if(br.favicon_url){
    var lk=document.createElement('link'); lk.rel='icon'; lk.href=br.favicon_url;
    document.head.appendChild(lk);
  }
  function applyBrand(){
    var nome = br.nome || 'Syntoniqa';
    var bn=document.getElementById('brandName'); if(bn) bn.textContent=nome;
    var bs=document.getElementById('brandSub'); if(bs) bs.textContent='Portale Tecnico';
    var logoDiv=document.getElementById('loginLogo');
    if(logoDiv){
      if(br.logo_url){
        logoDiv.innerHTML='<img src="'+br.logo_url+'" style="height:48px;max-width:180px;object-fit:contain" alt="'+nome+'">';
      } else {
        var ini=(br.initiali||nome.replace(/[^A-Z0-9]/gi,'').substring(0,3)).toUpperCase();
        var col=(co.primary||'#C30A14');
        logoDiv.innerHTML='<div style="width:64px;height:64px;background:'+col+';border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto;box-shadow:0 6px 20px '+col+'55"><span style="font-size:1.25rem;font-weight:900;color:#fff">'+ini+'</span></div>';
      }
    }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', applyBrand);
  else applyBrand();
})();
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
:root{
  --font:'DM Sans',system-ui,sans-serif;
  --c1:#C30A14; --c1h:#A00810; --c3:#3B7EF7;
  --ok:#10B981; --warn:#F59E0B; --err:#EF4444;
  --gray:#6B7280; --gray2:#9CA3AF; --gray3:#D1D5DB; --gray4:#F3F4F6; --gray5:#F9FAFB;
  --dark:#050505; --white:#FFFFFF;
  --hh:56px; --nh:70px;
  --shadow:0 1px 3px rgba(0,0,0,.08);
  --shadow-lg:0 8px 24px rgba(0,0,0,.12);
  --radius:12px; --radius-sm:8px;
  --safe-b:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:var(--font);background:var(--gray5);color:var(--dark);min-height:100vh;min-height:100dvh;line-height:1.5;font-size:14px;overflow-x:hidden}
::-webkit-scrollbar{display:none}

/* LOGIN */
.login{position:fixed;inset:0;background:linear-gradient(160deg,var(--dark),var(--c1));display:flex;justify-content:center;align-items:center;padding:24px;z-index:9000}
.login.hidden{display:none}
.login-box{background:var(--white);padding:40px 28px;border-radius:20px;width:100%;max-width:360px;box-shadow:var(--shadow-lg)}
.login-box h1{font-size:1.375rem;font-weight:700;color:var(--dark);text-align:center;margin-bottom:4px}
.login-box .sub{color:var(--gray);text-align:center;font-size:.8125rem;margin-bottom:28px}
.login-box .loading{text-align:center;padding:32px}
.spin{display:inline-block;width:28px;height:28px;border:3px solid var(--gray3);border-top-color:var(--c1);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* FORM */
.field{margin-bottom:14px}
.field label{display:block;font-size:.6875rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--gray);margin-bottom:5px}
.field input,.field select,.field textarea{width:100%;padding:11px 14px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.875rem;font-family:var(--font);color:var(--dark);background:var(--white);transition:border-color .2s;-webkit-appearance:none}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--c1);outline:none;box-shadow:0 0 0 3px rgba(195,10,20,.1)}
.field textarea{resize:vertical;min-height:70px}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:11px 20px;border:none;border-radius:var(--radius-sm);font-size:.875rem;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s;-webkit-appearance:none}
.btn:active{transform:scale(.97);opacity:.9}
.btn-primary{background:var(--c1);color:var(--white)}
.btn-ok{background:var(--ok);color:var(--white)}
.btn-warn{background:var(--warn);color:var(--white)}
.btn-err{background:var(--err);color:var(--white)}
.btn-outline{background:var(--white);border:1.5px solid var(--gray3);color:var(--dark)}
.btn-ghost{background:transparent;color:var(--gray);padding:8px}
.btn-sm{padding:8px 14px;font-size:.8125rem}
.btn-block{width:100%}

/* HEADER */
.hdr{position:fixed;top:0;left:0;right:0;height:var(--hh);background:var(--c1);color:var(--white);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.hdr h1{font-size:.9375rem;font-weight:700;letter-spacing:-.02em}
.hdr button{background:none;border:none;color:var(--white);font-size:1.25rem;cursor:pointer;padding:6px}

/* BOTTOM NAV */
.bnav{position:fixed;bottom:0;left:0;right:0;height:var(--nh);background:var(--white);border-top:1px solid #E5E7EB;display:flex;justify-content:space-around;align-items:center;z-index:100;padding-bottom:var(--safe-b)}
.bnav button{display:flex;flex-direction:column;align-items:center;gap:2px;background:none;border:none;color:var(--gray2);font-size:.625rem;font-family:var(--font);font-weight:500;cursor:pointer;padding:6px 12px;transition:.15s;position:relative}
.bnav button .ico{font-size:1.25rem}
.bnav button.active{color:var(--c1);font-weight:600}
.bnav button .nbadge{position:absolute;top:0;right:4px;background:var(--err);color:var(--white);font-size:.5625rem;font-weight:700;padding:1px 5px;border-radius:8px;min-width:14px;text-align:center}

/* CONTENT */
.app{display:none;padding-top:var(--hh);padding-bottom:calc(var(--nh) + 8px)}
.page{display:none;padding:12px 16px}
.page.active{display:block}

/* CARDS */
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:12px;border:1px solid #E5E7EB}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #E5E7EB}
.card-head h3{font-size:.875rem;font-weight:600}
.card-body{padding:14px 16px}
.card-body.np{padding:0}

/* INTERVENTION ITEM */
.int-item{padding:14px 16px;border-bottom:1px solid #E5E7EB;display:flex;gap:12px;align-items:flex-start;cursor:pointer;transition:background .1s}
.int-item:active{background:var(--gray5)}
.int-item .time-block{min-width:48px;text-align:center}
.int-item .time-block .time{font-size:1rem;font-weight:700;color:var(--c1)}
.int-item .time-block .date{font-size:.625rem;color:var(--gray);text-transform:uppercase}
.int-item .info{flex:1;min-width:0}
.int-item .info h4{font-size:.875rem;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.int-item .info p{font-size:.75rem;color:var(--gray);margin-bottom:4px}
.int-item .arrow{color:var(--gray3);font-size:1rem;align-self:center}

/* TAGS */
.tag{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:16px;font-size:.6875rem;font-weight:600}
.tag-ok{background:#D1FAE5;color:#065F46}
.tag-warn{background:#FEF3C7;color:#92400E}
.tag-err{background:#FEE2E2;color:#991B1B}
.tag-info{background:#DBEAFE;color:#1E40AF}
.tag-gray{background:var(--gray4);color:#374151}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.kpi-mini{background:var(--white);border-radius:var(--radius-sm);padding:12px;text-align:center;box-shadow:var(--shadow);border:1px solid #E5E7EB}
.kpi-mini .val{font-size:1.375rem;font-weight:700;letter-spacing:-.02em}
.kpi-mini .lbl{font-size:.625rem;color:var(--gray);text-transform:uppercase;margin-top:2px}

/* BOTTOM SHEET */
.sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:5000;opacity:0;pointer-events:none;transition:opacity .2s}
.sheet-overlay.show{opacity:1;pointer-events:auto}
.sheet{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-radius:20px 20px 0 0;max-height:88vh;display:flex;flex-direction:column;z-index:5001;transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1)}
.sheet-overlay.show .sheet{transform:translateY(0)}
.sheet .handle{width:36px;height:4px;border-radius:2px;background:var(--gray3);margin:10px auto 0}
.sheet-head{padding:14px 20px 10px;display:flex;align-items:center;justify-content:space-between}
.sheet-head h2{font-size:1rem;font-weight:700}
.sheet-head button{background:none;border:none;font-size:1.125rem;color:var(--gray);cursor:pointer;padding:4px 8px}
.sheet-body{padding:0 20px 24px;overflow-y:auto;flex:1;padding-bottom:calc(24px + var(--safe-b))}

/* TOAST */
.toast-c{position:fixed;top:calc(var(--hh) + 8px);left:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:6px}
.toast{padding:12px 16px;border-radius:var(--radius-sm);color:var(--white);font-size:.8125rem;font-weight:500;box-shadow:var(--shadow-lg);animation:tIn .3s ease}
.toast.ok{background:var(--ok)}.toast.err{background:var(--err)}.toast.warn{background:var(--warn)}.toast.info{background:var(--c3)}
@keyframes tIn{from{opacity:0;transform:translateY(-16px)}to{opacity:1;transform:translateY(0)}}

/* MAP */
#mapTec{height:calc(100vh - var(--hh) - var(--nh) - 60px);min-height:300px;border-radius:var(--radius);z-index:1}

/* EMPTY */
.empty{text-align:center;padding:40px 20px;color:var(--gray)}
.empty .ico{font-size:2.5rem;margin-bottom:8px;opacity:.5}

/* MENU GRID */
.menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.menu-item{padding:16px;background:var(--white);border:1px solid #E5E7EB;border-radius:var(--radius);text-align:center;cursor:pointer;transition:all .15s}
.menu-item:active{background:var(--gray5);transform:scale(.95)}
.menu-item .ico{font-size:1.75rem;margin-bottom:6px;display:block}
.menu-item .lbl{font-size:.8125rem;font-weight:600;color:var(--dark)}

/* NOTIF ITEM */
.notif-item{padding:14px 16px;border-bottom:1px solid #E5E7EB;display:flex;gap:12px}
.notif-item.unread{background:#FEF3C7}
.notif-item .dot-n{width:10px;height:10px;border-radius:50%;background:var(--c1);flex-shrink:0;margin-top:4px}
.notif-item .dot-n.read{background:var(--gray3)}
.notif-item .n-info{flex:1}

/* WORKFLOW */
.wf-mini{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
.wf-dot{width:8px;height:8px;border-radius:50%;background:var(--gray3)}
.wf-dot.done{background:var(--ok)}
.wf-dot.active{background:var(--c1);box-shadow:0 0 0 3px rgba(195,10,20,.2)}

/* Calendar dot */
.cal-dot{width:5px;height:5px;border-radius:50%;background:var(--c1);margin:2px auto 0;display:block}

/* CHAT */
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - var(--hh) - var(--nh) - 24px)}
.chat-channels{display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
.chat-ch-btn{padding:6px 14px;border-radius:20px;border:1.5px solid var(--gray3);background:var(--white);font-size:.75rem;font-weight:600;cursor:pointer;white-space:nowrap;font-family:var(--font);transition:.15s}
.chat-ch-btn.active{background:var(--c1);color:var(--white);border-color:var(--c1)}
.chat-msgs{flex:1;overflow-y:auto;padding:8px 0;display:flex;flex-direction:column;gap:6px}
.chat-msg{max-width:85%;padding:10px 14px;border-radius:16px;font-size:.8125rem;line-height:1.4;word-break:break-word}
.chat-msg.mine{align-self:flex-end;background:var(--c1);color:var(--white);border-bottom-right-radius:4px}
.chat-msg.other{align-self:flex-start;background:var(--white);border:1px solid #E5E7EB;border-bottom-left-radius:4px}
.chat-msg .sender{font-size:.6875rem;font-weight:600;opacity:.8;margin-bottom:2px}
.chat-msg .meta{font-size:.625rem;opacity:.6;text-align:right;margin-top:2px}
.chat-msg.tg{border-left:3px solid #0088cc}
.chat-input-bar{display:flex;gap:8px;padding:8px 0 4px;border-top:1px solid #E5E7EB;margin-top:auto}
.chat-input-bar input{flex:1;padding:10px 14px;border:1.5px solid var(--gray3);border-radius:24px;font-size:.875rem;font-family:var(--font)}
.chat-input-bar input:focus{border-color:var(--c1);outline:none}
.chat-input-bar button{width:44px;height:44px;border-radius:50%;background:var(--c1);border:none;color:var(--white);font-size:1.1rem;cursor:pointer}

/* ROUTE MAP */
.map-controls{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
.route-num{width:24px;height:24px;border-radius:50%;background:var(--c1);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.3)}
</style>
</head>
<body>
<div class="toast-c" id="toasts"></div>

<!-- LOGIN -->
<div class="login" id="loginScreen">
<div class="login-box">
<div id="loginLogo" style="display:flex;justify-content:center;margin-bottom:6px;font-size:2.5rem"></div>
<h1 id="brandName">Syntoniqa</h1>
<p class="sub" id="brandSub">Portale Tecnico v2.0</p>
<div id="loginLoad" class="loading"><div class="spin"></div><p style="margin-top:10px;font-size:.8125rem;color:var(--gray)">Connessione...</p></div>
<form id="loginForm" onsubmit="return doLogin(event)" style="display:none">
<div class="field"><label>Username</label><input type="text" id="inpUser" required placeholder="nome.cognome" autocomplete="username"></div>
<div class="field"><label>Password</label><input type="password" id="inpPwd" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
<div id="loginErr" style="color:var(--err);font-size:.8125rem;margin-bottom:10px;display:none"></div>
<button class="btn btn-primary btn-block" id="btnLogin" type="submit">Accedi</button>
</form>
</div>
</div>

<!-- HEADER -->
<header class="hdr" id="hdr" style="display:none">
<h1 id="hdrTitle">Home</h1>
<div style="display:flex;gap:6px;align-items:center">
<span id="hdrDate" style="font-size:.6875rem;opacity:.7"></span>
<button onclick="goPage('notifiche')" id="btnNotHdr" style="position:relative">ğŸ””</button>
</div>
</header>

<!-- MAIN -->
<main class="app" id="app">

<!-- PAGE: HOME -->
<div class="page active" id="pgHome">
<div class="kpi-row" id="homeKpi"></div>
<div class="card">
<div class="card-head"><h3>ğŸ“‹ Interventi Oggi</h3></div>
<div class="card-body np" id="homeList"></div>
</div>
<div class="card" id="homeUrgBox" style="display:none">
<div class="card-head"><h3>ğŸš¨ Urgenze Attive</h3></div>
<div class="card-body np" id="homeUrg"></div>
</div>
<div class="card" id="homeRepBox" style="display:none">
<div class="card-head"><h3>ğŸ“ ReperibilitÃ  Attiva</h3></div>
<div class="card-body" id="homeRep"></div>
</div>
</div>

<!-- PAGE: INTERVENTI -->
<div class="page" id="pgInterventi">
<div style="display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;-webkit-overflow-scrolling:touch">
<button class="btn btn-sm btn-primary" onclick="filtInt('')" id="fAll">Tutti</button>
<button class="btn btn-sm btn-outline" onclick="filtInt('pianificato')" id="fPian">ğŸ“… Pianif.</button>
<button class="btn btn-sm btn-outline" onclick="filtInt('in_corso')" id="fCorso">âš¡ In Corso</button>
<button class="btn btn-sm btn-outline" onclick="filtInt('completato')" id="fComp">âœ… Fatti</button>
</div>
<div class="card"><div class="card-body np" id="intList"></div></div>
</div>

<!-- PAGE: URGENZE -->
<div class="page" id="pgUrgenze">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openCreaUrg()">ğŸš¨ + Crea Urgenza</button>
<div style="font-size:.7rem;color:var(--warn);margin:-8px 0 12px;padding:0 4px">âš ï¸ Le urgenze create dal tecnico richiedono approvazione del caposquadra/admin</div>
<div id="urgList"></div>
</div>

<!-- PAGE: ORDINI -->
<div class="page" id="pgOrdini">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openSheet('shOrdine')">+ Nuovo Ordine Ricambi</button>
<div id="ordList"></div>
</div>

<!-- PAGE: CHAT TELEGRAM -->
<div class="page" id="pgChat">
<div class="chat-wrap">
<div class="chat-channels" id="chatChannels"></div>
<div class="chat-msgs" id="chatMsgs">
<div class="empty"><div class="ico">ğŸ’¬</div><p>Seleziona un canale</p></div>
</div>
<div class="chat-input-bar">
<input type="text" id="chatInput" placeholder="Scrivi messaggio..." onkeydown="if(event.key==='Enter')sendChatMsg()">
<button onclick="sendChatMsg()">â¤</button>
</div>
</div>
</div>

<!-- PAGE: MENU -->
<div class="page" id="pgMenu">
<div class="menu-grid">
<div class="menu-item" onclick="goPage('notifiche')"><span class="ico">ğŸ””</span><span class="lbl">Notifiche</span></div>
<div class="menu-item" onclick="goPage('richieste')"><span class="ico">ğŸ“</span><span class="lbl">Richieste</span></div>
<div class="menu-item" onclick="goPage('reperibilita')"><span class="ico">ğŸ“</span><span class="lbl">ReperibilitÃ </span></div>
<div class="menu-item" onclick="goPage('trasferte')"><span class="ico">ğŸ§³</span><span class="lbl">Trasferte</span></div>
<div class="menu-item" onclick="goPage('installazioni')"><span class="ico">ğŸ”§</span><span class="lbl">Installazioni</span></div>
<div class="menu-item" onclick="goPage('clienti')"><span class="ico">ğŸ¢</span><span class="lbl">Clienti</span></div>
<div class="menu-item" onclick="goPage('macchine')"><span class="ico">âš™ï¸</span><span class="lbl">Macchine</span></div>
<div class="menu-item" onclick="goPage('documenti')"><span class="ico">ğŸ“</span><span class="lbl">Documenti</span></div>
<div class="menu-item" onclick="goPage('mappa')"><span class="ico">ğŸ—ºï¸</span><span class="lbl">Mappa Giro</span></div>
<div class="menu-item" onclick="goPage('calendario')"><span class="ico">ğŸ“…</span><span class="lbl">Calendario</span></div>
<div class="menu-item" onclick="goPage('profilo')"><span class="ico">ğŸ‘¤</span><span class="lbl">Profilo</span></div>
</div>
</div>

<!-- PAGE: NOTIFICHE -->
<div class="page" id="pgNotifiche">
<div class="card"><div class="card-head"><h3>ğŸ”” Notifiche</h3><button class="btn btn-ghost btn-sm" onclick="markAllRead()">Tutte lette</button></div><div class="card-body np" id="notList"></div></div>
</div>

<!-- PAGE: RICHIESTE -->
<div class="page" id="pgRichieste">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openSheet('shRichiesta')">+ Nuova Richiesta</button>
<div id="richList"></div>
</div>

<!-- PAGE: REPERIBILITA -->
<div class="page" id="pgReperibilita">
<div id="repList"></div>
</div>

<!-- PAGE: TRASFERTE -->
<div class="page" id="pgTrasferte">
<button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openSheet('shTrasferta')">+ Nuova Trasferta</button>
<div id="trasfList"></div>
</div>

<!-- PAGE: INSTALLAZIONI -->
<div class="page" id="pgInstallazioni">
<div id="instList"></div>
</div>

<!-- PAGE: CLIENTI -->
<div class="page" id="pgClienti">
<div class="field" style="margin-bottom:12px"><input type="text" id="srcCliMob" placeholder="ğŸ” Cerca cliente..." oninput="renderCliMob()" style="width:100%"></div>
<div id="cliMobList"></div>
</div>

<!-- PAGE: MACCHINE -->
<div class="page" id="pgMacchine">
<div class="field" style="margin-bottom:12px"><input type="text" id="srcMacMob" placeholder="ğŸ” Cerca macchina..." oninput="renderMacMob()" style="width:100%"></div>
<div id="macMobList"></div>
</div>

<!-- PAGE: DOCUMENTI -->
<div class="page" id="pgDocumenti">
<div class="field" style="margin-bottom:12px"><input type="text" id="srcDocMob" placeholder="ğŸ” Cerca documento..." oninput="renderDocMob()" style="width:100%"></div>
<div id="docMobList"></div>
</div>

<!-- PAGE: MAPPA -->
<div class="page" id="pgMappa">
<div class="map-controls">
<button class="btn btn-sm btn-primary" id="mapFAll" onclick="mapFilter('all')">ğŸ“ Tutti</button>
<button class="btn btn-sm btn-outline" id="mapFToday" onclick="mapFilter('today')">ğŸ“‹ Oggi</button>
<button class="btn btn-sm btn-outline" id="mapFWeek" onclick="mapFilter('week')">ğŸ“… Settimana</button>
<button class="btn btn-sm btn-outline" id="mapFExport" onclick="exportGoogleMaps()" style="margin-left:auto">ğŸ—ºï¸ Google Maps</button>
</div>
<div class="card">
<div class="card-head"><h3>ğŸ—ºï¸ Mappa Giro Visite</h3><span id="mapInfo" style="font-size:.75rem;color:var(--gray)"></span></div>
<div class="card-body np"><div id="mapTec"></div></div>
</div>
</div>

<!-- PAGE: CALENDARIO -->
<div class="page" id="pgCalendario">
<div class="card" style="margin-bottom:12px">
<div class="card-head">
<button onclick="calMobileNav(-1)" style="background:none;border:none;font-size:1.2rem;cursor:pointer">â—€</button>
<h3 id="calMobTitle" style="flex:1;text-align:center;font-size:.9375rem">â€”</h3>
<button onclick="calMobileNav(1)" style="background:none;border:none;font-size:1.2rem;cursor:pointer">â–¶</button>
</div>
<div class="card-body">
<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;font-size:.75rem" id="calMobGrid"></div>
</div>
</div>
<div id="calMobDetail"></div>
</div>

<!-- PAGE: PROFILO -->
<div class="page" id="pgProfilo">
<div style="text-align:center;padding:24px 0 16px">
<div style="width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--dark),var(--c1));display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:1.5rem;font-weight:700;color:var(--white)" id="profAvatar">MC</div>
<h2 style="font-size:1.125rem;font-weight:700" id="profName">â€”</h2>
<p style="font-size:.8125rem;color:var(--gray)" id="profRole">â€”</p>
</div>
<div class="kpi-row" id="profKpi"></div>
<div class="card" id="profCard"></div>
<div style="padding:16px"><button class="btn btn-outline btn-block" onclick="logout()">ğŸšª Esci</button></div>
</div>

</main>

<!-- BOTTOM NAV -->
<nav class="bnav" id="bnav" style="display:none">
<button class="active" onclick="goPage('home')" data-p="home"><span class="ico">ğŸ </span>Home</button>
<button onclick="goPage('interventi')" data-p="interventi"><span class="ico">ğŸ“‹</span>Interventi</button>
<button onclick="goPage('urgenze')" data-p="urgenze"><span class="ico">ğŸš¨</span>Urgenze</button>
<button onclick="goPage('chat')" data-p="chat"><span class="ico">ğŸ’¬</span>Chat TG</button>
<button onclick="goPage('menu')" data-p="menu"><span class="ico">â‹¯</span>Menu</button>
</nav>

<!-- ==================== SHEETS ==================== -->

<!-- Sheet: Intervento Detail -->
<div class="sheet-overlay" id="shInt" onclick="if(event.target===this)closeSheet('shInt')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2 id="siTitle">Intervento</h2><button onclick="closeSheet('shInt')">âœ•</button></div>
<div class="sheet-body" id="siBody"></div>
</div>
</div>

<!-- Sheet: Complete Intervento -->
<div class="sheet-overlay" id="shCompleta" onclick="if(event.target===this)closeSheet('shCompleta')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>âœ… Completa Intervento</h2><button onclick="closeSheet('shCompleta')">âœ•</button></div>
<div class="sheet-body">
<input type="hidden" id="scId">
<div class="field-row">
<div class="field"><label>Km Percorsi</label><input type="number" id="scKm" placeholder="0" min="0" inputmode="decimal"></div>
<div class="field"><label>Ore Lavorate</label><input type="number" id="scOre" placeholder="0" step="0.5" min="0" inputmode="decimal"></div>
</div>
<div class="field"><label>Valutazione Cliente (1-10)</label><input type="number" id="scVoto" placeholder="â€”" min="1" max="10" inputmode="numeric"></div>
<div class="field"><label>Note Completamento</label><textarea id="scNote" rows="3" placeholder="Descrivi il lavoro svolto..."></textarea></div>
<div style="margin-top:12px">
<label style="font-weight:600;font-size:.8125rem;margin-bottom:8px;display:block">ğŸ“ Allegati</label>
<div style="display:flex;gap:8px;margin-bottom:8px">
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“· Foto<input type="file" accept="image/*" capture="environment" style="display:none" onchange="addAllegatoFile(this)"></label>
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“ File<input type="file" style="display:none" onchange="addAllegatoFile(this)"></label>
</div>
<div id="scAllegatiPreview" style="display:flex;flex-direction:column;gap:6px"></div>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shCompleta')" style="flex:1">Annulla</button>
<button class="btn btn-ok" onclick="completaInt()" style="flex:1">âœ… Conferma</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Urgenza Detail -->
<div class="sheet-overlay" id="shUrg" onclick="if(event.target===this)closeSheet('shUrg')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2 id="suTitle">Urgenza</h2><button onclick="closeSheet('shUrg')">âœ•</button></div>
<div class="sheet-body" id="suBody"></div>
</div>
</div>

<!-- Sheet: Nuovo Ordine -->
<div class="sheet-overlay" id="shOrdine" onclick="if(event.target===this)closeSheet('shOrdine')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸ“¦ Nuovo Ordine</h2><button onclick="closeSheet('shOrdine')">âœ•</button></div>
<div class="sheet-body">
<div class="field"><label>Codice Ricambio</label><input type="text" id="soCodice" placeholder="LY-12345"></div>
<div class="field"><label>Descrizione</label><input type="text" id="soDesc" placeholder="Descrizione pezzo"></div>
<div class="field-row">
<div class="field"><label>QuantitÃ </label><input type="number" id="soQta" value="1" min="1" inputmode="numeric"></div>
<div class="field"><label>Cliente</label><select id="soCliente"><option value="">â€”</option></select></div>
</div>
<div class="field"><label>Note</label><textarea id="soNote" rows="2"></textarea></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shOrdine')" style="flex:1">Annulla</button>
<button class="btn btn-warn" onclick="saveOrdine()" style="flex:1">ğŸ“¦ Crea</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Nuova Richiesta -->
<div class="sheet-overlay" id="shRichiesta" onclick="if(event.target===this)closeSheet('shRichiesta')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸ“ Nuova Richiesta</h2><button onclick="closeSheet('shRichiesta')">âœ•</button></div>
<div class="sheet-body">
<div class="field"><label>Tipo</label><select id="srTipo"><option value="ferie">Ferie</option><option value="permesso">Permesso</option><option value="cambio_turno">Cambio Turno</option><option value="malattia">Malattia</option><option value="generico">Generico</option></select></div>
<div class="field-row">
<div class="field"><label>Dal</label><input type="date" id="srDal"></div>
<div class="field"><label>Al</label><input type="date" id="srAl"></div>
</div>
<div class="field"><label>Motivo</label><textarea id="srMotivo" rows="3" placeholder="Motivo della richiesta..."></textarea></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shRichiesta')" style="flex:1">Annulla</button>
<button class="btn btn-primary" onclick="saveRichiesta()" style="flex:1">ğŸ“¤ Invia</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Nuova Trasferta -->
<div class="sheet-overlay" id="shTrasferta" onclick="if(event.target===this)closeSheet('shTrasferta')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸ§³ Nuova Trasferta</h2><button onclick="closeSheet('shTrasferta')">âœ•</button></div>
<div class="sheet-body">
<div class="field"><label>Destinazione (Cliente)</label><select id="stCliente"></select></div>
<div class="field"><label>Automezzo</label><select id="stAutomezzo"></select></div>
<div class="field-row">
<div class="field"><label>Dal</label><input type="date" id="stDal"></div>
<div class="field"><label>Al</label><input type="date" id="stAl"></div>
</div>
<div class="field"><label>Motivo</label><textarea id="stMotivo" rows="3" placeholder="Motivo della trasferta..."></textarea></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shTrasferta')" style="flex:1">Annulla</button>
<button class="btn btn-primary" onclick="saveTrasferta()" style="flex:1">ğŸ“¤ Invia</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Crea Urgenza (tecnico) -->
<div class="sheet-overlay" id="shCreaUrg" onclick="if(event.target===this)closeSheet('shCreaUrg')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>ğŸš¨ Crea Urgenza</h2><button onclick="closeSheet('shCreaUrg')">âœ•</button></div>
<div class="sheet-body">
<div style="background:#FEF3C7;padding:10px 14px;border-radius:var(--radius-sm);font-size:.8125rem;color:#92400E;margin-bottom:16px">âš ï¸ Le urgenze create dal tecnico vengono inviate con stato <strong>IN ATTESA</strong> di approvazione admin/caposquadra</div>
<div class="field"><label>Cliente</label><select id="suCliUrg"><option value="">â€” Seleziona â€”</option></select></div>
<div class="field"><label>Macchina</label><select id="suMacUrg"><option value="">â€” Seleziona â€”</option></select></div>
<div class="field"><label>PrioritÃ </label><select id="suPriUrg"></select></div>
<div class="field"><label>Problema</label><textarea id="suProbUrg" rows="4" placeholder="Descrivi il problema in dettaglio..."></textarea></div>
<div class="field"><label>Note aggiuntive</label><textarea id="suNoteUrg" rows="2" placeholder="Es. codice errore, foto fatta, etc."></textarea></div>
<div style="margin-top:12px">
<label style="font-weight:600;font-size:.8125rem;margin-bottom:8px;display:block">ğŸ“ Allegato (opzionale)</label>
<div style="display:flex;gap:8px">
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“· Foto<input type="file" accept="image/*" capture="environment" style="display:none" onchange="urgAllegatoChange(this)"></label>
<label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer">ğŸ“ File<input type="file" style="display:none" onchange="urgAllegatoChange(this)"></label>
</div>
<div id="urgAllegatoPreview" style="margin-top:8px"></div>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shCreaUrg')" style="flex:1">Annulla</button>
<button class="btn btn-err" onclick="saveUrgenzaTecnico()" style="flex:1">ğŸš¨ Invia Urgenza</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Modifica Intervento -->
<div class="sheet-overlay" id="shEditInt" onclick="if(event.target===this)closeSheet('shEditInt')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2>âœï¸ Modifica Intervento</h2><button onclick="closeSheet('shEditInt')">âœ•</button></div>
<div class="sheet-body">
<input type="hidden" id="eiId">
<div id="eiOwnNotice" style="display:none;background:#FEF3C7;padding:10px 14px;border-radius:var(--radius-sm);font-size:.8125rem;color:#92400E;margin-bottom:12px">âš ï¸ Non Ã¨ il tuo intervento â€” la modifica richiede approvazione admin</div>
<div class="field"><label>Note</label><textarea id="eiNote" rows="3" placeholder="Aggiorna le note..."></textarea></div>
<div class="field"><label>Stato</label><select id="eiStato"><option value="pianificato">ğŸ“… Pianificato</option><option value="in_corso">âš¡ In Corso</option></select></div>
<div class="field-row">
<div class="field"><label>Data</label><input type="date" id="eiData"></div>
<div class="field"><label>Ora Inizio</label><input type="time" id="eiOra"></div>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeSheet('shEditInt')" style="flex:1">Annulla</button>
<button class="btn btn-primary" onclick="saveEditInt()" style="flex:1">ğŸ’¾ Salva</button>
</div>
</div>
</div>
</div>

<!-- Sheet: Installazione Detail -->
<div class="sheet-overlay" id="shInstDet" onclick="if(event.target===this)closeSheet('shInstDet')">
<div class="sheet">
<div class="handle"></div>
<div class="sheet-head"><h2 id="instDetTitle">ğŸ”§ Installazione</h2><button onclick="closeSheet('shInstDet')">âœ•</button></div>
<div class="sheet-body" id="instDetBody"></div>
</div>
</div>

<script>
/* ============================================================
   SYNTONIQA TECNICO v2.0 â€” FULL JS
   Coerente 1:1 con admin_v1.html (API, nomi, strutture dati)
   ============================================================ */

// ============ STATE ============
let DATA={}, USER=null, intF='', scAllegatiFiles=[], mapTec=null;

// ============ CONFIG (da white_label_config.js) ============
const API_URL = (window.SYNTONIQA_CONFIG&&window.SYNTONIQA_CONFIG.api&&window.SYNTONIQA_CONFIG.api.url)
  || 'https://syntoniqa-api.YOUR_SUBDOMAIN.workers.dev';
const API_TOKEN = (window.SYNTONIQA_CONFIG&&window.SYNTONIQA_CONFIG.api&&window.SYNTONIQA_CONFIG.api.token)
  || 'FF_TOKEN_CAMBIA_QUESTO_IN_PRODUZIONE';

// ============ HELPERS (coerenti con admin_v1) ============
const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];
const fmtDate=d=>{if(!d)return'â€”';const p=String(d).substring(0,10).split('-');return p.length===3?p[2]+'/'+p[1]+'/'+p[0]:'â€”'};
const fmtDateTime=d=>{if(!d)return'â€”';try{return new Date(d).toLocaleString('it-IT',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}catch{return'â€”'}};
const fmtTime=d=>d?(d+'').substring(0,5):'â€”';

// getName â€” identica ad admin_v1
const getName=(list,id,field='Nome')=>{
  const o=(list||[]).find(x=>x.ID===id||x.CodiceM3===id);
  if(!o)return id||'â€”';
  if(field!=='Nome'&&o[field])return o[field];
  return(o.NomeInterno||o.NomeAccount||o.Nome||o.Descrizione||'')+(o.Cognome?' '+o.Cognome:'');
};
const getColor=(list,id)=>{const o=(list||[]).find(x=>x.ID===id);return o?.Colore||'#6B7280'};

// statusTag â€” identica ad admin_v1
function statusTag(stato){
  const m={'pianificato':['tag-info','ğŸ“…'],'in_corso':['tag-warn','âš¡'],'completato':['tag-ok','âœ…'],
    'aperta':['tag-err','ğŸ”´'],'assegnata':['tag-warn','ğŸ‘¤'],'schedulata':['tag-info','ğŸ“…'],'risolta':['tag-ok','âœ…'],
    'richiesto':['tag-info','ğŸ“'],'preso_in_carico':['tag-warn','ğŸ“‹'],'ordinato':['tag-warn','ğŸ“¦'],'in_arrivo':['tag-info','ğŸšš'],'arrivato':['tag-ok','âœ…'],
    'attiva':['tag-ok','âœ…'],'in_attesa':['tag-warn','â³'],'approvata':['tag-ok','âœ…'],'rifiutata':['tag-err','âŒ'],
    'chiuso':['tag-gray','ğŸ”’'],'da_rivedere':['tag-warn','âš ï¸'],'annullato':['tag-err','âŒ']};
  const x=m[stato]||['tag-gray',''];
  return'<span class="tag '+x[0]+'">'+x[1]+' '+(stato||'â€”')+'</span>';
}

function toast(m,t){const d=document.createElement('div');d.className='toast '+(t||'info');d.textContent=m;$('toasts').appendChild(d);setTimeout(()=>d.remove(),3500)}
function openSheet(id){$(id).classList.add('show')}
function closeSheet(id){$(id).classList.remove('show')}

// ============ NAVIGATION ============
function goPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav button').forEach(b=>b.classList.remove('active'));
  const pg=$('pg'+name.charAt(0).toUpperCase()+name.slice(1));
  if(pg)pg.classList.add('active');
  const btn=document.querySelector('.bnav button[data-p="'+name+'"]');
  if(btn)btn.classList.add('active');
  const t={'home':'ğŸ  Home','interventi':'ğŸ“‹ Interventi','urgenze':'ğŸš¨ Urgenze','ordini':'ğŸ“¦ Ordini','menu':'â‹¯ Menu',
    'chat':'ğŸ’¬ Chat Telegram','notifiche':'ğŸ”” Notifiche','richieste':'ğŸ“ Richieste','reperibilita':'ğŸ“ ReperibilitÃ ','trasferte':'ğŸ§³ Trasferte',
    'installazioni':'ğŸ”§ Installazioni','clienti':'ğŸ¢ Clienti','macchine':'âš™ï¸ Macchine','documenti':'ğŸ“ Documenti',
    'mappa':'ğŸ—ºï¸ Mappa Giro','calendario':'ğŸ“… Calendario','profilo':'ğŸ‘¤ Profilo'};
  $('hdrTitle').textContent=t[name]||name;
  window.scrollTo(0,0);
  if(name==='calendario')renderCalMobile();
  if(name==='mappa')setTimeout(initMap,200);
  if(name==='chat')initChat();
}

// ============ API (identica ad admin_v1) ============
async function apiCall(action,data,method){
  let url=API_URL,opts={};
  if(!method||method==='GET'){
    url+='?'+new URLSearchParams({action,token:API_TOKEN,...(data||{})});
  }else{
    opts={method:'POST',headers:{'Content-Type':'application/json','X-Token':API_TOKEN},body:JSON.stringify({action,userId:USER?.ID||'',...(data||{})})};
  }
  const r=await fetch(url,opts);
  const json=await r.json();
  if(!json.success)throw new Error(json.error||'Errore API');
  return json.data!==undefined?json.data:json;
}

async function refreshData(){
  try{
    DATA=await apiCall('getAll',{userId:USER?.ID||''});
    if(USER&&USER.ID){const fresh=(DATA.utenti||[]).find(x=>x.ID===USER.ID);if(fresh)USER={...fresh}}
    renderAll();
  }catch(e){toast('Errore: '+e.message,'err')}
}

// ============ AUTH ============
document.addEventListener('DOMContentLoaded',init);
async function init(){
  try{
    DATA=await apiCall('getAll');
    $('loginLoad').style.display='none';
    $('loginForm').style.display='block';
    const s=localStorage.getItem('sq2tec');
    if(s){const o=JSON.parse(s);const u=(DATA.utenti||[]).find(x=>x.ID===o.id);if(u){USER=u;enterApp()}}
  }catch(e){$('loginLoad').innerHTML='<div style="color:var(--err)">Errore connessione: '+e.message+'</div>'}
}

async function doLogin(e){
  e.preventDefault();
  $('btnLogin').disabled=true;$('loginErr').style.display='none';
  try{
    const r=await apiCall('login',{username:$('inpUser').value.trim(),password:$('inpPwd').value},'POST');
    if(!r.user)throw new Error('Credenziali non valide');
    USER=r.user;
    localStorage.setItem('sq2tec',JSON.stringify({id:USER.ID}));
    enterApp();
  }catch(e){$('loginErr').textContent=e.message;$('loginErr').style.display='block'}
  finally{$('btnLogin').disabled=false}
  return false;
}

function logout(){localStorage.removeItem('sq2tec');location.reload()}

function enterApp(){
  if(USER&&USER.ID){const full=(DATA.utenti||[]).find(x=>x.ID===USER.ID);if(full)USER={...full,...USER}}
  $('loginScreen').classList.add('hidden');
  $('hdr').style.display='flex';$('app').style.display='block';$('bnav').style.display='flex';
  $('hdrDate').textContent=new Date().toLocaleDateString('it-IT',{weekday:'short',day:'numeric',month:'short'});
  fillSelects();
  renderAll();
  setInterval(refreshData,120000);
}

function fillSelects(){
  const cls=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
  const furgoni=(DATA.automezzi||[]).filter(f=>!f.Obsoleto);
  // Ordine - cliente
  const s=$('soCliente');if(s){s.innerHTML='<option value="">â€”</option>';cls.forEach(c=>{const o=document.createElement('option');o.value=c.CodiceM3||c.ID;o.textContent=getName(DATA.clienti,c.ID);s.appendChild(o)})}
  // Trasferta - cliente
  const st=$('stCliente');if(st){st.innerHTML='<option value="">â€”</option>';cls.forEach(c=>{const o=document.createElement('option');o.value=c.CodiceM3||c.ID;o.textContent=getName(DATA.clienti,c.ID);st.appendChild(o)})}
  // Trasferta - automezzo
  const sa=$('stAutomezzo');if(sa){sa.innerHTML='<option value="">â€”</option>';furgoni.forEach(f=>{const o=document.createElement('option');o.value=f.ID;o.textContent=f.Descrizione||f.Targa||f.ID;sa.appendChild(o)})}
}

// ============ FILTRO MIEI ITEMS ============
function my(list){return(list||[]).filter(p=>!p.Obsoleto&&(p.TecnicoID===USER?.ID||p.TecnicoAssegnato===USER?.ID||(p.TecniciIDs||'').includes(USER?.ID)))}

// ============ RENDER ALL ============
function renderAll(){
  renderHome();renderInt();renderUrg();renderOrd();renderNot();renderRep();renderRich();renderTrasf();renderInst();renderCliMob();renderMacMob();renderDocMob();renderProf();updateBadges();
}

function updateBadges(){
  const nu=my(DATA.urgenze).filter(u=>u.Stato!=='risolta').length;
  const nn=(DATA.notifiche||[]).filter(n=>!n.Obsoleto&&n.Stato==='inviata'&&(n.DestinatarioID===USER?.ID||(n.DestinatariIDs||'').includes(USER?.ID))).length;
  const no=my(DATA.ordini).filter(o=>o.Stato!=='arrivato').length;
  document.querySelectorAll('.bnav .nbadge').forEach(b=>b.remove());
  if(nu>0){const b=document.querySelector('[data-p=urgenze]');if(b){const s=document.createElement('span');s.className='nbadge';s.textContent=nu;b.appendChild(s)}}
  if(no>0){const b=document.querySelector('[data-p=ordini]');if(b){const s=document.createElement('span');s.className='nbadge';s.textContent=no;b.appendChild(s)}}
  // Notifiche badge su header bell
  const nh=$('btnNotHdr');
  if(nh){nh.querySelectorAll('.nbadge').forEach(b=>b.remove());if(nn>0){const s=document.createElement('span');s.className='nbadge';s.style.cssText='position:absolute;top:-2px;right:-2px';s.textContent=nn;nh.appendChild(s)}}
}

// ============ HOME ============
function renderHome(){
  const d=today();
  const miei=my(DATA.piano);
  const oggi=miei.filter(p=>p.Data===d).sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||''));
  const urgA=my(DATA.urgenze).filter(u=>u.Stato!=='risolta');
  const reps=(DATA.reperibilita||[]).filter(r=>!r.Obsoleto&&r.Stato==='attiva'&&r.TecnicoID===USER?.ID&&r.DataInizio<=d&&r.DataFine>=d);

  $('homeKpi').innerHTML=
    '<div class="kpi-mini"><div class="val" style="color:var(--c3)">'+oggi.length+'</div><div class="lbl">ğŸ“‹ Oggi</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:'+(oggi.filter(p=>p.Stato==='completato').length===oggi.length&&oggi.length>0?'var(--ok)':'var(--warn)')+'">'+oggi.filter(p=>p.Stato==='completato').length+'/'+oggi.length+'</div><div class="lbl">âœ… Fatti</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:'+(urgA.length>0?'var(--err)':'var(--ok)')+'">'+urgA.length+'</div><div class="lbl">ğŸš¨ Urgenze</div></div>';

  $('homeList').innerHTML=oggi.length?oggi.map(p=>intItem(p)).join(''):'<div class="empty"><div class="ico">â˜€ï¸</div><p>Nessun intervento oggi</p></div>';

  if(urgA.length>0){
    $('homeUrgBox').style.display='';
    $('homeUrg').innerHTML=urgA.slice(0,3).map(u=>{
      const pc=getColor(DATA.priorita,u.PrioritaID);
      return '<div style="padding:10px 16px;border-bottom:1px solid #E5E7EB;cursor:pointer" onclick="showUrg(\''+u.ID+'\')">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:2px"><span class="tag" style="background:'+pc+'20;color:'+pc+'">'+getName(DATA.priorita,u.PrioritaID)+'</span>'+statusTag(u.Stato)+'</div>'+
        '<div style="font-weight:600;font-size:.875rem">'+getName(DATA.clienti,u.ClienteID)+'</div>'+
        '<div style="font-size:.75rem;color:var(--gray)">'+(u.Problema||'').substring(0,60)+'</div></div>';
    }).join('');
  }else{$('homeUrgBox').style.display='none'}

  if(reps.length>0){
    $('homeRepBox').style.display='';
    $('homeRep').innerHTML=reps.map(r=>'<div style="font-size:.875rem"><strong>ğŸ“ ReperibilitÃ  attiva</strong> Â· '+(r.Turno||'24h')+'<br><span style="font-size:.75rem;color:var(--gray)">'+fmtDate(r.DataInizio)+' â†’ '+fmtDate(r.DataFine)+'</span></div>').join('');
  }else{$('homeRepBox').style.display='none'}
}

// ============ INTERVENTI ============
function intItem(p){
  const cli=getName(DATA.clienti,p.ClienteID);
  const tipo=getName(DATA.tipiIntervento,p.TipoInterventoID);
  const tc=getColor(DATA.tipiIntervento,p.TipoInterventoID);
  const furg=getName(DATA.automezzi||[],p.AutomezzoID,'Descrizione');
  return '<div class="int-item" onclick="showInt(\''+p.ID+'\')">'+
    '<div class="time-block"><div class="time">'+fmtTime(p.OraInizio)+'</div><div class="date">'+fmtDate(p.Data).substring(0,5)+'</div></div>'+
    '<div class="info"><h4>'+cli+'</h4>'+
    '<p><span class="tag" style="background:'+tc+'20;color:'+tc+'">'+tipo+'</span>'+(furg&&furg!=='â€”'?' <span style="font-size:.65rem;color:var(--gray)">ğŸš '+furg+'</span>':'')+'</p>'+
    statusTag(p.Stato)+'</div><div class="arrow">â€º</div></div>';
}

function filtInt(s){
  intF=s;renderInt();
  ['fAll','fPian','fCorso','fComp'].forEach(id=>{const b=$(id);if(b)b.className=b.className.replace('btn-primary','btn-outline')});
  if(!s)$('fAll').className=$('fAll').className.replace('btn-outline','btn-primary');
  else if(s==='pianificato')$('fPian').className=$('fPian').className.replace('btn-outline','btn-primary');
  else if(s==='in_corso')$('fCorso').className=$('fCorso').className.replace('btn-outline','btn-primary');
  else if(s==='completato')$('fComp').className=$('fComp').className.replace('btn-outline','btn-primary');
}

function renderInt(){
  let items=my(DATA.piano);
  if(intF)items=items.filter(p=>p.Stato===intF);
  items.sort((a,b)=>(b.Data||'').localeCompare(a.Data||'')||(a.OraInizio||'').localeCompare(b.OraInizio||''));
  $('intList').innerHTML=items.length?items.map(p=>intItem(p)).join(''):'<div class="empty"><div class="ico">ğŸ“‹</div><p>Nessun intervento</p></div>';
}

function showInt(id){
  const p=(DATA.piano||[]).find(x=>x.ID===id);if(!p)return;
  const cli=getName(DATA.clienti,p.ClienteID);
  const cObj=(DATA.clienti||[]).find(c=>c.ID===p.ClienteID||c.CodiceM3===p.ClienteID);
  const mac=(DATA.macchine||[]).find(m=>m.ID===p.MacchinaID);
  const furg=getName(DATA.automezzi||[],p.AutomezzoID,'Descrizione');
  $('siTitle').textContent=cli;
  $('siBody').innerHTML=
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'+
    '<span style="font-size:1.5rem;font-weight:700;color:var(--c1)">'+fmtTime(p.OraInizio)+'</span>'+statusTag(p.Stato)+'</div>'+
    '<div style="font-size:.9375rem;font-weight:600;margin-bottom:4px">'+fmtDate(p.Data)+'</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0;font-size:.8125rem">'+
    '<div><span style="color:var(--gray)">Tipo</span><br><strong>'+getName(DATA.tipiIntervento,p.TipoInterventoID)+'</strong></div>'+
    '<div><span style="color:var(--gray)">PrioritÃ </span><br><strong>'+getName(DATA.priorita,p.PrioritaID)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Macchina</span><br><strong>'+(mac?mac.Tipo+' '+mac.Modello:'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Furgone</span><br><strong>'+furg+'</strong></div>'+
    '<div><span style="color:var(--gray)">Km / Ore</span><br><strong>'+(p.KmPercorsi||'â€”')+' / '+(p.OreLavorate||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Durata stimata</span><br><strong>'+(p.DurataOre||'â€”')+'h</strong></div>'+
    '</div>'+
    (p.Note?'<div style="margin-bottom:12px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm);font-size:.8125rem">'+p.Note+'</div></div>':'')+
    (p.NoteCompletamento?'<div style="margin-bottom:12px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note completamento</div><div style="background:#D1FAE5;padding:12px;border-radius:var(--radius-sm);font-size:.8125rem">'+p.NoteCompletamento+'</div></div>':'')+
    '<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">'+
    (cObj?.Telefono?'<a href="tel:'+cObj.Telefono+'" class="btn btn-outline">ğŸ“ Chiama '+cObj.Telefono+'</a>':'')+
    (cObj?.Latitudine&&cObj?.Longitudine?'<a href="https://www.google.com/maps/dir/?api=1&destination='+cObj.Latitudine+','+cObj.Longitudine+'&travelmode=driving" target="_blank" class="btn btn-outline">ğŸ“ Naviga</a>':'')+
    (p.Stato==='pianificato'?'<button class="btn btn-warn" onclick="startInt(\''+id+'\')">âš¡ Inizia Intervento</button>':'')+
    (p.Stato==='in_corso'?'<button class="btn btn-ok" onclick="closeSheet(\'shInt\');openCompleta(\''+id+'\')">âœ… Completa Intervento</button>':'')+
    (p.Stato!=='completato'?'<button class="btn btn-outline" onclick="openEditInt(\''+id+'\')">âœï¸ Modifica Intervento</button>':'')+
    '</div>';
  openSheet('shInt');
}

async function startInt(id){
  try{await apiCall('updatePiano',{id,data:{Stato:'in_corso'}},'POST');toast('Intervento iniziato','ok');closeSheet('shInt');await refreshData()}catch(e){toast(e.message,'err')}
}

function openCompleta(id){
  $('scId').value=id;$('scKm').value='';$('scOre').value='';$('scVoto').value='';$('scNote').value='';scAllegatiFiles=[];$('scAllegatiPreview').innerHTML='';
  openSheet('shCompleta');
}

async function completaInt(){
  try{
    const interventoId=$('scId').value;
    const voto=parseInt($('scVoto').value)||null;
    if(voto&&(voto<1||voto>10)){toast('Voto deve essere tra 1 e 10','warn');return}
    const data={Stato:'completato',KmPercorsi:parseFloat($('scKm').value)||0,OreLavorate:parseFloat($('scOre').value)||0,NoteCompletamento:$('scNote').value,ValutazioneCliente:voto};
    await apiCall('updatePiano',{id:interventoId,data},'POST');
    for(const af of scAllegatiFiles){
      if(!af)continue;
      try{
        const up=await apiCall('uploadFile',{base64:af.base64,mimeType:af.type,fileName:af.name,userId:USER?.ID},'POST');
        if(up&&up.fileUrl) await apiCall('createAllegato',{Nome:af.name,FileURL:up.fileUrl,FileID:up.fileId,MimeType:af.type,DimensioneKB:af.sizeKB,RiferimentoTipo:'piano',RiferimentoID:interventoId},'POST');
      }catch(e){}
    }
    toast('Intervento completato!','ok');closeSheet('shCompleta');await refreshData();
  }catch(e){toast(e.message,'err')}
}

function addAllegatoFile(input){
  const file=input.files[0];if(!file)return;
  if(file.size>20*1024*1024){toast('File troppo grande (max 20MB)','err');input.value='';return}
  const reader=new FileReader();
  reader.onload=function(){
    const base64=reader.result.split(',')[1];
    const idx=scAllegatiFiles.length;
    scAllegatiFiles.push({base64,type:file.type,name:file.name,sizeKB:Math.round(file.size/1024)});
    const isImg=file.type.startsWith('image/');
    const prev=document.createElement('div');
    prev.style.cssText='display:flex;align-items:center;gap:8px;padding:8px 10px;background:#F9FAFB;border-radius:8px';
    prev.innerHTML=(isImg?'<img src="'+reader.result+'" style="width:40px;height:40px;border-radius:6px;object-fit:cover">':'<span>ğŸ“„</span>')+
      '<div style="flex:1;min-width:0"><div style="font-size:.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+file.name+'</div><div style="font-size:.7rem;color:var(--gray)">'+Math.round(file.size/1024)+' KB</div></div>'+
      '<button onclick="rmAllegato('+idx+',this.parentElement)" style="background:none;border:none;color:var(--err);cursor:pointer">âœ•</button>';
    $('scAllegatiPreview').appendChild(prev);
    input.value='';
  };
  reader.readAsDataURL(file);
}
function rmAllegato(idx,el){scAllegatiFiles[idx]=null;el.remove()}

// ============ URGENZE ============
function renderUrg(){
  const items=my(DATA.urgenze).sort((a,b)=>{const o={'breach':0,'critical':1,'warning':2,'ok':3,'':4};return(o[a.SLAStatus]||4)-(o[b.SLAStatus]||4)});
  const aperte=items.filter(u=>u.Stato!=='risolta');
  const risolte=items.filter(u=>u.Stato==='risolta').slice(0,5);
  let h='';
  if(aperte.length){
    h+=aperte.map(u=>{
      const pc=getColor(DATA.priorita,u.PrioritaID);
      return '<div class="card" style="border-left:4px solid '+pc+'" onclick="showUrg(\''+u.ID+'\')"><div class="card-body">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span class="tag" style="background:'+pc+'20;color:'+pc+'">'+getName(DATA.priorita,u.PrioritaID)+'</span>'+statusTag(u.Stato)+'</div>'+
        '<div style="font-weight:600;margin-bottom:2px">'+getName(DATA.clienti,u.ClienteID)+'</div>'+
        '<div style="font-size:.8125rem;color:var(--gray);margin-bottom:4px">'+(u.Problema||'').substring(0,80)+'</div>'+
        (u.SLAStatus&&u.SLAStatus!=='ok'?'<div style="font-size:.7rem;color:var(--err)">SLA: '+u.SLAStatus+'</div>':'')+
        '</div></div>';
    }).join('');
  }else{h+='<div class="empty"><div class="ico">ğŸ‰</div><p>Nessuna urgenza aperta</p></div>'}
  if(risolte.length){
    h+='<div style="font-size:.75rem;color:var(--gray);font-weight:600;margin:16px 0 8px">Risolte di recente</div>';
    h+=risolte.map(u=>'<div class="card" style="opacity:.7" onclick="showUrg(\''+u.ID+'\')"><div class="card-body" style="padding:10px 16px;display:flex;justify-content:space-between"><span>'+getName(DATA.clienti,u.ClienteID)+'</span>'+statusTag(u.Stato)+'</div></div>').join('');
  }
  $('urgList').innerHTML=h;
}

function showUrg(id){
  const u=(DATA.urgenze||[]).find(x=>x.ID===id);if(!u)return;
  const cObj=(DATA.clienti||[]).find(c=>c.ID===u.ClienteID||c.CodiceM3===u.ClienteID);
  $('suTitle').textContent='ğŸš¨ '+getName(DATA.clienti,u.ClienteID);
  $('suBody').innerHTML=
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem;margin-bottom:16px">'+
    '<div><span style="color:var(--gray)">PrioritÃ </span><br><span class="tag" style="background:'+getColor(DATA.priorita,u.PrioritaID)+'20;color:'+getColor(DATA.priorita,u.PrioritaID)+'">'+getName(DATA.priorita,u.PrioritaID)+'</span></div>'+
    '<div><span style="color:var(--gray)">Stato</span><br>'+statusTag(u.Stato)+'</div>'+
    '<div><span style="color:var(--gray)">Macchina</span><br><strong>'+getName(DATA.macchine,u.MacchinaID)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Segnalata</span><br><strong>'+fmtDateTime(u.DataSegnalazione)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Data Prevista</span><br><strong>'+fmtDate(u.DataPrevista)+'</strong></div>'+
    '<div><span style="color:var(--gray)">SLA</span><br><strong style="color:'+(u.SLAStatus==='ok'?'var(--ok)':'var(--err)')+'">'+( u.SLAStatus||'â€”')+'</strong></div>'+
    '</div>'+
    '<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Problema</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+(u.Problema||'â€”')+'</div></div>'+
    (u.Note?'<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+u.Note+'</div></div>':'')+
    '<div style="display:flex;flex-direction:column;gap:8px">'+
    (cObj?.Telefono?'<a href="tel:'+cObj.Telefono+'" class="btn btn-outline">ğŸ“ Chiama '+cObj.Telefono+'</a>':'')+
    (cObj?.Latitudine&&cObj?.Longitudine?'<a href="https://www.google.com/maps/dir/?api=1&destination='+cObj.Latitudine+','+cObj.Longitudine+'&travelmode=driving" target="_blank" class="btn btn-outline">ğŸ“ Naviga</a>':'')+
    '<button class="btn btn-outline" onclick="closeSheet(\'shUrg\')">Chiudi</button></div>';
  openSheet('shUrg');
}

// ============ ORDINI ============
function renderOrd(){
  const items=my(DATA.ordini).sort((a,b)=>(b.DataRichiesta||'').localeCompare(a.DataRichiesta||''));
  $('ordList').innerHTML=items.length?items.map(o=>{
    const sts=['richiesto','preso_in_carico','ordinato','in_arrivo','arrivato'];
    const ix=sts.indexOf(o.Stato);
    const wf='<div style="display:flex;gap:4px;margin:6px 0">'+sts.map((s,i)=>'<div class="wf-dot'+(i<ix?' done':i===ix?' active':'')+'"></div>').join('')+'</div>';
    return '<div class="card"><div class="card-body">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+(o.Codice||'â€”')+'</strong>'+statusTag(o.Stato)+'</div>'+
      '<div style="font-size:.8125rem;color:var(--gray)">'+(o.Descrizione||'â€”')+' Â· Q: '+(o.Quantita||1)+'</div>'+wf+
      '<div style="font-size:.75rem;color:var(--gray)">Richiesto: '+fmtDate(o.DataRichiesta)+'</div>'+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ“¦</div><p>Nessun ordine</p></div>';
}

async function saveOrdine(){
  try{
    const data={Codice:$('soCodice').value,Descrizione:$('soDesc').value||$('soCodice').value||'Ordine ricambio',Quantita:parseInt($('soQta').value)||1,ClienteID:$('soCliente').value,Note:$('soNote').value,TecnicoID:USER?.ID};
    if(!data.Codice){toast('Inserisci codice ricambio','warn');return}
    await apiCall('createOrdine',{data},'POST');
    toast('Ordine creato!','ok');closeSheet('shOrdine');
    $('soCodice').value='';$('soDesc').value='';$('soNote').value='';
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ NOTIFICHE ============
function renderNot(){
  const items=(DATA.notifiche||[]).filter(n=>!n.Obsoleto&&(n.DestinatarioID===USER?.ID||(n.DestinatariIDs||'').includes(USER?.ID))).sort((a,b)=>(b.DataInvio||'').localeCompare(a.DataInvio||''));
  $('notList').innerHTML=items.length?items.map(n=>{
    const unread=n.Stato==='inviata';
    return '<div class="notif-item'+(unread?' unread':'')+'"><div class="dot-n'+(unread?'':' read')+'"></div><div class="n-info">'+
      '<div style="display:flex;justify-content:space-between"><strong style="font-size:.875rem">'+(n.Oggetto||n.Tipo||'Notifica')+'</strong><span style="font-size:.6875rem;color:var(--gray)">'+fmtDateTime(n.DataInvio)+'</span></div>'+
      '<div style="font-size:.8125rem;color:var(--gray);margin-top:2px">'+(n.Testo||'').substring(0,100)+'</div>'+
      (unread?'<button class="btn btn-sm btn-ok" style="margin-top:8px" onclick="markNot(\''+n.ID+'\')">âœ… Ricevuta</button>':'')+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ””</div><p>Nessuna notifica</p></div>';
}

async function markNot(id){try{await apiCall('markNotifica',{id,azione:'presa_in_carico'},'POST');toast('Notifica confermata','ok');await refreshData()}catch(e){toast(e.message,'err')}}
async function markAllRead(){try{await apiCall('markAllRead',{},'POST');toast('Tutte lette','ok');await refreshData()}catch(e){toast(e.message,'err')}}

// ============ REPERIBILITA ============
function renderRep(){
  const items=(DATA.reperibilita||[]).filter(r=>!r.Obsoleto&&r.TecnicoID===USER?.ID).sort((a,b)=>(b.DataInizio||'').localeCompare(a.DataInizio||''));
  $('repList').innerHTML=items.length?items.map(r=>{
    const active=r.Stato==='attiva'&&r.DataInizio<=today()&&r.DataFine>=today();
    return '<div class="card" '+(active?'style="border-left:4px solid var(--ok)"':'')+'><div class="card-body">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+(r.Turno||'24h')+'</strong>'+statusTag(r.Stato)+'</div>'+
      '<div style="font-size:.875rem">ğŸ“… '+fmtDate(r.DataInizio)+' â†’ '+fmtDate(r.DataFine)+'</div>'+
      (active?'<div style="margin-top:6px"><span class="tag tag-ok">ğŸŸ¢ Attualmente attiva</span></div>':'')+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ“</div><p>Nessun turno</p></div>';
}

// ============ RICHIESTE ============
function renderRich(){
  const items=(DATA.richieste||[]).filter(r=>!r.Obsoleto&&r.TecnicoID===USER?.ID).sort((a,b)=>(b.DataRichiesta||'').localeCompare(a.DataRichiesta||''));
  $('richList').innerHTML=items.length?items.map(r=>'<div class="card"><div class="card-body">'+
    '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+(r.Tipo||'â€”')+'</strong>'+statusTag(r.Stato)+'</div>'+
    '<div style="font-size:.875rem">ğŸ“… '+fmtDate(r.DataInizio)+(r.DataFine?' â†’ '+fmtDate(r.DataFine):'')+'</div>'+
    '<div style="font-size:.8125rem;color:var(--gray);margin-top:4px">'+(r.Motivo||'â€”')+'</div>'+
    '</div></div>').join(''):'<div class="empty"><div class="ico">ğŸ“</div><p>Nessuna richiesta</p></div>';
}

async function saveRichiesta(){
  try{
    const data={TecnicoID:USER?.ID,Tipo:$('srTipo').value,DataInizio:$('srDal').value,DataFine:$('srAl').value,Motivo:$('srMotivo').value};
    if(!data.DataInizio){toast('Inserisci data inizio','warn');return}
    await apiCall('createRichiesta',{data},'POST');
    toast('Richiesta inviata!','ok');closeSheet('shRichiesta');
    $('srDal').value='';$('srAl').value='';$('srMotivo').value='';
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ TRASFERTE ============
function renderTrasf(){
  const items=(DATA.trasferte||[]).filter(t=>!t.Obsoleto&&(t.TecnicoID===USER?.ID||(t.TecniciIDs||'').includes(USER?.ID))).sort((a,b)=>(b.DataInizio||'').localeCompare(a.DataInizio||''));
  $('trasfList').innerHTML=items.length?items.map(t=>{
    const active=t.Stato!=='completata'&&t.DataInizio<=today()&&(t.DataFine||'9999')>=today();
    return '<div class="card" '+(active?'style="border-left:4px solid var(--c1)"':'')+'><div class="card-body">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+getName(DATA.clienti,t.ClienteID)+'</strong>'+statusTag(t.Stato)+'</div>'+
      '<div style="font-size:.875rem">ğŸ“… '+fmtDate(t.DataInizio)+' â†’ '+fmtDate(t.DataFine)+'</div>'+
      (t.Motivo?'<div style="font-size:.8125rem;color:var(--gray);margin-top:4px">'+t.Motivo+'</div>':'')+
      (active?'<div style="margin-top:6px"><span class="tag tag-warn">ğŸ§³ In trasferta adesso</span></div>':'')+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ§³</div><p>Nessuna trasferta</p></div>';
}

async function saveTrasferta(){
  try{
    const data={TecnicoID:USER?.ID,ClienteID:$('stCliente').value,AutomezzoID:$('stAutomezzo').value,DataInizio:$('stDal').value,DataFine:$('stAl').value,Motivo:$('stMotivo').value};
    if(!data.DataInizio){toast('Inserisci data inizio','warn');return}
    await apiCall('createTrasferta',{data},'POST');
    toast('Trasferta inviata!','ok');closeSheet('shTrasferta');
    $('stDal').value='';$('stAl').value='';$('stMotivo').value='';
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ INSTALLAZIONI ============
function renderInst(){
  const items=(DATA.installazioni||[]).filter(i=>!i.Obsoleto).sort((a,b)=>(b.DataInizio||'').localeCompare(a.DataInizio||''));
  const el=$('instList');if(!el)return;
  el.innerHTML=items.length?items.map(i=>{
    const cli=getName(DATA.clienti,i.ClienteID);
    const mac=getName(DATA.macchine,i.MacchinaID);
    const avz=i.Avanzamento||0;
    return '<div class="card" style="cursor:pointer" onclick="showInstDetail(\''+i.ID+'\')"><div class="card-body">'+
      '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>'+cli+'</strong>'+statusTag(i.Stato)+'</div>'+
      '<div style="font-size:.8125rem;color:var(--gray)">'+mac+'</div>'+
      '<div style="display:flex;align-items:center;gap:8px;margin-top:6px"><div style="flex:1;height:6px;background:var(--gray4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+avz+'%;background:var(--ok);border-radius:3px"></div></div><span style="font-size:.7rem;font-weight:600;color:var(--gray)">'+avz+'%</span></div>'+
      '<div style="font-size:.75rem;color:var(--gray);margin-top:4px">ğŸ“… '+fmtDate(i.DataInizio)+(i.DataFine?' â†’ '+fmtDate(i.DataFine):'')+' <span style="color:var(--gray3)">â€º</span></div>'+
      '</div></div>';
  }).join(''):'<div class="empty"><div class="ico">ğŸ”§</div><p>Nessuna installazione</p></div>';
}

// ============ CLIENTI ============
function renderCliMob(){
  const q=($('srcCliMob')?.value||'').toLowerCase();
  const items=(DATA.clienti||[]).filter(c=>!c.Obsoleto&&(!q||(c.NomeInterno||c.NomeAccount||c.Nome||'').toLowerCase().includes(q)||(c.Citta||'').toLowerCase().includes(q)));
  $('cliMobList').innerHTML=items.length?items.map(c=>'<div class="card" onclick="showCliDetail(\''+c.ID+'\')"><div class="card-body" style="padding:12px 16px"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+getName(DATA.clienti,c.ID)+'</strong><div style="font-size:.8125rem;color:var(--gray)">'+(c.Citta||'')+(c.Prov?' ('+c.Prov+')':'')+'</div></div><span style="color:var(--gray3)">â€º</span></div></div></div>').join(''):'<div class="empty"><div class="ico">ğŸ¢</div><p>Nessun cliente</p></div>';
}

function showCliDetail(id){
  const c=(DATA.clienti||[]).find(x=>x.ID===id||x.CodiceM3===id);if(!c)return;
  const interventi=(DATA.piano||[]).filter(p=>!p.Obsoleto&&p.ClienteID===id).sort((a,b)=>(b.Data||'').localeCompare(a.Data||'')).slice(0,5);
  $('suTitle').textContent='ğŸ¢ '+getName(DATA.clienti,c.ID);
  $('suBody').innerHTML=
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem;margin-bottom:16px">'+
    '<div><span style="color:var(--gray)">CittÃ </span><br><strong>'+(c.Citta||'â€”')+(c.Prov?' ('+c.Prov+')':'')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Telefono</span><br><strong>'+(c.Telefono||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Email</span><br><strong>'+(c.Email||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Contratto</span><br><strong>'+(c.Contratto||'â€”')+'</strong></div>'+
    '</div>'+
    (c.Note?'<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+c.Note+'</div></div>':'')+
    '<div style="font-weight:600;font-size:.8125rem;margin-bottom:8px">Ultimi interventi</div>'+
    (interventi.length?interventi.map(p=>'<div style="padding:8px 12px;border-left:3px solid '+getColor(DATA.tipiIntervento,p.TipoInterventoID)+';margin-bottom:6px;background:var(--gray5);border-radius:0 var(--radius-sm) var(--radius-sm) 0;font-size:.8125rem"><strong>'+fmtDate(p.Data)+'</strong> '+getName(DATA.tipiIntervento,p.TipoInterventoID)+' '+statusTag(p.Stato)+'</div>').join(''):'<div style="font-size:.8125rem;color:var(--gray)">Nessun intervento</div>')+
    '<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">'+
    (c.Telefono?'<a href="tel:'+c.Telefono+'" class="btn btn-outline">ğŸ“ Chiama</a>':'')+
    (c.Latitudine&&c.Longitudine?'<a href="https://www.google.com/maps/dir/?api=1&destination='+c.Latitudine+','+c.Longitudine+'&travelmode=driving" target="_blank" class="btn btn-outline">ğŸ“ Naviga</a>':'')+
    '<button class="btn btn-outline" onclick="closeSheet(\'shUrg\')">Chiudi</button></div>';
  openSheet('shUrg');
}

// ============ MACCHINE ============
function renderMacMob(){
  const q=($('srcMacMob')?.value||'').toLowerCase();
  const items=(DATA.macchine||[]).filter(m=>!m.Obsoleto&&(!q||(m.Tipo||'').toLowerCase().includes(q)||(m.Modello||'').toLowerCase().includes(q)||(m.Seriale||'').toLowerCase().includes(q)));
  $('macMobList').innerHTML=items.length?items.map(m=>{
    const gar=m.GaranziaFino&&m.GaranziaFino>=today();
    return '<div class="card" onclick="showMacDetail(\''+m.ID+'\')"><div class="card-body" style="padding:12px 16px"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+(m.Tipo||'â€”')+' '+(m.Modello||'')+'</strong><div style="font-size:.8125rem;color:var(--gray)">S/N: '+(m.Seriale||'â€”')+' Â· '+getName(DATA.clienti,m.ClienteID)+'</div></div>'+(gar?'<span class="tag tag-ok">âœ… Garanzia</span>':'')+'</div></div></div>';
  }).join(''):'<div class="empty"><div class="ico">âš™ï¸</div><p>Nessuna macchina</p></div>';
}

function showMacDetail(id){
  const m=(DATA.macchine||[]).find(x=>x.ID===id);if(!m)return;
  const cli=(DATA.clienti||[]).find(c=>c.ID===m.ClienteID||c.CodiceM3===m.ClienteID);
  const interventi=(DATA.piano||[]).filter(p=>!p.Obsoleto&&p.MacchinaID===id).sort((a,b)=>(b.Data||'').localeCompare(a.Data||'')).slice(0,5);
  $('suTitle').textContent='âš™ï¸ '+(m.Tipo||'')+' '+(m.Modello||'');
  $('suBody').innerHTML=
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem;margin-bottom:16px">'+
    '<div><span style="color:var(--gray)">Tipo</span><br><strong>'+(m.Tipo||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Modello</span><br><strong>'+(m.Modello||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Seriale</span><br><strong>'+(m.Seriale||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Anno</span><br><strong>'+(m.AnnoInstallazione||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Cliente</span><br><strong>'+(cli?getName(DATA.clienti,cli.ID):'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Garanzia</span><br><strong>'+(m.GaranziaFino?fmtDate(m.GaranziaFino):'â€”')+'</strong></div>'+
    '</div>'+
    (m.Note?'<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+m.Note+'</div></div>':'')+
    '<div style="font-weight:600;font-size:.8125rem;margin-bottom:8px">Ultimi interventi</div>'+
    (interventi.length?interventi.map(p=>'<div style="padding:8px 12px;border-left:3px solid '+getColor(DATA.tipiIntervento,p.TipoInterventoID)+';margin-bottom:6px;background:var(--gray5);border-radius:0 var(--radius-sm) var(--radius-sm) 0;font-size:.8125rem"><strong>'+fmtDate(p.Data)+'</strong> '+getName(DATA.tipiIntervento,p.TipoInterventoID)+'</div>').join(''):'<div style="font-size:.8125rem;color:var(--gray)">Nessun intervento</div>')+
    '<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">'+
    (cli?.Telefono?'<a href="tel:'+cli.Telefono+'" class="btn btn-outline">ğŸ“ Chiama cliente</a>':'')+
    '<button class="btn btn-outline" onclick="closeSheet(\'shUrg\')">Chiudi</button></div>';
  openSheet('shUrg');
}

// ============ DOCUMENTI ============
function renderDocMob(){
  const docs=(DATA.documenti||[]).filter(d=>!d.Obsoleto&&(d.Pubblico===true||d.Pubblico==='true'));
  const q=($('srcDocMob')?.value||'').toLowerCase();
  const filtered=docs.filter(d=>!q||(d.Nome||'').toLowerCase().includes(q)||(d.Tags||'').toLowerCase().includes(q)).sort((a,b)=>(b.DataCaricamento||'').localeCompare(a.DataCaricamento||''));
  $('docMobList').innerHTML=filtered.length?filtered.map(d=>'<div class="card"><div class="card-body"><div style="display:flex;justify-content:space-between;align-items:center"><div style="flex:1"><strong>'+(d.Nome||'â€”')+'</strong><div style="font-size:.75rem;color:var(--gray)">ğŸ“… '+fmtDate(d.DataCaricamento)+(d.DimensioneKB?' Â· '+d.DimensioneKB+'KB':'')+'</div></div><a href="'+(d.FileURL||'#')+'" target="_blank" style="color:var(--c1);text-decoration:none;font-size:1.25rem;padding:8px">â†“</a></div></div></div>').join(''):'<div class="empty"><div class="ico">ğŸ“</div><p>Nessun documento</p></div>';
}

// ============ MAPPA GIRO VISITE (Leaflet) ============
let mapFilterMode='today', mapMarkers=[], mapRouteLine=null, mapRouteStops=[];

function initMap(){
  if(mapTec){mapTec.invalidateSize();renderMapMarkers();return}
  const el=$('mapTec');if(!el)return;
  mapTec=L.map('mapTec').setView([44.65,10.92],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(mapTec);
  renderMapMarkers();
}

function mapFilter(mode){
  mapFilterMode=mode;
  ['mapFAll','mapFToday','mapFWeek'].forEach(id=>{const b=$(id);if(b)b.className=b.className.replace('btn-primary','btn-outline')});
  const btn=$('mapF'+mode.charAt(0).toUpperCase()+mode.slice(1));
  if(btn)btn.className=btn.className.replace('btn-outline','btn-primary');
  renderMapMarkers();
}

function renderMapMarkers(){
  if(!mapTec)return;
  // Pulisci
  mapMarkers.forEach(m=>mapTec.removeLayer(m));mapMarkers=[];
  if(mapRouteLine){mapTec.removeLayer(mapRouteLine);mapRouteLine=null}
  mapRouteStops=[];

  const todayStr=today();
  const miei=my(DATA.piano);
  let pianoFiltered=[];

  if(mapFilterMode==='today'){
    pianoFiltered=miei.filter(p=>p.Data===todayStr);
  }else if(mapFilterMode==='week'){
    const d=new Date();const weekStart=new Date(d);weekStart.setDate(d.getDate()-d.getDay()+1);
    const ws=weekStart.toISOString().split('T')[0];
    const we=new Date(weekStart);we.setDate(we.getDate()+6);const wes=we.toISOString().split('T')[0];
    pianoFiltered=miei.filter(p=>p.Data>=ws&&p.Data<=wes);
  }else{
    pianoFiltered=miei;
  }

  // Ordina per ora
  pianoFiltered.sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||''));

  // Raccogli coordinate con info
  const stops=[];
  pianoFiltered.forEach((p,idx)=>{
    const c=(DATA.clienti||[]).find(c=>c.ID===p.ClienteID||c.CodiceM3===p.ClienteID);
    if(c&&c.Latitudine&&c.Longitudine){
      stops.push({lat:c.Latitudine,lng:c.Longitudine,name:getName(DATA.clienti,c.ID),piano:p,num:stops.length+1,cliente:c});
    }
  });

  // Anche clienti senza interventi filtrati (solo in "tutti")
  if(mapFilterMode==='all'){
    const clientiConInt=new Set(stops.map(s=>s.cliente.ID));
    const altriClienti=(DATA.clienti||[]).filter(c=>!c.Obsoleto&&c.Latitudine&&c.Longitudine&&!clientiConInt.has(c.ID));
    altriClienti.forEach(c=>{
      const m=L.circleMarker([c.Latitudine,c.Longitudine],{radius:4,fillColor:'#9CA3AF',color:'#9CA3AF',weight:1,fillOpacity:.5}).addTo(mapTec);
      m.bindPopup('<strong>'+getName(DATA.clienti,c.ID)+'</strong><br><span style="color:var(--gray)">'+(c.Citta||'')+'</span>');
      mapMarkers.push(m);
    });
  }

  // Markers numerati per le tappe
  stops.forEach(s=>{
    const icon=L.divIcon({
      className:'',
      html:'<div class="route-num">'+s.num+'</div>',
      iconSize:[24,24],iconAnchor:[12,12]
    });
    const m=L.marker([s.lat,s.lng],{icon}).addTo(mapTec);
    const p=s.piano;
    m.bindPopup(
      '<div style="min-width:160px"><strong>'+s.num+'. '+s.name+'</strong><br>'+
      '<span style="font-size:.8rem">ğŸ• '+(p.OraInizio||'â€”')+' Â· '+getName(DATA.tipiIntervento,p.TipoInterventoID)+'</span><br>'+
      statusTag(p.Stato)+
      '<br><a href="https://www.google.com/maps/dir/?api=1&destination='+s.lat+','+s.lng+'&travelmode=driving" target="_blank" style="color:#C30A14;font-size:.8rem;font-weight:600">ğŸ“ Naviga qui</a></div>'
    );
    mapMarkers.push(m);
  });

  // Polyline route
  if(stops.length>=2){
    const coords=stops.map(s=>[s.lat,s.lng]);
    mapRouteLine=L.polyline(coords,{color:'#C30A14',weight:3,opacity:.7,dashArray:'8,8'}).addTo(mapTec);
    mapMarkers.push(mapRouteLine);
  }

  mapRouteStops=stops;

  // Info
  $('mapInfo').textContent=stops.length+' tappe'+(mapFilterMode==='today'?' oggi':mapFilterMode==='week'?' settimana':'');

  // Fit bounds
  const allPts=stops.map(s=>[s.lat,s.lng]);
  if(allPts.length){mapTec.fitBounds(allPts,{padding:[30,30]})}
  else if(mapFilterMode!=='all'){
    // Nessuna tappa, mostra tutti i clienti
    const allCli=(DATA.clienti||[]).filter(c=>!c.Obsoleto&&c.Latitudine&&c.Longitudine);
    if(allCli.length){mapTec.fitBounds(allCli.map(c=>[c.Latitudine,c.Longitudine]),{padding:[20,20]})}
  }
}

function exportGoogleMaps(){
  if(!mapRouteStops.length){toast('Nessuna tappa da esportare','warn');return}
  // Google Maps directions URL (max ~10 waypoints)
  const stops=mapRouteStops.slice(0,10);
  const dest=stops[stops.length-1];
  const waypoints=stops.slice(0,-1).map(s=>s.lat+','+s.lng).join('|');
  let url='https://www.google.com/maps/dir/?api=1&destination='+dest.lat+','+dest.lng+'&travelmode=driving';
  if(waypoints)url+='&waypoints='+encodeURIComponent(waypoints);
  window.open(url,'_blank');
}

// ============ CALENDARIO ============
let calMobDate=new Date();
function renderCalMobile(){
  const y=calMobDate.getFullYear(),m=calMobDate.getMonth();
  $('calMobTitle').textContent=new Date(y,m).toLocaleDateString('it-IT',{month:'long',year:'numeric'});
  const piano=my(DATA.piano).filter(p=>p.Data);
  const todayStr=today();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  const startDay=(first.getDay()+6)%7;
  const days=['L','M','M','G','V','S','D'];
  let html=days.map(d=>'<div style="font-weight:600;color:var(--gray);padding:4px;font-size:.625rem;text-transform:uppercase;text-align:center">'+d+'</div>').join('');
  const prevLast=new Date(y,m,0).getDate();
  for(let i=startDay-1;i>=0;i--)html+='<div style="padding:8px 4px;color:var(--gray3);text-align:center;font-size:.75rem">'+(prevLast-i)+'</div>';
  for(let d=1;d<=last.getDate();d++){
    const ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const dayItems=piano.filter(p=>p.Data===ds);
    const isToday=ds===todayStr;
    const bg=isToday?'background:var(--c1);color:var(--white);font-weight:700':'';
    html+='<div style="padding:6px 4px;border-radius:var(--radius-sm);cursor:pointer;text-align:center;font-size:.75rem;'+bg+'" onclick="showCalMobDay(\''+ds+'\')">'+d+(dayItems.length>0?'<span class="cal-dot"></span>':'')+'</div>';
  }
  const rem=7-((startDay+last.getDate())%7);
  if(rem<7)for(let i=1;i<=rem;i++)html+='<div style="padding:8px 4px;color:var(--gray3);text-align:center;font-size:.75rem">'+i+'</div>';
  $('calMobGrid').innerHTML=html;
  $('calMobDetail').innerHTML='';
}

function calMobileNav(dir){calMobDate.setMonth(calMobDate.getMonth()+dir);renderCalMobile()}

function showCalMobDay(ds){
  const items=my(DATA.piano).filter(p=>p.Data===ds).sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||''));
  const urgs=my(DATA.urgenze).filter(u=>(u.DataPrevista||'').split('T')[0]===ds);
  const label=new Date(ds+'T00:00:00').toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long'});
  if(!items.length&&!urgs.length){$('calMobDetail').innerHTML='<div class="card"><div class="card-body" style="text-align:center;color:var(--gray);padding:20px">Nessun impegno per '+label+'</div></div>';return}
  let h='<div style="font-weight:600;font-size:.8125rem;margin-bottom:8px;padding:0 4px">'+label+' â€” '+items.length+' interventi'+(urgs.length?', '+urgs.length+' urgenze':'')+'</div>';
  h+=items.map(p=>{
    const tc=getColor(DATA.tipiIntervento,p.TipoInterventoID);
    return '<div class="card" onclick="showInt(\''+p.ID+'\')" style="border-left:3px solid '+tc+'"><div class="card-body" style="padding:10px 14px"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><strong>'+(p.OraInizio||'â€”')+'</strong>'+statusTag(p.Stato)+'</div><div style="font-size:.8125rem">'+getName(DATA.clienti,p.ClienteID)+'</div><div style="font-size:.75rem;color:var(--gray)">'+getName(DATA.tipiIntervento,p.TipoInterventoID)+'</div></div></div>';
  }).join('');
  if(urgs.length){
    h+=urgs.map(u=>'<div class="card" style="border-left:3px solid var(--err)" onclick="showUrg(\''+u.ID+'\')"><div class="card-body" style="padding:10px 14px"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><strong>ğŸš¨ Urgenza</strong>'+statusTag(u.Stato)+'</div><div style="font-size:.8125rem">'+getName(DATA.clienti,u.ClienteID)+'</div></div></div>').join('');
  }
  $('calMobDetail').innerHTML=h;
}

// ============ CHAT TELEGRAM ============
let chatCanale='CH_GENERALE', chatMsgCache=[], chatPollTimer=null;

function initChat(){
  renderChatChannels();
  loadChatMessages();
  // Polling ogni 5 sec
  if(chatPollTimer)clearInterval(chatPollTimer);
  chatPollTimer=setInterval(()=>{
    const pg=$('pgChat');
    if(pg&&pg.classList.contains('active'))loadChatMessages(true);
  },5000);
}

function renderChatChannels(){
  const canali=[
    {id:'CH_GENERALE',nome:'ğŸ’¬ Generale'},
    {id:'CH_URGENZE',nome:'ğŸš¨ Urgenze'},
    {id:'CH_ADMIN',nome:'ğŸ‘‘ Admin & Capi'}
  ];
  $('chatChannels').innerHTML=canali.map(c=>
    '<button class="chat-ch-btn'+(c.id===chatCanale?' active':'')+'" onclick="switchChatCh(\''+c.id+'\')">'+c.nome+'</button>'
  ).join('');
}

function switchChatCh(id){
  chatCanale=id;
  renderChatChannels();
  loadChatMessages();
}

async function loadChatMessages(silent){
  try{
    const msgs=await apiCall('getChatMessaggi',{canale_id:chatCanale,limit:'50'});
    chatMsgCache=Array.isArray(msgs)?msgs:[];
    renderChatMsgs();
  }catch(e){if(!silent)toast('Errore chat: '+e.message,'err')}
}

function renderChatMsgs(){
  const el=$('chatMsgs');
  if(!chatMsgCache.length){el.innerHTML='<div class="empty"><div class="ico">ğŸ’¬</div><p>Nessun messaggio</p></div>';return}
  const sorted=[...chatMsgCache].sort((a,b)=>(a.CreatedAt||'').localeCompare(b.CreatedAt||''));
  el.innerHTML=sorted.map(m=>{
    const isMine=m.MittenteID===USER?.ID;
    const isTg=m.MittenteID==='TELEGRAM'||(m.Testo||'').startsWith('ğŸ“±');
    const sender=isMine?'':(getName(DATA.utenti||[],m.MittenteID)||(m.MittenteID==='TELEGRAM'?'Telegram':'?'));
    const time=(m.CreatedAt||'').substring(11,16);
    return '<div class="chat-msg'+(isMine?' mine':' other')+(isTg?' tg':'')+'">'+
      (!isMine&&sender?'<div class="sender">'+(isTg?'ğŸ“± ':'')+sender+'</div>':'')+
      '<div>'+(m.Testo||'')+'</div>'+
      '<div class="meta">'+time+'</div></div>';
  }).join('');
  el.scrollTop=el.scrollHeight;
}

async function sendChatMsg(){
  const inp=$('chatInput');
  const txt=(inp.value||'').trim();
  if(!txt)return;
  inp.value='';
  try{
    await apiCall('sendChatMessage',{canale_id:chatCanale,testo:txt,userId:USER?.ID},'POST');
    // Aggiungi subito alla cache locale per feedback istantaneo
    chatMsgCache.push({MittenteID:USER?.ID,Testo:txt,CreatedAt:new Date().toISOString()});
    renderChatMsgs();
    // Ricarica dal server dopo 1 sec per sincronizzare
    setTimeout(()=>loadChatMessages(true),1000);
  }catch(e){toast('Errore invio: '+e.message,'err')}
}

// ============ CREA URGENZA (tecnico) ============
let urgAllegatoFile=null;

function openCreaUrg(){
  // Popola selects
  const cls=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
  const s=$('suCliUrg');
  s.innerHTML='<option value="">â€” Seleziona â€”</option>';
  cls.forEach(c=>{const o=document.createElement('option');o.value=c.CodiceM3||c.ID;o.textContent=getName(DATA.clienti,c.ID);s.appendChild(o)});
  // Macchine (si aggiornano on change cliente)
  $('suMacUrg').innerHTML='<option value="">â€” Tutte â€”</option>';
  s.onchange=function(){
    const cid=this.value;
    const macs=(DATA.macchine||[]).filter(m=>!m.Obsoleto&&(m.ClienteID===cid));
    const ms=$('suMacUrg');ms.innerHTML='<option value="">â€” Seleziona â€”</option>';
    macs.forEach(m=>{const o=document.createElement('option');o.value=m.ID;o.textContent=(m.Tipo||'')+' '+(m.Modello||'')+' (S/N: '+(m.Seriale||'â€”')+')';ms.appendChild(o)});
  };
  // PrioritÃ 
  const ps=$('suPriUrg');
  ps.innerHTML='';
  (DATA.priorita||[]).forEach(p=>{const o=document.createElement('option');o.value=p.ID;o.textContent=p.Nome||p.ID;ps.appendChild(o)});
  // Reset
  $('suProbUrg').value='';$('suNoteUrg').value='';urgAllegatoFile=null;$('urgAllegatoPreview').innerHTML='';
  openSheet('shCreaUrg');
}

function urgAllegatoChange(input){
  const file=input.files[0];if(!file)return;
  if(file.size>20*1024*1024){toast('File troppo grande (max 20MB)','err');input.value='';return}
  const reader=new FileReader();
  reader.onload=function(){
    urgAllegatoFile={base64:reader.result.split(',')[1],type:file.type,name:file.name,sizeKB:Math.round(file.size/1024)};
    $('urgAllegatoPreview').innerHTML='<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--gray5);border-radius:8px"><span>'+(file.type.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„')+'</span><span style="flex:1;font-size:.8rem">'+file.name+' ('+urgAllegatoFile.sizeKB+'KB)</span><button onclick="urgAllegatoFile=null;this.parentElement.remove()" style="background:none;border:none;color:var(--err);cursor:pointer">âœ•</button></div>';
    input.value='';
  };
  reader.readAsDataURL(file);
}

async function saveUrgenzaTecnico(){
  try{
    const clienteID=$('suCliUrg').value;
    const problema=$('suProbUrg').value.trim();
    if(!clienteID){toast('Seleziona un cliente','warn');return}
    if(!problema){toast('Descrivi il problema','warn');return}
    const data={
      ClienteID:clienteID,
      MacchinaID:$('suMacUrg').value||null,
      PrioritaID:$('suPriUrg').value,
      Problema:problema,
      Note:$('suNoteUrg').value||null,
      Stato:'in_attesa',
      TecnicoID:USER?.ID,
      SegnalatoDa:USER?.ID,
      DataSegnalazione:new Date().toISOString()
    };
    await apiCall('createUrgenza',{data},'POST');
    // Upload allegato se presente
    if(urgAllegatoFile){
      try{
        const up=await apiCall('uploadFile',{base64:urgAllegatoFile.base64,mimeType:urgAllegatoFile.type,fileName:urgAllegatoFile.name,userId:USER?.ID},'POST');
        // TODO: collegare allegato all'urgenza
      }catch(e){}
    }
    // Notifica admin via chat
    try{
      await apiCall('sendChatMessage',{canale_id:'CH_URGENZE',testo:'ğŸš¨ NUOVA URGENZA (da tecnico '+((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim()+'):\n'+getName(DATA.clienti,clienteID)+' â€” '+problema+'\nâš ï¸ Stato: IN ATTESA approvazione',userId:USER?.ID},'POST');
    }catch(e){}
    toast('Urgenza inviata! In attesa di approvazione.','ok');
    closeSheet('shCreaUrg');
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ MODIFICA INTERVENTO ============
function openEditInt(id){
  const p=(DATA.piano||[]).find(x=>x.ID===id);if(!p)return;
  closeSheet('shInt');
  $('eiId').value=id;
  $('eiNote').value=p.Note||'';
  $('eiStato').value=p.Stato==='completato'?'in_corso':p.Stato;
  $('eiData').value=p.Data||'';
  $('eiOra').value=p.OraInizio||'';
  // Mostra avviso se non Ã¨ il proprio intervento
  const isOwn=p.TecnicoID===USER?.ID||p.TecnicoAssegnato===USER?.ID||(p.TecniciIDs||'').includes(USER?.ID);
  $('eiOwnNotice').style.display=isOwn?'none':'block';
  openSheet('shEditInt');
}

async function saveEditInt(){
  try{
    const id=$('eiId').value;
    const p=(DATA.piano||[]).find(x=>x.ID===id);if(!p)return;
    const isOwn=p.TecnicoID===USER?.ID||p.TecnicoAssegnato===USER?.ID||(p.TecniciIDs||'').includes(USER?.ID);
    const data={Note:$('eiNote').value,Stato:$('eiStato').value,Data:$('eiData').value,OraInizio:$('eiOra').value};
    await apiCall('updatePiano',{id,data},'POST');
    // Se non Ã¨ il proprio intervento, notifica admin
    if(!isOwn){
      try{
        await apiCall('sendChatMessage',{canale_id:'CH_ADMIN',testo:'âœï¸ MODIFICA INTERVENTO (da '+((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim()+'):\nIntervento '+id+' di '+getName(DATA.clienti,p.ClienteID)+'\nâš ï¸ Richiede approvazione â€” l\'intervento non Ã¨ assegnato a questo tecnico',userId:USER?.ID},'POST');
      }catch(e){}
      toast('Modifica inviata â€” attendi approvazione admin','warn');
    }else{
      // Notifica admin della modifica
      try{
        await apiCall('createNotifica',{data:{Tipo:'modifica_intervento',Oggetto:'Intervento modificato dal tecnico',Testo:((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim()+' ha modificato l\'intervento '+id+' ('+getName(DATA.clienti,p.ClienteID)+')',DestinatarioID:'ADMIN',Priorita:'media'}},'POST');
      }catch(e){}
      toast('Intervento aggiornato!','ok');
    }
    closeSheet('shEditInt');
    await refreshData();
  }catch(e){toast(e.message,'err')}
}

// ============ INSTALLAZIONI (detail) ============
function showInstDetail(id){
  const i=(DATA.installazioni||[]).find(x=>x.ID===id);if(!i)return;
  const cli=getName(DATA.clienti,i.ClienteID);
  const mac=getName(DATA.macchine,i.MacchinaID);
  const mObj=(DATA.macchine||[]).find(m=>m.ID===i.MacchinaID);
  const cObj=(DATA.clienti||[]).find(c=>c.ID===i.ClienteID||c.CodiceM3===i.ClienteID);
  // Fasi installazione
  const fasi=i.Fasi||i.FasiCompletate||'';
  $('instDetTitle').textContent='ğŸ”§ '+cli;
  $('instDetBody').innerHTML=
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem;margin-bottom:16px">'+
    '<div><span style="color:var(--gray)">Cliente</span><br><strong>'+cli+'</strong></div>'+
    '<div><span style="color:var(--gray)">Stato</span><br>'+statusTag(i.Stato)+'</div>'+
    '<div><span style="color:var(--gray)">Macchina</span><br><strong>'+mac+'</strong></div>'+
    '<div><span style="color:var(--gray)">S/N</span><br><strong>'+(mObj?.Seriale||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Data Inizio</span><br><strong>'+fmtDate(i.DataInizio)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Data Fine</span><br><strong>'+fmtDate(i.DataFine)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Responsabile</span><br><strong>'+getName(DATA.utenti||[],i.ResponsabileID)+'</strong></div>'+
    '<div><span style="color:var(--gray)">Avanzamento</span><br><strong>'+(i.Avanzamento||0)+'%</strong></div>'+
    '</div>'+
    (i.Avanzamento!=null?'<div style="margin-bottom:16px"><div style="height:8px;background:var(--gray4);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+(i.Avanzamento||0)+'%;background:var(--ok);border-radius:4px;transition:width .3s"></div></div></div>':'')+
    (i.Note?'<div style="margin-bottom:16px"><div style="font-size:.75rem;color:var(--gray);margin-bottom:4px">Note</div><div style="background:var(--gray5);padding:12px;border-radius:var(--radius-sm)">'+i.Note+'</div></div>':'')+
    '<div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">'+
    (cObj?.Telefono?'<a href="tel:'+cObj.Telefono+'" class="btn btn-outline">ğŸ“ Chiama cliente</a>':'')+
    (cObj?.Latitudine&&cObj?.Longitudine?'<a href="https://www.google.com/maps/dir/?api=1&destination='+cObj.Latitudine+','+cObj.Longitudine+'&travelmode=driving" target="_blank" class="btn btn-outline">ğŸ“ Naviga</a>':'')+
    '<button class="btn btn-outline" onclick="closeSheet(\'shInstDet\')">Chiudi</button></div>';
  openSheet('shInstDet');
}

// ============ PROFILO (con KPI personali) ============
function renderProf(){
  if(!USER)return;
  const abb=((USER.Nome||'').charAt(0)+(USER.Cognome||'').charAt(0)).toUpperCase()||'??';
  $('profAvatar').textContent=abb;
  $('profName').textContent=(USER.NomeInterno||USER.Nome||'')+(USER.Cognome?' '+USER.Cognome:'');
  $('profRole').textContent=USER.Ruolo||'Tecnico';

  // KPI personali
  const miei=my(DATA.piano);
  const meseCorrente=today().substring(0,7);
  const mese=miei.filter(p=>p.Data&&p.Data.startsWith(meseCorrente));
  const completati=mese.filter(p=>p.Stato==='completato').length;
  const totOre=mese.reduce((s,p)=>s+(parseFloat(p.OreLavorate)||0),0);
  const totKm=mese.reduce((s,p)=>s+(parseFloat(p.KmPercorsi)||0),0);
  $('profKpi').innerHTML=
    '<div class="kpi-mini"><div class="val" style="color:var(--ok)">'+completati+'</div><div class="lbl">âœ… Completati (mese)</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:var(--c3)">'+totOre.toFixed(1)+'</div><div class="lbl">â±ï¸ Ore lavorate</div></div>'+
    '<div class="kpi-mini"><div class="val" style="color:var(--warn)">'+Math.round(totKm)+'</div><div class="lbl">ğŸš Km percorsi</div></div>';

  $('profCard').innerHTML='<div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.8125rem">'+
    '<div><span style="color:var(--gray)">ID</span><br><strong>'+(USER.ID||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Email</span><br><strong>'+(USER.Email||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Telefono</span><br><strong>'+(USER.Telefono||'â€”')+'</strong></div>'+
    '<div><span style="color:var(--gray)">Ruolo</span><br><strong>'+(USER.Ruolo||'â€”')+'</strong></div>'+
    '</div></div>';
}

</script>
</body>
</html>
