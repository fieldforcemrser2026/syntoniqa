<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#050C14">
<title>Syntoniqa Admin v1.0</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="white_label_config.js"></script>
<script>
/* ============================================================
   WHITE-LABEL BOOT - Syntoniqa v1.0
   Legge white_label.config.js e applica brand/colori/features
   ============================================================ */
;(function(){
  var cfg = window.SYNTONIQA_CONFIG;
  if(!cfg) return;

  /* -- CSS Variables -- */
  var r = document.documentElement.style;
  var co = cfg.colors||{};
  if(co.primary)       r.setProperty('--c1', co.primary);
  if(co.primary_dark)  r.setProperty('--c2', co.primary_dark);
  if(co.primary_light) r.setProperty('--c3', co.primary_light);
  if(co.accent)        r.setProperty('--c4', co.accent);

  /* -- Meta theme-color -- */
  var mt = document.querySelector('meta[name="theme-color"]');
  if(mt && co.primary) mt.content = co.primary;

  /* -- Title -- */
  var br = cfg.brand||{};
  if(br.nome) document.title = br.nome + ' Admin';

  /* -- Favicon -- */
  if(br.favicon_url){
    var lk = document.querySelector('link[rel="icon"]') || document.createElement('link');
    lk.rel='icon'; lk.href=br.favicon_url;
    if(!lk.parentNode) document.head.appendChild(lk);
  }

  /* -- DOM ready: apply lockup + API + features -- */
  function applyBrand(){
    var nome    = br.nome    || 'Syntoniqa';
    var tagline = br.tagline || 'Field Service Management';

    /* Login lockup */
    var logoEl = document.getElementById('brandLogo');
    if(logoEl){
      if(br.logo_url){
        logoEl.innerHTML = '<img src="'+br.logo_url+'" style="height:'+(br.logo_height||'56px')+';max-width:220px;object-fit:contain" alt="'+nome+'">';
      } else {
        logoEl.innerHTML = '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCI+CiAgPHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIHJ4PSI0MCIgZmlsbD0iIzA1MEMxNCIvPgogIDwhLS0gQ2VyY2hpbyBzaW5pc3RybyB2ZXJkZSAtLT4KICA8Y2lyY2xlIGN4PSI3OCIgY3k9IjEwMCIgcj0iNDIiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwQzlBNyIgc3Ryb2tlLXdpZHRoPSI4Ii8+CiAgPCEtLSBDZXJjaGlvIGRlc3RybyBibHUgLS0+CiAgPGNpcmNsZSBjeD0iMTIyIiBjeT0iMTAwIiByPSI0MiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjM0I3RUY3IiBzdHJva2Utd2lkdGg9IjgiLz4KICA8IS0tIEN1cnZhIGludGVybmEgc2luaXN0cmEgKHNpZ25hbCkgLS0+CiAgPHBhdGggZD0iTSA5MCA3MiBRIDEwMCAxMDAgOTAgMTI4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMEM5QTciIHN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CiAgPCEtLSBDdXJ2YSBpbnRlcm5hIGRlc3RyYSAoc3luYykgLS0+CiAgPHBhdGggZD0iTSAxMTAgNzIgUSAxMDAgMTAwIDExMCAxMjgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzNCN0VGNyIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cg==" style="height:64px;width:64px;" alt="Syntoniqa">';
      }    }
    var bn=document.getElementById('brandName');   if(bn) bn.textContent=nome;
    var bs=document.getElementById('brandSlogan'); if(bs) bs.textContent=tagline;

    /* Sidebar lockup */
    var sb=document.getElementById('sidebarBrand');
    if(sb){
      if(br.logo_url){
        sb.innerHTML='<img src="'+br.logo_url+'" style="height:22px;max-width:150px;object-fit:contain;filter:brightness(0) invert(1)" alt="'+nome+'">';
      } else {
        sb.innerHTML='<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCI+CiAgPHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIHJ4PSI0MCIgZmlsbD0iIzA1MEMxNCIvPgogIDwhLS0gQ2VyY2hpbyBzaW5pc3RybyB2ZXJkZSAtLT4KICA8Y2lyY2xlIGN4PSI3OCIgY3k9IjEwMCIgcj0iNDIiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwQzlBNyIgc3Ryb2tlLXdpZHRoPSI4Ii8+CiAgPCEtLSBDZXJjaGlvIGRlc3RybyBibHUgLS0+CiAgPGNpcmNsZSBjeD0iMTIyIiBjeT0iMTAwIiByPSI0MiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjM0I3RUY3IiBzdHJva2Utd2lkdGg9IjgiLz4KICA8IS0tIEN1cnZhIGludGVybmEgc2luaXN0cmEgKHNpZ25hbCkgLS0+CiAgPHBhdGggZD0iTSA5MCA3MiBRIDEwMCAxMDAgOTAgMTI4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMEM5QTciIHN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CiAgPCEtLSBDdXJ2YSBpbnRlcm5hIGRlc3RyYSAoc3luYykgLS0+CiAgPHBhdGggZD0iTSAxMTAgNzIgUSAxMDAgMTAwIDExMCAxMjgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzNCN0VGNyIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cg==" style="height:22px;width:22px;margin-right:6px;vertical-align:middle" alt="">' + nome;
      }
    }
    var ss=document.getElementById('sidebarSub');
    if(ss) ss.textContent = tagline;

    /* Feature toggles */
    var feat = cfg.features||{};
    var featMap = {
      ai_planner:   "showSec\'ai\'",
      mappa:        "showSec\'mappa\'",
      kpi_dashboard:"showSec\'kpi\'",
      trasferte:    "showSec\'trasferte\'",
      installazioni:"showSec\'installazioni\'",
      pagellini:    "showSec\'pagellini\'",
      documenti:    "showSec\'documenti\'",
      power_bi:     "showSec\'powerbi\'",
      telegram:     "showSec\'telegramconfig\'"
    };
    Object.keys(featMap).forEach(function(k){
      if(feat[k]===false){
        var q='[onclick*="'+featMap[k]+'"]';
        var el=document.querySelector(q);
        if(el) el.style.display='none';
      }
    });
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', applyBrand);
  } else {
    applyBrand();
  }
})();
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500&display=swap');
:root{
--font:'DM Sans',system-ui,sans-serif;
--mono:'JetBrains Mono',monospace;
--c1:#00C9A7;--c2:#009B83;--c3:#33D4B5;--c4:#3B7EF7;
--ok:#10B981;--ok2:#059669;--warn:#F59E0B;--warn2:#D97706;--err:#EF4444;--err2:#DC2626;
--info:#3B82F6;--info2:#2563EB;--purple:#8B5CF6;
--gray:#6B7280;--gray2:#9CA3AF;--gray3:#D1D5DB;--gray4:#F3F4F6;--gray5:#F9FAFB;
--dark:#050C14;--dark2:#0A1628;--dark3:#1A2B3C;
--white:#FFFFFF;--sidebar:240px;--header:56px;
--shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
--shadow-lg:0 10px 25px rgba(0,0,0,.1),0 4px 10px rgba(0,0,0,.06);
--radius:10px;--radius-sm:6px;--radius-lg:16px;
}
[data-theme="dark"]{
  --gray:#9CA3AF;--gray2:#6B7280;--gray3:#374151;--gray4:#111827;--gray5:#0F172A;
  --dark:#F9FAFB;--dark2:#E5E7EB;--dark3:#D1D5DB;
  --white:#1F2937;
  --shadow:0 1px 3px rgba(0,0,0,.3),0 1px 2px rgba(0,0,0,.2);
  --shadow-lg:0 10px 25px rgba(0,0,0,.3),0 4px 10px rgba(0,0,0,.2);
}
[data-theme="dark"] .sidebar{background:#0F172A;border-color:#1E293B}
[data-theme="dark"] .header{background:#1F2937;border-color:#374151}
[data-theme="dark"] .card{border-color:#374151}
[data-theme="dark"] .tbl th{background:#0F172A}
[data-theme="dark"] .tbl td{border-color:#374151}
[data-theme="dark"] .modal-content{background:#1F2937}
[data-theme="dark"] .field input,[data-theme="dark"] .field select,[data-theme="dark"] .field textarea{background:#111827;border-color:#374151;color:#F9FAFB}
[data-theme="dark"] .nav-item:hover{background:rgba(255,255,255,.08)}
[data-theme="dark"] .nav-item.active{background:rgba(0,201,167,.15)}
[data-theme="dark"] .login-box{background:#1F2937}
[data-theme="dark"] ::-webkit-scrollbar-thumb{background:#4B5563}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--gray4);color:var(--dark);line-height:1.5;font-size:13px;overflow-x:hidden}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--gray3);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--gray2)}

/* ===== LOGIN ===== */
.login{position:fixed;inset:0;background:linear-gradient(135deg,var(--c2) 0%,var(--c1) 50%,var(--c3) 100%);display:flex;justify-content:center;align-items:center;padding:24px;z-index:9000}
.login.hidden{display:none}
.login-box{background:var(--white);padding:48px 40px;border-radius:var(--radius-lg);width:100%;max-width:380px;box-shadow:var(--shadow-lg)}
.login-box .logo{text-align:center;margin-bottom:24px}
.login-box .logo img{height:48px;margin-bottom:12px}
.login-box h1{font-size:1.5rem;font-weight:700;color:var(--dark);text-align:center;margin-bottom:4px;letter-spacing:-0.02em}
.login-box .sub{color:var(--gray);text-align:center;font-size:0.8125rem;margin-bottom:32px}
.login-box .loading{text-align:center;padding:40px;color:var(--gray)}
.login-box .loading .spin{display:inline-block;width:32px;height:32px;border:3px solid var(--gray3);border-top-color:var(--c1);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}

/* ===== FORM ELEMENTS ===== */
.field{margin-bottom:16px}
.field label{display:block;font-size:0.6875rem;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;color:var(--gray);margin-bottom:6px}
.field input,.field select,.field textarea{width:100%;padding:10px 12px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:0.8125rem;font-family:var(--font);color:var(--dark);background:var(--white);transition:border-color .2s}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--c1);outline:none;box-shadow:0 0 0 3px rgba(0,201,167,.15)}
.field textarea{resize:vertical;min-height:80px}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.field-row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
.field-check{display:flex;align-items:center;gap:8px;cursor:pointer}
.field-check input[type=checkbox]{width:16px;height:16px;accent-color:var(--c1)}

/* ===== BUTTONS ===== */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border:none;border-radius:var(--radius-sm);font-size:0.8125rem;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .2s;letter-spacing:-0.01em}
.btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
.btn:active{transform:translateY(0)}
.btn-primary{background:var(--c1);color:var(--white)}
.btn-primary:hover{background:var(--c2)}
.btn-ok{background:var(--ok);color:var(--white)}
.btn-ok:hover{background:var(--ok2)}
.btn-warn{background:var(--warn);color:var(--white)}
.btn-warn:hover{background:var(--warn2)}
.btn-err{background:var(--err);color:var(--white)}
.btn-err:hover{background:var(--err2)}
.btn-info{background:var(--info);color:var(--white)}
.btn-info:hover{background:var(--info2)}
.btn-outline{background:var(--white);border:1.5px solid var(--gray3);color:var(--dark)}
.btn-outline:hover{border-color:var(--c1);color:var(--c1)}
.btn-ghost{background:transparent;color:var(--gray);padding:6px 10px}
.btn-ghost:hover{background:var(--gray4);color:var(--dark)}
.btn-sm{padding:6px 12px;font-size:0.75rem}
.btn-xs{padding:4px 8px;font-size:0.6875rem}
.btn-lg{padding:12px 24px;font-size:0.875rem}
.btn-block{width:100%}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}

/* ===== LAYOUT ===== */
.sidebar{position:fixed;left:0;top:0;bottom:0;width:var(--sidebar);background:var(--dark);color:var(--white);display:flex;flex-direction:column;z-index:100;transition:transform .3s}
.sidebar .brand{padding:16px 20px;border-bottom:1px solid var(--dark3)}
.sidebar .brand h2{font-size:0.9375rem;font-weight:700;letter-spacing:-0.02em}
.sidebar .brand small{font-size:0.6875rem;color:var(--gray2);display:block;margin-top:2px}
.sidebar .nav{flex:1;overflow-y:auto;padding:8px 0}
.sidebar .nav-label{font-size:0.5625rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--gray);padding:16px 20px 6px;font-weight:600}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;color:var(--gray2);cursor:pointer;border:none;background:none;width:100%;text-align:left;font-size:0.8125rem;font-family:var(--font);transition:.15s;border-left:3px solid transparent}
.nav-item:hover{background:rgba(255,255,255,.05);color:var(--white)}
.nav-item.active{background:rgba(0,201,167,.15);color:var(--c4);border-left-color:var(--c1)}
.nav-item .ico{width:18px;text-align:center;font-size:0.875rem}
.nav-item .badge{margin-left:auto;background:var(--err);color:white;padding:1px 7px;border-radius:10px;font-size:0.625rem;font-weight:600}
.sidebar .foot{padding:12px 20px;border-top:1px solid var(--dark3);font-size:0.6875rem;color:var(--gray)}
.sidebar .foot button{background:none;border:none;color:var(--gray2);cursor:pointer;font-family:var(--font);font-size:0.75rem;padding:6px 0}
.sidebar .foot button:hover{color:var(--white)}
.main{margin-left:var(--sidebar);min-height:100vh}
.header{position:sticky;top:0;height:var(--header);background:var(--white);border-bottom:1px solid #E5E7EB;display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:50}
.header h1{font-size:1rem;font-weight:700;letter-spacing:-0.02em}
.header .actions{display:flex;align-items:center;gap:12px}
.content{padding:20px 24px}

/* ===== SECTION ===== */
.sec{display:none}
.sec.active{display:block}

/* ===== CARDS ===== */
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #F3F4F6}
.card-head h3{font-size:0.875rem;font-weight:600;letter-spacing:-0.01em}
.card-body{padding:16px 18px}
.card-body.np{padding:0}
.card-foot{padding:12px 18px;border-top:1px solid #F3F4F6;background:var(--gray5)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.gap-sm{gap:12px}
.mb{margin-bottom:16px}
.mb-sm{margin-bottom:8px}
.mb-lg{margin-bottom:24px}

/* ===== KPI CARDS ===== */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:20px}
.kpi{background:var(--white);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border-left:4px solid var(--gray3)}
.kpi.red{border-left-color:var(--err)}
.kpi.green{border-left-color:var(--ok)}
.kpi.blue{border-left-color:var(--info)}
.kpi.yellow{border-left-color:var(--warn)}
.kpi.purple{border-left-color:var(--purple)}
.kpi .kpi-val{font-size:1.5rem;font-weight:700;letter-spacing:-0.02em;line-height:1.2}
.kpi .kpi-lbl{font-size:0.6875rem;color:var(--gray);text-transform:uppercase;letter-spacing:0.04em;margin-top:4px}
.kpi .kpi-sub{font-size:0.75rem;color:var(--gray2);margin-top:4px}

/* ===== TABLE ===== */
.tbl{width:100%;border-collapse:collapse;font-size:0.8125rem}
.tbl th{background:var(--gray5);font-weight:600;font-size:0.6875rem;text-transform:uppercase;letter-spacing:0.04em;color:var(--gray);padding:8px 12px;text-align:left;border-bottom:1px solid #E5E7EB;position:sticky;top:0}
.tbl td{padding:8px 12px;border-bottom:1px solid #F3F4F6;vertical-align:middle}
.tbl tr:hover td{background:var(--gray5)}
.tbl .actions-cell{white-space:nowrap}

/* ===== BADGES/TAGS ===== */
.tag{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:20px;font-size:0.6875rem;font-weight:600;letter-spacing:0.01em}
.tag-ok{background:#D1FAE5;color:#065F46}
.tag-warn{background:#FEF3C7;color:#92400E}
.tag-err{background:#FEE2E2;color:#991B1B}
.tag-info{background:#DBEAFE;color:#1E40AF}
.tag-purple{background:#EDE9FE;color:#5B21B6}
.tag-gray{background:#F3F4F6;color:#374151}

/* ===== SLA BAR ===== */
.sla-bar{height:6px;background:var(--gray3);border-radius:3px;overflow:hidden;margin-top:4px}
.sla-bar .fill{height:100%;border-radius:3px;transition:width .3s}
.sla-ok .fill{background:var(--ok)}
.sla-warn .fill{background:var(--warn)}
.sla-crit .fill{background:var(--err)}
.sla-breach .fill{background:#7F1D1D}

/* ===== TABS ===== */
.tabs{display:flex;gap:0;border-bottom:2px solid #E5E7EB;margin-bottom:16px}
.tab{padding:8px 16px;font-size:0.8125rem;font-weight:500;color:var(--gray);cursor:pointer;border:none;background:none;font-family:var(--font);border-bottom:2px solid transparent;margin-bottom:-2px;transition:.15s}
.tab:hover{color:var(--dark)}
.tab.active{color:var(--c1);border-bottom-color:var(--c1);font-weight:600}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);display:flex;justify-content:center;align-items:center;z-index:5000;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal{background:var(--white);border-radius:var(--radius-lg);width:95%;max-width:640px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px rgba(0,0,0,.2);transform:translateY(20px);transition:transform .2s}
.modal-overlay.show .modal{transform:translateY(0)}
.modal-lg{max-width:900px}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid #E5E7EB}
.modal-head h2{font-size:1rem;font-weight:700;letter-spacing:-0.02em}
.modal-head .close{background:none;border:none;font-size:1.25rem;cursor:pointer;color:var(--gray);padding:4px 8px;border-radius:var(--radius-sm)}
.modal-head .close:hover{background:var(--gray4);color:var(--dark)}
.modal-body{padding:20px 24px;overflow-y:auto;flex:1}
.modal-foot{padding:14px 24px;border-top:1px solid #E5E7EB;display:flex;justify-content:flex-end;gap:8px}

/* ===== TOAST ===== */
.toast-container{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:var(--radius-sm);color:var(--white);font-size:0.8125rem;font-weight:500;box-shadow:var(--shadow-lg);animation:toastIn .3s ease;max-width:360px}
.toast.ok{background:var(--ok)}
.toast.err{background:var(--err)}
.toast.warn{background:var(--warn)}
.toast.info{background:var(--info)}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}

/* ===== MAP ===== */
#mapAdmin{height:500px;border-radius:var(--radius);z-index:1}
.map-controls{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}

/* ===== AI PLANNER ===== */
.ai-box{background:linear-gradient(135deg,#1E1B4B,#312E81);color:var(--white);border-radius:var(--radius-lg);padding:24px;margin-bottom:16px}
.ai-box h3{font-size:1rem;margin-bottom:4px}
.ai-box p{font-size:0.8125rem;opacity:.8;margin-bottom:16px}
.ai-box textarea{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:var(--white);border-radius:var(--radius);padding:14px;font-family:var(--font);font-size:0.875rem;width:100%;resize:vertical;min-height:100px}
.ai-box textarea::placeholder{color:rgba(255,255,255,.4)}
.ai-result{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:16px;margin-top:12px;max-height:400px;overflow-y:auto;font-family:var(--mono);font-size:0.75rem;white-space:pre-wrap}

/* ===== WORKFLOW STEPS ===== */
.wf-steps{display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.wf-step{padding:4px 12px;border-radius:20px;font-size:0.6875rem;font-weight:600;background:var(--gray4);color:var(--gray)}
.wf-step.active{background:var(--c1);color:var(--white)}
.wf-step.done{background:var(--ok);color:var(--white)}
.wf-arrow{color:var(--gray3);font-size:0.75rem}

/* ===== STATS BAR ===== */
.stat-bar{display:flex;height:24px;border-radius:4px;overflow:hidden;margin:8px 0}
.stat-bar div{display:flex;align-items:center;justify-content:center;font-size:0.625rem;font-weight:600;color:var(--white);min-width:20px}

/* ===== CALENDAR MINI ===== */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;font-size:0.75rem;text-align:center}
.cal-hdr{font-weight:600;color:var(--gray);padding:4px;font-size:0.625rem;text-transform:uppercase}
.cal-day{padding:6px 4px;border-radius:var(--radius-sm);cursor:pointer;position:relative}
.cal-day:hover{background:var(--gray4)}
.cal-day.today{background:var(--c1);color:var(--white);font-weight:700}
.cal-day.other{color:var(--gray3)}
.cal-day .dot{width:5px;height:5px;border-radius:50%;background:var(--c1);display:inline-block;position:absolute;bottom:2px;left:50%;transform:translateX(-50%)}

/* ===== RESPONSIVE ===== */
@media(max-width:1024px){
:root{--sidebar:200px}
.grid-4{grid-template-columns:1fr 1fr}
.kpi-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
}
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.main{margin-left:0}
.header .burger{display:flex}
.grid-2,.grid-3{grid-template-columns:1fr}
.field-row,.field-row-3,.field-row-4{grid-template-columns:1fr}
.modal{width:98%;max-height:95vh}
.content{padding:12px}
}
.burger{display:none;background:none;border:none;cursor:pointer;padding:8px;font-size:1.25rem}
.overlay-side{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99}
.overlay-side.show{display:block}

/* ===== TOUCH DRAG & DROP (FIX B-005) ===== */
[ondrop].touch-hover{background:#ECFDF5 !important;outline:2px solid #10B981 !important;outline-offset:-2px}
@media(hover:none) and (pointer:coarse){
  /* Mobile touch devices */
  [draggable="true"]{cursor:default;-webkit-user-select:none;user-select:none}
  [draggable="true"]:active{transform:scale(0.97);opacity:0.8}
  .btn,.btn-sm{min-height:44px;min-width:44px}
  input,select,textarea{font-size:16px !important}  /* prevent iOS zoom */
  .modal{width:98% !important;max-width:100vw !important;max-height:95vh !important}
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .sidebar{-webkit-overflow-scrolling:touch}
  .tag,.badge{padding:4px 10px;font-size:.75rem}
  td,th{padding:8px 10px}
}
/* Small mobile */
@media(max-width:480px){
  .content{padding:8px !important}
  .modal{margin:4px !important;padding:16px !important}
  h2{font-size:1.1rem}
  .grid-4,.grid-3,.grid-2{grid-template-columns:1fr !important;gap:8px !important}
  .header{padding:0 8px}
  .header h1{font-size:.85rem}
}

/* ===== PAGELLINO ===== */
.star{cursor:pointer;font-size:1.25rem;color:var(--gray3);transition:.15s}
.star.filled{color:#F59E0B}
.star:hover{transform:scale(1.2)}
.score-circle{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:700;color:var(--white)}

/* ===== ANAGRAFICA TREE ===== */
.anag-arrow{display:inline-block;width:16px;font-size:.7rem;color:var(--gray);transition:transform .2s}
.anag-row:hover{background:var(--bg)!important}
.badge-ok{background:#dcfce7;color:#166534}.badge-warn{background:#fef3c7;color:#92400e}.badge-err{background:#fecaca;color:#991b1b}
#anagDetail_ table.tbl{margin:0;font-size:.78rem}
#anagDetail_ table.tbl td,#anagDetail_ table.tbl th{padding:5px 8px}

/* ===== EMPTY STATE ===== */
.empty{text-align:center;padding:40px 20px;color:var(--gray)}
.empty .ico{font-size:2.5rem;margin-bottom:12px;opacity:.5}
.empty p{font-size:0.875rem}

/* ===== TOOLTIP ===== */
[data-tip]{position:relative}
[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--dark);color:var(--white);padding:4px 10px;border-radius:4px;font-size:0.6875rem;white-space:nowrap;z-index:100}
</style>
</head>
<body>
<div class="toast-container" id="toasts"></div>
<!-- Global loading overlay -->
<div id="globalLoad" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,12,20,.35);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(2px)">
  <div style="background:#fff;padding:24px 32px;border-radius:16px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.2)">
    <div style="width:36px;height:36px;border:3px solid #E5E7EB;border-top-color:var(--c1);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto"></div>
    <p style="margin:12px 0 0;font-size:.8125rem;color:#6B7280">Operazione in corso...</p>
  </div>
</div>

<!-- ===== LOGIN ===== -->
<div class="login" id="loginScreen">
<div class="login-box">
<div class="logo"><div id="brandLogo"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCI+CiAgPHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIHJ4PSI0MCIgZmlsbD0iIzA1MEMxNCIvPgogIDwhLS0gQ2VyY2hpbyBzaW5pc3RybyB2ZXJkZSAtLT4KICA8Y2lyY2xlIGN4PSI3OCIgY3k9IjEwMCIgcj0iNDIiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwQzlBNyIgc3Ryb2tlLXdpZHRoPSI4Ii8+CiAgPCEtLSBDZXJjaGlvIGRlc3RybyBibHUgLS0+CiAgPGNpcmNsZSBjeD0iMTIyIiBjeT0iMTAwIiByPSI0MiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjM0I3RUY3IiBzdHJva2Utd2lkdGg9IjgiLz4KICA8IS0tIEN1cnZhIGludGVybmEgc2luaXN0cmEgKHNpZ25hbCkgLS0+CiAgPHBhdGggZD0iTSA5MCA3MiBRIDEwMCAxMDAgOTAgMTI4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMEM5QTciIHN0cm9rZS13aWR0aD0iNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CiAgPCEtLSBDdXJ2YSBpbnRlcm5hIGRlc3RyYSAoc3luYykgLS0+CiAgPHBhdGggZD0iTSAxMTAgNzIgUSAxMDAgMTAwIDExMCAxMjgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzNCN0VGNyIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cg==" style="height:64px;width:64px;" alt="Syntoniqa"></div></div>
<h1 id="brandName">Syntoniqa</h1>
<p class="sub" id="brandSlogan">Enterprise Field Service Management</p>
<div id="loginLoad" class="loading"><div class="spin"></div><p style="margin-top:12px;font-size:.8125rem">Connessione al server...</p></div>
<form id="loginForm" onsubmit="return doLogin(event)" style="display:none">
<div class="field"><label>Username</label><input type="text" id="inpUser" required placeholder="nome.cognome" autocomplete="username"></div>
<div class="field"><label>Password</label><input type="password" id="inpPwd" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
<div id="loginErr" style="color:var(--err);font-size:.8125rem;margin-bottom:12px;display:none"></div>
<button class="btn btn-primary btn-block btn-lg" id="btnLogin" type="submit">Accedi</button>
</form>
</div>
</div>

<!-- ===== SIDEBAR OVERLAY (mobile) ===== -->
<div class="overlay-side" id="sideOverlay" onclick="toggleSidebar()"></div>

<!-- ===== SIDEBAR ===== -->
<nav class="sidebar" id="sidebar">
<div class="brand"><h2 id="sidebarBrand">âš™ï¸ Syntoniqa</h2><small id="sidebarSub">v1.0</small></div>
<div class="nav">
<div class="nav-label">Operazioni</div>
<button class="nav-item active" onclick="showSec('dashboard',this)"><span class="ico">ğŸ“Š</span>Dashboard</button>
<button class="nav-item" onclick="showSec('calendario',this)"><span class="ico">ğŸ“…</span>Calendario</button>
<button class="nav-item" onclick="showSec('piano',this)"><span class="ico">ğŸ“‹</span>Interventi</button>
<button class="nav-item" onclick="showSec('urgenze',this)"><span class="ico">ğŸš¨</span>Urgenze<span class="badge" id="badgeUrg" style="display:none">0</span></button>
<button class="nav-item" onclick="showSec('ordini',this)"><span class="ico">ğŸ“¦</span>Ordini<span class="badge" id="badgeOrd" style="display:none">0</span></button>
<button class="nav-item" onclick="showSec('installazioni',this)"><span class="ico">ğŸ—ï¸</span>Installazioni</button>
<div class="nav-label">Risorse</div>
<button class="nav-item" onclick="showSec('reperibilita',this)"><span class="ico">ğŸ“</span>ReperibilitÃ </button>
<button class="nav-item" onclick="showSec('trasferte',this)"><span class="ico">ğŸ§³</span>Trasferte</button>
<button class="nav-item" onclick="showSec('notifiche',this)"><span class="ico">ğŸ””</span>Notifiche<span class="badge" id="badgeNot" style="display:none">0</span></button>
<button class="nav-item" onclick="showSec('richieste',this)"><span class="ico">ğŸ“</span>Richieste<span class="badge" id="badgeRich" style="display:none">0</span></button>
<div class="nav-label">Anagrafiche</div>
<button class="nav-item" onclick="showSec('anagrafica',this)"><span class="ico">ğŸ¢</span>Clienti & Assets</button>
<button class="nav-item" onclick="showSec('macchine',this)"><span class="ico">âš™ï¸</span>Macchine</button>
<button class="nav-item" onclick="showSec('automezzi',this)"><span class="ico">ğŸš</span>Automezzi</button>
<button class="nav-item" onclick="showSec('tecnici',this)"><span class="ico">ğŸ‘¥</span>Tecnici</button>
<div class="nav-label">Intelligence</div>
<button class="nav-item" onclick="showSec('ai',this)"><span class="ico">ğŸ¤–</span>AI Planner</button>
<button class="nav-item" onclick="showSec('planner',this)"><span class="ico">ğŸ“†</span>Planner Visuale</button>
<button class="nav-item" onclick="showSec('mappa',this)"><span class="ico">ğŸ—ºï¸</span>Mappa</button>
<button class="nav-item" onclick="showSec('kpi',this)"><span class="ico">ğŸ“ˆ</span>KPI</button>
<button class="nav-item" onclick="showSec('pagellini',this)"><span class="ico">ğŸ¯</span>Pagellini</button>
<button class="nav-item" onclick="showSec('checklist',this)"><span class="ico">âœ…</span>Checklist</button>
<button class="nav-item" onclick="showSec('chat',this)"><span class="ico">ğŸ’¬</span>Chat Telegram<span class="badge" id="chatBadge" style="display:none">0</span></button>
<div class="nav-label">Sistema</div>
<button class="nav-item" onclick="showSec('sla',this)"><span class="ico">â±ï¸</span>SLA Monitor</button>
<button class="nav-item" onclick="showSec('documenti',this)"><span class="ico">ğŸ“</span>Documenti</button>
<button class="nav-item" onclick="showSec('allegati',this)"><span class="ico">ğŸ“</span>Allegati</button>
<button class="nav-item" onclick="showSec('report',this)"><span class="ico">ğŸ“Š</span>Report Builder</button>
<button class="nav-item" onclick="showSec('auditlog',this)"><span class="ico">ğŸ“œ</span>Audit Log</button>
<button class="nav-item" onclick="showSec('powerbi',this)"><span class="ico">âš¡</span>Power BI</button>
<button class="nav-item" onclick="showSec('emailconfig',this)"><span class="ico">ğŸ“§</span>Email</button>
<button class="nav-item" onclick="showSec('telegramconfig',this)"><span class="ico">ğŸ’¬</span>Telegram</button>
<button class="nav-item" onclick="showSec('backup',this)"><span class="ico">ğŸ’¾</span>Backup</button>
<button class="nav-item" onclick="showSec('config',this)"><span class="ico">ğŸ”§</span>Configurazione</button>
</div>
<div class="foot">
<div style="display:flex;justify-content:space-between;align-items:center">
<span id="footUser">â€”</span>
<button onclick="logout()">Esci â†—</button>
</div>
</div>
</nav>

<!-- ===== MAIN ===== -->
<div class="main" id="appMain" style="display:none">
<header class="header">
<div style="display:flex;align-items:center;gap:12px">
<button class="burger" onclick="toggleSidebar()">â˜°</button>
<h1 id="headerTitle">ğŸ“Š Dashboard</h1>
</div>
<div class="actions" style="display:flex;align-items:center;gap:10px">
<button onclick="toggleDarkMode()" id="darkBtn" title="Dark/Light mode" style="background:none;border:none;cursor:pointer;font-size:1.125rem;padding:4px">ğŸŒ™</button>
<span id="headerDate" style="font-size:.75rem;color:var(--gray)"></span>
<span id="headerUser" style="font-size:.8125rem;font-weight:600"></span>
</div>
</header>
<div class="content">

<!-- ========== SEC: DASHBOARD ========== -->
<section class="sec active" id="secDashboard">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
  <div style="font-size:.75rem;color:var(--gray)">Ultimo aggiornamento: <span id="dashLastUpdate">â€”</span></div>
  <button class="btn btn-outline btn-sm" onclick="refreshData();toast('Aggiornamento...','info')" style="font-size:.75rem">ğŸ”„ Aggiorna</button>
</div>
<div class="kpi-grid" id="kpiDash"></div>
<div class="grid-2 mb">
<div class="card"><div class="card-head"><h3>ğŸ“‹ Interventi Oggi</h3><button class="btn btn-primary btn-sm" onclick="openModal('modalPiano')">+ Nuovo</button></div><div class="card-body np" style="max-height:360px;overflow-y:auto"><table class="tbl"><thead><tr><th>Ora</th><th>Tecnico</th><th>ğŸš</th><th>Cliente</th><th>Tipo</th><th>Stato</th><th></th></tr></thead><tbody id="tblOggi"></tbody></table></div></div>
<div class="card"><div class="card-head"><h3>ğŸš¨ Urgenze Aperte</h3><button class="btn btn-err btn-sm" onclick="openModal('modalUrgenza')">+ Nuova</button></div><div class="card-body np" style="max-height:360px;overflow-y:auto"><table class="tbl"><thead><tr><th>PrioritÃ </th><th>Cliente</th><th>Problema</th><th>SLA</th><th>Stato</th><th></th></tr></thead><tbody id="tblUrgDash"></tbody></table></div></div>
</div>
<!-- Alert critici -->
<div id="dashAlerts" class="mb" style="display:none"></div>
<!-- Tecnici attivi oggi -->
<div class="card mb"><div class="card-head"><h3>ğŸ‘¥ Tecnici Oggi</h3></div><div class="card-body" id="tecniciDash" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px"></div></div>
<!-- Andamento settimanale (sparkline SVG) + Timeline giornata -->
<div class="grid-2 mb">
<div class="card"><div class="card-head"><h3>ğŸ“ˆ Andamento 7 Giorni</h3></div><div class="card-body" id="sparkDash" style="height:180px"></div></div>
<div class="card"><div class="card-head"><h3>â±ï¸ Timeline Oggi</h3></div><div class="card-body" id="timelineDash" style="height:180px;overflow-y:auto;padding:8px 12px"></div></div>
</div>
<div class="grid-3 mb">
<div class="card"><div class="card-head"><h3>ğŸ“¦ Ordini In Attesa</h3></div><div class="card-body np" style="max-height:200px;overflow-y:auto"><table class="tbl"><thead><tr><th>Codice</th><th>Tecnico</th><th>Stato</th><th>Richiesto</th></tr></thead><tbody id="tblOrdDash"></tbody></table></div></div>
<div class="card"><div class="card-head"><h3>ğŸš Stato Automezzi</h3></div><div class="card-body" id="automezziDash"></div></div>
<div class="card"><div class="card-head"><h3>ğŸ“ ReperibilitÃ  Attiva</h3></div><div class="card-body" id="repDash"></div></div>
</div>
</section>

<!-- ========== SEC: CALENDARIO ========== -->
<section class="sec" id="secCalendario">
<div class="card mb">
<div class="card-head">
<h3>ğŸ“… Calendario Interventi</h3>
<div class="btn-group">
<button class="btn btn-sm btn-outline" onclick="calNav(-1)">â—€ Prec</button>
<button class="btn btn-sm btn-primary" id="calTitle">Febbraio 2026</button>
<button class="btn btn-sm btn-outline" onclick="calNav(1)">Succ â–¶</button>
</div>
</div>
<div class="card-body">
<div class="map-controls mb-sm">
<select id="calFiltroTec" onchange="renderCal()" style="padding:6px 10px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem"><option value="">Tutti i tecnici</option></select>
</div>
<div class="cal-grid" id="calGrid"></div>
<div id="calDetail" style="margin-top:16px"></div>
</div>
</div>
</section>

<!-- ========== SEC: INTERVENTI (PIANO) ========== -->
<section class="sec" id="secPiano">
<div class="card">
<div class="card-head">
<h3>ğŸ“‹ Tutti gli Interventi</h3>
<div class="btn-group">
<input type="date" id="filtPianoDataDa" onchange="renderPiano()" style="padding:5px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem" title="Da data">
<input type="date" id="filtPianoDataA" onchange="renderPiano()" style="padding:5px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem" title="A data">
<select id="filtPianoStato" onchange="renderPiano()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem"><option value="">Tutti gli stati</option><option value="da_confermare">â³ Da Confermare</option><option value="pianificato">Pianificato</option><option value="in_corso">In Corso</option><option value="completato">Completato</option><option value="annullato">Annullato</option></select>
<select id="filtPianoTec" onchange="renderPiano()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem"><option value="">Tutti i tecnici</option></select>
<button class="btn btn-ghost btn-sm" onclick="exportPianoCSV()" title="Esporta CSV">ğŸ“¥</button>
<button class="btn btn-primary btn-sm" onclick="openModal('modalPiano')">+ Nuovo Intervento</button>
</div>
</div>
<div class="card-body np" style="max-height:600px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Data</th><th>Ora</th><th>Tecnico</th><th>ğŸš</th><th>Cliente</th><th>Macchina</th><th>Tipo</th><th>Stato</th><th>Km</th><th>Ore</th><th></th></tr></thead><tbody id="tblPiano"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: URGENZE ========== -->
<section class="sec" id="secUrgenze">
<div class="card">
<div class="card-head">
<h3>ğŸš¨ Gestione Urgenze</h3>
<div class="btn-group">
<input type="date" id="filtUrgDataDa" onchange="renderUrgenze()" style="padding:5px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem" title="Da data">
<input type="date" id="filtUrgDataA" onchange="renderUrgenze()" style="padding:5px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem" title="A data">
<select id="filtUrgStato" onchange="renderUrgenze()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem"><option value="">Tutti</option><option value="aperta">ğŸ”´ Aperte</option><option value="assegnata">ğŸ‘¤ Assegnate</option><option value="schedulata">ğŸ“… Schedulate</option><option value="in_corso">âš¡ In Corso</option><option value="risolta">âœ… Risolte</option><option value="chiusa">ğŸ“ Chiuse</option></select>
<button class="btn btn-ghost btn-sm" onclick="exportUrgenzeCSV()" title="Esporta CSV">ğŸ“¥</button>
<button class="btn btn-err" onclick="openModal('modalUrgenza')" style="font-size:.9rem;padding:10px 20px;animation:pulse 2s infinite">ğŸš¨ + NUOVA URGENZA</button>
</div>
</div>
<div class="card-body np" style="max-height:600px;overflow-y:auto">
<table class="tbl"><thead><tr><th>PrioritÃ </th><th>Cliente</th><th>Macchina</th><th>Problema</th><th>Tecnico</th><th>SLA</th><th>Stato</th><th>Data</th><th></th></tr></thead><tbody id="tblUrgenze"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: ORDINI ========== -->
<section class="sec" id="secOrdini">
<div class="card">
<div class="card-head">
<h3>ğŸ“¦ Gestione Ordini Ricambi</h3>
<div class="btn-group">
<select id="filtOrdStato" onchange="renderOrdini()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem"><option value="">Tutti</option><option value="richiesto">Richiesto</option><option value="preso_in_carico">Preso in Carico</option><option value="ordinato">Ordinato</option><option value="in_arrivo">In Arrivo</option><option value="arrivato">Arrivato</option></select>
<button class="btn btn-ghost btn-sm" onclick="exportOrdiniCSV()" title="Esporta CSV">ğŸ“¥</button>
<button class="btn btn-info btn-sm" onclick="openModal('modalOrdine')">+ Nuovo Ordine</button>
</div>
</div>
<div class="card-body">
<div class="wf-steps mb">
<span class="wf-step" id="wfOrd1">ğŸ“ Richiesto</span><span class="wf-arrow">â†’</span>
<span class="wf-step" id="wfOrd2">ğŸ‘‹ Preso in Carico</span><span class="wf-arrow">â†’</span>
<span class="wf-step" id="wfOrd3">ğŸ“¦ Ordinato</span><span class="wf-arrow">â†’</span>
<span class="wf-step" id="wfOrd4">ğŸšš In Arrivo</span><span class="wf-arrow">â†’</span>
<span class="wf-step" id="wfOrd5">âœ… Arrivato</span>
</div>
</div>
<div class="card-body np" style="max-height:500px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Codice</th><th>Descrizione</th><th>QtÃ </th><th>Tecnico</th><th>Cliente</th><th>Stato</th><th>Richiesto</th><th>ETA</th><th></th></tr></thead><tbody id="tblOrdini"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: INSTALLAZIONI ========== -->
<section class="sec" id="secInstallazioni">
<div class="card">
<div class="card-head"><h3>ğŸ—ï¸ Installazioni in Corso</h3><button class="btn btn-primary btn-sm" onclick="openModal('modalInstall')">+ Nuova</button></div>
<div class="card-body np" style="max-height:600px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Cliente</th><th>Macchina</th><th>Inizio</th><th>Fine Prev.</th><th>Fase</th><th>Tecnici</th><th>Stato</th><th></th></tr></thead><tbody id="tblInstall"></tbody></table>
</div>
</div>
</section>


<!-- ========== SEC: REPERIBILITA ========== -->
<section class="sec" id="secReperibilita">
<div class="card">
<div class="card-head"><h3>ğŸ“ Turni ReperibilitÃ </h3><button class="btn btn-primary btn-sm" onclick="openModal('modalRep')">+ Nuovo Turno</button></div>
<div class="card-body">
<div class="tabs mb">
<button class="tab active" onclick="repTab('attivi',this)">Attivi</button>
<button class="tab" onclick="repTab('tutti',this)">Storico</button>
</div>
</div>
<div class="card-body np" style="max-height:500px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Tecnico</th><th>Dal</th><th>Al</th><th>Turno</th><th>Tipo</th><th>Stato</th><th>Note</th><th></th></tr></thead><tbody id="tblRep"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: TRASFERTE ========== -->
<section class="sec" id="secTrasferte">
<div class="card">
<div class="card-head"><h3>ğŸ§³ Trasferte</h3><button class="btn btn-primary btn-sm" onclick="openModal('modalTrasf')">+ Nuova Trasferta</button></div>
<div class="card-body np" style="max-height:500px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Tecnici</th><th>Cliente</th><th>Dal</th><th>Al</th><th>Automezzo</th><th>Motivo</th><th>Stato</th><th></th></tr></thead><tbody id="tblTrasf"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: NOTIFICHE ========== -->
<section class="sec" id="secNotifiche">
<div class="card">
<div class="card-head"><h3>ğŸ”” Notifiche</h3>
<div class="btn-group">
<button class="btn btn-ghost btn-sm" onclick="markAllRead()">Segna tutte lette</button>
<button class="btn btn-primary btn-sm" onclick="openModal('modalNotifica')">+ Nuova</button>
</div>
</div>
<div class="card-body np" style="max-height:600px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Da</th><th>Tipo</th><th>Oggetto</th><th>Destinatario</th><th>Stato</th><th>Data</th><th></th></tr></thead><tbody id="tblNotifiche"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: RICHIESTE ========== -->
<section class="sec" id="secRichieste">
<div class="card">
<div class="card-head"><h3>ğŸ“ Richieste</h3>
<div class="btn-group"><button class="btn btn-ok btn-sm" onclick="openNewRichiesta()">+ Nuova Richiesta</button></div>
</div>
<div class="card-body np" style="max-height:500px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Tecnico</th><th>Tipo</th><th>Motivo</th><th>Stato</th><th>Data</th><th></th></tr></thead><tbody id="tblRich"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: CLIENTI ========== -->
<section class="sec" id="secClienti">
<div class="card">
<div class="card-head"><h3>ğŸ¢ Anagrafica Clienti</h3>
<div class="btn-group">
<input type="text" id="srcClienti" placeholder="ğŸ” Cerca..." oninput="renderClienti()" style="padding:6px 12px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem;width:200px">
<button class="btn btn-ok btn-sm" onclick="apiCall('geocodeAll',{},'POST').then(r=>{toast('Geocodificati '+r.updated+' clienti','ok');refreshData()})">ğŸŒ Geocodifica</button>
<button class="btn btn-ghost btn-sm" onclick="exportClientiCSV()" title="Esporta CSV">ğŸ“¥</button>
<button class="btn btn-ok btn-sm" onclick="openNewCliente()">+ Nuovo Cliente</button>
</div>
</div>
<div class="card-body np" style="max-height:600px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Nome</th><th>CittÃ </th><th>Prov</th><th>Indirizzo</th><th>Telefono</th><th>Contratto</th><th>ğŸ“</th><th></th></tr></thead><tbody id="tblClienti"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: MACCHINE ========== -->
<section class="sec" id="secMacchine">
<div class="card">
<div class="card-head"><h3>âš™ï¸ Parco Macchine</h3>
<div class="btn-group" style="flex-wrap:wrap;gap:6px">
<input type="text" id="srcMacch" placeholder="Cerca macchina..." oninput="renderMacchine()" style="padding:6px 12px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem;width:200px">
<select id="filtMacchCli" onchange="renderMacchine()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem"><option value="">Tutti i clienti</option></select>
<select id="filtMacchType" onchange="renderMacchine()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem"><option value="">Tutti i tipi</option></select>
<select id="filtMacchView" onchange="renderMacchine()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem">
  <option value="tree">Vista ad albero</option>
  <option value="list">Vista lista</option>
</select>
</div>
</div>
<div id="macchStats" style="padding:8px 14px;display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid #eee"></div>
<div class="card-body np" style="max-height:700px;overflow-y:auto">
<div id="macchTreeView"></div>
<table class="tbl" id="macchListTable" style="display:none"><thead><tr><th style="width:30px"></th><th>Modello</th><th>Asset</th><th>N. Serie</th><th>Cliente</th><th>Stato</th><th style="width:180px">Azioni</th></tr></thead><tbody id="tblMacchine"></tbody></table>
</div>
</div>
<!-- Modal mappa singolo asset -->
<div id="macchMapModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;background:rgba(0,0,0,.5)">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:700px;background:white;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)">
    <div style="padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee">
      <h4 id="macchMapTitle" style="margin:0"></h4>
      <button class="btn btn-xs" onclick="closeMacchMap()">âœ•</button>
    </div>
    <div id="macchMapContainer" style="height:400px"></div>
  </div>
</div>
</section>

<!-- ========== SEC: AUTOMEZZI ========== -->
<section class="sec" id="secAutomezzi">
<div class="card">
<div class="card-head"><h3>ğŸš Flotta Automezzi</h3>
<button class="btn btn-primary btn-sm" onclick="openNewAutomezzo()">+ Nuovo Automezzo</button>
</div>
<div class="card-body" id="furgGrid"></div>
</div>
</section>

<!-- ========== SEC: TECNICI ========== -->
<section class="sec" id="secTecnici">
<div class="card">
<div class="card-head"><h3>ğŸ‘¥ Tecnici & Staff</h3>
<button class="btn btn-primary btn-sm" onclick="openNewUtente()">+ Nuovo Utente</button>
</div>
<div class="card-body np">
<table class="tbl"><thead><tr><th>Foto</th><th>Nome</th><th>Ruolo</th><th>Squadra</th><th>Automezzo</th><th>Base</th><th>Telefono</th><th>Email</th><th>Attivo</th><th></th></tr></thead><tbody id="tblTecnici"></tbody></table>
</div>
</div>
</section>


<!-- ========== SEC: AI PLANNER ========== -->
<section class="sec" id="secAi">
<div class="ai-box">
<h3>ğŸ¤– AI Planner â€” Simulatore Intelligente</h3>
<p>Descrivi i vincoli e le esigenze in linguaggio naturale. Puoi anche allegare documenti (Excel, PDF, Word, foto) che l'AI userÃ  per ottimizzare il piano.</p>
<textarea id="aiPrompt" placeholder="Es: Pianifica la prossima settimana. Marco Ã¨ in ferie lunedÃ¬ e martedÃ¬. Dai prioritÃ  ai tagliandi scaduti. Il automezzo F3 Ã¨ in officina."></textarea>
<div style="margin-top:12px">
<div id="aiUploadZone" style="border:2px dashed rgba(255,255,255,.3);border-radius:var(--radius);padding:16px;text-align:center;cursor:pointer;margin-bottom:12px;transition:all .2s" onclick="$('aiFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#6366F1';this.style.background='rgba(99,102,241,.1)'" ondragleave="this.style.borderColor='rgba(255,255,255,.3)';this.style.background='transparent'" ondrop="event.preventDefault();handleAIFileDrop(event);this.style.borderColor='rgba(255,255,255,.3)';this.style.background='transparent'">
ğŸ“ <strong>Trascina qui</strong> o clicca per allegare documenti (xlsx, pdf, docx, foto)
<input type="file" id="aiFileInput" multiple accept=".xlsx,.xls,.pdf,.docx,.doc,.jpg,.jpeg,.png,.csv" style="display:none" onchange="handleAIFiles(this.files)">
</div>
<div id="aiFileList" style="display:none;margin-bottom:12px"></div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
<label class="btn btn-sm" style="background:#22c55e;color:white;cursor:pointer">ğŸ“Š Importa Piano da Excel <input type="file" accept=".xlsx,.xls" style="display:none" onchange="importPlanFromExcel(this.files[0])"></label>
<span style="font-size:.75rem;color:rgba(255,255,255,.5);align-self:center">Carica il file Programmazione Mensile come base di partenza</span>
</div>
<div id="excelImportPreview" style="display:none;margin-bottom:12px"></div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn btn-lg" style="background:#6366F1;color:white" onclick="runAI()">ğŸ¤– Genera Piano</button>
<button class="btn btn-lg" style="background:#22c55e;color:white" onclick="downloadAIPlanXlsx()" id="btnDownloadPlan" disabled>ğŸ“¥ Scarica Excel</button>
<button class="btn btn-lg" style="background:#10B981;color:white" onclick="applyAI()" id="btnApplyAI" disabled>âœ… Applica al Sistema</button>
<button class="btn btn-lg" style="background:#3B82F6;color:white" onclick="submitAIPlanForApproval()" id="btnSubmitPlan" disabled>ğŸ“¤ Invia per Approvazione</button>
</div>
<div class="ai-result" id="aiResult" style="display:none"></div>
</div>

<!-- Workflow Approvativo -->
<div class="card" style="margin-top:24px">
<div class="card-head"><h3>ğŸ“‹ Iter Approvativo Piano</h3>
<div class="btn-group">
<select id="approvalFilter" onchange="renderApprovalQueue()" style="padding:6px 10px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem">
<option value="">Tutti</option><option value="in_attesa">In attesa</option><option value="approvato">Approvati</option><option value="rifiutato">Rifiutati</option>
</select>
</div>
</div>
<div class="card-body np" style="max-height:400px;overflow-y:auto">
<table class="tbl"><thead><tr>
<th>ID</th><th>Data</th><th>Creato da</th><th>Stato</th><th>Approvato da</th><th>Note</th><th>Azioni</th>
</tr></thead><tbody id="tblApproval"></tbody></table>
</div>
</div>

<!-- Vista Tecnico: Piano Personale -->
<div class="card" style="margin-top:16px" id="cardTecnicoPlan">
<div class="card-head"><h3>ğŸ‘· Piano Personale</h3>
<div class="btn-group">
<select id="tecViewSelect" onchange="renderTecnicoPlan()" style="padding:6px 10px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem">
<option value="mio">Il mio piano</option><option value="tutti">Tutti i piani (sola lettura)</option>
</select>
</div>
</div>
<div class="card-body np" style="max-height:500px;overflow-y:auto">
<div id="tecnicoPlanGrid"></div>
</div>
</div>
</section>

<!-- ========== SEC: MAPPA ========== -->
<section class="sec" id="secMappa">
<div class="card">
<div class="card-head"><h3>ğŸ—ºï¸ Mappa Operativa</h3>
<div class="btn-group">
<button class="btn btn-sm btn-ok" onclick="geocodeAllClienti()">&#x1F30D; Geocodifica Clienti</button>
<button class="btn btn-sm" style="background:#2563EB;color:white" onclick="openGoogleMaps()">&#x1F4CD; Google Maps</button>
</div>
</div>
<div class="card-body">
<div class="map-controls">
<select id="mapFiltroTec" onchange="updateMap()" style="padding:6px 10px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem"><option value="">Tutti i tecnici</option></select>
<select id="mapFiltroGiorno" onchange="updateMap()" style="padding:6px 10px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem"><option value="tutti_clienti">ğŸ  Tutti i clienti</option><option value="oggi">ğŸ“‹ Oggi</option><option value="domani">ğŸ“… Domani</option><option value="settimana">ğŸ“† Settimana</option></select>
<label class="field-check" style="font-size:.8125rem"><input type="checkbox" id="mapPercorso" onchange="updateMap()" checked> Mostra percorso</label>
<button class="btn btn-sm btn-ok" onclick="openGoogleMaps()">ğŸ“ Google Maps</button>
</div>
<div id="mapLegenda" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px;font-size:.75rem"></div>
<div id="mapAdmin" style="height:500px"></div>
<div id="mapInfo" style="margin-top:12px;font-size:.8125rem;color:var(--gray)"></div>
</div>
</div>
</section>

<!-- ========== SEC: KPI ========== -->
<section class="sec" id="secKpi">
<div class="card mb">
<div class="card-head"><h3>ğŸ“ˆ KPI Dashboard</h3>
<div class="btn-group">
<select id="kpiPeriodo" onchange="loadKPIWithCharts()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem">
<option value="giorno">Oggi</option><option value="settimana" selected>Settimana</option><option value="mese">Mese</option><option value="trimestre">Trimestre</option>
</select>
<select id="kpiTecnico" onchange="loadKPIWithCharts()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem"><option value="">Tutti</option></select>
</div>
</div>
<div class="card-body">
<div class="kpi-grid" id="kpiGrid"></div>
</div>
</div>
<div class="grid-2 mb">
<div class="card"><div class="card-head"><h3>&#x1F4CA; Interventi per Mese</h3></div>
<div class="card-body" style="height:260px;position:relative"><canvas id="chartMensile"></canvas></div></div>
<div class="card"><div class="card-head"><h3>&#x1F369; Distribuzione Stati</h3></div>
<div class="card-body" style="height:260px;position:relative"><canvas id="chartStati"></canvas></div></div>
</div>
<div class="grid-2 mb">
<div class="card"><div class="card-head"><h3>&#x23F1; SLA Compliance per Tecnico</h3></div>
<div class="card-body" style="height:260px;position:relative"><canvas id="chartSLATec"></canvas></div></div>
<div class="card"><div class="card-head"><h3>&#x23F3; Ore Lavorate per Tecnico</h3></div>
<div class="card-body" style="height:260px;position:relative"><canvas id="chartOreTec"></canvas></div></div>
</div>
<div class="card">
<div class="card-head"><h3>ğŸ‘¥ Classifica Tecnici</h3></div>
<div class="card-body np" style="max-height:400px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Tecnico</th><th>Interventi</th><th>Completati</th><th>%</th><th>Km Tot</th><th>Ore Tot</th><th>Media Voto</th><th>SLA %</th></tr></thead><tbody id="tblKpiTec"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: PLANNER VISUALE ========== -->
<section class="sec" id="secPlanner">
<div class="card mb">
<div class="card-head">
<h3>&#x1F4C6; Planner Visuale Settimanale</h3>
<div class="btn-group">
<button class="btn btn-sm btn-outline" onclick="plannerNav(-1)">&#9664; Prec</button>
<span id="plannerTitle" style="font-size:.875rem;font-weight:600;padding:0 8px"></span>
<button class="btn btn-sm btn-outline" onclick="plannerNav(1)">Succ &#9654;</button>
<button class="btn btn-sm btn-primary" onclick="openModal('modalPiano')">+ Intervento</button>
<button class="btn btn-sm" style="background:#6366F1;color:white" onclick="runAIPlanner()">&#x1F916; AI Genera Piano</button>
</div>
</div>
<div class="card-body">
<div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<select id="plannerFiltroTec" onchange="renderPlanner()" style="padding:6px 10px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem"><option value="">Tutti i tecnici</option></select>
<label style="font-size:.8125rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="plannerShowUrg" onchange="renderPlanner()" checked> Mostra urgenze</label>
<label style="font-size:.8125rem;display:flex;align-items:center;gap:4px"><input type="checkbox" id="plannerShowLiberi" onchange="renderPlanner()"> Evidenzia slot liberi</label>
</div>
<div style="overflow-x:auto"><div id="plannerGrid" style="min-width:900px"></div></div>
<div id="plannerLegend" style="margin-top:14px;padding:12px 16px;background:#F8FAFC;border-radius:8px;border:1px solid #E2E8F0"></div>
</div>
</div>
<div class="card">
<div class="card-head"><h3>&#x1F4CB; Dettaglio Giorno Selezionato</h3></div>
<div class="card-body" id="plannerDayDetail"><p style="color:var(--gray)">Clicca su un giorno nell'intestazione per vederne il riepilogo. Clicca su un intervento nella griglia per modificarlo. Trascina gli interventi per spostarli ad altro tecnico/giorno.</p></div>
</div>
</section>

<!-- ========== SEC: PAGELLINI ========== -->
<section class="sec" id="secPagellini">
<div class="card">
<div class="card-head"><h3>ğŸ¯ Pagellini / Valutazioni</h3>
<button class="btn btn-primary btn-sm" onclick="openModal('modalPagellino')">+ Nuovo Pagellino</button>
</div>
<div class="card-body">
<div class="tabs mb">
<button class="tab active" onclick="pagTab('bozze',this)">ğŸ“ Bozze</button>
<button class="tab" onclick="pagTab('approvati',this)">âœ… Approvati</button>
<button class="tab" onclick="pagTab('tutti',this)">Tutti</button>
</div>
</div>
<div class="card-body np" style="max-height:500px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Tecnico</th><th>Data</th><th>Periodo</th><th>Valutatore</th><th>Media</th><th>Stato</th><th></th></tr></thead><tbody id="tblPag"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: SLA MONITOR ========== -->
<section class="sec" id="secSla">
<div class="card mb">
<div class="card-head"><h3>â±ï¸ SLA Monitoring</h3>
<button class="btn btn-sm btn-warn" onclick="apiCall('updateSLAStatus',{},'POST').then(r=>{toast('SLA aggiornati: '+r.updated,'ok');refreshData()})">ğŸ”„ Aggiorna SLA</button>
</div>
<div class="card-body">
<div class="kpi-grid" id="slaKpi"></div>
</div>
</div>
<div class="card">
<div class="card-head"><h3>Urgenze con SLA Attivo</h3></div>
<div class="card-body np" style="max-height:400px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Urgenza</th><th>Cliente</th><th>PrioritÃ </th><th>Scadenza</th><th>SLA Status</th><th>% Tempo</th><th></th></tr></thead><tbody id="tblSla"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: DOCUMENTI (FULL) ========== -->
<section class="sec" id="secDocumenti">
<div class="card">
<div class="card-head"><h3>ğŸ“ Documenti</h3>
<div class="btn-group">
<input type="text" id="filtDocSearch" placeholder="Cerca nome, tags..." oninput="renderDocumenti()" style="padding:6px 12px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem;width:200px">
<select id="filtDocCat" onchange="renderDocumenti()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem">
<option value="">Tutte le categorie</option>
<option>Contratti</option><option>Manuali</option><option>Certificati</option><option>Report</option><option>Altro</option>
</select>
<button class="btn btn-primary btn-sm" onclick="openModal('modalDocumento')">+ Documento</button>
</div></div>
<div class="card-body"><div id="tblDocumenti"></div></div>
</div>
</section>

<!-- ========== SEC: CHECKLIST ========== -->
<section class="sec" id="secChecklist">
<div class="card">
<div class="card-head"><h3>âœ… Checklist Templates</h3>
<div class="btn-group">
<button class="btn btn-primary btn-sm" onclick="openModal('modalChecklist')">+ Template</button>
</div></div>
<div class="card-body"><div id="tblChecklist"></div></div>
</div>
<div class="card" style="margin-top:16px">
<div class="card-head"><h3>ğŸ“‹ Checklist Compilate</h3></div>
<div class="card-body"><div id="tblChecklistCompilate"></div></div>
</div>
</section>

<!-- ========== SEC: ALLEGATI ========== -->
<section class="sec" id="secAllegati">
<div class="card">
<div class="card-head"><h3>ğŸ“ Allegati</h3>
<div class="btn-group">
<select id="filtAllTipo" onchange="renderAllegati()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem">
<option value="">Tutti i tipi</option>
<option value="piano">Interventi</option><option value="urgenza">Urgenze</option><option value="altro">Altro</option>
</select>
<button class="btn btn-primary btn-sm" onclick="openModal('modalAllegato')">+ Allegato</button>
</div></div>
<div class="card-body"><div id="tblAllegati"></div></div>
</div>
</section>

<!-- ========== SEC: REPORT BUILDER ========== -->
<section class="sec" id="secReport">
<div class="card">
<div class="card-head"><h3>ğŸ“Š Report Builder</h3></div>
<div class="card-body">
<div class="field-row" style="margin-bottom:16px">
<div class="field"><label>Tipo Report</label>
<select id="rptTipo" style="padding:8px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);width:100%">
<option value="interventi_tecnico">Interventi per Tecnico</option>
<option value="urgenze_summary">Urgenze Summary</option>
<option value="clienti_inattivi">Clienti Inattivi (>90gg)</option>
<option value="kpi_mensile">KPI Mensile</option>
<option value="performance_squadra">Performance per Squadra</option>
</select></div>
<div class="field"><label>Da</label><input type="date" id="rptDa"></div>
<div class="field"><label>A</label><input type="date" id="rptA"></div>
<div class="field"><label>Tecnico</label><select id="rptTecnico" style="padding:8px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);width:100%"><option value="">Tutti</option></select></div>
</div>
<div style="display:flex;gap:8px;margin-bottom:16px">
<button class="btn btn-primary" onclick="generateReportAdmin()">ğŸ“Š Genera Report</button>
<button class="btn btn-outline" onclick="printReport()">ğŸ–¨ï¸ Stampa</button>
</div>
<div id="reportOutput" style="border:1px solid var(--gray4);border-radius:var(--radius);padding:16px;min-height:200px;background:#fff"></div>
</div>
</div>
</section>

<!-- ========== SEC: EMAIL CONFIG ========== -->
<section class="sec" id="secEmailconfig">
<div class="card">
<div class="card-head"><h3>ğŸ“§ Configurazione Email</h3></div>
<div class="card-body">
<div style="margin-bottom:16px;padding:12px;background:#FEF3C7;border-radius:var(--radius-sm);font-size:.8125rem">
âš ï¸ Richiede autorizzazione GmailApp in Apps Script. Le email partono dall'account che ha deployato l'API.
</div>
<div class="field" style="margin-bottom:12px">
<label>Email Abilitata</label>
<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="cfgEmailEnabled" onchange="saveEmailConfig()"> Attiva invio email automatiche</label>
</div>
<div class="field" style="margin-bottom:12px">
<label>Eventi Abilitati</label>
<div style="display:flex;flex-direction:column;gap:6px">
<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="evtUrgenza" value="urgenza_creata" onchange="saveEmailConfig()"> ğŸš¨ Nuova urgenza creata</label>
<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="evtIntervento" value="intervento_assegnato" onchange="saveEmailConfig()"> ğŸ“‹ Intervento assegnato</label>
<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="evtRichiesta" value="richiesta_risposta" onchange="saveEmailConfig()"> ğŸ“ Richiesta approvata/rifiutata</label>
</div></div>
<div class="field-row" style="margin-top:16px">
<div class="field"><label>Test Email</label><input type="email" id="testEmailAddr" placeholder="email@test.com"></div>
<div class="field" style="padding-top:24px"><button class="btn btn-outline" onclick="sendTestEmail()">ğŸ“§ Invia Test</button></div>
</div>
</div>
</div>
</section>

<!-- ========== SEC: TELEGRAM CONFIG ========== -->
<section class="sec" id="secTelegramconfig">
<div class="card">
<div class="card-head"><h3>ğŸ’¬ Configurazione Telegram</h3></div>
<div class="card-body">
<div style="margin-bottom:16px;padding:12px;background:#DBEAFE;border-radius:var(--radius-sm);font-size:.8125rem">
â„¹ï¸ <b>Setup:</b> 1) Crea bot con @BotFather su Telegram â†’ copia token. 2) Ogni tecnico avvia il bot e invia /start. 3) Usa @userinfobot o /getUpdates per ottenere il chat_id.
</div>
<div class="field" style="margin-bottom:16px"><label>Bot Token</label><input type="text" id="cfgTgToken" placeholder="123456:ABC-DEF..." style="width:100%;font-family:JetBrains Mono,monospace;font-size:.75rem"></div>
<button class="btn btn-outline btn-sm" onclick="saveTelegramConfig()" style="margin-bottom:16px">ğŸ’¾ Salva Token + Chat ID</button><h4 style="margin:16px 0 8px">Chat ID per Tecnico</h4>
<div id="tblTelegramIds"></div>
<div class="field-row" style="margin-top:16px">
<div class="field"><label>Test Chat ID</label><input type="text" id="testTgChatId" placeholder="123456789"></div>
<div class="field" style="padding-top:24px"><button class="btn btn-outline" onclick="sendTestTelegram()">ğŸ’¬ Invia Test</button></div>
</div>

<hr style="margin:24px 0;border:none;border-top:1px solid var(--gray3)">
<h4 style="margin-bottom:12px">ğŸ“¨ Invia Messaggio a Tecnici</h4>
<div class="field"><label>Destinatari</label>
<select id="tgMsgDest" style="width:100%"><option value="all">ğŸ”” Tutti i tecnici con Chat ID</option></select>
</div>
<div class="field"><label>Messaggio</label><textarea id="tgMsgText" rows="3" placeholder="Scrivi il messaggio da inviare via Telegram..."></textarea></div>
<div style="display:flex;gap:8px">
<button class="btn btn-outline" onclick="sendTelegramBroadcast()">ğŸ“¨ Invia Messaggio</button>
<button class="btn btn-outline" onclick="openTelegramBot()" id="btnOpenTgBot" style="display:none">ğŸ¤– Apri Bot Telegram</button>
</div>

<hr style="margin:24px 0;border:none;border-top:1px solid var(--gray3)">
<h4 style="margin-bottom:12px">ğŸ’¬ Chat Gruppo Telegram</h4>
<div style="padding:12px;background:var(--gray5);border-radius:var(--radius-sm);margin-bottom:12px">
<p style="font-size:.8125rem;color:var(--gray);margin-bottom:8px">Per accedere alla chat del gruppo, inserisci l'ID o il link del gruppo nella configurazione, poi clicca il bottone per aprire Telegram.</p>
<div class="field"><label>Link/ID Gruppo</label><input type="text" id="cfgTgGroup" placeholder="@gruppo o https://t.me/gruppo" style="width:100%"></div>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn btn-primary btn-sm" onclick="saveTelegramGroup()">ğŸ’¾ Salva</button>
<button class="btn btn-outline btn-sm" onclick="openTelegramGroup()">ğŸ’¬ Apri Gruppo Telegram</button>
</div>
</div>
</div>
</div>
</section>

<!-- ========== SEC: BACKUP ========== -->
<section class="sec" id="secBackup">
<div class="card">
<div class="card-head"><h3>ğŸ’¾ Backup Automatico</h3>
<button class="btn btn-primary btn-sm" onclick="runBackupNow()">âš¡ Backup Adesso</button>
</div>
<div class="card-body">
<div class="field" style="margin-bottom:16px"><label>ID Cartella Google Drive per Backup</label>
<input type="text" id="cfgBackupFolder" placeholder="Es: 1ABCxyz... (dall'URL della cartella Drive)" style="width:100%;font-family:JetBrains Mono,monospace;font-size:.75rem">
<button class="btn btn-outline btn-sm" onclick="saveBackupConfig()" style="margin-top:8px">ğŸ’¾ Salva</button>
</div>
<div style="margin-bottom:16px;padding:12px;background:#F0FDF4;border-radius:var(--radius-sm);font-size:.8125rem">
ğŸ’¡ Per backup automatico giornaliero: Apps Script â†’ Trigger â†’ dailyMaintenance â†’ Ogni giorno alle 02:00
</div>
<h4>Storico Backup</h4>
<div id="tblBackupHistory"><div class="empty"><p>Caricamento...</p></div></div>
</div>
</div>
</section>

<!-- ========== SEC: AUDIT LOG ========== -->
<section class="sec" id="secAuditlog">
<div class="card">
<div class="card-head"><h3>ğŸ“œ Audit Trail</h3>
<div class="btn-group">
<select id="filtLogEntity" onchange="renderAuditLog()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem"><option value="">Tutte le entitÃ </option><option value="piano">Interventi</option><option value="urgenza">Urgenze</option><option value="ordine">Ordini</option><option value="pagellino">Pagellini</option></select>
<input type="date" id="filtLogData" onchange="renderAuditLog()" style="padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.75rem">
</div>
</div>
<div class="card-body np" style="max-height:600px;overflow-y:auto">
<table class="tbl"><thead><tr><th>Timestamp</th><th>EntitÃ </th><th>ID</th><th>Azione</th><th>Utente</th><th>Dettagli</th></tr></thead><tbody id="tblLog"></tbody></table>
</div>
</div>
</section>

<!-- ========== SEC: POWER BI ========== -->
<section class="sec" id="secPowerbi">
<div class="card mb">
<div class="card-head"><h3>âš¡ Power BI â€” Connessione Live</h3></div>
<div class="card-body">
<p style="margin-bottom:16px;font-size:.875rem;color:var(--gray)">Connetti Power BI Desktop ai dati Syntoniqa in tempo reale tramite gli endpoint seguenti.</p>
<div class="field"><label>URL Base (Tutti i Dati)</label><input type="text" id="pbiUrl" readonly onclick="this.select()" style="font-family:var(--mono);font-size:.75rem;background:var(--gray5)"></div>
<div class="grid-2 mb">
<div>
<h4 style="font-size:.8125rem;margin-bottom:8px;font-weight:600">ğŸ“Š Fact Tables</h4>
<div id="pbiFacts" style="font-size:.8125rem"></div>
</div>
<div>
<h4 style="font-size:.8125rem;margin-bottom:8px;font-weight:600">ğŸ“ Dimension Tables</h4>
<div id="pbiDims" style="font-size:.8125rem"></div>
</div>
</div>
<div class="card" style="background:var(--gray5)">
<div class="card-body" style="font-size:.8125rem;font-family:var(--mono)">
<strong>Setup Power BI Desktop:</strong><br>
1. Recupera Dati â†’ Web<br>
2. Inserisci URL dalla tabella sopra<br>
3. Trasforma Dati: il JSON viene convertito automaticamente<br>
4. Imposta refresh automatico nelle impostazioni
</div>
</div>
</div>
</div>
</section>

<!-- ========== SEC: ANAGRAFICA ========== -->
<section class="sec" id="secAnagrafica">
<div class="sec-head" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
  <h2>ğŸ“‹ Anagrafica Clienti & Assets</h2>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <input type="text" id="anagSearch" placeholder="Cerca cliente, cittÃ , M3..." style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;font-size:.8125rem;width:220px" oninput="filterAnagClients()">
    <select id="anagFilterType" onchange="filterAnagClients()" style="padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:.8rem">
      <option value="">Tutti i prodotti</option>
      <option value="ROBOT">Astronaut</option>
      <option value="JUNO">Juno</option>
      <option value="VECTOR">Vector</option>
      <option value="DISCOVERY">Discovery</option>
      <option value="COLLECTOR">Collector</option>
      <option value="COSMIX">Cosmix</option>
      <option value="NAUTILUS">Nautilus</option>
      <option value="LUNA">Luna</option>
      <option value="CU">Central Unit</option>
      <option value="CALM">Calm</option>
      <option value="COMPRESSORI">Compressori</option>
      <option value="METEOR">Meteor</option>
      <option value="GRAZEWAY">Grazeway</option>
      <option value="L4C LED">L4C LED</option>
    </select>
    <button class="btn btn-sm" onclick="anagView='list';renderAnagClients(ANAG_FILTERED)" title="Vista Lista" id="btnAnagList">ğŸ“‹</button>
    <button class="btn btn-sm" onclick="anagView='map';renderAnagClients(ANAG_FILTERED)" title="Vista Mappa" id="btnAnagMap">ğŸ—ºï¸</button>
    <button class="btn btn-sm" onclick="loadAnagClients()" title="Ricarica">ğŸ”„</button>
    <label class="btn btn-sm btn-primary" style="cursor:pointer">ğŸ“¤ Importa XLSX<input type="file" accept=".xlsx,.xls" style="display:none" onchange="importAnagXlsx(this.files[0])"></label>
  </div>
</div>
<div id="anagStats" style="display:flex;gap:12px;margin:8px 0;flex-wrap:wrap"></div>
<!-- MAP VIEW -->
<div id="anagMapWrap" style="display:none;height:550px;border-radius:8px;overflow:hidden;margin-bottom:12px"></div>
<!-- TREE LIST VIEW -->
<div id="anagTreeWrap">
<div class="table-wrap">
<table class="tbl" id="anagClientiTable">
<thead><tr>
  <th style="width:30px"></th>
  <th>Cliente</th>
  <th>CittÃ </th>
  <th>Prov.</th>
  <th>Stato</th>
  <th>Titolare</th>
  <th title="Astronaut">ğŸ¤–</th>
  <th title="Juno">ğŸ”„</th>
  <th title="Vector">ğŸšœ</th>
  <th title="Discovery">ğŸ§¹</th>
  <th title="CU">ğŸ–¥ï¸</th>
  <th title="Cosmix">ğŸ¥£</th>
  <th title="Nautilus">ğŸ”§</th>
  <th title="Altri">ğŸ“¦</th>
  <th>Tot</th>
  <th style="width:80px"></th>
</tr></thead>
<tbody id="anagClientiBody"></tbody>
</table>
</div>
</div>
</section>

<!-- ========== SEC: CHAT INTERNA ========== -->
<section class="sec" id="secChat">
<div style="display:grid;grid-template-columns:280px 1fr;gap:0;height:calc(100vh - var(--header) - 40px)">
<!-- Lista Canali -->
<div class="card" style="border-radius:var(--radius) 0 0 var(--radius);border-right:1px solid #E5E7EB;display:flex;flex-direction:column">
<div class="card-head" style="flex-shrink:0"><h3>ğŸ’¬ Canali</h3><button class="btn btn-primary btn-xs" onclick="openNewCanale()">+</button></div>
<div id="chatCanaliList" style="flex:1;overflow-y:auto;padding:4px 0"></div>
</div>
<!-- Area Messaggi -->
<div class="card" style="border-radius:0 var(--radius) var(--radius) 0;display:flex;flex-direction:column">
<div class="card-head" style="flex-shrink:0"><h3 id="chatTitle">Seleziona un canale</h3><span id="chatMembri" style="font-size:.75rem;color:var(--gray)"></span></div>
<div id="chatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px;background:var(--gray5)">
<div class="empty" style="margin:auto"><p>Seleziona un canale per iniziare</p></div>
</div>
<div id="adminChatAllegatoPreview" style="display:none;padding:6px 12px;border-top:1px solid #E5E7EB;background:var(--gray5)"></div>
<div id="chatInput" style="padding:12px;border-top:1px solid #E5E7EB;display:none">
<form onsubmit="sendChat(event)" style="display:flex;gap:8px;align-items:center">
<label style="cursor:pointer;font-size:1.2rem;padding:0 4px;display:flex;align-items:center" title="Allega foto/file">ğŸ“<input type="file" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx" style="display:none" onchange="adminChatAllegatoChange(this)"></label>
<input type="text" id="chatText" placeholder="Scrivi un messaggio..." style="flex:1;padding:10px 14px;border:1.5px solid var(--gray3);border-radius:20px;font-size:.8125rem;font-family:var(--font)" autocomplete="off">
<button type="submit" class="btn btn-primary" style="border-radius:20px;padding:10px 18px">ğŸ“¤</button>
</form>
</div>
</div>
</div>
</section>

<!-- ========== SEC: CONFIGURAZIONE ========== -->
<section class="sec" id="secConfig">
<div class="card">
<div class="card-head"><h3>ğŸ”§ Configurazione Sistema</h3><button class="btn btn-ok btn-sm" onclick="saveConfig()">ğŸ’¾ Salva</button></div>
<div class="card-body" id="configBody"></div>
</div>
</section>


</div><!-- /content -->
</div><!-- /main -->

<!-- ========== MODALS ========== -->

<!-- MODAL: Nuovo Intervento -->
<div class="modal-overlay" id="modalPiano">
<div class="modal modal-lg">
<div class="modal-head"><h2>ğŸ“‹ Nuovo Intervento</h2><button class="close" onclick="closeModal('modalPiano')">âœ•</button></div>
<div class="modal-body">
<div class="field-row-3">
<div class="field"><label>Data</label><input type="date" id="mpData"></div>
<div class="field"><label>Data Fine (multi-giorno)</label><input type="date" id="mpDataFine"></div>
<div class="field"><label>Ora Inizio</label><input type="time" id="mpOra" value="08:00"></div>
</div>
<div class="field-row-3">
<div class="field"><label>Tecnico Principale</label><select id="mpTecnico"></select></div>
<div class="field"><label>Tecnici Aggiuntivi</label><select id="mpTecnici" multiple style="min-height:60px"></select></div>
<div class="field"><label>Automezzo</label><select id="mpAutomezzo"></select></div>
</div>
<div class="field-row-3">
<div class="field"><label>Cliente</label><select id="mpCliente" onchange="loadMacchineCliente('mp')"></select></div>
<div class="field"><label>Macchina</label><select id="mpMacchina"></select></div>
<div class="field"><label>Tipo Intervento</label><select id="mpTipo"></select></div>
</div>
<div class="field-row">
<div class="field"><label>PrioritÃ </label><select id="mpPriorita"></select></div>
<div class="field"><label>Durata Ore (stima)</label><input type="number" id="mpDurata" value="2" step="0.5" min="0.5"></div>
</div>
<div class="field"><label>Note</label><textarea id="mpNote" rows="2"></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalPiano')">Annulla</button>
<button class="btn btn-primary" onclick="savePiano()">ğŸ’¾ Salva Intervento</button>
</div>
</div>
</div>

<!-- MODAL: Nuova Urgenza -->
<div class="modal-overlay" id="modalUrgenza">
<div class="modal">
<div class="modal-head"><h2>ğŸš¨ Nuova Urgenza</h2><button class="close" onclick="closeModal('modalUrgenza')">âœ•</button></div>
<div class="modal-body">
<div class="field-row">
<div class="field"><label>Cliente</label><select id="muCliente" onchange="loadMacchineCliente('mu')"></select></div>
<div class="field"><label>Macchina</label><select id="muMacchina"></select></div>
</div>
<div class="field"><label>Problema</label><textarea id="muProblema" rows="3" placeholder="Descrivi il problema..."></textarea></div>
<div class="field"><label>PrioritÃ </label><select id="muPriorita"></select></div>
<div class="field"><label>Note</label><textarea id="muNote" rows="2"></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalUrgenza')">Annulla</button>
<button class="btn btn-err" onclick="saveUrgenza()">ğŸš¨ Crea Urgenza</button>
</div>
</div>
</div>

<!-- MODAL: Assegna Urgenza -->
<div class="modal-overlay" id="modalAssegna">
<div class="modal">
<div class="modal-head"><h2>ğŸ‘¤ Assegna Urgenza</h2><button class="close" onclick="closeModal('modalAssegna')">âœ•</button></div>
<div class="modal-body">
<input type="hidden" id="maUrgId">
<div class="field-row">
<div class="field"><label>Tecnico</label><select id="maTecnico"></select></div>
<div class="field"><label>Automezzo</label><select id="maAutomezzo"></select></div>
</div>
<div class="field-row">
<div class="field"><label>Data Prevista</label><input type="date" id="maData"></div>
<div class="field"><label>Ora Prevista</label><input type="time" id="maOra" value="08:00"></div>
</div>
<label class="field-check" style="margin-top:8px"><input type="checkbox" id="maCreaInt" checked> Crea intervento automaticamente</label>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalAssegna')">Annulla</button>
<button class="btn btn-primary" onclick="saveAssegna()">âœ… Assegna</button>
</div>
</div>
</div>

<!-- MODAL: Nuovo Ordine -->
<div class="modal-overlay" id="modalOrdine">
<div class="modal">
<div class="modal-head"><h2>ğŸ“¦ Nuovo Ordine Ricambi</h2><button class="close" onclick="closeModal('modalOrdine')">âœ•</button></div>
<div class="modal-body">
<div class="field-row">
<div class="field"><label>Codice Ricambio</label><input type="text" id="moCodice" placeholder="Es: LY-12345"></div>
<div class="field"><label>QuantitÃ </label><input type="number" id="moQta" value="1" min="1"></div>
</div>
<div class="field"><label>Descrizione</label><input type="text" id="moDesc" placeholder="Descrizione pezzo"></div>
<div class="field-row">
<div class="field"><label>Tecnico Richiedente</label><select id="moTecnico"></select></div>
<div class="field"><label>Cliente (opzionale)</label><select id="moCliente"><option value="">â€”</option></select></div>
</div>
<div class="field"><label>Note</label><textarea id="moNote" rows="2"></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalOrdine')">Annulla</button>
<button class="btn btn-info" onclick="saveOrdine()">ğŸ“¦ Crea Ordine</button>
</div>
</div>
</div>

<!-- MODAL: ReperibilitÃ  -->
<div class="modal-overlay" id="modalRep">
<div class="modal">
<div class="modal-head"><h2>ğŸ“ Nuovo Turno ReperibilitÃ </h2><button class="close" onclick="closeModal('modalRep')">âœ•</button></div>
<div class="modal-body">
<div class="field"><label>Tecnico</label><select id="mrTecnico"></select></div>
<div class="field-row">
<div class="field"><label>Data Inizio</label><input type="date" id="mrDal"></div>
<div class="field"><label>Data Fine</label><input type="date" id="mrAl"></div>
</div>
<div class="field-row">
<div class="field"><label>Turno</label><select id="mrTurno"><option value="24h">24h</option><option value="notturno">Notturno (20-08)</option><option value="festivo">Festivo</option><option value="custom">Custom</option></select></div>
<div class="field"><label>Tipo</label><select id="mrTipo"><option value="reperibilita">ReperibilitÃ </option><option value="guardia">Guardia attiva</option></select></div>
</div>
<div class="field"><label>Note</label><textarea id="mrNote" rows="2"></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalRep')">Annulla</button>
<button class="btn btn-primary" onclick="saveRep()">ğŸ’¾ Salva</button>
</div>
</div>
</div>

<!-- MODAL: Trasferta -->
<div class="modal-overlay" id="modalTrasf">
<div class="modal">
<div class="modal-head"><h2>ğŸ§³ Nuova Trasferta</h2><button class="close" onclick="closeModal('modalTrasf')">âœ•</button></div>
<div class="modal-body">
<div class="field"><label>Tecnici</label><select id="mtTecnici" multiple style="min-height:80px"></select></div>
<div class="field"><label>Cliente</label><select id="mtCliente"></select></div>
<div class="field-row">
<div class="field"><label>Data Inizio</label><input type="date" id="mtDal"></div>
<div class="field"><label>Data Fine</label><input type="date" id="mtAl"></div>
</div>
<div class="field"><label>Automezzo</label><select id="mtAutomezzo"></select></div>
<div class="field"><label>Motivo</label><textarea id="mtMotivo" rows="2"></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalTrasf')">Annulla</button>
<button class="btn btn-primary" onclick="saveTrasf()">ğŸ’¾ Salva</button>
</div>
</div>
</div>

<!-- MODAL: Notifica -->
<div class="modal-overlay" id="modalNotifica">
<div class="modal">
<div class="modal-head"><h2>ğŸ”” Nuova Notifica</h2><button class="close" onclick="closeModal('modalNotifica')">âœ•</button></div>
<div class="modal-body">
<div class="field-row">
<div class="field"><label>Destinatari</label><select id="mnDest" multiple style="min-height:80px"></select></div>
<div class="field"><label>Tipo</label><select id="mnTipo"><option value="messaggio">Messaggio</option><option value="urgente">Urgente</option><option value="info">Informativa</option><option value="reminder">Promemoria</option></select></div>
</div>
<div class="field"><label>Oggetto</label><input type="text" id="mnOgg"></div>
<div class="field"><label>Messaggio</label><textarea id="mnMsg" rows="4"></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalNotifica')">Annulla</button>
<button class="btn btn-primary" onclick="saveNotifica()">ğŸ“¤ Invia</button>
</div>
</div>
</div>

<!-- MODAL: Pagellino -->
<div class="modal-overlay" id="modalPagellino">
<div class="modal modal-lg">
<div class="modal-head"><h2>ğŸ¯ Nuovo Pagellino</h2><button class="close" onclick="closeModal('modalPagellino')">âœ•</button></div>
<div class="modal-body">
<div class="field-row-3">
<div class="field"><label>Tecnico</label><select id="mgTecnico"></select></div>
<div class="field"><label>Periodo</label><select id="mgPeriodo"><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="annuale">Annuale</option></select></div>
<div class="field"><label>Data Rilevazione</label><input type="date" id="mgData"></div>
</div>
<h4 style="font-size:.8125rem;font-weight:600;margin:16px 0 8px">Voci di Valutazione</h4>
<div id="pagVoci">
<div class="pag-voce" style="display:grid;grid-template-columns:2fr 1fr 80px 60px;gap:8px;align-items:end;margin-bottom:8px">
<div class="field mb-sm"><label>Voce</label><input type="text" class="pv-voce" placeholder="Es: Competenza tecnica"></div>
<div class="field mb-sm"><label>Categoria</label><select class="pv-cat"><option value="tecnica">Tecnica</option><option value="soft_skill">Soft Skill</option><option value="operativa">Operativa</option></select></div>
<div class="field mb-sm"><label>Voto (1-10)</label><input type="number" class="pv-voto" min="1" max="10" value="6"></div>
<div class="field mb-sm"><label>Peso</label><input type="number" class="pv-peso" min="1" max="5" value="1"></div>
</div>
</div>
<button class="btn btn-outline btn-sm" onclick="addPagVoce()">+ Aggiungi Voce</button>
<div class="field" style="margin-top:16px"><label>Nota Complessiva</label><textarea id="mgNota" rows="3"></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalPagellino')">Annulla</button>
<button class="btn btn-primary" onclick="savePagellino()">ğŸ’¾ Salva Pagellino</button>
</div>
</div>
</div>

<!-- MODAL: Installazione -->
<div class="modal-overlay" id="modalInstall">
<div class="modal">
<div class="modal-head"><h2>ğŸ—ï¸ Nuova Installazione</h2><button class="close" onclick="closeModal('modalInstall')">âœ•</button></div>
<div class="modal-body">
<div class="field-row">
<div class="field"><label>Cliente</label><select id="miCliente" onchange="loadMacchineCliente('mi')"></select></div>
<div class="field"><label>Macchina</label><select id="miMacchina"></select></div>
</div>
<div class="field-row">
<div class="field"><label>Data Inizio</label><input type="date" id="miDal"></div>
<div class="field"><label>Data Fine Prevista</label><input type="date" id="miAl"></div>
</div>
<div class="field"><label>Tecnici</label><select id="miTecnici" multiple style="min-height:80px"></select></div>
<div class="field"><label>Note</label><textarea id="miNote" rows="2"></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalInstall')">Annulla</button>
<button class="btn btn-primary" onclick="saveInstall()">ğŸ’¾ Salva</button>
</div>
</div>
</div>

<!-- MODAL: Dettaglio generico -->
<div class="modal-overlay" id="modalDetail">
<div class="modal modal-lg">
<div class="modal-head"><h2 id="detailTitle">Dettaglio</h2><button class="close" onclick="closeModal('modalDetail')">âœ•</button></div>
<div class="modal-body" id="detailBody"></div>
<div class="modal-foot" id="detailFoot"></div>
</div>
</div>

<!-- MODAL: Nuovo Documento -->
<div class="modal-overlay" id="modalDocumento">
<div class="modal">
<div class="modal-head"><h2>ğŸ“ Nuovo Documento</h2><button class="close" onclick="closeModal('modalDocumento')">âœ•</button></div>
<div class="modal-body">
<div class="field"><label>Nome</label><input type="text" id="mdNome" placeholder="Nome documento"></div>
<div class="field"><label>ğŸ“ Carica file</label><input type="file" id="mdFile" onchange="$('mdUrl').value='';$('mdFileLabel').textContent=this.files[0]?.name||''"><span id="mdFileLabel" style="font-size:.75rem;color:var(--gray);margin-top:4px;display:block"></span></div>
<div class="field"><label>oppure URL diretto (Google Drive)</label><input type="url" id="mdUrl" placeholder="https://drive.google.com/..." style="font-size:.8rem"></div>
<div class="field-row">
<div class="field"><label>Categoria</label><select id="mdCategoria"><option>Contratti</option><option>Manuali</option><option>Certificati</option><option>Report</option><option>Altro</option></select></div>
<div class="field"><label>Pubblico</label><select id="mdPubblico"><option value="true">SÃ¬ â€” tutti</option><option value="false">No â€” solo admin</option></select></div>
</div>
<div class="field"><label>Descrizione</label><textarea id="mdDescrizione" rows="2"></textarea></div>
<div class="field"><label>Tags (virgola separati)</label><input type="text" id="mdTags" placeholder="manutenzione, lely, robot"></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalDocumento')">Annulla</button>
<button class="btn btn-primary" onclick="saveDocumento()">ğŸ’¾ Salva</button>
</div>
</div>
</div>

<!-- MODAL: Nuovo Checklist Template -->
<div class="modal-overlay" id="modalChecklist">
<div class="modal">
<div class="modal-head"><h2>âœ… Nuovo Template Checklist</h2><button class="close" onclick="closeModal('modalChecklist')">âœ•</button></div>
<div class="modal-body">
<div class="field"><label>Nome Template</label><input type="text" id="mclNome" placeholder="Es: Checklist Tagliando Robot"></div>
<div class="field"><label>Tipo Intervento (associa)</label><select id="mclTipo"><option value="">Nessuno (generico)</option></select></div>
<div class="field"><label>Voci Checklist</label>
<div id="mclVociList" style="display:flex;flex-direction:column;gap:6px"></div>
<button class="btn btn-outline btn-sm" onclick="addChecklistVoce()" style="margin-top:8px">+ Aggiungi Voce</button>
</div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalChecklist')">Annulla</button>
<button class="btn btn-primary" onclick="saveChecklistTemplate()">ğŸ’¾ Salva Template</button>
</div>
</div>
</div>

<!-- MODAL: Nuovo Allegato -->
<div class="modal-overlay" id="modalAllegato">
<div class="modal">
<div class="modal-head"><h2>ğŸ“ Nuovo Allegato</h2><button class="close" onclick="closeModal('modalAllegato')">âœ•</button></div>
<div class="modal-body">
<div class="field"><label>Nome File</label><input type="text" id="maName" placeholder="foto_intervento.jpg"></div>
<div class="field"><label>URL File (Google Drive)</label><input type="url" id="maUrl" placeholder="https://drive.google.com/..."></div>
<div class="field-row">
<div class="field"><label>Collegato a</label><select id="maRefTipo"><option value="">Nessuno</option><option value="piano">Intervento</option><option value="urgenza">Urgenza</option></select></div>
<div class="field"><label>ID Riferimento</label><input type="text" id="maRefId" placeholder="INT_xxx / URG_xxx"></div>
</div>
<div class="field"><label>Note</label><input type="text" id="maNote"></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalAllegato')">Annulla</button>
<button class="btn btn-primary" onclick="saveAllegato()">ğŸ’¾ Salva</button>
</div>
</div>
</div>

<!-- MODAL: Nuovo Utente -->
<div class="modal-overlay" id="modalUtente">
<div class="modal modal-lg">
<div class="modal-head"><h2>ğŸ‘¤ Nuovo Utente</h2><button class="close" onclick="closeModal('modalUtente')">âœ•</button></div>
<div class="modal-body">
<div class="field-row">
<div class="field"><label>Nome</label><input type="text" id="nuNome" placeholder="Marco"></div>
<div class="field"><label>Cognome</label><input type="text" id="nuCognome" placeholder="Rossi"></div>
</div>
<div class="field-row">
<div class="field"><label>Username</label><input type="text" id="nuUsername" placeholder="marco.rossi"></div>
<div class="field"><label>Password</label><input type="password" id="nuPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
</div>
<div class="field-row">
<div class="field"><label>Ruolo</label><select id="nuRuolo"><option value="">Seleziona ruolo</option><option value="admin">Admin</option><option value="caposquadra">Caposquadra</option><option value="tecnico">Tecnico</option><option value="magazziniere">Magazziniere</option><option value="commerciale">Commerciale</option></select></div>
<div class="field"><label>Squadra</label><select id="nuSquadra"><option value="">Seleziona squadra</option></select></div>
</div>
<div class="field-row">
<div class="field"><label>Automezzo</label><select id="nuAutomezzo"><option value="">Nessuno</option></select></div>
<div class="field"><label>Base</label><input type="text" id="nuBase" placeholder="Sede principale"></div>
</div>
<div class="field-row">
<div class="field"><label>Telefono</label><input type="tel" id="nuTelefono" placeholder="+39 06 1234567"></div>
<div class="field"><label>Email</label><input type="email" id="nuEmail" placeholder="marco@azienda.it"></div>
</div>
</div>
<div id="resetPwdBox" style="display:none;margin-top:8px;padding:12px;background:#FEF3C7;border-radius:8px">
<div style="font-size:.8125rem;font-weight:600;margin-bottom:8px">ğŸ”‘ Reset Password</div>
<div class="field-row">
<div class="field"><label>Nuova Password</label><input type="text" id="nuResetPwd" placeholder="NuovaPassword123!"></div>
<div class="field" style="display:flex;align-items:flex-end"><button class="btn btn-warn btn-sm" onclick="doResetPassword()" style="width:100%">ğŸ”‘ Reset</button></div>
</div>
<button class="btn btn-ghost btn-sm" onclick="generateRandomPwd()" style="font-size:.75rem;margin-top:4px">ğŸ² Genera password casuale</button>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalUtente')">Annulla</button>
<button class="btn btn-primary" onclick="saveUtente()">ğŸ’¾ Salva Utente</button>
</div>
</div>
</div>

<!-- MODAL: Nuovo Cliente -->
<div class="modal-overlay" id="modalCliente">
<div class="modal modal-lg">
<div class="modal-head"><h2>ğŸ¢ Nuovo Cliente</h2><button class="close" onclick="closeModal('modalCliente')">âœ•</button></div>
<div class="modal-body">
<div class="field"><label>Nome Cliente</label><input type="text" id="ncNome" placeholder="Azienda ABC"></div>
<div class="field-row">
<div class="field"><label>CittÃ </label><input type="text" id="ncCitta" placeholder="Roma"></div>
<div class="field"><label>Provincia</label><input type="text" id="ncProv" placeholder="RM" maxlength="2"></div>
<div class="field"><label>CAP</label><input type="text" id="ncCap" placeholder="00100" maxlength="5"></div>
</div>
<div class="field"><label>Indirizzo</label><input type="text" id="ncIndirizzo" placeholder="Via Roma 1"></div>
<div class="field-row">
<div class="field"><label>Telefono</label><input type="tel" id="ncTelefono" placeholder="+39 06 1234567"></div>
<div class="field"><label>Email</label><input type="email" id="ncEmail" placeholder="info@azienda.it"></div>
</div>
<div class="field-row">
<div class="field"><label>Contratto</label><input type="text" id="ncContratto" placeholder="NUM_2024_001"></div>
</div>
<div class="field"><label>Note</label><textarea id="ncNote" rows="2" placeholder="Informazioni aggiuntive..."></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalCliente')">Annulla</button>
<button class="btn btn-primary" onclick="saveCliente()">ğŸ’¾ Salva Cliente</button>
</div>
</div>
</div>

<!-- MODAL: Nuova Macchina -->
<div class="modal-overlay" id="modalMacchina">
<div class="modal modal-lg">
<div class="modal-head"><h2>âš™ï¸ Nuova Macchina</h2><button class="close" onclick="closeModal('modalMacchina')">âœ•</button></div>
<div class="modal-body">
<div class="field"><label>Cliente</label><select id="nmCliente"></select></div>
<div class="field-row">
<div class="field"><label>Tipo</label><input type="text" id="nmTipo" placeholder="Robot da mungitura"></div>
<div class="field"><label>Modello</label><input type="text" id="nmModello" placeholder="Lely A4"></div>
</div>
<div class="field-row">
<div class="field"><label>Numero Seriale</label><input type="text" id="nmSeriale" placeholder="SN123456"></div>
<div class="field"><label>Anno Installazione</label><input type="number" id="nmAnno" placeholder="2023" min="2000" max="2099"></div>
</div>
<div class="field-row">
<div class="field"><label>Ore di Lavoro</label><input type="number" id="nmOre" placeholder="0" min="0"></div>
</div>
<div class="field-row">
<div class="field"><label>Ultimo Tagliando</label><input type="date" id="nmUltimoTag"></div>
<div class="field"><label>Prossimo Tagliando</label><input type="date" id="nmProssTag"></div>
</div>
<div class="field"><label>Garanzia Fino A</label><input type="date" id="nmGaranzia"></div>
<div class="field"><label>Note</label><textarea id="nmNote" rows="2" placeholder="Informazioni aggiuntive..."></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalMacchina')">Annulla</button>
<button class="btn btn-primary" onclick="saveMacchina()">ğŸ’¾ Salva Macchina</button>
</div>
</div>
</div>

<!-- MODAL: Nuovo Automezzo -->
<div class="modal-overlay" id="modalAutomezzo">
<div class="modal modal-lg">
<div class="modal-head"><h2>ğŸš Nuovo Automezzo</h2><button class="close" onclick="closeModal('modalAutomezzo')">âœ•</button></div>
<div class="modal-body">
<div class="field-row">
<div class="field"><label>Targa</label><input type="text" id="naTarga" placeholder="AB123CD"></div>
<div class="field"><label>Descrizione</label><input type="text" id="naDesc" placeholder="Furgone Mertz bianco"></div>
</div>
<div class="field"><label>Allestimento</label><input type="text" id="naAllestimento" placeholder="Scaffalature + Frigorifero"></div>
<div class="field"><label>Status</label><select id="naStatus"><option value="">Seleziona stato</option><option value="disponibile">Disponibile</option><option value="in_uso">In Uso</option><option value="in_officina">In Officina</option><option value="dismesso">Dismesso</option></select></div>
<div class="field-row">
<div class="field"><label>Prossimo Controllo</label><input type="date" id="naControllo"></div>
<div class="field"><label>Km Attuali</label><input type="number" id="naKm" placeholder="0" min="0"></div>
</div>
<div class="field"><label>Assegnatario (Tecnico)</label><select id="naAssegnatario"><option value="">Nessuno</option></select></div>
<div class="field"><label>Note</label><textarea id="naNote" rows="2" placeholder="Informazioni aggiuntive..."></textarea></div>
</div>
<div class="modal-foot">
<button class="btn btn-outline" onclick="closeModal('modalAutomezzo')">Annulla</button>
<button class="btn btn-primary" onclick="saveAutomezzo()">ğŸ’¾ Salva Automezzo</button>
</div>
</div>
</div>

<script>
// ============ GLOBAL STATE ============
let DATA={},USER=null,MAP=null,MARKERS=[],AI_PLAN=null;
const API_URL = (window.SYNTONIQA_CONFIG&&window.SYNTONIQA_CONFIG.api&&window.SYNTONIQA_CONFIG.api.url)
  || 'https://syntoniqa-api.YOUR_SUBDOMAIN.workers.dev';
const API_TOKEN = (window.SYNTONIQA_CONFIG&&window.SYNTONIQA_CONFIG.api&&window.SYNTONIQA_CONFIG.api.token)
  || 'FF_TOKEN_CAMBIA_QUESTO_IN_PRODUZIONE';
let calDate=new Date(), repFilter='attivi', pagFilter='bozze';

// ============ HELPERS ============
const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];
const fmtDate=d=>{if(!d)return 'â€”';const p=String(d).substring(0,10).split('-');return p.length===3?p[2]+'/'+p[1]+'/'+p[0]:'â€”'};
const fmtDateTime=d=>{if(!d)return 'â€”';try{return new Date(d).toLocaleString('it-IT',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}catch{return 'â€”'}};
function calcOraFine(oraInizio,durata){const [h,m]=(oraInizio||'08:00').split(':').map(Number);const t=h*60+m+Math.round(durata*60);return String(Math.floor(t/60)%24).padStart(2,'0')+':'+String(t%60).padStart(2,'0')}
const getName=(list,id,field='Nome')=>{const o=list.find(x=>x.ID===id||x.CodiceM3===id);if(!o)return id||'â€”';if(field!=='Nome'&&o[field])return o[field];return(o.NomeInterno||o.Nome||o.Descrizione||'')+(o.Cognome?' '+o.Cognome:'');};
const getColor=(list,id)=>{const o=list.find(x=>x.ID===id);return o?.Colore||'#6B7280'};
const statusTag=(s)=>{const m={'pianificato':['tag-info','ğŸ“…'],'in_corso':['tag-warn','âš¡'],'completato':['tag-ok','âœ…'],'chiuso':['tag-gray','ğŸ”’'],'aperta':['tag-err','ğŸ”´'],'assegnata':['tag-warn','ğŸ‘¤'],'schedulata':['tag-info','ğŸ“…'],'risolta':['tag-ok','âœ…'],'richiesto':['tag-info','ğŸ“'],'preso_in_carico':['tag-warn','ğŸ‘‹'],'ordinato':['tag-purple','ğŸ“¦'],'in_arrivo':['tag-info','ğŸšš'],'arrivato':['tag-ok','âœ…'],'attiva':['tag-ok','âœ…'],'pianificata':['tag-info','ğŸ“…'],'completata':['tag-ok','âœ…'],'bozza':['tag-warn','ğŸ“'],'approvato':['tag-ok','âœ…'],'approvata':['tag-ok','âœ…'],'rifiutata':['tag-err','âŒ'],'in_attesa':['tag-warn','â³']};const x=m[s]||['tag-gray',''];return `<span class="tag ${x[0]}">${x[1]} ${s||'â€”'}</span>`};
const slaTag=(s,pct)=>{const m={'ok':['tag-ok','âœ… OK'],'warning':['tag-warn','âš ï¸ Warning'],'critical':['tag-err','ğŸ”´ Critical'],'breach':['tag-err','ğŸ’¥ Breach']};const x=m[s]||['tag-gray',s||'â€”'];return `<span class="tag ${x[0]}">${x[1]}</span>${pct!==undefined?`<div class="sla-bar sla-${s}"><div class="fill" style="width:${Math.min(pct,100)}%"></div></div>`:''}`};

function toast(msg,type='info'){const d=document.createElement('div');d.className='toast '+type;d.textContent=msg;$('toasts').appendChild(d);setTimeout(()=>d.remove(),4000)}
function openModal(id){$(id).classList.add('show')}
function closeModal(id){$(id).classList.remove('show')}
function toggleSidebar(){$('sidebar').classList.toggle('open');$('sideOverlay').classList.toggle('show')}

function showSec(id,btn){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const sec=$('sec'+id.charAt(0).toUpperCase()+id.slice(1));
  if(sec)sec.classList.add('active');
  if(btn)btn.classList.add('active');
  const titles={'dashboard':'ğŸ“Š Dashboard','calendario':'ğŸ“… Calendario','piano':'ğŸ“‹ Interventi','urgenze':'ğŸš¨ Urgenze','ordini':'ğŸ“¦ Ordini','installazioni':'ğŸ—ï¸ Installazioni','reperibilita':'ğŸ“ ReperibilitÃ ','trasferte':'ğŸ§³ Trasferte','notifiche':'ğŸ”” Notifiche','richieste':'ğŸ“ Richieste','clienti':'ğŸ¢ Clienti','macchine':'âš™ï¸ Macchine','automezzi':'ğŸš Automezzi','tecnici':'ğŸ‘¥ Tecnici','ai':'ğŸ¤– AI Planner','planner':'ğŸ“† Planner Visuale','mappa':'ğŸ—ºï¸ Mappa','kpi':'ğŸ“ˆ KPI','pagellini':'ğŸ¯ Pagellini','checklist':'âœ… Checklist','sla':'â±ï¸ SLA Monitor','documenti':'ğŸ“ Documenti','allegati':'ğŸ“ Allegati','report':'ğŸ“Š Report Builder','auditlog':'ğŸ“œ Audit Log','powerbi':'âš¡ Power BI','emailconfig':'ğŸ“§ Email','telegramconfig':'ğŸ’¬ Telegram','backup':'ğŸ’¾ Backup','chat':'ğŸ’¬ Chat Telegram','config':'ğŸ”§ Configurazione'};
  $('headerTitle').textContent=titles[id]||id;
  // Stop chat polling when navigating away from chat section
  if(id!=='chat'&&CHAT_POLL){clearInterval(CHAT_POLL);CHAT_POLL=null;}
  if(id==='mappa')setTimeout(()=>initMap(),100);
  if(id==='kpi')loadKPIWithCharts();
  if(id==='planner')setTimeout(()=>initPlanner(),100);
  if(id==='ai'){renderApprovalQueue();renderTecnicoPlan()}
  if(id==='chat')loadChatCanali();
  if(id==='backup')loadBackupHistory();
  if(id==='anagrafica'){loadAnagClients()}
  $('sidebar').classList.remove('open');$('sideOverlay').classList.remove('show');
}

// ============ API ============
let _apiActive=0;
function showGlobalLoad(show){const el=$('globalLoad');if(el)el.style.display=show?'flex':'none'}
async function apiCall(action,data={},method='GET'){
  let url=API_URL,opts={};
  if(method==='GET'){
    const p=new URLSearchParams({action,token:API_TOKEN,...data});
    url+='?'+p;
  }else{
    opts={method:'POST',headers:{'Content-Type':'application/json','X-Token':API_TOKEN},body:JSON.stringify({action,userId:USER?.ID||'',...data})};
  }
  _apiActive++;if(_apiActive===1)showGlobalLoad(true);
  try{
    const controller=new AbortController();
    const timeout=setTimeout(()=>controller.abort(),30000);
    opts.signal=controller.signal;
    const r=await fetch(url,opts);
    clearTimeout(timeout);
    const json=await r.json();
    if(!json.success)throw new Error(json.error||'Errore API');
    return json.data !== undefined ? json.data : json;
  }catch(e){
    if(e.name==='AbortError')throw new Error('Timeout: il server non risponde. Riprova.');
    throw e;
  }finally{
    _apiActive--;if(_apiActive<=0){_apiActive=0;showGlobalLoad(false)}
  }
}

let _refreshBusy=false;
async function refreshData(silent){
  // Debounce: skip se giÃ  in corso
  if(_refreshBusy){console.warn('[REFRESH] skipped, already in progress');return}
  _refreshBusy=true;
  try{
    // Sempre fetch diretto senza overlay (apiCall userebbe lo spinner globale)
    let url=API_URL+'?'+new URLSearchParams({action:'getAll',token:API_TOKEN,userId:USER?.ID||''});
    const r=await fetch(url,{signal:AbortSignal.timeout(15000)});
    const json=await r.json();
    if(json.success&&json.data){DATA=json.data;renderAll()}
  }catch(e){if(!silent)toast('Errore refresh: '+e.message,'err');else console.warn('[REFRESH]',e.message)}
  finally{_refreshBusy=false}
}

// ============ INIT & AUTH ============
document.addEventListener('DOMContentLoaded',init);
async function init(){
  // Safety: assicurati che globalLoad non blocchi il login
  showGlobalLoad(false);
  try{
    DATA=await apiCall('getAll');
    applyConfig();
    $('loginLoad').style.display='none';
    $('loginForm').style.display='block';
    const saved=localStorage.getItem('ff8_session');
    if(saved){
      const s=JSON.parse(saved);
      const u=(DATA.utenti||[]).find(x=>x.ID===s.id);
      if(u&&(u.Ruolo==='admin'||u.Ruolo==='caposquadra')){USER=u;enterApp()}
    }
  }catch(e){
    showGlobalLoad(false);
    console.error('[INIT]',e);
    $('loginLoad').innerHTML='<div style="color:var(--err)">âŒ '+e.message+'</div><br><button class="btn btn-primary btn-sm" onclick="location.reload()">Riprova</button>';
  }
}

function applyConfig(){
  const c=DATA.config||{};
  if(c.colore_primario){document.documentElement.style.setProperty('--c1',c.colore_primario);document.querySelector('meta[name=theme-color]')?.setAttribute('content',c.colore_primario)}
  if(c.colore_secondario)document.documentElement.style.setProperty('--c2',c.colore_secondario);
  if(c.azienda_nome){$('brandName').textContent=c.azienda_nome;var sb=$('sidebarBrand');if(sb&&!c.logo_url)sb.textContent='âš™ï¸ '+c.azienda_nome}
  if(c.azienda_slogan){$('brandSlogan').textContent=c.azienda_slogan;$('sidebarSub').textContent=c.azienda_slogan}
  // LOGO: applica da config DB se presente (supporta logo_url O azienda_logo)
  var logoUrl=c.logo_url||c.azienda_logo||'';
  if(logoUrl){
    var logo=$('brandLogo');if(logo)logo.innerHTML='<img src="'+logoUrl+'" style="height:56px;max-width:220px;object-fit:contain" alt="Logo">';
    var sbr=$('sidebarBrand');if(sbr)sbr.innerHTML='<img src="'+logoUrl+'" style="height:22px;max-width:150px;object-fit:contain;filter:brightness(0) invert(1)" alt=""> '+(c.azienda_nome||'Syntoniqa');
  }
  if(c.favicon_url){var lk=document.querySelector('link[rel="icon"]')||document.createElement('link');lk.rel='icon';lk.href=c.favicon_url;if(!lk.parentNode)document.head.appendChild(lk)}
}

async function doLogin(e){
  e.preventDefault();
  $('btnLogin').disabled=true;$('btnLogin').textContent='Accesso...';$('loginErr').style.display='none';
  try{
    const r=await apiCall('login',{username:$('inpUser').value.trim(),password:$('inpPwd').value},'POST');
    if(!r.user)throw new Error('Credenziali non valide');
    if(r.user.Ruolo!=='admin'&&r.user.Ruolo!=='caposquadra')throw new Error('Accesso riservato a Admin e Capo Squadra');
    USER=r.user;localStorage.setItem('ff8_session',JSON.stringify({id:USER.ID}));enterApp();
  }catch(e){$('loginErr').textContent=e.message;$('loginErr').style.display='block'}
  finally{$('btnLogin').disabled=false;$('btnLogin').textContent='Accedi'}
  return false;
}

function logout(){localStorage.removeItem('ff8_session');location.reload()}

/* â”€â”€â”€ DARK MODE â”€â”€â”€ */
function initDarkMode(){
  const saved = localStorage.getItem('sq2_admin_theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme:dark)').matches;
  if(saved === 'dark' || (!saved && prefersDark)){
    document.documentElement.setAttribute('data-theme','dark');
    updateDarkBtn(true);
  }
}
function toggleDarkMode(){
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  if(isDark){
    document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('sq2_admin_theme','light');
  } else {
    document.documentElement.setAttribute('data-theme','dark');
    localStorage.setItem('sq2_admin_theme','dark');
  }
  updateDarkBtn(!isDark);
}
function updateDarkBtn(dark){
  const b = $('darkBtn'); if(b) b.textContent = dark ? 'â˜€ï¸' : 'ğŸŒ™';
}
initDarkMode();

function enterApp(){
  $('loginScreen').classList.add('hidden');
  $('appMain').style.display='block';
  $('headerUser').textContent=(USER.Nome||'')+' '+(USER.Cognome||'');
  $('headerDate').textContent=new Date().toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  $('footUser').textContent=(USER.Nome||'')[0]+(USER.Cognome||'')[0]+' Â· '+USER.Ruolo;
  populateSelects();
  renderAll();
  loadAnagClients().then(()=>{renderMacchine();populateModalClientsFromAnag()}).catch(()=>{});
  // Auto-refresh dashboard ogni 5 min (silenzioso, senza overlay)
  setInterval(()=>{refreshData(true)},300000);
}

// ============ POPULATE SELECTS ============
function populateSelects(){
  const tecs=(DATA.utenti||[]).filter(u=>!u.Obsoleto&&u.Attivo&&(u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
  const clis=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
  const automezziList=(DATA.automezzi||[]).filter(f=>!f.Obsoleto);
  const tipi=(DATA.tipiIntervento||[]).filter(t=>t.Attivo);
  const pris=(DATA.priorita||[]).filter(p=>p.Attivo);
  const squadreList=(DATA.squadre||[]).filter(s=>!s.Obsoleto);

  const fillSel=(id,items,fmt)=>{const s=$(id);if(!s)return;const v=s.value;const first=s.options[0]?.textContent||'';s.innerHTML='<option value="">'+first+'</option>';items.forEach(i=>{const o=document.createElement('option');o.value=i.ID;o.textContent=fmt(i);s.appendChild(o)});if(v)s.value=v};
  const fillMulti=(id,items,fmt)=>{const s=$(id);if(!s)return;s.innerHTML='';items.forEach(i=>{const o=document.createElement('option');o.value=i.ID;o.textContent=fmt(i);s.appendChild(o)})};
  const tecFmt=t=>(t.Nome||'')+' '+(t.Cognome||'');
  const cliFmt=c=>c.Nome||c.ID;

  // Piano
  fillSel('mpTecnico',tecs,tecFmt);fillMulti('mpTecnici',tecs,tecFmt);fillSel('mpAutomezzo',automezziList,f=>f.ID+' â€” '+(f.Targa||f.Descrizione||''));
  fillSel('mpCliente',clis,cliFmt);fillSel('mpTipo',tipi,t=>t.Nome);fillSel('mpPriorita',pris,p=>p.Nome);
  // Urgenza
  fillSel('muCliente',clis,cliFmt);fillSel('muPriorita',pris,p=>p.Nome);
  // Assegna
  fillSel('maTecnico',tecs,tecFmt);fillSel('maAutomezzo',automezziList,f=>f.ID+' â€” '+(f.Targa||''));
  // Ordine
  fillSel('moTecnico',tecs,tecFmt);fillSel('moCliente',clis,cliFmt);
  // Rep
  fillSel('mrTecnico',tecs,tecFmt);
  // Trasferta
  fillMulti('mtTecnici',tecs,tecFmt);fillSel('mtCliente',clis,cliFmt);fillSel('mtAutomezzo',automezziList,f=>f.ID+' â€” '+(f.Targa||''));
  // Notifica
  const allUsers=(DATA.utenti||[]).filter(u=>!u.Obsoleto&&u.Attivo);
  fillMulti('mnDest',allUsers,tecFmt);
  // Pagellino
  fillSel('mgTecnico',tecs,tecFmt);
  // Installazione
  fillSel('miCliente',clis,cliFmt);fillMulti('miTecnici',tecs,tecFmt);
  // Nuovo Utente
  fillSel('nuSquadra',squadreList,s=>s.Nome||s.ID);fillSel('nuAutomezzo',automezziList,f=>f.Targa||f.Descrizione||f.ID);
  // Nuovo Cliente (no additional selects needed)
  // Nuova Macchina
  fillSel('nmCliente',clis,cliFmt);
  // Nuovo Automezzo
  fillSel('naAssegnatario',tecs,tecFmt);
  // Filtri
  fillSel('filtPianoTec',tecs,tecFmt);fillSel('calFiltroTec',tecs,tecFmt);fillSel('mapFiltroTec',tecs,tecFmt);fillSel('kpiTecnico',tecs,tecFmt);
  // filtMacchCli will be populated by renderMacchine from anagrafica
}

// After anagrafica loads, repopulate modal client selectors with anagrafica data
function populateModalClientsFromAnag(){
  if(!ANAG_CLIENTI.length)return;
  ['mpCliente','muCliente','moCliente','mtCliente','miCliente','nmCliente'].forEach(id=>{
    populateModalClients(id);
  });
}

function loadMacchineCliente(prefix){
  const cliSel=$(prefix+'Cliente');
  const cliId=cliSel?cliSel.value:'';
  const s=$(prefix+'Macchina');if(!s)return;
  s.innerHTML='<option value="">â€” Seleziona Macchina â€”</option>';

  // First try anagrafica assets (primary data source)
  if(cliId&&ANAG_CLIENTI.length){
    // Find M3 code for this client
    const cli=ANAG_CLIENTI.find(c=>c.CodiceM3===cliId)||
              (DATA.clienti||[]).find(c=>c.ID===cliId);
    const m3=cli?.CodiceM3||cliId;
    const assets=(ANAG_ASSETS_CACHE[m3]||[]).filter(a=>{
      const tf=(a.TipoFoglio||'').toUpperCase();
      return tf&&tf!=='ASSETS'&&tf!=='NONE';
    });
    if(assets.length){
      assets.forEach(a=>{
        const tipo=normAssetType(a.GruppoAttrezzatura||a.TipoFoglio);
        const cfg=PROD_CFG[tipo]||{};
        const o=document.createElement('option');
        o.value=a.NumeroSerie||a.NomeAsset||'';
        o.textContent=(cfg.label||tipo)+' '+(a.Modello||'')+' â€” '+(a.NomeAsset||'')+(a.NumeroSerie?' (SN: '+a.NumeroSerie+')':'');
        o.dataset.tipo=tipo;
        o.dataset.modello=a.Modello||'';
        o.dataset.seriale=a.NumeroSerie||'';
        o.dataset.asset=a.NomeAsset||'';
        o.dataset.m3=m3;
        s.appendChild(o);
      });
      return;
    }
  }
  // Fallback to CRUD macchine
  const maccs=(DATA.macchine||[]).filter(m=>!m.Obsoleto&&(!cliId||m.ClienteID===cliId));
  maccs.forEach(m=>{const o=document.createElement('option');o.value=m.ID;o.textContent=m.Tipo+' '+m.Modello+(m.Seriale?' ('+m.Seriale+')':'');s.appendChild(o)});
}

// Populate client select in modals with BOTH CRUD and anagrafica clients
function populateModalClients(selId){
  const s=$(selId);if(!s)return;
  const current=s.value;
  s.innerHTML='<option value="">â€” Seleziona Cliente â€”</option>';

  // Add anagrafica clients (primary)
  const seen=new Set();
  if(ANAG_CLIENTI.length){
    ANAG_CLIENTI.filter(c=>c.CodiceM3&&!seen.has(c.CodiceM3)).forEach(c=>{
      seen.add(c.CodiceM3);
      const o=document.createElement('option');
      o.value=c.CodiceM3;
      o.textContent=c.NomeAccount||c.NomeInterno||c.CodiceM3;
      s.appendChild(o);
    });
  }
  // Add CRUD clients not already in anagrafica
  (DATA.clienti||[]).forEach(c=>{
    if(!seen.has(c.ID)){
      const o=document.createElement('option');
      o.value=c.ID;
      o.textContent=c.Nome||c.ID;
      s.appendChild(o);
    }
  });
  if(current)s.value=current;
}

// ============ RENDER ALL ============
function renderAll(){
  renderDashboard();renderPiano();renderUrgenze();renderOrdini();renderInstallazioni();
  renderReperibilita();renderTrasferte();renderNotifiche();renderRichieste();
  renderClienti();renderMacchine();renderAutomezzi();renderTecnici();
  renderSLA();renderAuditLog();renderPowerBI();renderConfig();renderPagellini();
  renderCal();renderDocumenti();renderChecklist();renderAllegati();
  renderEmailConfig();renderTelegramConfig();renderTelegramExtras();
  updateBadges();
}

function updateBadges(){
  const urgAperte=(DATA.urgenze||[]).filter(u=>!u.Obsoleto&&u.Stato==='aperta').length;
  const ordAtt=(DATA.ordini||[]).filter(o=>!o.Obsoleto&&['richiesto','preso_in_carico'].includes(o.Stato)).length;
  const notUnread=(DATA.notifiche||[]).filter(n=>!n.Obsoleto&&n.Stato==='inviata'&&(n.DestinatarioID===USER?.ID||(n.DestinatariIDs||'').includes(USER?.ID))).length;
  const richPend=(DATA.richieste||[]).filter(r=>!r.Obsoleto&&r.Stato==='in_attesa').length;
  [['badgeUrg',urgAperte],['badgeOrd',ordAtt],['badgeNot',notUnread],['badgeRich',richPend]].forEach(([id,n])=>{const b=$(id);if(b){b.textContent=n;b.style.display=n>0?'':'none'}});
}

// ============ DASHBOARD ============
function renderDashboard(){
  // Timestamp ultimo aggiornamento
  const upd=$('dashLastUpdate');if(upd)upd.textContent=new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const piano=(DATA.piano||[]).filter(p=>!p.Obsoleto);
  const urg=(DATA.urgenze||[]).filter(u=>!u.Obsoleto);
  const ord=(DATA.ordini||[]).filter(o=>!o.Obsoleto);
  const d=today();
  const oggi=piano.filter(p=>p.Data===d);
  const comp=piano.filter(p=>p.Stato==='completato').length;
  const urgA=urg.filter(u=>u.Stato!=='risolta'&&u.Stato!=='chiusa').length;
  const urgSLA=urg.filter(u=>u.SLAStatus==='breach'&&u.Stato!=='risolta'&&u.Stato!=='chiusa').length;
  // Mezzi "attivi oggi": guarda l'automezzo assegnato negli interventi di oggi (pianificato/in_corso)
  const oggiConAuto=oggi.filter(p=>(p.Stato==='pianificato'||p.Stato==='in_corso')&&p.AutomezzoID);
  const autoOggiIds=[...new Set(oggiConAuto.map(p=>p.AutomezzoID))];
  // Fallback: se intervento non ha automezzo, usa quello dell'ultimo intervento del tecnico
  const tecSenzaAuto=oggi.filter(p=>(p.Stato==='pianificato'||p.Stato==='in_corso')&&!p.AutomezzoID).map(p=>p.TecnicoID).filter(Boolean);
  for(const tid of tecSenzaAuto){
    const ultimoInt=piano.filter(p=>p.TecnicoID===tid&&p.AutomezzoID&&p.Data<=d).sort((a,b)=>(b.Data||'').localeCompare(a.Data||''))[0];
    if(ultimoInt?.AutomezzoID&&!autoOggiIds.includes(ultimoInt.AutomezzoID)) autoOggiIds.push(ultimoInt.AutomezzoID);
  }
  const automezziAtt=autoOggiIds.length;
  const automezziTot=(DATA.automezzi||[]).filter(f=>!f.Obsoleto).length;
  const tecs=(DATA.utenti||[]).filter(u=>!u.Obsoleto&&u.Attivo&&u.Ruolo==='tecnico').length;
  const reps=(DATA.reperibilita||[]).filter(r=>!r.Obsoleto&&r.Stato==='attiva'&&r.DataInizio<=d&&r.DataFine>=d);

  const oggiComp=oggi.filter(p=>p.Stato==='completato').length;
  const oggiCorso=oggi.filter(p=>p.Stato==='in_corso').length;
  const pctOggi=oggi.length>0?Math.round(oggiComp/oggi.length*100):0;
  $('kpiDash').innerHTML=`
    <div class="kpi blue"><div class="kpi-val">${oggi.length}</div><div class="kpi-lbl">ğŸ“‹ Interventi Oggi</div><div class="kpi-sub">${oggiComp}âœ… ${oggiCorso}âš¡ ${oggi.length-oggiComp-oggiCorso}â³</div></div>
    <div class="kpi ${pctOggi>=80?'green':pctOggi>=50?'yellow':'red'}"><div class="kpi-val">${pctOggi}%</div><div class="kpi-lbl">ğŸ“Š Completamento Oggi</div><div class="kpi-sub">${oggiComp}/${oggi.length} fatti</div></div>
    <div class="kpi ${urgA>0?'red':'green'}"><div class="kpi-val">${urgA}</div><div class="kpi-lbl">ğŸš¨ Urgenze Aperte</div>${urgSLA>0?`<div class="kpi-sub" style="color:var(--err)">âš ï¸ ${urgSLA} SLA breach</div>`:''}</div>
    <div class="kpi yellow"><div class="kpi-val">${ord.filter(o=>o.Stato!=='arrivato').length}</div><div class="kpi-lbl">ğŸ“¦ Ordini in Attesa</div></div>
    <div class="kpi blue"><div class="kpi-val">${automezziAtt}/${automezziTot}</div><div class="kpi-lbl">ğŸš Mezzi Attivi</div></div>
    <div class="kpi purple"><div class="kpi-val">${tecs}</div><div class="kpi-lbl">ğŸ‘¥ Tecnici</div>${reps.length>0?`<div class="kpi-sub">ğŸ“ ${reps.length} in reperibilitÃ </div>`:''}</div>
  `;

  // Tabella oggi
  $('tblOggi').innerHTML=oggi.length?oggi.sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||'')).map(p=>`<tr>
    <td>${p.OraInizio||'â€”'}</td>
    <td>${getName(DATA.utenti||[],p.TecnicoID)}</td>
    <td>${getName(DATA.automezzi||[],p.AutomezzoID,'Descrizione')}</td>
    <td>${getName(DATA.clienti||[],p.ClienteID)}</td>
    <td><span class="tag" style="background:${getColor(DATA.tipiIntervento||[],p.TipoInterventoID)}20;color:${getColor(DATA.tipiIntervento||[],p.TipoInterventoID)}">${getName(DATA.tipiIntervento||[],p.TipoInterventoID)}</span></td>
    <td>${statusTag(p.Stato)}</td>
    <td><button class="btn btn-ghost btn-xs" onclick="showDetail('piano','${p.ID}')">ğŸ‘ï¸</button></td>
  </tr>`).join(''):'<tr><td colspan="7" class="empty"><p>Nessun intervento oggi</p></td></tr>';

  // Urgenze dash
  const urgOpen=urg.filter(u=>u.Stato!=='risolta'&&u.Stato!=='chiusa').slice(0,5);
  $('tblUrgDash').innerHTML=urgOpen.length?urgOpen.map(u=>`<tr>
    <td><span class="tag" style="background:${getColor(DATA.priorita||[],u.PrioritaID)}20;color:${getColor(DATA.priorita||[],u.PrioritaID)}">${getName(DATA.priorita||[],u.PrioritaID)}</span></td>
    <td>${getName(DATA.clienti||[],u.ClienteID)}</td>
    <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${u.Problema||'â€”'}</td>
    <td>${slaTag(u.SLAStatus)}</td>
    <td>${statusTag(u.Stato)}</td>
    <td>${u.Stato==='aperta'?`<button class="btn btn-primary btn-xs" onclick="openAssegna('${u.ID}')">ğŸ‘¤</button> `:''}${u.Stato==='assegnata'||u.Stato==='schedulata'?`<button class="btn btn-warn btn-xs" onclick="urgAction('${u.ID}','startUrgenza')">âš¡</button> `:''}${u.Stato==='in_corso'?`<button class="btn btn-ok btn-xs" onclick="urgAction('${u.ID}','resolveUrgenza')">âœ…</button> `:''}<button class="btn btn-ghost btn-xs" onclick="showDetail('urgenza','${u.ID}')">ğŸ‘ï¸</button></td>
  </tr>`).join(''):'<tr><td colspan="6" class="empty"><p>Nessuna urgenza aperta ğŸ‰</p></td></tr>';

  // Ordini dash
  const ordPend=ord.filter(o=>o.Stato!=='arrivato').slice(0,5);
  $('tblOrdDash').innerHTML=ordPend.length?ordPend.map(o=>`<tr>
    <td><strong>${o.Codice||'â€”'}</strong></td>
    <td>${getName(DATA.utenti||[],o.TecnicoID)}</td>
    <td>${statusTag(o.Stato)}</td>
    <td>${fmtDate(o.DataRichiesta)}</td>
  </tr>`).join(''):'<tr><td colspan="4" class="empty"><p>Nessun ordine in attesa</p></td></tr>';

  // Automezzi dash
  const automezziList=(DATA.automezzi||[]).filter(f=>!f.Obsoleto);
  $('automezziDash').innerHTML=automezziList.length?automezziList.map(f=>{
    const ctrl=f.ProssimoControllo&&f.ProssimoControllo<=d;
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--gray4)">
      <span><strong>${f.Descrizione||f.Targa||f.ID}</strong> ${f.AssegnatarioID?'â†’ '+getName(DATA.utenti||[],f.AssegnatarioID):''}</span>
      <span>${ctrl?'<span class="tag tag-err">âš ï¸ Controllo scaduto</span>':'<span class="tag tag-ok">âœ… OK</span>'}</span>
    </div>`}).join(''):'<p class="empty">Nessun automezzo</p>';

  // ReperibilitÃ  dash
  $('repDash').innerHTML=reps.length?reps.map(r=>`<div style="padding:6px 0;border-bottom:1px solid var(--gray4)">
    <strong>${getName(DATA.utenti||[],r.TecnicoID)}</strong> â€” ${r.Turno||'24h'}<br>
    <span style="font-size:.75rem;color:var(--gray)">${fmtDate(r.DataInizio)} â†’ ${fmtDate(r.DataFine)}</span>
  </div>`).join(''):'<p style="color:var(--gray);font-size:.8125rem">Nessun turno attivo</p>';

  // ======== NUOVE SEZIONI DASHBOARD ========

  // 1. ALERT CRITICI
  const alerts=[];
  const slaBreach=urg.filter(u=>u.SLAStatus==='breach'&&u.Stato!=='risolta'&&u.Stato!=='chiusa');
  if(slaBreach.length)alerts.push({icon:'ğŸ”´',txt:`${slaBreach.length} urgenz${slaBreach.length>1?'e':'a'} in SLA BREACH!`,color:'#DC2626',action:`showSec('urgenze')`});
  const slaCrit=urg.filter(u=>u.SLAStatus==='critical'&&u.Stato!=='risolta'&&u.Stato!=='chiusa');
  if(slaCrit.length)alerts.push({icon:'ğŸŸ ',txt:`${slaCrit.length} urgenz${slaCrit.length>1?'e':'a'} SLA critical (<2h)`,color:'#D97706',action:`showSec('urgenze')`});
  const urgNoAssign=urg.filter(u=>u.Stato==='aperta'&&!u.TecnicoAssegnato);
  if(urgNoAssign.length)alerts.push({icon:'ğŸ‘¤',txt:`${urgNoAssign.length} urgenz${urgNoAssign.length>1?'e':'a'} non assegnat${urgNoAssign.length>1?'e':'a'}`,color:'#7C3AED',action:`showSec('urgenze')`});
  const ordOld=ord.filter(o=>{if(o.Stato==='arrivato')return false;const dr=o.DataRichiesta;if(!dr)return false;const diff=(new Date()-new Date(dr))/86400000;return diff>7;});
  if(ordOld.length)alerts.push({icon:'ğŸ“¦',txt:`${ordOld.length} ordini in attesa da >7 giorni`,color:'#EA580C',action:`showSec('ordini')`});
  const intNonPart=oggi.filter(p=>{const now=new Date();const h=now.getHours();const m=now.getMinutes();const nowT=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');return p.Stato==='pianificato'&&p.OraInizio&&p.OraInizio<nowT});
  if(intNonPart.length)alerts.push({icon:'â°',txt:`${intNonPart.length} interventi di oggi non ancora iniziati (ora passata)`,color:'#DC2626',action:`showSec('piano')`});
  const alertEl=$('dashAlerts');
  if(alerts.length){
    alertEl.style.display='';
    alertEl.innerHTML=alerts.map(a=>`<div style="display:flex;align-items:center;gap:10px;padding:10px 16px;background:${a.color}10;border-left:4px solid ${a.color};border-radius:0 8px 8px 0;margin-bottom:6px;cursor:pointer;font-size:.8125rem" onclick="${a.action}">
      <span style="font-size:1.2rem">${a.icon}</span><span style="flex:1;color:${a.color};font-weight:600">${a.txt}</span><span style="color:var(--gray)">â†’</span>
    </div>`).join('');
  }else{alertEl.style.display='none'}

  // 2. TECNICI ATTIVI OGGI
  const tecnici=(DATA.utenti||[]).filter(u=>!u.Obsoleto&&u.Attivo&&(u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
  $('tecniciDash').innerHTML=tecnici.map(t=>{
    const intTec=oggi.filter(p=>p.TecnicoID===t.ID);
    const compTec=intTec.filter(p=>p.Stato==='completato').length;
    const corsoTec=intTec.filter(p=>p.Stato==='in_corso').length;
    const pctTec=intTec.length>0?Math.round(compTec/intTec.length*100):0;
    const urgTec=(DATA.urgenze||[]).filter(u=>u.TecnicoAssegnato===t.ID&&u.Stato!=='risolta'&&u.Stato!=='chiusa').length;
    const repTec=reps.some(r=>r.TecnicoID===t.ID);
    const auto=(DATA.automezzi||[]).find(a=>a.AssegnatarioID===t.ID);
    const statusDot=corsoTec>0?'ğŸŸ¢':intTec.length>0?'ğŸ”µ':'âšª';
    return `<div style="padding:10px 14px;background:var(--gray5);border-radius:10px;font-size:.8125rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>${statusDot} ${t.Nome||''} ${(t.Cognome||'').charAt(0)}.</strong>
        ${urgTec?`<span class="tag tag-err" style="font-size:.65rem">ğŸš¨${urgTec}</span>`:''}
        ${repTec?'<span style="font-size:.7rem">ğŸ“</span>':''}
      </div>
      <div style="display:flex;gap:4px;font-size:.7rem;margin-bottom:4px">
        <span>${intTec.length} int.</span>Â·<span>${compTec}âœ…</span>Â·<span>${corsoTec}âš¡</span>
        ${auto?`Â· <span>ğŸš ${auto.Descrizione||auto.Targa||auto.ID}</span>`:''}
      </div>
      <div style="height:4px;background:var(--gray3);border-radius:2px;overflow:hidden">
        <div style="height:100%;width:${pctTec}%;background:${pctTec>=80?'var(--ok)':pctTec>=50?'var(--warn)':'var(--c1)'};border-radius:2px"></div>
      </div>
    </div>`;
  }).join('');

  // 3. SPARKLINE ANDAMENTO 7 GIORNI (SVG)
  const days7=[];for(let i=6;i>=0;i--){const dd=new Date();dd.setDate(dd.getDate()-i);days7.push(dd.toISOString().split('T')[0])}
  const dayData=days7.map(dd=>{
    const dayPiano=piano.filter(p=>p.Data===dd);
    return{d:dd,total:dayPiano.length,comp:dayPiano.filter(p=>p.Stato==='completato').length,urg:urg.filter(u=>(u.DataSegnalazione||'').startsWith(dd)).length};
  });
  const maxV=Math.max(...dayData.map(x=>Math.max(x.total,x.urg)),1);
  const svgW=400,svgH=140,pad=30;
  const xStep=(svgW-pad*2)/(dayData.length-1||1);
  const yScale=(svgH-pad*2)/maxV;
  const ptTotal=dayData.map((x,i)=>`${pad+i*xStep},${svgH-pad-x.total*yScale}`).join(' ');
  const ptComp=dayData.map((x,i)=>`${pad+i*xStep},${svgH-pad-x.comp*yScale}`).join(' ');
  const ptUrg=dayData.map((x,i)=>`${pad+i*xStep},${svgH-pad-x.urg*yScale}`).join(' ');
  const xLabels=dayData.map((x,i)=>`<text x="${pad+i*xStep}" y="${svgH-5}" text-anchor="middle" style="font-size:9px;fill:#9CA3AF">${x.d.substring(5)}</text>`).join('');
  $('sparkDash').innerHTML=`<svg viewBox="0 0 ${svgW} ${svgH}" style="width:100%;height:100%">
    <polyline points="${ptTotal}" fill="none" stroke="#3B82F6" stroke-width="2.5" stroke-linejoin="round"/>
    <polyline points="${ptComp}" fill="none" stroke="#10B981" stroke-width="2" stroke-dasharray="4,3" stroke-linejoin="round"/>
    <polyline points="${ptUrg}" fill="none" stroke="#EF4444" stroke-width="2" stroke-dasharray="2,2" stroke-linejoin="round"/>
    ${dayData.map((x,i)=>`<circle cx="${pad+i*xStep}" cy="${svgH-pad-x.total*yScale}" r="3.5" fill="#3B82F6"/><circle cx="${pad+i*xStep}" cy="${svgH-pad-x.comp*yScale}" r="3" fill="#10B981"/>`).join('')}
    ${xLabels}
    <text x="${svgW-8}" y="16" text-anchor="end" style="font-size:8px;fill:#3B82F6">â— Totali</text>
    <text x="${svgW-8}" y="26" text-anchor="end" style="font-size:8px;fill:#10B981">- - Completati</text>
    <text x="${svgW-8}" y="36" text-anchor="end" style="font-size:8px;fill:#EF4444">Â· Â· Urgenze</text>
  </svg>`;

  // 4. TIMELINE GIORNATA
  const oreLav=[];for(let h=7;h<=19;h++)oreLav.push(h);
  const nowH=new Date().getHours();
  $('timelineDash').innerHTML=oreLav.map(h=>{
    const hStr=String(h).padStart(2,'0');
    const intH=oggi.filter(p=>(p.OraInizio||'').startsWith(hStr));
    const isPast=h<nowH;const isNow=h===nowH;
    return `<div style="display:flex;gap:8px;align-items:flex-start;padding:3px 0;${isNow?'background:#EFF6FF;margin:0 -12px;padding:3px 12px;border-radius:6px':''}">
      <div style="width:32px;font-size:.7rem;font-weight:600;color:${isNow?'var(--c1)':isPast?'var(--gray)':'#111'};flex-shrink:0">${hStr}:00</div>
      <div style="flex:1;min-height:20px;border-left:2px solid ${isNow?'var(--c1)':isPast?'var(--gray3)':'#E5E7EB'};padding-left:8px">
        ${intH.map(p=>`<div style="font-size:.7rem;padding:2px 0;${isPast&&p.Stato!=='completato'?'color:var(--err)':''}">
          <strong>${getName(DATA.utenti||[],p.TecnicoID).split(' ')[0]}</strong> â†’ ${getName(DATA.clienti||[],p.ClienteID).substring(0,20)} ${statusTag(p.Stato)}
        </div>`).join('')}
      </div>
    </div>`;
  }).join('');
}

// ============ PIANO (INTERVENTI) ============
let _lastPianoItems=[]; // per export CSV
function renderPiano(){
  const stato=$('filtPianoStato')?.value||'';
  const tec=$('filtPianoTec')?.value||'';
  const dataDa=$('filtPianoDataDa')?.value||'';
  const dataA=$('filtPianoDataA')?.value||'';
  let items=(DATA.piano||[]).filter(p=>!p.Obsoleto);
  if(stato==='da_confermare')items=items.filter(p=>(p.Note||'').includes('DA CONFERMARE'));
  else if(stato)items=items.filter(p=>p.Stato===stato);
  if(tec)items=items.filter(p=>p.TecnicoID===tec||(p.TecniciIDs||'').includes(tec));
  if(dataDa)items=items.filter(p=>(p.Data||'')>=dataDa);
  if(dataA)items=items.filter(p=>(p.Data||'')<=dataA);
  items.sort((a,b)=>(b.Data||'').localeCompare(a.Data||''));
  _lastPianoItems=items;
  $('tblPiano').innerHTML=items.length?items.map(p=>`<tr>
    <td>${fmtDate(p.Data)}${p.DataFine&&p.DataFine!==p.Data?' â†’ '+fmtDate(p.DataFine):''}</td>
    <td>${p.OraInizio||'â€”'}</td>
    <td>${getName(DATA.utenti||[],p.TecnicoID)}${p.TecniciIDs?'<br><span style="font-size:.6875rem;color:var(--gray)">+'+p.TecniciIDs.split(',').filter(Boolean).length+' altri</span>':''}</td>
    <td>${getName(DATA.automezzi||[],p.AutomezzoID,'Descrizione')}</td>
    <td>${getName(DATA.clienti||[],p.ClienteID)}</td>
    <td>${getName(DATA.macchine||[],p.MacchinaID,'Tipo')}</td>
    <td><span class="tag" style="background:${getColor(DATA.tipiIntervento||[],p.TipoInterventoID)}20;color:${getColor(DATA.tipiIntervento||[],p.TipoInterventoID)}">${getName(DATA.tipiIntervento||[],p.TipoInterventoID)}</span></td>
    <td>${statusTag(p.Stato)}${(p.Note||'').includes('DA CONFERMARE')?'<br><span class="tag tag-warn" style="font-size:.6rem">â³ DA CONFERMARE</span>':''}</td>
    <td>${p.KmPercorsi||'â€”'}</td>
    <td>${p.OreLavorate||'â€”'}</td>
    <td>${(p.Note||'').includes('DA CONFERMARE')?`<button class="btn btn-ok btn-xs" onclick="approvaInt('${p.ID}')">âœ…</button> <button class="btn btn-err btn-xs" onclick="rifiutaInt('${p.ID}')">âŒ</button> `:''}<button class="btn btn-ghost btn-xs" onclick="showDetail('piano','${p.ID}')">ğŸ‘ï¸</button></td>
  </tr>`).join(''):'<tr><td colspan="11" class="empty"><p>Nessun intervento trovato</p></td></tr>';
}

function exportPianoCSV(){
  const items=_lastPianoItems;
  if(!items.length){toast('Nessun dato da esportare','err');return}
  const header='Data;Ora;Tecnico;Furgone;Cliente;Macchina;Tipo;Stato;Km;Ore;Note';
  const rows=items.map(p=>[
    p.Data||'',p.OraInizio||'',getName(DATA.utenti||[],p.TecnicoID),getName(DATA.automezzi||[],p.AutomezzoID,'Descrizione'),
    getName(DATA.clienti||[],p.ClienteID),getName(DATA.macchine||[],p.MacchinaID,'Tipo'),
    getName(DATA.tipiIntervento||[],p.TipoInterventoID),p.Stato||'',p.KmPercorsi||'',p.OreLavorate||'',
    (p.Note||'').replace(/;/g,',').replace(/\n/g,' ').substring(0,100)
  ].join(';'));
  const csv='\uFEFF'+header+'\n'+rows.join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='interventi_'+today()+'.csv';a.click();
  URL.revokeObjectURL(url);
  toast(`Esportati ${items.length} interventi`,'ok');
}

// ============ URGENZE ============
let _lastUrgItems=[];
function renderUrgenze(){
  const stato=$('filtUrgStato')?.value||'';
  const dataDa=$('filtUrgDataDa')?.value||'';
  const dataA=$('filtUrgDataA')?.value||'';
  let items=(DATA.urgenze||[]).filter(u=>!u.Obsoleto);
  if(stato)items=items.filter(u=>u.Stato===stato);
  if(dataDa)items=items.filter(u=>(u.DataSegnalazione||'').substring(0,10)>=dataDa);
  if(dataA)items=items.filter(u=>(u.DataSegnalazione||'').substring(0,10)<=dataA);
  items.sort((a,b)=>(b.DataSegnalazione||'').localeCompare(a.DataSegnalazione||''));
  _lastUrgItems=items;
  $('tblUrgenze').innerHTML=items.length?items.map(u=>`<tr>
    <td><span class="tag" style="background:${getColor(DATA.priorita||[],u.PrioritaID)}20;color:${getColor(DATA.priorita||[],u.PrioritaID)}">${getName(DATA.priorita||[],u.PrioritaID)}</span></td>
    <td>${getName(DATA.clienti||[],u.ClienteID)}</td>
    <td>${getName(DATA.macchine||[],u.MacchinaID,'Tipo')}</td>
    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${u.Problema||'â€”'}</td>
    <td>${u.TecnicoAssegnato?getName(DATA.utenti||[],u.TecnicoAssegnato):'<em style="color:var(--gray)">Non assegnata</em>'}</td>
    <td style="min-width:120px">${slaTag(u.SLAStatus)}</td>
    <td>${statusTag(u.Stato)}</td>
    <td>${fmtDateTime(u.DataSegnalazione)}</td>
    <td class="actions-cell">${u.Stato==='aperta'?`<button class="btn btn-primary btn-xs" onclick="openAssegna('${u.ID}')">âœ… Approva+Assegna</button>`:u.Stato==='assegnata'||u.Stato==='schedulata'?`<button class="btn btn-warn btn-xs" onclick="urgAction('${u.ID}','startUrgenza')">âš¡ Inizia</button>`:u.Stato==='in_corso'?`<button class="btn btn-ok btn-xs" onclick="urgAction('${u.ID}','resolveUrgenza')">âœ… Risolvi</button>`:''} <button class="btn btn-ghost btn-xs" onclick="showDetail('urgenza','${u.ID}')">ğŸ‘ï¸</button></td>
  </tr>`).join(''):'<tr><td colspan="9" class="empty"><p>Nessuna urgenza</p></td></tr>';
}

function exportUrgenzeCSV(){
  const items=_lastUrgItems;
  if(!items.length){toast('Nessun dato da esportare','err');return}
  const header='Data Segnalazione;PrioritÃ ;Cliente;Macchina;Problema;Tecnico;SLA;Stato;Data Risoluzione;Note';
  const rows=items.map(u=>[
    (u.DataSegnalazione||'').substring(0,16),getName(DATA.priorita||[],u.PrioritaID),
    getName(DATA.clienti||[],u.ClienteID),getName(DATA.macchine||[],u.MacchinaID,'Tipo'),
    (u.Problema||'').replace(/;/g,',').replace(/\n/g,' ').substring(0,150),
    u.TecnicoAssegnato?getName(DATA.utenti||[],u.TecnicoAssegnato):'â€”',
    u.SLAStatus||'â€”',u.Stato||'',(u.DataRisoluzione||'').substring(0,16),
    (u.Note||'').replace(/;/g,',').replace(/\n/g,' ').substring(0,100)
  ].join(';'));
  const csv='\uFEFF'+header+'\n'+rows.join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='urgenze_'+today()+'.csv';a.click();
  URL.revokeObjectURL(url);
  toast(`Esportate ${items.length} urgenze`,'ok');
}

function exportOrdiniCSV(){
  const items=(DATA.ordini||[]).filter(o=>!o.Obsoleto);
  const stato=$('filtOrdStato')?.value;
  const filtered=stato?items.filter(o=>o.Stato===stato):items;
  if(!filtered.length){toast('Nessun dato da esportare','err');return}
  const header='Codice Ricambio;Descrizione;QuantitÃ ;Tecnico;Cliente;Stato;Data Richiesta;ETA;Note';
  const rows=filtered.map(o=>[
    o.CodiceRicambio||'',
    (o.Descrizione||'').replace(/;/g,',').replace(/\n/g,' ').substring(0,150),
    o.Quantita||1,
    getName(DATA.utenti||[],o.TecnicoID),
    getName(DATA.clienti||[],o.ClienteID),
    o.Stato||'',
    (o.DataRichiesta||o.CreatedAt||'').substring(0,10),
    (o.DataArrivo||'').substring(0,10),
    (o.Note||'').replace(/;/g,',').replace(/\n/g,' ').substring(0,100)
  ].join(';'));
  downloadCSV('ordini_'+today()+'.csv', header, rows, filtered.length, 'ordini');
}

function exportClientiCSV(){
  const items=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
  if(!items.length){toast('Nessun dato da esportare','err');return}
  const header='Nome;CittÃ ;Provincia;Indirizzo;Telefono;Email;Contratto;Codice M3;Lat;Lng';
  const rows=items.map(c=>[
    (c.Nome||'').replace(/;/g,','),c.Citta||'',c.Provincia||'',
    (c.Indirizzo||'').replace(/;/g,','),c.Telefono||'',c.Email||'',
    c.TipoContratto||'',c.CodiceM3||'',c.Lat||'',c.Lng||''
  ].join(';'));
  downloadCSV('clienti_'+today()+'.csv', header, rows, items.length, 'clienti');
}

function downloadCSV(filename, header, rows, count, label){
  const csv='\uFEFF'+header+'\n'+rows.join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);
  toast(`Esportati ${count} ${label}`,'ok');
}

function openAssegna(urgId){$('maUrgId').value=urgId;$('maData').value=today();openModal('modalAssegna')}
async function urgAction(id,action){try{await apiCall(action,{id,operatoreId:USER?.ID},'POST');toast(action==='startUrgenza'?'Urgenza in corso!':'Urgenza risolta!','ok');await refreshData(true)}catch(e){toast(e.message,'err')}}
async function closeUrgenza(id){try{await apiCall('updateUrgenza',{id,Stato:'chiusa',operatoreId:USER?.ID},'POST');toast('Urgenza chiusa!','ok');closeModal('modalDetail');await refreshData(true)}catch(e){toast(e.message,'err')}}

async function saveUrgenzaEdit(id){
  try{
    const updates={id,
      ClienteID:$('edUrgCliente')?.value||null,
      PrioritaID:$('edUrgPriorita')?.value||null,
      TecnicoAssegnato:$('edUrgTecnico')?.value||null,
      DataPrevista:$('edUrgDataPrev')?.value||null,
      OraPrevista:$('edUrgOraPrev')?.value||null,
      Problema:$('edUrgProblema')?.value||'',
      Note:$('edUrgNote')?.value||''
    };
    await apiCall('updateUrgenza',updates,'POST');
    toast('Urgenza aggiornata!','ok');
    closeModal('modalDetail');
    await refreshData(true);
  }catch(e){toast('Errore: '+e.message,'err')}
}

// ---- AI Vision: Analisi foto guasto ----
function previewAIPhoto(urgId){
  const file=document.getElementById('aiVisionFile_'+urgId)?.files?.[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    document.getElementById('aiVisionImg_'+urgId).src=e.target.result;
    document.getElementById('aiVisionPreview_'+urgId).style.display='block';
  };
  reader.readAsDataURL(file);
}
function cancelAIPhoto(urgId){
  document.getElementById('aiVisionPreview_'+urgId).style.display='none';
  document.getElementById('aiVisionFile_'+urgId).value='';
  document.getElementById('aiVisionResult_'+urgId).style.display='none';
}
async function runAIVision(urgId){
  const file=document.getElementById('aiVisionFile_'+urgId)?.files?.[0];
  if(!file){toast('Seleziona una foto','err');return}
  // Compress image client-side (max 800px, quality 0.7)
  const compressed=await compressImage(file,800,0.7);
  const base64=compressed.split(',')[1]; // Remove data:image/...;base64, prefix
  document.getElementById('aiVisionLoading_'+urgId).style.display='block';
  document.getElementById('aiVisionResult_'+urgId).style.display='none';
  // Get urgenza context
  const urg=(DATA.urgenze||[]).find(u=>u.ID===urgId);
  const macchina=urg?getName(DATA.macchine||[],urg.MacchinaID,'Tipo'):'';
  const cliente=urg?getName(DATA.clienti||[],urg.ClienteID):'';
  try{
    const res=await apiCall('analyzeImage',{
      image_base64:base64,
      urgenza_id:urgId,
      contesto:`${macchina||'macchina agricola Lely'} presso ${cliente||'cliente'} - Problema: ${urg?.Problema||'non specificato'}`
    },'POST');
    document.getElementById('aiVisionLoading_'+urgId).style.display='none';
    const r=document.getElementById('aiVisionResult_'+urgId);
    r.style.display='block';
    const gravColor=res.gravita==='alta'?'#DC2626':res.gravita==='media'?'#F59E0B':'#10B981';
    r.innerHTML=`<div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px">
      <div style="font-weight:600;margin-bottom:6px">ğŸ” Diagnosi: ${res.diagnosi||'N/D'}</div>
      <div style="margin-bottom:4px"><strong>GravitÃ :</strong> <span style="background:${gravColor}20;color:${gravColor};padding:2px 8px;border-radius:4px;font-weight:600">${(res.gravita||'?').toUpperCase()}</span></div>
      ${res.ricambio_suggerito?`<div style="margin-bottom:4px"><strong>Ricambio:</strong> ${res.ricambio_suggerito} ${res.codice_ricambio?'('+res.codice_ricambio+')':''}</div>`:''}
      ${res.azione_consigliata?`<div style="margin-bottom:4px"><strong>Azione:</strong> ${res.azione_consigliata}</div>`:''}
      <div style="margin-bottom:8px"><strong>Confidenza:</strong> <div style="background:var(--border);border-radius:4px;height:8px;width:150px;display:inline-block;vertical-align:middle"><div style="background:${gravColor};height:100%;border-radius:4px;width:${Math.round((res.confidence||0)*100)}%"></div></div> ${Math.round((res.confidence||0)*100)}%</div>
      ${res.ricambio_suggerito?`<button class="btn btn-outline btn-sm" onclick="prefillOrdineFromAI('${urgId}','${(res.ricambio_suggerito||'').replace(/'/g,"\\'")}','${(res.codice_ricambio||'').replace(/'/g,"\\'")}')">ğŸ“¦ Ordina Ricambio</button>`:''}
    </div>`;
    toast('Analisi AI completata!','ok');
    await refreshData(true);
  }catch(e){
    document.getElementById('aiVisionLoading_'+urgId).style.display='none';
    document.getElementById('aiVisionResult_'+urgId).style.display='block';
    document.getElementById('aiVisionResult_'+urgId).innerHTML=`<div style="color:var(--err)">âŒ Errore: ${e.message}</div>`;
  }
}
function compressImage(file,maxSize,quality){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement('canvas');
        let w=img.width,h=img.height;
        if(w>maxSize||h>maxSize){
          if(w>h){h=Math.round(h*maxSize/w);w=maxSize}
          else{w=Math.round(w*maxSize/h);h=maxSize}
        }
        canvas.width=w;canvas.height=h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        resolve(canvas.toDataURL('image/jpeg',quality));
      };
      img.onerror=reject;
      img.src=e.target.result;
    };
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}
function prefillOrdineFromAI(urgId,ricambio,codice){
  const urg=(DATA.urgenze||[]).find(u=>u.ID===urgId);
  closeModal('modalDetail');
  openModal('modalOrdine');
  setTimeout(()=>{
    if($('ordCodice'))$('ordCodice').value=codice||'';
    if($('ordDescrizione'))$('ordDescrizione').value=ricambio||'';
    if($('ordQuantita'))$('ordQuantita').value='1';
    if($('ordCliente')&&urg)$('ordCliente').value=urg.ClienteID||'';
    if($('ordNote'))$('ordNote').value=`[AI Vision] Suggerito per urgenza ${urgId}`;
  },200);
}

async function saveInterventoEdit(id){
  try{
    const updates={id,
      ClienteID:$('edIntCliente')?.value||null,
      TecnicoID:$('edIntTecnico')?.value||null,
      AutomezzoID:$('edIntFurgone')?.value||null,
      TipoInterventoID:$('edIntTipo')?.value||null,
      Data:$('edIntData')?.value||null,
      OraInizio:$('edIntOra')?.value||null,
      Note:$('edIntNote')?.value||''
    };
    await apiCall('updatePiano',updates,'POST');
    toast('Intervento aggiornato!','ok');
    closeModal('modalDetail');
    await refreshData(true);
  }catch(e){toast('Errore: '+e.message,'err')}
}

async function approvaInt(id){
  try{
    const p=(DATA.piano||[]).find(x=>x.ID===id);if(!p)return;
    const note=(p.Note||'').replace(/\[RICHIESTA TECNICO - DA CONFERMARE\]\n?/g,'').replace(/\[URGENZA - DA CONFERMARE\]\n?/g,'').replace(/\[URGENZA ADMIN\]\n?/g,'');
    await apiCall('updatePiano',{id,data:{Note:'[APPROVATO âœ…]\n'+note,Stato:'pianificato'}},'POST');
    const nome=((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim();
    try{await apiCall('createNotifica',{data:{Tipo:'approvazione_intervento',Oggetto:'âœ… Intervento approvato',Testo:nome+' ha approvato il tuo intervento per '+getName(DATA.clienti,p.ClienteID)+' del '+fmtDate(p.Data),DestinatarioID:p.TecnicoID,Priorita:'alta'}},'POST')}catch(e){}
    try{await apiCall('sendChatMessage',{canale_id:'CH_ADMIN',testo:'âœ… APPROVATO intervento '+id+' per '+getName(DATA.clienti,p.ClienteID)+' ('+fmtDate(p.Data)+') â€” approvato da '+nome,userId:USER?.ID},'POST')}catch(e){}
    toast('Intervento approvato!','ok');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function rifiutaInt(id){
  const motivo=prompt('Motivo del rifiuto:');
  if(motivo===null)return;
  try{
    const p=(DATA.piano||[]).find(x=>x.ID===id);if(!p)return;
    await apiCall('updatePiano',{id,data:{Note:'[RIFIUTATO âŒ] '+(motivo||'Nessun motivo')+'\n'+(p.Note||''),Stato:'annullato'}},'POST');
    const nome=((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim();
    try{await apiCall('createNotifica',{data:{Tipo:'rifiuto_intervento',Oggetto:'âŒ Intervento rifiutato',Testo:nome+' ha rifiutato il tuo intervento per '+getName(DATA.clienti,p.ClienteID)+'. Motivo: '+(motivo||'non specificato'),DestinatarioID:p.TecnicoID,Priorita:'alta'}},'POST')}catch(e){}
    try{await apiCall('sendChatMessage',{canale_id:'CH_ADMIN',testo:'âŒ RIFIUTATO intervento '+id+' per '+getName(DATA.clienti,p.ClienteID)+' â€” da '+nome+(motivo?'\nMotivo: '+motivo:''),userId:USER?.ID},'POST')}catch(e){}
    toast('Intervento rifiutato','warn');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}


// ============ ORDINI ============
function renderOrdini(){
  const stato=$('filtOrdStato')?.value||'';
  let items=(DATA.ordini||[]).filter(o=>!o.Obsoleto);
  if(stato)items=items.filter(o=>o.Stato===stato);
  items.sort((a,b)=>(b.DataRichiesta||'').localeCompare(a.DataRichiesta||''));

  // Workflow counters
  const stati=['richiesto','preso_in_carico','ordinato','in_arrivo','arrivato'];
  stati.forEach((s,i)=>{const el=$('wfOrd'+(i+1));if(el){const c=items.filter(o=>o.Stato===s).length;el.className='wf-step'+(c>0?' active':'');el.textContent=el.textContent.split('(')[0]+(c>0?' ('+c+')':'')}});

  $('tblOrdini').innerHTML=items.length?items.map(o=>`<tr>
    <td><strong>${o.Codice||'â€”'}</strong></td>
    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${o.Descrizione||'â€”'}</td>
    <td>${o.Quantita||1}</td>
    <td>${getName(DATA.utenti||[],o.TecnicoID)}</td>
    <td>${getName(DATA.clienti||[],o.ClienteID)}</td>
    <td>${statusTag(o.Stato)}</td>
    <td>${fmtDate(o.DataRichiesta)}</td>
    <td>${fmtDate(o.DataArrivoPrevista)}</td>
    <td class="actions-cell">${nextOrdAction(o)}<button class="btn btn-ghost btn-xs" onclick="showDetail('ordine','${o.ID}')">ğŸ‘ï¸</button></td>
  </tr>`).join(''):'<tr><td colspan="9" class="empty"><p>Nessun ordine</p></td></tr>';
}

function nextOrdAction(o){
  const next={'richiesto':'preso_in_carico','preso_in_carico':'ordinato','ordinato':'in_arrivo','in_arrivo':'arrivato'};
  const labels={'preso_in_carico':'ğŸ‘‹ Prendi in Carico','ordinato':'ğŸ“¦ Ordinato','in_arrivo':'ğŸšš In Arrivo','arrivato':'âœ… Arrivato'};
  const n=next[o.Stato];
  if(!n)return '';
  return `<button class="btn btn-sm btn-outline" onclick="advanceOrdine('${o.ID}','${n}')" style="margin-right:4px">${labels[n]||n}</button>`;
}

async function advanceOrdine(id,stato){
  try{await apiCall('updateOrdineStato',{id,stato},'POST');toast('Ordine aggiornato','ok');await refreshData(true)}catch(e){toast(e.message,'err')}
}


// ============ INSTALLAZIONI ============
function renderInstallazioni(){
  const items=(DATA.installazioni||[]).filter(i=>!i.Obsoleto);
  $('tblInstall').innerHTML=items.length?items.map(i=>{
    const fasi=(DATA.fasiInstallazione||[]).filter(f=>f.Attivo).sort((a,b)=>a.Ordine-b.Ordine);
    const corrente=fasi.find(f=>f.ID===i.FaseCorrenteID);
    return `<tr>
      <td>${getName(DATA.clienti||[],i.ClienteID)}</td>
      <td>${getName(DATA.macchine||[],i.MacchinaID,'Tipo')}</td>
      <td>${fmtDate(i.DataInizio)}</td>
      <td>${fmtDate(i.DataFinePrevista)}</td>
      <td>${corrente?corrente.Nome:'â€”'}</td>
      <td>${(i.TecniciIDs||'').split(',').filter(Boolean).map(id=>getName(DATA.utenti||[],id)).join(', ')||'â€”'}</td>
      <td>${statusTag(i.Stato)}</td>
      <td><button class="btn btn-ghost btn-xs" onclick="showDetail('installazione','${i.ID}')">ğŸ‘ï¸</button></td>
    </tr>`}).join(''):'<tr><td colspan="8" class="empty"><p>Nessuna installazione in corso</p></td></tr>';
}

// ============ REPERIBILITA ============
function renderReperibilita(){
  const d=today();
  let items=(DATA.reperibilita||[]).filter(r=>!r.Obsoleto);
  if(repFilter==='attivi')items=items.filter(r=>r.Stato==='attiva'&&r.DataFine>=d);
  items.sort((a,b)=>(b.DataInizio||'').localeCompare(a.DataInizio||''));
  $('tblRep').innerHTML=items.length?items.map(r=>`<tr>
    <td>${getName(DATA.utenti||[],r.TecnicoID)}</td>
    <td>${fmtDate(r.DataInizio)}</td>
    <td>${fmtDate(r.DataFine)}</td>
    <td>${r.Turno||'24h'}</td>
    <td>${r.Tipo||'reperibilitÃ '}</td>
    <td>${statusTag(r.Stato)}</td>
    <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.Note||'â€”'}</td>
    <td></td>
  </tr>`).join(''):'<tr><td colspan="8" class="empty"><p>Nessun turno</p></td></tr>';
}
function repTab(f,btn){repFilter=f;document.querySelectorAll('#secReperibilita .tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderReperibilita()}

// ============ TRASFERTE ============
function renderTrasferte(){
  const items=(DATA.trasferte||[]).filter(t=>!t.Obsoleto).sort((a,b)=>(b.DataInizio||'').localeCompare(a.DataInizio||''));
  $('tblTrasf').innerHTML=items.length?items.map(t=>{
    const tecIds=(t.TecniciIDs||t.TecnicoID||'').split(',').filter(Boolean);
    return `<tr>
      <td>${tecIds.map(id=>getName(DATA.utenti||[],id)).join(', ')}</td>
      <td>${getName(DATA.clienti||[],t.ClienteID)}</td>
      <td>${fmtDate(t.DataInizio)}</td>
      <td>${fmtDate(t.DataFine)}</td>
      <td>${t.AutomezzoID||'â€”'}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.Motivo||'â€”'}</td>
      <td>${statusTag(t.Stato)}</td>
      <td></td>
    </tr>`}).join(''):'<tr><td colspan="8" class="empty"><p>Nessuna trasferta</p></td></tr>';
}

// ============ NOTIFICHE ============
function renderNotifiche(){
  const items=(DATA.notifiche||[]).filter(n=>!n.Obsoleto).sort((a,b)=>(b.DataInvio||'').localeCompare(a.DataInvio||''));
  $('tblNotifiche').innerHTML=items.length?items.map(n=>`<tr style="${n.Stato==='inviata'&&(n.DestinatarioID===USER?.ID||(n.DestinatariIDs||'').includes(USER?.ID))?'background:#FEF3C7':''}">
    <td>${getName(DATA.utenti||[],n.MittenteID)}</td>
    <td><span class="tag tag-info">${n.Tipo||'messaggio'}</span></td>
    <td><strong>${n.Oggetto||'â€”'}</strong><br><span style="font-size:.75rem;color:var(--gray)">${(n.Testo||'').substring(0,60)}${(n.Testo||'').length>60?'...':''}</span></td>
    <td>${getName(DATA.utenti||[],n.DestinatarioID)}</td>
    <td>${statusTag(n.Stato)}</td>
    <td>${fmtDateTime(n.DataInvio)}</td>
    <td>${n.Stato==='inviata'?`<button class="btn btn-ok btn-xs" onclick="markNotifica('${n.ID}','presa_in_carico')">âœ…</button>`:''}</td>
  </tr>`).join(''):'<tr><td colspan="7" class="empty"><p>Nessuna notifica</p></td></tr>';
}
async function markNotifica(id,azione){try{await apiCall('markNotifica',{id,azione},'POST');toast('Notifica aggiornata','ok');await refreshData(true)}catch(e){toast(e.message,'err')}}
async function markAllRead(){try{await apiCall('markAllRead',{},'POST');toast('Tutte lette','ok');await refreshData(true)}catch(e){toast(e.message,'err')}}

// ============ RICHIESTE ============
function renderRichieste(){
  const items=(DATA.richieste||[]).filter(r=>!r.Obsoleto).sort((a,b)=>(b.DataRichiesta||'').localeCompare(a.DataRichiesta||''));
  $('tblRich').innerHTML=items.length?items.map(r=>`<tr>
    <td>${getName(DATA.utenti||[],r.TecnicoID)}</td>
    <td><span class="tag">${r.Tipo||'generico'}</span></td>
    <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.Motivo||'â€”'}</td>
    <td>${statusTag(r.Stato)}</td>
    <td>${fmtDate(r.DataRichiesta)}</td>
    <td>${r.Stato==='in_attesa'?`<button class="btn btn-ok btn-xs" onclick="approveRich('${r.ID}','approvata')">âœ…</button><button class="btn btn-err btn-xs" onclick="approveRich('${r.ID}','rifiutata')" style="margin-left:4px">âŒ</button>`:''}</td>
  </tr>`).join(''):'<tr><td colspan="6" class="empty"><p>Nessuna richiesta</p></td></tr>';
}
async function approveRich(id,stato){try{await apiCall('updateRichiesta',{id,stato},'POST');toast('Richiesta '+stato,'ok');await refreshData(true)}catch(e){toast(e.message,'err')}}
function openNewRichiesta(){
  const tecOpts=(DATA.utenti||[]).filter(u=>!u.Obsoleto).map(u=>`<option value="${u.ID}">${u.Nome} ${u.Cognome||''}</option>`).join('');
  const html=`<div style="display:flex;flex-direction:column;gap:12px;padding:8px">
    <label>Tipo<select id="nrTipo" class="inp"><option value="ferie">Ferie</option><option value="permesso">Permesso</option><option value="malattia">Malattia</option><option value="cambio_turno">Cambio Turno</option><option value="generico">Generico</option></select></label>
    <label>Tecnico<select id="nrTecnico" class="inp"><option value="">â€” Seleziona â€”</option>${tecOpts}</select></label>
    <label>Motivo<textarea id="nrMotivo" class="inp" rows="3" placeholder="Descrizione richiesta..."></textarea></label>
    <button class="btn btn-ok" onclick="submitRichiesta()">ğŸ“ Invia Richiesta</button>
  </div>`;
  openModal('modalDetail','ğŸ“ Nuova Richiesta',html);
}
async function submitRichiesta(){
  const tipo=$('nrTipo')?.value||'generico';
  const tecnico=$('nrTecnico')?.value||null;
  const motivo=$('nrMotivo')?.value||'';
  if(!motivo.trim()){toast('Inserisci un motivo','err');return}
  try{
    await apiCall('createRichiesta',{tipo,tecnicoId:tecnico,motivo},'POST');
    toast('Richiesta creata!','ok');closeModal('modalDetail');await refreshData(true);
  }catch(e){toast('Errore: '+e.message,'err')}
}

// ============ CLIENTI ============
function renderClienti(){
  const q=($('srcClienti')?.value||'').toLowerCase();
  let items=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
  if(q)items=items.filter(c=>(c.Nome||'').toLowerCase().includes(q)||(c.Citta||'').toLowerCase().includes(q));
  $('tblClienti').innerHTML=items.length?items.map(c=>`<tr>
    <td><strong>${c.Nome||'â€”'}</strong></td>
    <td>${c.Citta||'â€”'}</td>
    <td>${c.Prov||'â€”'}</td>
    <td>${c.Indirizzo||'â€”'}</td>
    <td>${c.Telefono?`<a href="tel:${c.Telefono}">${c.Telefono}</a>`:'â€”'}</td>
    <td>${c.Contratto||'â€”'}</td>
    <td>${c.Latitudine&&c.Longitudine?'<span class="tag tag-ok">ğŸ“</span>':'<span class="tag tag-gray">â€”</span>'}</td>
    <td><button class="btn btn-ghost btn-xs" onclick="editCliente('${c.ID}')">âœï¸</button><button class="btn btn-ghost btn-xs" onclick="showDetail('cliente','${c.ID}')">ğŸ‘ï¸</button></td>
  </tr>`).join(''):'<tr><td colspan="8" class="empty"><p>Nessun cliente trovato</p></td></tr>';
}

// ============ MACCHINE ============
function renderMacchine(){
  const q=($('srcMacch')?.value||'').toLowerCase();
  const cliFilter=$('filtMacchCli')?.value||'';
  const typeFilter=$('filtMacchType')?.value||'';
  const view=$('filtMacchView')?.value||'tree';

  // Pull from anagrafica assets (the real data source with 1137+ assets)
  let items=getAllAnagAssets();

  // Populate client filter dropdown from anagrafica
  const cliSel=$('filtMacchCli');
  if(cliSel&&cliSel.options.length<=1&&ANAG_CLIENTI.length){
    const seen=new Set();
    ANAG_CLIENTI.filter(c=>{
      const m3=c.CodiceM3;
      if(!m3||seen.has(m3))return false;
      seen.add(m3);
      return (ANAG_ASSETS_CACHE[m3]||[]).length>0;
    }).sort((a,b)=>(a.NomeAccount||'').localeCompare(b.NomeAccount||'')).forEach(c=>{
      const o=document.createElement('option');o.value=c.CodiceM3;o.textContent=c.NomeAccount||c.NomeInterno||c.CodiceM3;cliSel.appendChild(o);
    });
  }
  // Populate type filter dropdown
  const typeSel=$('filtMacchType');
  if(typeSel&&typeSel.options.length<=1&&items.length){
    const typeCounts={};
    items.forEach(a=>{const k=normAssetType(a.GruppoAttrezzatura||a.TipoFoglio);typeCounts[k]=(typeCounts[k]||0)+1});
    Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
      const cfg=PROD_CFG[k]||{};
      const o=document.createElement('option');o.value=k;o.textContent=(cfg.label||k)+` (${v})`;typeSel.appendChild(o);
    });
  }

  // Apply filters
  if(q)items=items.filter(a=>{
    const s=[a.NomeAsset,a.NumeroSerie,a.Modello,a.NomeAccount,a.GruppoAttrezzatura].map(x=>(x||'').toLowerCase()).join(' ');
    return s.includes(q);
  });
  if(cliFilter)items=items.filter(a=>a.CodiceM3===cliFilter);
  if(typeFilter)items=items.filter(a=>normAssetType(a.GruppoAttrezzatura||a.TipoFoglio)===typeFilter);

  // Stats bar
  const statsDiv=$('macchStats');
  if(statsDiv){
    const typeCounts={};
    items.forEach(a=>{const k=normAssetType(a.GruppoAttrezzatura||a.TipoFoglio);typeCounts[k]=(typeCounts[k]||0)+1});
    const clientSet=new Set(items.map(a=>a.CodiceM3).filter(Boolean));
    let cards=[[items.length,'Totale Assets'],[clientSet.size,'Clienti']];
    Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
      cards.push([v,prodIcon(k,18)+' '+(PROD_CFG[k]?.label||k)]);
    });
    statsDiv.innerHTML=cards.map(([v,l])=>`<div style="min-width:70px;padding:4px 8px;text-align:center;background:#f8f9fa;border-radius:6px"><div style="font-size:1rem;font-weight:700;color:var(--primary)">${v}</div><div style="font-size:.6rem;color:var(--muted)">${l}</div></div>`).join('');
  }

  // Helper: escape quotes for onclick attrs
  const esc=s=>(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');

  if(view==='tree'){
    $('macchListTable').style.display='none';
    const treeDiv=$('macchTreeView');treeDiv.style.display='block';
    if(!items.length){treeDiv.innerHTML='<div class="empty"><p>Nessuna macchina trovata. Importa l\'anagrafica Excel per popolare il parco macchine.</p></div>';return}
    // Group by normalized type
    const groups={};
    items.forEach(a=>{const k=normAssetType(a.GruppoAttrezzatura||a.TipoFoglio);if(!groups[k])groups[k]=[];groups[k].push(a)});
    let html='';
    // Sort: ALTRI always last, rest by count desc
    const sortedGroups=Object.entries(groups).sort((a,b)=>{
      if(a[0]==='ALTRI')return 1;if(b[0]==='ALTRI')return -1;
      return b[1].length-a[1].length;
    });
    sortedGroups.forEach(([tipo,assets])=>{
      const cfg=PROD_CFG[tipo]||{};
      const iconBig=prodIcon(tipo,36);
      // DEFAULT: tree CLOSED (display:none), arrow â–¶
      html+=`<div style="margin-bottom:2px">
        <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none';this.querySelector('.mac-arrow').textContent=this.nextElementSibling.style.display==='none'?'â–¶':'â–¼'" style="cursor:pointer;padding:10px 14px;background:linear-gradient(135deg,#f8f9fa,#fff);border-bottom:1px solid #eee;display:flex;align-items:center">
          <span class="mac-arrow" style="margin-right:8px;font-size:.8rem;width:14px;color:${cfg.color||'#666'}">â–¶</span>
          <span style="margin-right:10px">${iconBig}</span>
          <div style="flex:1">
            <strong style="font-size:.95rem;color:${cfg.color||'#333'}">${cfg.label||tipo}</strong>
            <span class="badge" style="margin-left:8px;font-size:.7rem;background:${cfg.color||'#666'};color:#fff">${assets.length}</span>
          </div>
          ${cfg.url?`<a href="${cfg.url}" target="_blank" style="font-size:.7rem;color:${cfg.color||'var(--primary)'};text-decoration:none;opacity:.7" onclick="event.stopPropagation()">Info prodotto â†’</a>`:''}
        </div>
        <div style="padding:0;display:none">
          <table class="tbl" style="font-size:.8125rem;margin:0"><thead><tr>
            <th style="width:30px"></th><th>Modello</th><th>Asset</th><th>N. Serie</th><th>Cliente</th><th>Stato</th><th style="width:180px">Azioni</th>
          </tr></thead><tbody>`;
      assets.forEach(a=>{
        const stato=a.Stato||'';
        const statoTag=stato.toLowerCase().includes('attiv')?'<span class="tag tag-ok">Attivo</span>':stato.toLowerCase().includes('dismess')?'<span class="tag tag-err">Dismesso</span>':stato?`<span class="tag tag-gray">${stato}</span>`:'';
        const assetInfo=esc(a.NomeAsset||tipo)+' â€” SN:'+esc(a.NumeroSerie||'-');
        const cliName=esc(a.NomeAccount||'');
        html+=`<tr>
          <td>${prodIcon(tipo,20)}</td>
          <td><strong style="color:${cfg.color||'#333'}">${a.Modello||'â€”'}</strong></td>
          <td>${a.NomeAsset||'â€”'}</td>
          <td style="font-family:var(--mono);font-size:.72rem">${a.NumeroSerie||'â€”'}</td>
          <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${cliName}">${a.NomeAccount||'â€”'}</td>
          <td>${statoTag}</td>
          <td style="white-space:nowrap">
            <button class="btn btn-ghost btn-xs" onclick="openAssetAction('urgenza','${esc(a.CodiceM3)}','${assetInfo}','${cliName}')" title="Crea Urgenza" style="color:#ef4444">ğŸš¨</button>
            <button class="btn btn-ghost btn-xs" onclick="openAssetAction('piano','${esc(a.CodiceM3)}','${assetInfo}','${cliName}')" title="Crea Intervento/Tagliando" style="color:#3b82f6">ğŸ“‹</button>
            <button class="btn btn-ghost btn-xs" onclick="openAssetAction('ordine','${esc(a.CodiceM3)}','${assetInfo}','${cliName}')" title="Ordine Ricambi" style="color:#8b5cf6">ğŸ“¦</button>
            <button class="btn btn-ghost btn-xs" onclick="openAssetAction('notifica','${esc(a.CodiceM3)}','${assetInfo}','${cliName}')" title="Invia Notifica" style="color:#f59e0b">ğŸ””</button>
            <button class="btn btn-ghost btn-xs" onclick="showAssetOnMap('${esc(a.CodiceM3)}','${esc(a.NomeAsset)}')" title="Mappa">ğŸ“</button>
          </td>
        </tr>`;
      });
      html+=`</tbody></table></div></div>`;
    });
    treeDiv.innerHTML=html;
  }else{
    $('macchTreeView').style.display='none';
    $('macchListTable').style.display='';
    $('tblMacchine').innerHTML=items.length?items.map(a=>{
      const tipo=normAssetType(a.GruppoAttrezzatura||a.TipoFoglio);
      const cfg=PROD_CFG[tipo]||{};
      const stato=a.Stato||'';
      const statoTag=stato.toLowerCase().includes('attiv')?'<span class="tag tag-ok">Attivo</span>':stato.toLowerCase().includes('dismess')?'<span class="tag tag-err">Dismesso</span>':stato?`<span class="tag tag-gray">${stato}</span>`:'';
      const assetInfo=esc(a.NomeAsset||tipo)+' â€” SN:'+esc(a.NumeroSerie||'-');
      const cliName=esc(a.NomeAccount||'');
      return `<tr>
      <td>${prodIcon(tipo,24)}</td>
      <td style="color:${cfg.color||'#333'}"><strong>${a.Modello||'â€”'}</strong></td>
      <td>${a.NomeAsset||'â€”'}</td>
      <td style="font-family:var(--mono);font-size:.72rem">${a.NumeroSerie||'â€”'}</td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${cliName}">${a.NomeAccount||'â€”'}</td>
      <td>${statoTag}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost btn-xs" onclick="openAssetAction('urgenza','${esc(a.CodiceM3)}','${assetInfo}','${cliName}')" title="Urgenza" style="color:#ef4444">ğŸš¨</button>
        <button class="btn btn-ghost btn-xs" onclick="openAssetAction('piano','${esc(a.CodiceM3)}','${assetInfo}','${cliName}')" title="Intervento" style="color:#3b82f6">ğŸ“‹</button>
        <button class="btn btn-ghost btn-xs" onclick="openAssetAction('ordine','${esc(a.CodiceM3)}','${assetInfo}','${cliName}')" title="Ordine" style="color:#8b5cf6">ğŸ“¦</button>
        <button class="btn btn-ghost btn-xs" onclick="openAssetAction('notifica','${esc(a.CodiceM3)}','${assetInfo}','${cliName}')" title="Notifica" style="color:#f59e0b">ğŸ””</button>
        <button class="btn btn-ghost btn-xs" onclick="showAssetOnMap('${esc(a.CodiceM3)}','${esc(a.NomeAsset)}')" title="Mappa">ğŸ“</button>
      </td>
    </tr>`}).join(''):'<tr><td colspan="7" class="empty"><p>Nessuna macchina trovata</p></td></tr>';
  }
}

// Open action modal pre-filled with asset/client info from anagrafica
function openAssetAction(action, codiceM3, assetInfo, clienteName){
  // Ensure modal client selects have anagrafica data
  populateModalClientsFromAnag();

  const setCliAndMacch=(prefix,serialeOrName)=>{
    const cliSel=$(prefix+'Cliente');
    if(cliSel){
      // Try M3 code first (anagrafica), then CRUD client by name
      cliSel.value=codiceM3;
      if(!cliSel.value){
        // Try by name match in CRUD
        const crudCli=(DATA.clienti||[]).find(c=>(c.Nome||'').toUpperCase()===clienteName.toUpperCase());
        if(crudCli)cliSel.value=crudCli.ID;
      }
      // Load machines for this client
      loadMacchineCliente(prefix);
      // Auto-select the specific machine/asset if we have a serial number
      if(serialeOrName){
        const macSel=$(prefix+'Macchina');
        if(macSel){
          // Try to find by serial number in the options
          for(let i=0;i<macSel.options.length;i++){
            if(macSel.options[i].value===serialeOrName||
               macSel.options[i].textContent.includes(serialeOrName)){
              macSel.selectedIndex=i;break;
            }
          }
        }
      }
    }
  };

  // Extract serial from assetInfo string (format: "NomeAsset â€” SN:seriale")
  const snMatch=assetInfo.match(/SN:([^\s']+)/);
  const seriale=snMatch?snMatch[1]:'';

  if(action==='urgenza'){
    openModal('modalUrgenza');
    setCliAndMacch('mu',seriale);
    const prob=$('muProblema');if(prob)prob.value='';
    const note=$('muNote');if(note)note.value='Asset: '+assetInfo.replace(/'/g,"'")+' | M3: '+codiceM3;
  }else if(action==='piano'){
    openModal('modalPiano');
    const d=$('mpData');if(d)d.value=today();
    setCliAndMacch('mp',seriale);
    const note=$('mpNote');if(note)note.value='Asset: '+assetInfo.replace(/'/g,"'")+' | M3: '+codiceM3;
  }else if(action==='ordine'){
    openModal('modalOrdine');
    setCliAndMacch('mo',seriale);
    const desc=$('moDesc');if(desc)desc.value='Ricambio per: '+assetInfo.replace(/'/g,"'");
    const note=$('moNote');if(note)note.value='M3: '+codiceM3;
  }else if(action==='notifica'){
    openModal('modalNotifica');
    const tit=$('mnTitolo');if(tit)tit.value='Notifica per asset';
    const msg=$('mnMessaggio');if(msg)msg.value='Cliente: '+clienteName.replace(/'/g,"'")+' (M3: '+codiceM3+')\nAsset: '+assetInfo.replace(/'/g,"'");
  }
}

// Show single asset on map (from anagrafica)
var macchMapInst=null;
function showAssetOnMap(codiceM3,assetName){
  // Find client in anagrafica
  const cli=ANAG_CLIENTI.find(c=>c.CodiceM3===codiceM3);
  if(!cli||!cli.Lat||!cli.Lng){
    toast('Coordinate non disponibili per questo cliente. Importa lat/lng nell\'anagrafica.','warn');
    return;
  }
  const lat=parseFloat(cli.Lat),lng=parseFloat(cli.Lng);
  if(isNaN(lat)||isNaN(lng)){toast('Coordinate non valide','warn');return}
  const locName=cli.NomeAccount||cli.NomeInterno||codiceM3;
  // Find asset to get type info
  const assets=ANAG_ASSETS_CACHE[codiceM3]||[];
  const asset=assetName?assets.find(a=>(a.NomeAsset||'')===(assetName||'')):assets[0];
  const tipo=asset?normAssetType(asset.GruppoAttrezzatura||asset.TipoFoglio):'';
  const cfg=PROD_CFG[tipo]||{};
  $('macchMapTitle').innerHTML=`${prodIcon(tipo,24)} <span style="margin-left:6px">${asset?.NomeAsset||asset?.Modello||tipo} â€” ${asset?.NumeroSerie||''}</span> <small style="color:var(--muted)">@ ${locName}</small>`;
  $('macchMapModal').style.display='block';
  setTimeout(()=>{
    if(macchMapInst){macchMapInst.remove();macchMapInst=null}
    const cont=$('macchMapContainer');cont.innerHTML='';
    macchMapInst=L.map(cont).setView([lat,lng],14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(macchMapInst);
    const color=cfg.color||'#C30A14';
    L.circleMarker([lat,lng],{radius:12,color,fillColor:color,fillOpacity:.8,weight:2}).addTo(macchMapInst)
      .bindPopup(`<b>${asset?.NomeAsset||tipo}</b><br>SN: ${asset?.NumeroSerie||'-'}<br>Cliente: ${locName}<br><a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">Apri in Google Maps â†’</a>`).openPopup();
    setTimeout(()=>macchMapInst.invalidateSize(),200);
  },100);
}
function closeMacchMap(){
  $('macchMapModal').style.display='none';
  if(macchMapInst){macchMapInst.remove();macchMapInst=null}
}

// ============ AUTOMEZZI ============
function renderAutomezzi(){
  const items=(DATA.automezzi||[]).filter(f=>!f.Obsoleto);
  $('furgGrid').innerHTML=items.length?'<div class="grid-auto">'+items.map(f=>{
    const d=today();const ctrl=f.ProssimoControllo&&f.ProssimoControllo<=d;
    return `<div class="card" style="border-left:4px solid ${f.Status==='attivo'?'var(--ok)':'var(--warn)'}">
      <div class="card-body">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div><h4 style="font-size:1rem;margin-bottom:4px">ğŸš ${f.ID}</h4><p style="font-size:.8125rem;color:var(--gray)">${f.Targa||''} Â· ${f.Descrizione||''}</p></div>
          ${statusTag(f.Status)}
        </div>
        <div style="margin-top:12px;font-size:.8125rem">
          <div>ğŸ“ Allestimento: <strong>${f.Allestimento||'â€”'}</strong></div>
          <div>ğŸ“ Km: <strong>${f.KmAttuali||'â€”'}</strong></div>
          <div>ğŸ‘¤ Assegnato: <strong>${f.AssegnatarioID?getName(DATA.utenti||[],f.AssegnatarioID):'â€”'}</strong></div>
          <div>ğŸ”§ Prossimo controllo: ${ctrl?`<span class="tag tag-err">âš ï¸ ${fmtDate(f.ProssimoControllo)}</span>`:`<span>${fmtDate(f.ProssimoControllo)}</span>`}</div>
        </div>
        <div style="margin-top:10px;text-align:right"><button class="btn btn-outline btn-xs" onclick="editAutomezzo('${f.ID}')">âœï¸ Modifica</button></div>
      </div>
    </div>`}).join('')+'</div>':'<div class="empty"><div class="ico">ğŸš</div><p>Nessun automezzo configurato</p></div>';
}

// ============ TECNICI ============
function renderTecnici(){
  const items=(DATA.utenti||[]).filter(u=>!u.Obsoleto);
  $('tblTecnici').innerHTML=items.map(t=>{
    const sq=(DATA.squadre||[]).find(s=>s.ID===t.SquadraID);
    const ini=(t.Nome||'')[0]+''+(t.Cognome||'')[0];
    const foto=t.FotoURL
      ?`<img src="${t.FotoURL}" style="width:36px;height:36px;border-radius:50%;object-fit:cover">`
      :`<div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--c2),var(--c1));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:.7rem">${ini}</div>`;
    return `<tr>
    <td>${foto}</td>
    <td><strong>${(t.Nome||'')+' '+(t.Cognome||'')}</strong></td>
    <td><span class="tag ${t.Ruolo==='admin'?'tag-purple':t.Ruolo==='caposquadra'?'tag-info':'tag-gray'}">${t.Ruolo}</span></td>
    <td>${sq?sq.Nome:'â€”'}</td>
    <td>${t.AutomezzoID||'â€”'}</td>
    <td>${t.Base||'â€”'}</td>
    <td>${t.Telefono?`<a href="tel:${t.Telefono}">${t.Telefono}</a>`:'â€”'}</td>
    <td>${t.Email||'â€”'}</td>
    <td>${t.Attivo?'<span class="tag tag-ok">Attivo</span>':'<span class="tag tag-gray">Inattivo</span>'}</td>
    <td><button class="btn btn-ghost btn-xs" onclick="editUtente('${t.ID}')">âœï¸</button><label class="btn btn-outline" style="font-size:.75rem;padding:4px 8px;cursor:pointer;margin-left:2px">ğŸ“·<input type="file" accept="image/*" style="display:none" onchange="uploadFotoTec('${t.ID}',this)"></label></td>
  </tr>`}).join('');
}
async function uploadFotoTec(tecId,input){
  const file=input.files[0];if(!file)return;
  if(file.size>5*1024*1024){showToast('Foto troppo grande (max 5MB)','warn');return}
  showToast('Caricamento foto...','info');
  const reader=new FileReader();
  reader.onload=async function(){
    try{
      const base64=reader.result.split(',')[1];
      const r=await apiCall('uploadFotoProfilo',{base64,mimeType:file.type,userId:tecId});
      if(r.success){showToast('Foto caricata!','ok');await reloadData();renderTecnici()}
      else showToast('Errore: '+(r.error||'sconosciuto'),'err');
    }catch(e){showToast('Errore upload: '+e.message,'err')}
  };
  reader.readAsDataURL(file);
}
// ============ CALENDARIO ============
function renderCal(){
  const y=calDate.getFullYear(),m=calDate.getMonth();
  $('calTitle').textContent=new Date(y,m).toLocaleDateString('it-IT',{month:'long',year:'numeric'});
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  const startDay=(first.getDay()+6)%7;
  const filtTec=$('calFiltroTec')?.value||'';
  let piano=(DATA.piano||[]).filter(p=>!p.Obsoleto&&p.Data);
  if(filtTec)piano=piano.filter(p=>p.TecnicoID===filtTec||(p.TecniciIDs||'').includes(filtTec));

  let html='<div class="cal-hdr">Lun</div><div class="cal-hdr">Mar</div><div class="cal-hdr">Mer</div><div class="cal-hdr">Gio</div><div class="cal-hdr">Ven</div><div class="cal-hdr">Sab</div><div class="cal-hdr">Dom</div>';
  const prevLast=new Date(y,m,0).getDate();
  for(let i=startDay-1;i>=0;i--)html+=`<div class="cal-day other">${prevLast-i}</div>`;
  for(let d=1;d<=last.getDate();d++){
    const ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const cnt=piano.filter(p=>p.Data===ds).length;
    const isToday=ds===today();
    html+=`<div class="cal-day${isToday?' today':''}" onclick="showCalDay('${ds}')">${d}${cnt>0?'<span class="dot"></span>':''}</div>`;
  }
  const rem=7-((startDay+last.getDate())%7);
  if(rem<7)for(let i=1;i<=rem;i++)html+=`<div class="cal-day other">${i}</div>`;
  $('calGrid').innerHTML=html;
}
function calNav(dir){calDate.setMonth(calDate.getMonth()+dir);renderCal()}
function showCalDay(ds){
  const filtTec=$('calFiltroTec')?.value||'';
  let items=(DATA.piano||[]).filter(p=>!p.Obsoleto&&p.Data===ds);
  if(filtTec)items=items.filter(p=>p.TecnicoID===filtTec||(p.TecniciIDs||'').includes(filtTec));
  $('calDetail').innerHTML=items.length?`<h4 style="margin-bottom:8px">${fmtDate(ds)} â€” ${items.length} interventi</h4>`+items.map(p=>`<div style="padding:8px 12px;border-left:3px solid ${getColor(DATA.tipiIntervento||[],p.TipoInterventoID)};margin-bottom:6px;background:var(--gray5);border-radius:0 var(--radius-sm) var(--radius-sm) 0">
    <strong>${p.OraInizio||'â€”'}</strong> ${getName(DATA.utenti||[],p.TecnicoID)} â†’ ${getName(DATA.clienti||[],p.ClienteID)} Â· ${getName(DATA.tipiIntervento||[],p.TipoInterventoID)} ${statusTag(p.Stato)}
  </div>`).join(''):`<p style="color:var(--gray)">Nessun intervento per ${fmtDate(ds)}</p>`;
}

// ============ MAPPA ============
const GEO_CACHE={
'piacenza':[45.0526,9.6929],'parma':[44.8015,10.3279],'reggio emilia':[44.6989,10.6310],'modena':[44.6471,10.9252],
'bologna':[44.4949,11.3426],'ferrara':[44.8381,11.6199],'ravenna':[44.4184,12.2035],'rimini':[44.0678,12.5695],
'carpi':[44.7836,10.8862],'fidenza':[44.8667,10.0607],'correggio':[44.7713,10.7809],'collecchio':[44.7486,10.2200],
'langhirano':[44.6150,10.2660],'pavullo nel frignano':[44.3354,10.8362],'castelnovo ne monti':[44.4384,10.4059],
'noceto':[44.8117,10.1763],'fontanellato':[44.8780,10.1740],'soragna':[44.9270,10.1220],'busseto':[44.9803,10.0417],
'montecchio emilia':[44.7033,10.4478],'novellara':[44.8444,10.7289],'campegine':[44.7824,10.5338],
'bibbiano':[44.6669,10.4756],'san polo d\'enza':[44.6281,10.4228],'viano':[44.5528,10.5808],
'traversetolo':[44.6355,10.3772],'montechiarugolo':[44.6903,10.4159],'felino':[44.6934,10.2310],
'medesano':[44.7558,10.1406],'tizzano val parma':[44.5194,10.2001],'corniglio':[44.4836,10.0903],
'neviano degli arduini':[44.5625,10.3028],'monghidoro':[44.2944,11.3222],'monterenzio':[44.3347,11.4067],
'monte san pietro':[44.4122,11.1642],'castel d\'aiano':[44.2919,11.0158],'medicina':[44.4744,11.6367],
'budrio':[44.5367,11.5333],'argelato':[44.6417,11.3481],'bentivoglio':[44.6325,11.4172],
'granarolo dell\'emilia':[44.5522,11.4461],'san cesario sul panaro':[44.5631,11.0267],
'spilamberto':[44.5306,11.0242],'castelnuovo rangone':[44.5553,10.9389],'soliera':[44.7356,10.9250],
'medolla':[44.8528,11.0711],'san prospero':[44.7892,11.0217],'serramazzoni':[44.4564,10.7889],
'zocca':[44.3461,10.9939],'montese':[44.2661,10.9428],'palagano':[44.3211,10.6778],
'polinago':[44.3500,10.7222],'montecreto':[44.2508,10.7194],'prignano sulla secchia':[44.4394,10.6886],
'lama mocogno':[44.3075,10.7339],'villa minozzo':[44.3650,10.4694],'toano':[44.4539,10.5494],
'casina':[44.5061,10.5017],'castelnovo di sotto':[44.8072,10.5625],'campagnola emilia':[44.8394,10.7622],
'luzzara':[44.9556,10.6914],'gualtieri':[44.9064,10.6272],'poviglio':[44.8397,10.5486],
'rivergaro':[44.9139,9.5978],'borgonovo val tidone':[44.9850,9.4456],'gragnano trebbiense':[45.0044,9.5756],
'carpaneto piacentino':[44.9219,9.7867],'cadeo':[44.9592,9.8361],'san giorgio piacentino':[44.9494,9.7314],
'codogno':[45.1617,9.7072],'bagnolo in piano':[44.7647,10.6744],'colorno':[44.9308,10.3767],
'sorbolo':[44.8581,10.4481],'torrile':[44.8614,10.3319],'roccabianca':[44.9933,10.2183],
'compiano':[44.5117,9.6586],'bardi':[44.6333,9.7236],'reggiolo':[44.9183,10.8100],
'rolo':[44.8800,10.8644],'anzola dell\'emilia':[44.5467,11.1933],'fontevivo':[44.8350,10.1856],
'mesola':[44.9239,12.2331],'poggio renatico':[44.7664,11.4831],'sant\'agata bolognese':[44.6622,11.1361],
};
const _geoQueue={};
async function geocodeCity(city){
  if(!city)return null;
  const k=city.toLowerCase().replace(/\s+/g,' ').trim();
  if(GEO_CACHE[k])return GEO_CACHE[k];
  if(_geoQueue[k])return _geoQueue[k];
  _geoQueue[k]=(async()=>{
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=it&q=${encodeURIComponent(city+', Emilia-Romagna, Italia')}`);
      const d=await r.json();
      if(d[0]){GEO_CACHE[k]=[parseFloat(d[0].lat),parseFloat(d[0].lon)];return GEO_CACHE[k]}
    }catch(e){}
    return null;
  })();
  return _geoQueue[k];
}

function fillMapTecSelect(){
  const sel=$('mapFiltroTec');if(!sel)return;
  const cur=sel.value;
  sel.innerHTML='<option value="">ğŸ‘¥ Tutti i tecnici</option>';
  (DATA.utenti||[]).filter(u=>!u.Obsoleto&&(u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'||u.Ruolo==='tecnico_senior')).forEach(u=>{
    const o=document.createElement('option');o.value=u.ID;o.textContent=(u.Nome||'')+' '+(u.Cognome||'');sel.appendChild(o);
  });
  if(cur)sel.value=cur;
}

// Routing su strade reali via OSRM (open source, gratuito)
// Usa endpoint /trip per ottimizzare l'ordine di visita (TSP)
async function fetchOSRMRoute(waypoints){
  if(!waypoints||waypoints.length<2)return null;
  // OSRM vuole lng,lat
  const coords=waypoints.map(w=>`${w.lng},${w.lat}`).join(';');
  try{
    const url=`https://router.project-osrm.org/trip/v1/driving/${coords}?roundtrip=false&source=first&destination=last&overview=full&geometries=geojson`;
    const r=await fetch(url,{signal:AbortSignal.timeout(8000)});
    if(!r.ok)return null;
    const json=await r.json();
    if(json.code==='Ok'&&json.trips?.[0]){
      return {geometry:json.trips[0].geometry,distance:json.trips[0].distance,duration:json.trips[0].duration};
    }
  }catch(e){console.warn('[OSRM]',e.message)}
  return null;
}

async function initMap(){
  fillMapTecSelect();
  if(MAP){MAP.invalidateSize();await updateMap();return}
  MAP=L.map('mapAdmin').setView([44.6471,10.9252],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(MAP);
  // Assicurati che anagrafica sia caricata prima della mappa
  if(!ANAG_CLIENTI||!ANAG_CLIENTI.length){try{await loadAnagClients()}catch(e){}}
  await updateMap();
}

async function updateMap(){
  if(!MAP)return;
  MARKERS.forEach(m=>MAP.removeLayer(m));MARKERS=[];
  const filtTec=$('mapFiltroTec')?.value||'';
  const filtGiorno=$('mapFiltroGiorno')?.value||'tutti_clienti';
  const showRoute=$('mapPercorso')?.checked||false;
  const waypoints=[];

  // Risolvi coordinate da anagrafica
  async function getAnagCoords(anag){
    if(anag.Lat&&anag.Lng)return[parseFloat(anag.Lat),parseFloat(anag.Lng)];
    const citta=anag.CittaFatturazione||anag.CittaSpedizioni||'';
    if(citta){const coords=await geocodeCity(citta);if(coords)return coords}
    return null;
  }
  // Risolvi coordinate clienti (da campo Lat/Lng, poi anagrafica, poi geocoding cittÃ )
  async function getClientCoords(cli){
    if(cli.Latitudine&&cli.Longitudine)return[parseFloat(cli.Latitudine),parseFloat(cli.Longitudine)];
    const anag=(ANAG_CLIENTI||[]).find(a=>a.CodiceM3===cli.ID||a.NomeInterno===cli.Nome);
    if(anag){const c=await getAnagCoords(anag);if(c)return c}
    const citta=cli.Citta||cli.Indirizzo||'';
    if(citta){const coords=await geocodeCity(citta);if(coords)return coords}
    return null;
  }

  // â”€â”€â”€â”€ MODALITÃ€ "TUTTI I CLIENTI" â”€â”€â”€â”€
  if(filtGiorno==='tutti_clienti'){
    const anagList=ANAG_CLIENTI||[];
    let placed=0,total=anagList.length;
    for(const anag of anagList){
      const coords=await getAnagCoords(anag);
      if(!coords)continue;
      const [lat,lng]=coords;
      const nome=anag.NomeAccount||anag.NomeInterno||anag.CodiceM3;
      const citta=anag.CittaFatturazione||'';
      // Conta macchine
      const counts=anag._assetCounts||{};
      const nMac=counts._total||0;
      const icon=L.divIcon({className:'',html:`<div style="background:#C30A14;color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.3)">${nMac||'Â·'}</div>`,iconSize:[22,22],iconAnchor:[11,11]});
      const m=L.marker([lat,lng],{icon}).addTo(MAP);
      m.bindPopup(`<strong>${nome}</strong><br>${citta}<br>Macchine: ${nMac}<br>ID: ${anag.CodiceM3}`);
      MARKERS.push(m);
      waypoints.push({lat,lng,name:nome});
      placed++;
    }
    const allPts=MARKERS.filter(m=>m.getLatLng).map(m=>[m.getLatLng().lat,m.getLatLng().lng]);
    if(allPts.length>1)MAP.fitBounds(allPts,{padding:[40,40]});
    else if(allPts.length===1)MAP.setView(allPts[0],12);
    $('mapInfo').innerHTML=`ğŸ  ${placed}/${total} clienti su mappa`;
    MAP._ffWaypoints=waypoints;
    return;
  }

  // â”€â”€â”€â”€ MODALITÃ€ INTERVENTI PER GIORNO â”€â”€â”€â”€
  let targetDate=today();
  if(filtGiorno==='domani'){const d=new Date();d.setDate(d.getDate()+1);targetDate=d.toISOString().split('T')[0]}

  let piano=(DATA.piano||[]).filter(p=>!p.Obsoleto);
  if(filtGiorno!=='settimana')piano=piano.filter(p=>p.Data===targetDate);
  else{const d=new Date();const end=new Date();end.setDate(end.getDate()+7);piano=piano.filter(p=>p.Data>=d.toISOString().split('T')[0]&&p.Data<=end.toISOString().split('T')[0])}
  if(filtTec)piano=piano.filter(p=>p.TecnicoID===filtTec||(p.TecniciIDs||'').includes(filtTec));

  const clientiIds=[...new Set(piano.map(p=>p.ClienteID))];
  const colors=['#00C9A7','#3B7EF7','#10B981','#F59E0B','#8B5CF6','#EC4899'];
  let colorIdx=0;

  const tecGroup={};
  piano.forEach(p=>{const tid=p.TecnicoID||'notech';if(!tecGroup[tid])tecGroup[tid]=[];tecGroup[tid].push(p)});
  const routeSummary=[];

  for(const [tid,items] of Object.entries(tecGroup)){
    const color=colors[colorIdx++%colors.length];
    items.sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||''));
    const pts=[];

    for(let i=0;i<items.length;i++){
      const p=items[i];
      const cli=(DATA.clienti||[]).find(c=>c.ID===p.ClienteID);
      if(!cli)continue;
      const coords=await getClientCoords(cli);
      if(!coords)continue;
      const [lat,lng]=coords;
      pts.push([lat,lng]);
      const icon=L.divIcon({className:'',html:`<div style="background:${color};color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.3)">${i+1}</div>`,iconSize:[24,24],iconAnchor:[12,12]});
      const m=L.marker([lat,lng],{icon}).addTo(MAP);
      const anag=(ANAG_CLIENTI||[]).find(a=>a.CodiceM3===cli.ID);
      const cittaLabel=anag?.CittaFatturazione||cli.Citta||'';
      m.bindPopup(`<strong>${i+1}. ${cli.Nome||cli.ID}</strong><br>${cittaLabel}<br>${p.OraInizio||''} Â· ${getName(DATA.tipiIntervento||[],p.TipoInterventoID)}<br>Tecnico: ${getName(DATA.utenti||[],tid)}`);
      MARKERS.push(m);
      waypoints.push({lat,lng,name:cli.Nome||cli.ID});
    }

    if(showRoute&&pts.length>1){
      // Routing su strade reali con OSRM
      const osrmRoute=await fetchOSRMRoute(pts.map(p=>({lat:p[0],lng:p[1]})));
      if(osrmRoute&&osrmRoute.geometry){
        // GeoJSON coordinates sono [lng, lat] â€” inverti per Leaflet
        const routeCoords=osrmRoute.geometry.coordinates.map(c=>[c[1],c[0]]);
        const km=Math.round((osrmRoute.distance||0)/1000);
        const min=Math.round((osrmRoute.duration||0)/60);
        const tecName=getName(DATA.utenti||[],tid)||tid;
        const linea=L.polyline(routeCoords,{color,weight:4,opacity:.88}).addTo(MAP);
        linea.bindPopup(`<b>${tecName}</b><br>ğŸ“ ${pts.length} tappe<br>ğŸ›£ï¸ ${km} km totali<br>â±ï¸ ~${min} min di guida`);
        MARKERS.push(linea);
        routeSummary.push(`${tecName.split(' ')[0]}: ${km}km ~${min}min`);
      }else{
        // Fallback linea dritta se OSRM non risponde
        const linea=L.polyline(pts,{color,weight:3,opacity:.7,dashArray:'8,8'}).addTo(MAP);
        MARKERS.push(linea);
        routeSummary.push(getName(DATA.utenti||[],tid).split(' ')[0]+': (routing non disponibile)');
      }
    }
  }

  const allPts=MARKERS.filter(m=>m.getLatLng).map(m=>[m.getLatLng().lat,m.getLatLng().lng]);
  if(allPts.length>1)MAP.fitBounds(allPts,{padding:[40,40]});
  else if(allPts.length===1)MAP.setView(allPts[0],12);
  else $('mapInfo').innerHTML='âš ï¸ Nessun intervento trovato. Prova "Tutti i clienti" o "Settimana".';

  // Legenda multi-tecnico
  const legendaEl=$('mapLegenda');
  if(legendaEl){
    let legendaIdx=0;
    legendaEl.innerHTML=Object.entries(tecGroup).map(([tid])=>{
      const c=colors[legendaIdx++%colors.length];
      const tName=getName(DATA.utenti||[],tid);
      const count=tecGroup[tid].length;
      return `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:${c}22;border:1px solid ${c};border-radius:12px"><span style="width:10px;height:10px;border-radius:50%;background:${c};display:inline-block"></span>${tName} (${count})</span>`;
    }).join('');
  }
  const routeText=routeSummary.length>0?' ğŸ›£ï¸ '+routeSummary.join(' | '):'';
  $('mapInfo').innerHTML=`${piano.length} interventi Â· ${clientiIds.length} clienti Â· ${allPts.length} su mappa Â· ${Object.keys(tecGroup).length} tecnici${routeText}`;
  MAP._ffWaypoints=waypoints;
}

function openGoogleMaps(){
  const wp=MAP?._ffWaypoints||[];
  if(wp.length===0){toast('Nessun punto sulla mappa','warn');return}
  const origin=wp[0];const dest=wp[wp.length-1];
  const middle=wp.slice(1,-1).map(w=>w.lat+','+w.lng).join('|');
  let url=`https://www.google.com/maps/dir/?api=1&origin=${origin.lat},${origin.lng}&destination=${dest.lat},${dest.lng}`;
  if(middle)url+=`&waypoints=${middle}`;
  url+='&travelmode=driving';
  window.open(url,'_blank');
}

// ============ KPI ============
async function loadKPI(){
  const periodo=$('kpiPeriodo')?.value||'mese';
  const filtTec=$('kpiTecnico')?.value||'';
  try{
    // Calcolo locale da DATA â€” no API call (kpi_log potrebbe essere vuoto)
    let piano=(DATA.piano||[]).filter(p=>!p.Obsoleto);
    if(filtTec) piano=piano.filter(p=>p.TecnicoID===filtTec);
    const now=new Date();
    let fromDate='';
    if(periodo==='settimana'){const d=new Date(now);d.setDate(d.getDate()-7);fromDate=d.toISOString().split('T')[0]}
    else if(periodo==='mese'){fromDate=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-01'}
    else if(periodo==='trimestre'){const d=new Date(now);d.setMonth(d.getMonth()-3);fromDate=d.toISOString().split('T')[0]}
    else if(periodo==='anno'){fromDate=now.getFullYear()+'-01-01'}
    if(fromDate) piano=piano.filter(p=>(p.Data||'')>=fromDate);
    const totale=piano.length;
    const completati=piano.filter(p=>p.Stato==='completato'||p.Stato==='chiuso').length;
    const inCorso=piano.filter(p=>p.Stato==='in_corso').length;
    const tasso=totale>0?Math.round(completati/totale*100):0;
    const giorni=fromDate?Math.max(1,Math.round((now-new Date(fromDate))/(1000*86400))):7;
    const perGiorno=totale>0?(totale/giorni).toFixed(1):'0';
    const tempoMedio=totale>0?(piano.reduce((s,p)=>s+parseFloat(p.DurataOre||0),0)/totale).toFixed(1):'0';
    const kmMedio=totale>0?Math.round(piano.reduce((s,p)=>s+parseInt(p.KmPercorsi||0),0)/totale):0;
    const urgenzeAperte=(DATA.urgenze||[]).filter(u=>!u.Obsoleto&&!['risolta','chiusa'].includes(u.Stato)).length;
    const ordiniInAttesa=(DATA.ordini||[]).filter(o=>!o.Obsoleto&&['richiesto','preso_in_carico'].includes(o.Stato)).length;
    const urgenzeChiuse=(DATA.urgenze||[]).filter(u=>!u.Obsoleto&&['risolta','chiusa'].includes(u.Stato));
    const slaOk=urgenzeChiuse.filter(u=>!u.DataScadenzaSLA||!u.DataRisoluzione||u.DataRisoluzione<=u.DataScadenzaSLA).length;
    const sla=urgenzeChiuse.length>0?Math.round(slaOk/urgenzeChiuse.length*100):100;
    const grid=$('kpiGrid');
    if(grid) grid.innerHTML=`
      <div class="kpi blue"><div class="kpi-val">${totale}</div><div class="kpi-lbl">Interventi Totali</div></div>
      <div class="kpi green"><div class="kpi-val">${completati}</div><div class="kpi-lbl">Completati</div></div>
      <div class="kpi ${tasso>=90?'green':tasso>=70?'yellow':'red'}"><div class="kpi-val">${tasso}%</div><div class="kpi-lbl">Tasso Completamento</div></div>
      <div class="kpi blue"><div class="kpi-val">${inCorso}</div><div class="kpi-lbl">In Corso</div></div>
      <div class="kpi purple"><div class="kpi-val">${perGiorno}</div><div class="kpi-lbl">Interventi/Giorno</div></div>
      <div class="kpi blue"><div class="kpi-val">${tempoMedio}h</div><div class="kpi-lbl">Durata Media</div></div>
      <div class="kpi blue"><div class="kpi-val">${kmMedio}km</div><div class="kpi-lbl">Km Medio</div></div>
      <div class="kpi ${sla>=95?'green':sla>=80?'yellow':'red'}"><div class="kpi-val">${sla}%</div><div class="kpi-lbl">SLA Compliance</div></div>
      <div class="kpi yellow"><div class="kpi-val">${urgenzeAperte}</div><div class="kpi-lbl">Urgenze Aperte</div></div>
      <div class="kpi purple"><div class="kpi-val">${ordiniInAttesa}</div><div class="kpi-lbl">Ordini In Attesa</div></div>
    `;
    // Classifica tecnici â€” calcolo locale
    const tecnici=(DATA.utenti||[]).filter(u=>!u.Obsoleto&&(u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
    const rows=tecnici.map(t=>{
      const tp=piano.filter(p=>p.TecnicoID===t.ID);
      const co=tp.filter(p=>p.Stato==='completato'||p.Stato==='chiuso').length;
      const ta=tp.length>0?Math.round(co/tp.length*100):100;
      const ore=tp.reduce((s,p)=>s+parseFloat(p.DurataOre||0),0).toFixed(1);
      const km=tp.reduce((s,p)=>s+parseInt(p.KmPercorsi||0),0);
      const tUrg=(DATA.urgenze||[]).filter(u=>!u.Obsoleto&&u.TecnicoAssegnato===t.ID&&['risolta','chiusa'].includes(u.Stato));
      const tSla=tUrg.length>0?Math.round(tUrg.filter(u=>!u.DataScadenzaSLA||!u.DataRisoluzione||u.DataRisoluzione<=u.DataScadenzaSLA).length/tUrg.length*100):100;
      return {nome:(t.Nome||'')+' '+(t.Cognome||''),tot:tp.length,comp:co,ta,km,ore,sla:tSla};
    }).filter(r=>r.tot>0).sort((a,b)=>b.comp-a.comp);
    const tbl=$('tblKpiTec');
    if(tbl) tbl.innerHTML=rows.map(t=>`<tr>
      <td><strong>${t.nome}</strong></td>
      <td>${t.tot}</td>
      <td>${t.comp}</td>
      <td><div class="stat-bar"><div style="width:${t.ta}%;background:${t.ta>=90?'var(--ok)':t.ta>=70?'var(--warn)':'var(--err)'}">${t.ta}%</div></div></td>
      <td>${t.km}</td>
      <td>${t.ore}</td>
      <td>â€”</td>
      <td>${t.sla}%</td>
    </tr>`).join('')||'<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--gray)">Nessun dato nel periodo</td></tr>';
  }catch(e){toast('Errore KPI: '+e.message,'err')}
}

// ============ PAGELLINI ============
function renderPagellini(){
  let items=(DATA.pagellini||[]).filter(p=>!p.Obsoleto);
  if(pagFilter==='bozze')items=items.filter(p=>p.Stato==='bozza');
  else if(pagFilter==='approvati')items=items.filter(p=>p.Stato==='approvato');
  items.sort((a,b)=>(b.DataRilevazione||'').localeCompare(a.DataRilevazione||''));
  $('tblPag').innerHTML=items.length?items.map(p=>`<tr>
    <td>${getName(DATA.utenti||[],p.TecnicoID)}</td>
    <td>${fmtDate(p.DataRilevazione)}</td>
    <td>${p.Periodo||'â€”'}</td>
    <td>${getName(DATA.utenti||[],p.ValutatoreID)}</td>
    <td><div class="score-circle" style="background:${(parseFloat(p.MediaVoto)||0)>=7?'var(--ok)':(parseFloat(p.MediaVoto)||0)>=5?'var(--warn)':'var(--err)'};width:40px;height:40px;font-size:.875rem;display:inline-flex">${p.MediaVoto||'â€”'}</div>/10</td>
    <td>${statusTag(p.Stato)}</td>
    <td>${p.Stato==='bozza'?`<button class="btn btn-ok btn-xs" onclick="approvePagellino('${p.ID}')">âœ… Approva</button>`:''} <button class="btn btn-ghost btn-xs" onclick="showDetail('pagellino','${p.ID}')">ğŸ‘ï¸</button></td>
  </tr>`).join(''):'<tr><td colspan="7" class="empty"><p>Nessun pagellino</p></td></tr>';
}
function pagTab(f,btn){pagFilter=f;document.querySelectorAll('#secPagellini .tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderPagellini()}
async function approvePagellino(id){try{await apiCall('approvaPagellino',{id},'POST');toast('Pagellino approvato','ok');await refreshData(true)}catch(e){toast(e.message,'err')}}
function addPagVoce(){
  const div=document.createElement('div');div.className='pag-voce';div.style='display:grid;grid-template-columns:2fr 1fr 80px 60px;gap:8px;align-items:end;margin-bottom:8px';
  div.innerHTML=`<div class="field mb-sm"><input type="text" class="pv-voce" placeholder="Es: Comunicazione cliente"></div><div class="field mb-sm"><select class="pv-cat"><option value="tecnica">Tecnica</option><option value="soft_skill">Soft Skill</option><option value="operativa">Operativa</option></select></div><div class="field mb-sm"><input type="number" class="pv-voto" min="1" max="10" value="6"></div><div class="field mb-sm"><input type="number" class="pv-peso" min="1" max="5" value="1"></div>`;
  $('pagVoci').appendChild(div);
}

// ============ SLA MONITOR ============
function renderSLA(){
  const urg=(DATA.urgenze||[]).filter(u=>!u.Obsoleto&&u.Stato!=='risolta');
  const ok=urg.filter(u=>u.SLAStatus==='ok').length;
  const warn=urg.filter(u=>u.SLAStatus==='warning').length;
  const crit=urg.filter(u=>u.SLAStatus==='critical').length;
  const breach=urg.filter(u=>u.SLAStatus==='breach').length;
  const total=urg.length||1;

  $('slaKpi').innerHTML=`
    <div class="kpi green"><div class="kpi-val">${ok}</div><div class="kpi-lbl">âœ… OK</div></div>
    <div class="kpi yellow"><div class="kpi-val">${warn}</div><div class="kpi-lbl">âš ï¸ Warning</div></div>
    <div class="kpi red"><div class="kpi-val">${crit}</div><div class="kpi-lbl">ğŸ”´ Critical</div></div>
    <div class="kpi red"><div class="kpi-val">${breach}</div><div class="kpi-lbl">ğŸ’¥ Breach</div></div>
    <div class="kpi ${((ok+warn)/total*100)>=95?'green':'yellow'}"><div class="kpi-val">${Math.round((ok/(total))*100)}%</div><div class="kpi-lbl">Compliance</div></div>
  `;

  $('tblSla').innerHTML=urg.length?urg.sort((a,b)=>{const o={'breach':0,'critical':1,'warning':2,'ok':3};return (o[a.SLAStatus]||4)-(o[b.SLAStatus]||4)}).map(u=>`<tr>
    <td>${u.ID}</td>
    <td>${getName(DATA.clienti||[],u.ClienteID)}</td>
    <td><span class="tag" style="background:${getColor(DATA.priorita||[],u.PrioritaID)}20;color:${getColor(DATA.priorita||[],u.PrioritaID)}">${getName(DATA.priorita||[],u.PrioritaID)}</span></td>
    <td>${fmtDateTime(u.SLAScadenza)}</td>
    <td>${slaTag(u.SLAStatus)}</td>
    <td style="min-width:100px"><div class="stat-bar"><div style="width:${Math.min(100,100)}%;background:${u.SLAStatus==='ok'?'var(--ok)':u.SLAStatus==='warning'?'var(--warn)':'var(--err)'}"></div></div></td>
    <td><button class="btn btn-ghost btn-xs" onclick="showDetail('urgenza','${u.ID}')">ğŸ‘ï¸</button></td>
  </tr>`).join(''):'<tr><td colspan="7" class="empty"><p>Nessuna urgenza con SLA attivo</p></td></tr>';
}

// ============ AUDIT LOG ============
function renderAuditLog(){
  const entity=$('filtLogEntity')?.value||'';
  const data=$('filtLogData')?.value||'';
  let items=(DATA.workflowLog||[]).slice(-200);
  if(entity)items=items.filter(l=>l.EntityType===entity);
  if(data)items=items.filter(l=>(l.Timestamp||'').substring(0,10)===data);
  items.sort((a,b)=>(b.Timestamp||'').localeCompare(a.Timestamp||''));
  $('tblLog').innerHTML=items.length?items.slice(0,100).map(l=>`<tr>
    <td style="font-family:var(--mono);font-size:.6875rem">${fmtDateTime(l.Timestamp)}</td>
    <td><span class="tag tag-info">${l.EntityType||'â€”'}</span></td>
    <td style="font-family:var(--mono);font-size:.6875rem">${(l.EntityID||'').substring(0,12)}</td>
    <td>${l.Action||'â€”'}</td>
    <td>${getName(DATA.utenti||[],l.UserID)}</td>
    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:.6875rem">${l.Note||(l.NewValue||'').substring(0,80)||'â€”'}</td>
  </tr>`).join(''):'<tr><td colspan="6" class="empty"><p>Nessun log trovato</p></td></tr>';
}

// ============ POWER BI ============
function renderPowerBI(){
  const base=API_URL+'?action=exportPowerBI&token='+API_TOKEN;
  $('pbiUrl').value=base;
  const facts=['fact_interventi','fact_urgenze','fact_ordini','fact_reperibilita','fact_trasferte','fact_pagellini'];
  const dims=['dim_tecnici','dim_clienti','dim_macchine','dim_automezzi','dim_tipi_intervento','dim_priorita','dim_tempo','metrics'];
  $('pbiFacts').innerHTML=facts.map(t=>`<div style="margin-bottom:6px"><code style="background:var(--gray4);padding:2px 8px;border-radius:4px;font-size:.75rem">${t}</code><br><input type="text" value="${base}&table=${t}" readonly onclick="this.select()" style="width:100%;font-size:.6875rem;padding:4px;border:1px solid var(--gray3);border-radius:4px;margin-top:2px;font-family:var(--mono)"></div>`).join('');
  $('pbiDims').innerHTML=dims.map(t=>`<div style="margin-bottom:6px"><code style="background:var(--gray4);padding:2px 8px;border-radius:4px;font-size:.75rem">${t}</code><br><input type="text" value="${base}&table=${t}" readonly onclick="this.select()" style="width:100%;font-size:.6875rem;padding:4px;border:1px solid var(--gray3);border-radius:4px;margin-top:2px;font-family:var(--mono)"></div>`).join('');
}

// ============ CONFIG ============
function renderConfig(){
  const cfg=DATA.config||{};
  const keys=Object.keys(cfg);
  $('configBody').innerHTML=keys.length?keys.map(k=>`<div class="field-row mb-sm">
    <div class="field"><label>${k}</label><input type="text" class="cfg-input" data-key="${k}" value="${cfg[k]||''}"></div>
  </div>`).join(''):'<p class="empty">Nessuna configurazione trovata</p>';
}
function saveConfig(){
  const configObj={};
  document.querySelectorAll('.cfg-input').forEach(input=>{
    const key=input.getAttribute('data-key');
    const val=input.value;
    if(key&&val) configObj[key]=val;
  });
  if(Object.keys(configObj).length===0){toast('Nessuna configurazione da salvare','warn');return}
  apiCall('saveConfig',{config:configObj},'POST')
    .then(r=>{toast('Configurazione salvata!','ok');applyConfig()})
    .catch(e=>{toast(e.message,'err')})
}

// ============ CHAT INTERNA ============
var CHAT_CANALE=null;
var CHAT_POLL=null;

async function loadChatCanali(){
  try{
    const r=await apiCall('getChatCanali',{userId:USER?.ID},'POST');
    const canali=r.canali||[];
    const el=$('chatCanaliList');
    // Aggiorna badge totale
    const totNonLetti=canali.reduce((s,c)=>s+c.nonLetti,0);
    const badge=$('chatBadge');
    if(badge){badge.textContent=totNonLetti;badge.style.display=totNonLetti>0?'':'none'}

    el.innerHTML=canali.length?canali.map(c=>{
      const active=CHAT_CANALE===c.ID?'background:var(--gray4);':'';
      const unread=c.nonLetti>0?`<span class="badge" style="font-size:.6rem">${c.nonLetti}</span>`:'';
      return `<button onclick="openChat('${c.ID}','${(c.Nome||'').replace(/'/g,"\\'")}')" style="display:flex;align-items:center;gap:8px;padding:10px 16px;width:100%;border:none;background:none;cursor:pointer;font-family:var(--font);font-size:.8125rem;text-align:left;border-bottom:1px solid #f3f4f6;${active}">
        <span style="font-size:1.1rem">${c.Icona||'ğŸ’¬'}</span>
        <span style="flex:1;font-weight:${c.nonLetti>0?'700':'400'}">${c.Nome||'â€”'}</span>
        ${unread}
      </button>`;
    }).join(''):'<p style="padding:16px;color:var(--gray);font-size:.8125rem">Nessun canale. Crea il primo!</p>';
  }catch(e){toast('Errore chat: '+e.message,'err')}
}

async function openChat(canaleId,nome){
  CHAT_CANALE=canaleId;
  $('chatTitle').textContent=(nome||canaleId);
  $('chatInput').style.display='block';
  loadChatCanali();// refresh sidebar highlight
  await loadChatMessages();
  // Polling ogni 5s â€” skip se tab nascosta o fuori dalla sezione chat
  if(CHAT_POLL)clearInterval(CHAT_POLL);
  CHAT_POLL=setInterval(()=>{if(!document.hidden&&$('secChat')?.classList.contains('active'))loadChatMessages()},5000);
}

async function loadChatMessages(){
  if(!CHAT_CANALE)return;
  try{
    // Usa fetch diretto (senza apiCall) per non mostrare l'overlay globale ogni 5s
    const resp=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json','X-Token':API_TOKEN},body:JSON.stringify({action:'getChatMessaggi',canale_id:CHAT_CANALE,userId:USER?.ID,limit:100}),signal:AbortSignal.timeout(10000)});
    const json=await resp.json();
    if(!json.success)throw new Error(json.error||'Errore chat');
    const r=json.data||json;
    const msgs=r.messaggi||[];
    const el=$('chatMessages');
    const wasAtBottom=el.scrollHeight-el.scrollTop-el.clientHeight<50;
    el.innerHTML=msgs.length?msgs.map(m=>{
      const isMine=m.MittenteID===USER?.ID;
      const nome=getName(DATA.utenti||[],m.MittenteID);
      const ora=m.CreatedAt?new Date(m.CreatedAt).toLocaleString('it-IT',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'}):'';
      return `<div style="display:flex;flex-direction:column;align-items:${isMine?'flex-end':'flex-start'};max-width:75%${isMine?';margin-left:auto':''}">
        <div style="font-size:.6875rem;color:var(--gray);margin-bottom:2px">${isMine?'':nome+' Â· '}${ora}</div>
        <div style="background:${isMine?'var(--c1)':'var(--white)'};color:${isMine?'white':'var(--dark)'};padding:8px 14px;border-radius:${isMine?'16px 16px 4px 16px':'16px 16px 16px 4px'};font-size:.8125rem;box-shadow:0 1px 2px rgba(0,0,0,.06);word-break:break-word">${formatChatMsg(m.Testo||'',isMine)}</div>
      </div>`;
    }).join(''):'<div style="margin:auto;color:var(--gray);font-size:.8125rem">Nessun messaggio. Scrivi il primo! ğŸ‘‹</div>';
    if(wasAtBottom)el.scrollTop=el.scrollHeight;
  }catch(e){console.error('Chat load error:',e)}
}

function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function formatChatMsg(txt,isMine){
  let h=escHtml(txt);
  h=h.replace(/(https?:\/\/[^\s]+)/g,function(url){
    if(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(url))return '<a href="'+url+'" target="_blank"><img src="'+url+'" style="max-width:250px;max-height:180px;border-radius:8px;margin:4px 0;display:block" onerror="this.outerHTML=\'ğŸ“ <a href=\\\'\'+this.src+\'\\\' target=_blank>File</a>\'"></a>';
    return '<a href="'+url+'" target="_blank" style="color:'+(isMine?'#dbeafe':'var(--c1)')+';text-decoration:underline">ğŸ”— Link</a>';
  });
  return h.replace(/\n/g,'<br>');
}

let adminChatAllegato=null;

function adminChatAllegatoChange(input){
  const file=input.files[0];if(!file)return;
  if(file.size>20*1024*1024){toast('File troppo grande (max 20MB)','err');input.value='';return}
  const reader=new FileReader();
  reader.onload=function(){
    adminChatAllegato={base64:reader.result.split(',')[1],type:file.type,name:file.name};
    $('adminChatAllegatoPreview').style.display='block';
    $('adminChatAllegatoPreview').innerHTML='<div style="display:flex;align-items:center;gap:8px;font-size:.8rem"><span>'+(file.type.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„')+'</span><span style="flex:1">'+file.name+'</span><button onclick="adminChatAllegato=null;$(\'adminChatAllegatoPreview\').style.display=\'none\'" style="background:none;border:none;color:var(--err);cursor:pointer">âœ•</button></div>';
    input.value='';
  };
  reader.readAsDataURL(file);
}

async function sendChat(e){
  e.preventDefault();
  const txt=$('chatText').value.trim();
  if(!txt&&!adminChatAllegato){return}
  if(!CHAT_CANALE)return;
  $('chatText').value='';
  try{
    let allegatoUrl=null,allegatoName='';
    if(adminChatAllegato){
      allegatoName=adminChatAllegato.name;
      try{
        const up=await apiCall('uploadFile',{base64Data:adminChatAllegato.base64,mimeType:adminChatAllegato.type,fileName:adminChatAllegato.name,uploaderId:USER?.ID,riferimentoTipo:'chat',riferimentoId:CHAT_CANALE},'POST');
        allegatoUrl=up.url;
      }catch(e){toast('Errore upload: '+e.message,'err')}
      adminChatAllegato=null;$('adminChatAllegatoPreview').style.display='none';
    }
    let finalTxt=txt||'';
    if(allegatoUrl)finalTxt=(finalTxt?finalTxt+'\n':'')+'ğŸ“ Allegato: '+allegatoName+'\n'+allegatoUrl;
    if(!finalTxt)return;
    await apiCall('sendChatMessage',{canale_id:CHAT_CANALE,testo:finalTxt,userId:USER?.ID},'POST');
    await loadChatMessages();
    $('chatMessages').scrollTop=$('chatMessages').scrollHeight;
  }catch(err){toast('Errore invio: '+err.message,'err')}
}

function openNewCanale(){
  const nome=prompt('Nome del nuovo canale:');
  if(!nome)return;
  const icona=prompt('Icona (emoji):','ğŸ’¬')||'ğŸ’¬';
  apiCall('createChatCanale',{nome,icona,tipo:'gruppo',membri_ids:[USER?.ID]},'POST')
    .then(()=>{toast('Canale creato!','ok');loadChatCanali()})
    .catch(e=>toast(e.message,'err'));
}

// ============ ANAGRAFICA ============
var ANAG_CLIENTI=[];
var ANAG_FILTERED=[];
var ANAG_ASSETS_CACHE={};
var anagView='list';
// Product type config: real images, color, label, lelyUrl
const PROD_IMG_BASE='assets/products/';
const PROD_CFG={
  ROBOT:{img:'astronaut.png',emoji:'ğŸ¤–',color:'#C30A14',label:'Astronaut',url:'https://www.lely.com/solutions/milking/astronaut/'},
  JUNO:{img:'juno.png',emoji:'ğŸ”„',color:'#3b82f6',label:'Juno',url:'https://www.lely.com/solutions/feeding/juno/'},
  VECTOR:{img:'vector.png',emoji:'ğŸšœ',color:'#8b5cf6',label:'Vector',url:'https://www.lely.com/solutions/feeding/vector/'},
  DISCOVERY:{img:'discovery.png',emoji:'ğŸ§¹',color:'#06b6d4',label:'Discovery',url:'https://www.lely.com/solutions/manure/discovery/'},
  COLLECTOR:{img:'collector.png',emoji:'â™»ï¸',color:'#14b8a6',label:'Collector',url:'https://www.lely.com/solutions/manure/discovery-collector/'},
  CU:{emoji:'ğŸ–¥ï¸',color:'#6366f1',label:'Central Unit',url:''},
  CALM:{img:'calm.png',emoji:'ğŸ¼',color:'#f59e0b',label:'Calm',url:'https://www.lely.com/solutions/calf-rearing/calm/'},
  COMPRESSORI:{emoji:'ğŸ’¨',color:'#78716c',label:'Compressori',url:''},
  COSMIX:{img:'cosmix.png',emoji:'ğŸ¥£',color:'#22c55e',label:'Cosmix',url:'https://www.lely.com/solutions/feeding/cosmix/'},
  NAUTILUS:{emoji:'ğŸ”§',color:'#0ea5e9',label:'Nautilus',url:''},
  LUNA:{emoji:'ğŸ„',color:'#a855f7',label:'Luna',url:'https://www.lely.com/solutions/housing-and-caring/luna/'},
  METEOR:{emoji:'ğŸ›ï¸',color:'#ef4444',label:'Meteor',url:''},
  GRAZEWAY:{emoji:'ğŸšª',color:'#16a34a',label:'Grazeway',url:'https://www.lely.com/solutions/grazing/grazeway/'},
  'L4C LED':{emoji:'ğŸ’¡',color:'#eab308',label:'L4C LED',url:''},
  ARLA:{emoji:'ğŸ­',color:'#94a3b8',label:'Arla',url:''},
  TITANIA:{emoji:'âš™ï¸',color:'#64748b',label:'Titania',url:''},
  ALTRI:{emoji:'ğŸ“¦',color:'#9ca3af',label:'Altri',url:''}
};
function prodIcon(type,size){
  size=size||24;
  const cfg=PROD_CFG[type]||PROD_CFG[type.toUpperCase()]||{};
  const src=cfg.img?PROD_IMG_BASE+cfg.img:'';
  const emoji=cfg.emoji||'ğŸ“¦';
  // Emoji fallback if no image or image fails
  const emojiHtml=`<span style="display:inline-flex;align-items:center;justify-content:center;width:${size}px;height:${size}px;font-size:${Math.round(size*0.7)}px;vertical-align:middle" title="${cfg.label||type}">${emoji}</span>`;
  if(!src) return emojiHtml;
  const lnk=cfg.url?`onclick="window.open('${cfg.url}','_blank')" style="cursor:pointer"`:''
  return `<img src="${src}" alt="${cfg.label||type}" title="${cfg.label||type}" ${lnk} style="width:${size}px;height:${size}px;object-fit:contain;vertical-align:middle" onerror="this.outerHTML='${emojiHtml.replace(/'/g,"\\'")}'">`;
}
// Helper: normalize asset type to PROD_CFG key
// SOLO i tipi con foglio dedicato nell'Excel + ARLA e TITANIA sono tipi reali
// Tutto il resto â†’ ALTRI
const VALID_ASSET_TYPES=['ROBOT','JUNO','VECTOR','DISCOVERY','COLLECTOR','CU','CALM','COMPRESSORI','COSMIX','NAUTILUS','LUNA','METEOR','GRAZEWAY','L4C LED','ARLA','TITANIA'];
function normAssetType(tipo){
  tipo=(tipo||'').toUpperCase();
  if(tipo.includes('ASTRONAUT')||tipo==='ROBOT')return 'ROBOT';
  if(tipo.includes('JUNO'))return 'JUNO';
  if(tipo.includes('VECTOR'))return 'VECTOR';
  if(tipo.includes('DISCOVERY')&&!tipo.includes('COLLECTOR'))return 'DISCOVERY';
  if(tipo.includes('COLLECTOR'))return 'COLLECTOR';
  if(tipo.includes('CENTRAL')||tipo==='CU')return 'CU';
  if(tipo.includes('CALM')||tipo.includes('ALLAT'))return 'CALM';
  if(tipo.includes('COMPRESS'))return 'COMPRESSORI';
  if(tipo.includes('COSMIX'))return 'COSMIX';
  if(tipo.includes('NAUTILUS'))return 'NAUTILUS';
  if(tipo.includes('LUNA'))return 'LUNA';
  if(tipo.includes('METEOR'))return 'METEOR';
  if(tipo.includes('GRAZEWAY'))return 'GRAZEWAY';
  if(tipo.includes('L4C'))return 'L4C LED';
  if(tipo.includes('ARLA'))return 'ARLA';
  if(tipo.includes('TITANIA'))return 'TITANIA';
  // Tutto il resto Ã¨ "ALTRI"
  return 'ALTRI';
}
// Get ALL anagrafica assets as flat array - tutti gli asset, nessun filtro
function getAllAnagAssets(){
  let all=[];
  Object.values(ANAG_ASSETS_CACHE).forEach(arr=>all=all.concat(arr));
  return all;
}

async function loadAnagClients(){
  try{
    const data=await apiCall('getAnagraficaClienti',{},'POST');
    ANAG_CLIENTI=data||[];
    ANAG_ASSETS_CACHE={};
    // Load ALL assets to compute per-client counts by type
    try{
      const allAssets=await apiCall('getAnagraficaAssets',{all:true},'POST');
      // Group by codice_m3
      const byM3={};
      (allAssets||[]).forEach(a=>{
        const m3=a.CodiceM3;if(!m3)return;
        if(!byM3[m3])byM3[m3]=[];
        byM3[m3].push(a);
      });
      // Compute _assetCounts per client
      ANAG_CLIENTI.forEach(c=>{
        const m3=c.CodiceM3;
        const myAssets=byM3[m3]||[];
        ANAG_ASSETS_CACHE[m3]=myAssets;
        // Conta tutti gli asset del cliente senza filtri
        const counts={_total:myAssets.length};
        myAssets.forEach(a=>{
          const key=normAssetType(a.GruppoAttrezzatura||a.TipoFoglio||'Altro');
          counts[key]=(counts[key]||0)+1;
        });
        c._assetCounts=counts;
      });
    }catch(ae){console.warn('Could not load assets for counts:',ae)}
    filterAnagClients();
  }catch(e){toast('Errore caricamento anagrafica: '+e.message,'err')}
}

function filterAnagClients(){
  const q=($('anagSearch')?.value||'').toLowerCase();
  const typeFilter=$('anagFilterType')?.value||'';
  let list=ANAG_CLIENTI;
  if(q) list=list.filter(c=>
    (c.NomeAccount||'').toLowerCase().includes(q)||
    (c.NomeInterno||'').toLowerCase().includes(q)||
    (c.CodiceM3||'').includes(q)||
    (c.CittaFatturazione||'').toLowerCase().includes(q)||
    (c.ProvinciaFatturazione||'').toLowerCase().includes(q)||
    (c.TitolareAccount||'').toLowerCase().includes(q)
  );
  if(typeFilter){
    // Filter clients that have assets of this type (check _assetCounts)
    list=list.filter(c=>c._assetCounts&&c._assetCounts[typeFilter]>0);
  }
  ANAG_FILTERED=list;
  renderAnagClients(ANAG_FILTERED);
}

function renderAnagClients(list){
  // Stats â€” use _assetCounts from loaded data
  const s=$('anagStats');
  if(s){
    const sumType=(type)=>list.reduce((t,c)=>t+((c._assetCounts&&c._assetCounts[type])||0),0);
    const a=list.filter(c=>c.StatoCliente==='Attivo').length;
    const geo=list.filter(c=>c.Lat&&c.Lng).length;
    const totAssets=list.reduce((t,c)=>t+((c._assetCounts&&c._assetCounts._total)||0),0);
    const typeFilter=$('anagFilterType')?.value||'';
    const mainTypes=['ROBOT','JUNO','VECTOR','DISCOVERY','COLLECTOR','CU','COSMIX','NAUTILUS','LUNA','CALM','COMPRESSORI','METEOR','GRAZEWAY','L4C LED'];
    let statCards=[[list.length,'Clienti'],[a,'Attivi'],[geo,'ğŸ“ Geo'],[totAssets,'Assets']];
    mainTypes.forEach(t=>{
      const cfg=PROD_CFG[t]||{};
      const v=sumType(t);
      if(v>0) statCards.push([v, prodIcon(t,20)+' '+cfg.label||t]);
    });
    s.innerHTML=statCards.map(([v,l])=>`<div class="stat-card" style="min-width:75px;padding:6px 10px;text-align:center"><div class="stat-val" style="font-size:1.1rem">${v}</div><div class="stat-lbl" style="font-size:.65rem">${l}</div></div>`).join('');
  }

  if(anagView==='map'){renderAnagMap();return}

  const tb=$('anagClientiBody');if(!tb)return;
  $('anagMapWrap').style.display='none';
  $('anagTreeWrap').style.display='block';
  const cols=16;
  if(!list.length){tb.innerHTML=`<tr><td colspan="${cols}" style="text-align:center;color:var(--muted)">Nessun cliente trovato.</td></tr>`;return}
  const hi=(v,type)=>{
    if(!v||v<=0) return `<span style="color:#ddd">-</span>`;
    const cfg=PROD_CFG[type]||{};
    return `<strong style="color:${cfg.color||'inherit'}">${v}</strong>`;
  };
  tb.innerHTML=list.map((c,i)=>{
    const ac=c._assetCounts||{};
    const disc=(ac.DISCOVERY||0)+(ac.COLLECTOR||0);
    const altri=(ac.LUNA||0)+(ac.METEOR||0)+(ac.CALM||0)+(ac.COMPRESSORI||0)+(ac['L4C LED']||0)+(ac.GRAZEWAY||0)+(ac.ARLA||0)+(ac.TITANIA||0);
    const tot=ac._total||0;
    const m3=c.CodiceM3||'';
    const geo=c.Lat?'ğŸ“':'';
    return `<tr class="anag-row" id="anagRow_${m3}" onclick="toggleAnagTree('${m3}')" style="cursor:pointer">
      <td><span class="anag-arrow" id="anagArrow_${m3}">â–¶</span></td>
      <td><strong>${c.NomeAccount||'-'}</strong><br><small style="color:var(--muted)">${c.NomeInterno||''} ${geo}</small></td>
      <td>${c.CittaFatturazione||''}</td>
      <td>${c.ProvinciaFatturazione||''}</td>
      <td><span class="badge ${c.StatoCliente==='Attivo'?'badge-ok':'badge-warn'}" style="font-size:.7rem">${c.StatoCliente||'-'}</span></td>
      <td style="font-size:.8rem">${c.TitolareAccount||''}</td>
      <td>${hi(ac.ROBOT,'ROBOT')}</td><td>${hi(ac.JUNO,'JUNO')}</td><td>${hi(ac.VECTOR,'VECTOR')}</td>
      <td>${hi(disc,'DISCOVERY')}</td><td>${hi(ac.CU,'CU')}</td><td>${hi(ac.COSMIX,'COSMIX')}</td>
      <td>${hi(ac.NAUTILUS,'NAUTILUS')}</td><td>${hi(altri,'CALM')}</td>
      <td><strong>${tot||'-'}</strong></td>
      <td>
        <button class="btn btn-xs" onclick="event.stopPropagation();openAnagEdit('${m3}')" title="Modifica">âœï¸</button>
        ${c.Lat?`<button class="btn btn-xs" onclick="event.stopPropagation();openAnagGeo('${m3}')" title="Mappa">ğŸ“</button>`:''}
      </td>
    </tr>
    <tr id="anagExpand_${m3}" style="display:none"><td colspan="${cols}" style="padding:0;background:#f8f9fa">
      <div id="anagDetail_${m3}" style="padding:12px 16px"></div>
    </td></tr>`;
  }).join('');
}

async function toggleAnagTree(m3){
  const expandRow=document.getElementById('anagExpand_'+m3);
  const arrow=document.getElementById('anagArrow_'+m3);
  if(!expandRow)return;
  if(expandRow.style.display!=='none'){
    expandRow.style.display='none';arrow.textContent='â–¶';return;
  }
  expandRow.style.display='';arrow.textContent='â–¼';
  const detailDiv=document.getElementById('anagDetail_'+m3);
  if(detailDiv.innerHTML)return;

  detailDiv.innerHTML='<div class="loading"><div class="spin"></div></div>';
  try{
    const c=ANAG_CLIENTI.find(x=>x.CodiceM3===m3);
    const assets=ANAG_ASSETS_CACHE[m3]||(ANAG_ASSETS_CACHE[m3]=await apiCall('getAnagraficaAssets',{codice_m3:m3},'POST'));

    // Client detail card
    let html=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;font-size:.8125rem">
      <div><b>Indirizzo</b><br>${c.ViaFatturazione||'-'}<br>${c.CapFatturazione||''} ${c.CittaFatturazione||''} (${c.ProvinciaFatturazione||''})</div>
      <div><b>Contatti</b><br>ğŸ“ ${c.Telefono||'-'}<br>ğŸ“§ ${c.Email||'-'}</div>
      <div><b>Codici</b><br>M3: ${c.CodiceM3||'-'} | P.IVA: ${c.PartitaIva||'-'}<br>DANEA: ${c.CodiceDanea||'-'} | Account: ${c.AccountNumber||'-'}${c.Lat?`<br>ğŸ“ ${c.Lat}, ${c.Lng}`:''}</div>
    </div>`;

    // Product badges from _assetCounts
    const ac=c._assetCounts||{};
    const prodBadges=Object.entries(ac).filter(([k,v])=>k!=='_total'&&v>0).map(([type,cnt])=>{
      const cfg=PROD_CFG[type]||{icon:'ğŸ“¦',color:'#666',label:type};
      return `<span class="badge" style="font-size:.75rem;margin:2px;background:${cfg.color}15;border:1px solid ${cfg.color}40;color:${cfg.color}">${prodIcon(type,18)} ${cfg.label}: <b>${cnt}</b></span>`;
    });
    if(prodBadges.length) html+=`<div style="margin-bottom:10px">${prodBadges.join('')}</div>`;

    // Assets table grouped by type
    if(assets.length){
      const groups={};assets.forEach(a=>{const g=a.GruppoAttrezzatura||a.TipoFoglio||'Altro';groups[g]=(groups[g]||0)+1});
      html+=`<div style="margin-bottom:6px;font-size:.75rem;color:var(--muted)">
        <b>${assets.length} assets</b>: ${Object.entries(groups).map(([g,n])=>`${prodIcon(g,16)} ${g} (${n})`).join(', ')}
      </div>`;
      html+=`<table class="tbl" style="font-size:.8rem"><thead><tr>
        <th>#</th><th>Tipo</th><th>Modello</th><th>N. Serie</th><th>Data Install.</th><th>Prov.</th><th>Note</th><th>Stato</th><th style="width:160px">Azioni</th>
      </tr></thead><tbody>`;
      assets.forEach((a,i)=>{
        const tipo=a.GruppoAttrezzatura||a.TipoFoglio||'-';
        const nTipo=normAssetType(tipo);
        const cfg=PROD_CFG[nTipo]||{color:'#666'};
        const dt=formatAnagDate(a.DataInstallazione);
        const assetEsc=(a.NomeAsset||tipo).replace(/'/g,"\\'")+" â€” SN:"+(a.NumeroSerie||'-').replace(/'/g,"\\'");
        const cliEsc=(c.NomeAccount||'').replace(/'/g,"\\'");
        html+=`<tr>
          <td>${i+1}</td>
          <td>${prodIcon(nTipo,20)} <strong style="color:${cfg.color}">${cfg.label||tipo}</strong></td>
          <td><strong>${a.Modello||'-'}</strong></td>
          <td><code style="font-size:.72rem">${a.NumeroSerie||'-'}</code></td>
          <td>${dt}</td>
          <td>${a.Provincia||''}</td>
          <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(a.Note||'').replace(/"/g,'&quot;')}">${a.Note||''}</td>
          <td><span class="badge ${(a.Status||'').toLowerCase().includes('attiv')?'badge-ok':'badge-warn'}" style="font-size:.65rem">${a.Status||''}</span></td>
          <td style="white-space:nowrap">
            <button class="btn btn-ghost btn-xs" onclick="openAssetAction('urgenza','${m3}','${assetEsc}','${cliEsc}')" title="Urgenza" style="color:#ef4444">ğŸš¨</button>
            <button class="btn btn-ghost btn-xs" onclick="openAssetAction('piano','${m3}','${assetEsc}','${cliEsc}')" title="Intervento" style="color:#3b82f6">ğŸ“‹</button>
            <button class="btn btn-ghost btn-xs" onclick="openAssetAction('ordine','${m3}','${assetEsc}','${cliEsc}')" title="Ordine" style="color:#8b5cf6">ğŸ“¦</button>
            <button class="btn btn-ghost btn-xs" onclick="openAssetAction('notifica','${m3}','${assetEsc}','${cliEsc}')" title="Notifica" style="color:#f59e0b">ğŸ””</button>
            <button class="btn btn-ghost btn-xs" onclick="showAssetOnMap('${m3}','${(a.NomeAsset||'').replace(/'/g,"\\'")}')" title="Mappa">ğŸ“</button>
          </td>
        </tr>`;
      });
      html+=`</tbody></table>`;
    }else{
      html+=`<p style="color:var(--muted);font-size:.8125rem">Nessun asset collegato (codice M3: ${m3})</p>`;
    }
    detailDiv.innerHTML=html;
  }catch(e){detailDiv.innerHTML=`<p style="color:var(--err)">Errore: ${e.message}</p>`}
}

function formatAnagDate(d){
  if(!d)return '-';
  const s=String(d);
  // Already DD/MM/YYYY
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(s))return s;
  // ISO or datetime
  const m=s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m)return `${m[3]}/${m[2]}/${m[1]}`;
  // Excel serial number
  const n=Number(s);
  if(!isNaN(n)&&n>30000&&n<60000){
    const dt=new Date((n-25569)*86400000);
    return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
  }
  return s;
}

// MAP VIEW
var anagMapInstance=null;
function renderAnagMap(){
  $('anagTreeWrap').style.display='none';
  $('anagMapWrap').style.display='block';
  const geoClients=ANAG_FILTERED.filter(c=>c.Lat&&c.Lng);
  if(!geoClients.length){$('anagMapWrap').innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)">Nessun cliente georeferenziato</div>';return}

  if(!window.L){
    const css=document.createElement('link');css.rel='stylesheet';css.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';document.head.appendChild(css);
    const js=document.createElement('script');js.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';document.head.appendChild(js);
    js.onload=()=>buildAnagMap(geoClients);
  }else{buildAnagMap(geoClients)}
}

function buildAnagMap(clients){
  if(anagMapInstance){anagMapInstance.remove();anagMapInstance=null}
  const wrap=$('anagMapWrap');wrap.innerHTML='';
  anagMapInstance=L.map(wrap).setView([44.5,10.8],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(anagMapInstance);
  const bounds=[];
  const typeFilter=$('anagFilterType')?.value||'';
  clients.forEach(c=>{
    const ll=[c.Lat,c.Lng];bounds.push(ll);
    const ac=c._assetCounts||{};
    const tot=ac._total||0;
    // Color based on dominant product or filter
    let color='#22c55e';
    if(typeFilter&&PROD_CFG[typeFilter]){
      color=PROD_CFG[typeFilter].color;
    }else if(c.StatoCliente!=='Attivo'){
      color='#f59e0b';
    }
    const radius=Math.max(6,Math.min(tot*1.5,18));
    const marker=L.circleMarker(ll,{radius,color,fillColor:color,fillOpacity:.7,weight:1}).addTo(anagMapInstance);
    // Build popup with product breakdown
    let prodHtml='';
    Object.entries(ac).filter(([k,v])=>k!=='_total'&&v>0).forEach(([type,cnt])=>{
      const cfg=PROD_CFG[type]||{icon:'ğŸ“¦'};
      prodHtml+=`<span style="margin-right:4px">${prodIcon(type,16)}${cnt}</span> `;
    });
    marker.bindPopup(`<b>${c.NomeAccount}</b><br>${c.NomeInterno||''}<br>${c.CittaFatturazione||''} (${c.ProvinciaFatturazione||''})<br><span style="font-size:.85em">${prodHtml||'Nessun asset'}</span><br><a href="#" onclick="anagView='list';renderAnagClients(ANAG_FILTERED);setTimeout(()=>toggleAnagTree('${c.CodiceM3}'),200);return false">Apri dettaglio â†’</a>`);
  });
  if(bounds.length)anagMapInstance.fitBounds(bounds,{padding:[30,30]});
  setTimeout(()=>anagMapInstance.invalidateSize(),200);
}

function openAnagGeo(m3){
  const c=ANAG_CLIENTI.find(x=>x.CodiceM3===m3);
  if(!c||!c.Lat)return;
  window.open(`https://www.google.com/maps?q=${c.Lat},${c.Lng}`,'_blank');
}

function openAnagEdit(m3){
  toast('Funzione modifica in arrivo','info');
}

// Import XLSX via browser (SheetJS) â€” FULL parser for ALL asset sheets
async function importAnagXlsx(file){
  if(!file)return;
  toast('Caricamento XLSX in corso...','info');

  if(!window.XLSX){
    const s=document.createElement('script');
    s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(s);
    await new Promise(r=>{s.onload=r;setTimeout(r,5000)});
  }
  if(!window.XLSX){toast('Errore caricamento libreria XLSX','err');return}

  const reader=new FileReader();
  reader.onload=async function(e){
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});

      // 1. Parse Clienti sheet (NO qty from here â€” will calculate from assets)
      let cliSheet=wb.Sheets['Clienti'];
      if(!cliSheet){toast('Foglio "Clienti" non trovato!','err');return}
      const cliRows=XLSX.utils.sheet_to_json(cliSheet,{range:1,defval:null});

      const clienti=[];
      for(const r of cliRows){
        const nome=r['Nome account'];
        const m3=r['Numero cliente M3 OPT'];
        if(!nome&&!m3)continue;
        const m3s=m3?String(Math.floor(Number(m3))):'';
        clienti.push({
          IdAccount:r['id Account']||null,AccountNumber:r['Account Number ']||null,
          CodiceDanea:r['Codice DANEA']?String(r['Codice DANEA']):null,
          CodiceM3:m3s||null,PartitaIva:r['Partita IVA OPT']?String(Math.floor(Number(r['Partita IVA OPT']))):null,
          NomeAccount:nome,NomeDanea:r['Nome Danea']||null,NomeInterno:r['Nome Interno']||null,
          Lat:r['lat']||null,Lng:r['long']||null,
          TitolareAccount:r['Titolare account']||null,Telefono:r['Telefono']?String(r['Telefono']):null,
          Email:r['E-mail di fatturazione']||null,
          StatoCliente:r['Stato del cliente']||null,Status:r['Status']||null,
          TipoCliente:r['Tipo di cliente']||null,DataCreazione:r['Data creazione']||null,
          ViaFatturazione:r['Via fatturazione']||null,CittaFatturazione:r['CittÃ  fatturazione']||null,
          ProvinciaFatturazione:r['Stato/Provincia fatturazione']||null,CapFatturazione:r['CAP fatturazione']?String(r['CAP fatturazione']):null,
          ViaSpedizioni:r['Via spedizioni']||null,CittaSpedizioni:r['CittÃ  spedizioni']||null,
          ProvinciaSpedizioni:r['Stato/Provincia spedizioni']||null,CapSpedizioni:r['CAP spedizioni']?String(r['CAP spedizioni']):null,
          ServiceArea:r['Service Area']||null,
          ContrattoAssistenza:r['Contratto di assi']||null
        });
      }

      // 2. Parse Assets sheet (base data + descriptions)
      let asSheet=wb.Sheets['Assets'];
      const assets=[];
      const assetsBySerieNorm={};
      function normSerie(s){if(!s)return '';s=String(s).replace(/\.0$/,'');return /^\d+$/.test(s)?String(parseInt(s,10)):s}

      if(asSheet){
        const asRows=XLSX.utils.sheet_to_json(asSheet,{defval:null});
        for(const r of asRows){
          const serie=r['Numero di serie'];
          if(!serie)continue;
          const movex=r['Movex']?String(Math.floor(Number(r['Movex']))):'';
          const asset={
            IdAccount:r['ID account']||null,IdAsset:r['ID asset']||null,
            CodiceM3:movex||null,NomeAccount:r['Nome account']||null,
            TitolareAccount:r['Titolare account']||null,
            NomeAsset:r['Nome asset']||null,NumeroSerie:String(serie),
            Modello:r['Modello']||null,GruppoAttrezzatura:r['Gruppo Attrezzatura']||null,
            Descrizione:r['Descrizione']||null,
            DataInstallazione:r['Data di installazione']||null,
            DataCreazione:r['Data creazione']||null,
            DataUltimaModifica:r['Data ultima modifica']||null,
            Status:r['Status']||'Attivo',TipoFoglio:'Assets',
            Provincia:null,RhLh:null,Ind:null,Note:null,SalesAdvisor:null
          };
          assets.push(asset);
          assetsBySerieNorm[normSerie(serie)]=asset;
        }
      }

      // 3. Build M3 resolution helpers
      const movexSheet=wb.Sheets['MOVEX'];
      const movexMap={};
      if(movexSheet){
        const mvRows=XLSX.utils.sheet_to_json(movexSheet,{defval:null});
        mvRows.forEach(r=>{if(r.CLIENTE&&r.MOVEX)movexMap[String(r.CLIENTE).trim().toUpperCase()]=String(Math.floor(Number(r.MOVEX)))});
      }
      const nomeInternoMap={};
      clienti.forEach(c=>{if(c.NomeInterno&&c.CodiceM3)nomeInternoMap[c.NomeInterno.toUpperCase()]=c.CodiceM3});
      const nomeAccountMap={};
      clienti.forEach(c=>{if(c.NomeAccount&&c.CodiceM3)nomeAccountMap[c.NomeAccount.toUpperCase()]=c.CodiceM3});

      function resolveM3(cli,mvx){
        if(mvx){const m=String(mvx).replace(/\.0$/,'').replace(/^0+/,'');if(m&&m!=='0')return m}
        if(!cli)return null;
        const up=String(cli).trim().toUpperCase();
        return nomeInternoMap[up]||nomeAccountMap[up]||movexMap[up]||null;
      }

      // 4. Parse ALL individual asset sheets with full column mappings
      // Each config: hr=header row (0-based), data starts at hr+1
      // Right-side table (extended): cc=client col, sc=serial col, dc=date col, mc=movex col, nc=note col, pc=provincia col, sa=sales advisor col, stc=status col, modc=model col
      const sheetCfgs={
        ROBOT:  {hr:4,cc:0,mc:1,sc:9,dc:10,pc:11,sa:12,nc:14,modc:null,stc:null,rhlh:6,ind:7},
        JUNO:   {hr:4,cc:1,mc:11,sc:3,dc:4,pc:6,sa:7,nc:9,modc:2,stc:12,rhlh:null,ind:null},
        VECTOR: {hr:4,cc:13,mc:23,sc:15,dc:16,pc:18,sa:19,nc:21,modc:14,stc:24,rhlh:null,ind:null},
        DISCOVERY:{hr:4,cc:13,mc:23,sc:15,dc:16,pc:18,sa:19,nc:21,modc:14,stc:24,rhlh:null,ind:null},
        COLLECTOR:{hr:4,cc:16,mc:null,sc:18,dc:19,pc:21,sa:22,nc:null,modc:17,stc:null,rhlh:null,ind:null},
        CU:     {hr:4,cc:17,mc:27,sc:19,dc:20,pc:22,sa:23,nc:25,modc:18,stc:28,rhlh:null,ind:null},
        CALM:   {hr:4,cc:8,mc:18,sc:10,dc:11,pc:13,sa:14,nc:16,modc:9,stc:19,rhlh:null,ind:null},
        COMPRESSORI:{hr:4,cc:15,mc:25,sc:17,dc:18,pc:20,sa:21,nc:23,modc:16,stc:26,rhlh:null,ind:null},
        COSMIX: {hr:4,cc:16,mc:26,sc:18,dc:19,pc:21,sa:22,nc:null,modc:17,stc:27,rhlh:null,ind:null},
        NAUTILUS:{hr:4,cc:8,mc:18,sc:10,dc:11,pc:13,sa:14,nc:16,modc:9,stc:19,rhlh:null,ind:null},
        LUNA:   {hr:4,cc:13,mc:23,sc:15,dc:16,pc:18,sa:19,nc:21,modc:14,stc:24,rhlh:null,ind:null},
        METEOR: {hr:4,cc:11,mc:21,sc:13,dc:14,pc:16,sa:17,nc:19,modc:12,stc:22,rhlh:null,ind:null},
        GRAZEWAY:{hr:4,cc:7,mc:17,sc:9,dc:10,pc:12,sa:13,nc:15,modc:8,stc:18,rhlh:null,ind:null},
        'L4C LED':{hr:4,cc:7,mc:17,sc:9,dc:10,pc:12,sa:13,nc:15,modc:8,stc:18,rhlh:null,ind:null}
      };

      // Also simple sheets with minimal columns (left-side only)
      const simpleCfgs={
        ARLA:   {hr:2,cc:0,sc:1,dc:2},
        TITANIA:{hr:2,cc:0,sc:null,dc:2}
      };

      const seenSeries=new Set(assets.map(a=>normSerie(a.NumeroSerie)));

      for(const[sname,cfg] of Object.entries(sheetCfgs)){
        const ws=wb.Sheets[sname];if(!ws)continue;
        const allRows=XLSX.utils.sheet_to_json(ws,{header:1,defval:null});
        let added=0,enriched=0;
        for(let ri=cfg.hr;ri<allRows.length;ri++){
          const row=allRows[ri];if(!row)continue;
          const cli=row[cfg.cc];if(!cli||typeof cli==='number'&&cli<10)continue;
          const serie=row[cfg.sc];
          const serieNorm=normSerie(serie);

          // Extract fields
          const nota=cfg.nc!=null?row[cfg.nc]:null;
          const prov=cfg.pc!=null?row[cfg.pc]:null;
          const salesAdv=cfg.sa!=null?row[cfg.sa]:null;
          const modelo=cfg.modc!=null?row[cfg.modc]:null;
          const status=cfg.stc!=null?row[cfg.stc]:null;
          const dataInst=cfg.dc!=null?row[cfg.dc]:null;
          const rhlh=cfg.rhlh!=null?row[cfg.rhlh]:null;
          const ind=cfg.ind!=null?row[cfg.ind]:null;

          // Try to enrich existing asset first
          if(serieNorm&&assetsBySerieNorm[serieNorm]){
            const existing=assetsBySerieNorm[serieNorm];
            if(nota&&!existing.Note)existing.Note=String(nota);
            if(prov&&!existing.Provincia)existing.Provincia=String(prov);
            if(salesAdv&&!existing.SalesAdvisor)existing.SalesAdvisor=String(salesAdv);
            if(rhlh&&!existing.RhLh)existing.RhLh=String(rhlh);
            if(ind&&!existing.Ind)existing.Ind=String(ind);
            if(status&&!existing.Status)existing.Status=String(status);
            if(!existing.TipoFoglio||existing.TipoFoglio==='Assets')existing.TipoFoglio=sname;
            if(!existing.GruppoAttrezzatura||existing.GruppoAttrezzatura==='Assets')existing.GruppoAttrezzatura=sname;
            enriched++;
            continue;
          }

          if(!serie)continue;
          if(seenSeries.has(serieNorm))continue;
          seenSeries.add(serieNorm);
          const m3=resolveM3(cli,cfg.mc!=null?row[cfg.mc]:null);
          const asset={
            CodiceM3:m3,NomeAccount:String(cli),NumeroSerie:String(serie).replace(/\.0$/,''),
            Modello:modelo?String(modelo):sname,GruppoAttrezzatura:sname,
            DataInstallazione:dataInst||null,Status:status?String(status):'Attivo',TipoFoglio:sname,
            Provincia:prov?String(prov):null,Note:nota?String(nota):null,
            SalesAdvisor:salesAdv?String(salesAdv):null,
            RhLh:rhlh?String(rhlh):null,Ind:ind?String(ind):null
          };
          assets.push(asset);
          assetsBySerieNorm[serieNorm]=asset;
          added++;
        }
        console.log(`${sname}: +${added} new, ${enriched} enriched`);
      }

      // Simple sheets
      for(const[sname,cfg] of Object.entries(simpleCfgs)){
        const ws=wb.Sheets[sname];if(!ws)continue;
        const allRows=XLSX.utils.sheet_to_json(ws,{header:1,defval:null});
        for(let ri=cfg.hr;ri<allRows.length;ri++){
          const row=allRows[ri];if(!row)continue;
          const cli=row[cfg.cc];if(!cli)continue;
          const serie=cfg.sc!=null?row[cfg.sc]:null;
          const serieNorm=normSerie(serie||`${sname}_${cli}_${ri}`);
          if(seenSeries.has(serieNorm))continue;
          seenSeries.add(serieNorm);
          assets.push({
            CodiceM3:resolveM3(cli,null),NomeAccount:String(cli),
            NumeroSerie:serie?String(serie):`${sname}-${ri}`,
            Modello:sname,GruppoAttrezzatura:sname,
            DataInstallazione:cfg.dc!=null?row[cfg.dc]:null,
            Status:'Attivo',TipoFoglio:sname
          });
        }
      }

      // Normalize dates
      assets.forEach(a=>{a.DataInstallazione=formatAnagDate(a.DataInstallazione)});

      toast(`Parsati: ${clienti.length} clienti, ${assets.length} assets. Importazione...`,'info');

      // 5. Clear existing + import
      try{ await apiCall('clearAnagrafica',{},'POST'); toast('Dati precedenti cancellati','info'); }catch(ce){ console.warn('Clear failed, continuing:',ce); }
      const r1=await apiCall('importAnagraficaClienti',{rows:clienti},'POST');
      toast(`Clienti: ${r1.inserted} importati`,'ok');
      const r2=await apiCall('importAnagraficaAssets',{rows:assets},'POST');
      toast(`Assets: ${r2.inserted} importati, ${r2.skipped||0} skipped`,'ok');

      loadAnagClients();
    }catch(ex){
      console.error(ex);
      toast('Errore import: '+ex.message,'err');
    }
  };
  reader.readAsArrayBuffer(file);
}

// Auto-load when section is shown
var _origShowSec=typeof showSec==='function'?showSec:null;
// We'll hook into showSec after page load

// ============ EDIT STATE ============
var EDITING={utente:null,cliente:null,macchina:null,automezzo:null};

// ============ EDIT OPEN FUNCTIONS ============
function editUtente(id){
  const u=(DATA.utenti||[]).find(x=>x.ID===id);if(!u)return;
  EDITING.utente=id;
  $('nuNome').value=u.Nome||'';$('nuCognome').value=u.Cognome||'';
  $('nuUsername').value=u.Username||'';$('nuPassword').value='';
  $('nuRuolo').value=u.Ruolo||'tecnico';
  $('nuSquadra').value=u.SquadraID||'';$('nuAutomezzo').value=u.AutomezzoID||'';
  $('nuBase').value=u.Base||'';$('nuTelefono').value=u.Telefono||'';$('nuEmail').value=u.Email||'';
  document.querySelector('#modalUtente .modal-head h2').textContent='âœï¸ Modifica Utente';
  $('resetPwdBox').style.display='block';$('nuResetPwd').value='';
  openModal('modalUtente');
}
function editCliente(id){
  const c=(DATA.clienti||[]).find(x=>x.ID===id);if(!c)return;
  EDITING.cliente=id;
  $('ncNome').value=c.Nome||'';$('ncCitta').value=c.Citta||'';$('ncProv').value=c.Prov||'';
  $('ncIndirizzo').value=c.Indirizzo||'';$('ncCap').value=c.CAP||'';
  $('ncTelefono').value=c.Telefono||'';$('ncEmail').value=c.Email||'';
  $('ncContratto').value=c.Contratto||'';$('ncNote').value=c.Note||'';
  document.querySelector('#modalCliente .modal-head h2').textContent='âœï¸ Modifica Cliente';
  openModal('modalCliente');
}
function editMacchina(id){
  const m=(DATA.macchine||[]).find(x=>x.ID===id);if(!m)return;
  EDITING.macchina=id;
  $('nmCliente').value=m.ClienteID||'';$('nmTipo').value=m.Tipo||'';$('nmModello').value=m.Modello||'';
  $('nmSeriale').value=m.Seriale||'';$('nmAnno').value=m.AnnoInstallazione||'';
  $('nmOre').value=m.OreLavoro||'';$('nmUltimoTag').value=m.UltimoTagliando||'';
  $('nmProssTag').value=m.ProssimoTagliando||'';$('nmGaranzia').value=m.GaranziaFino||'';
  $('nmNote').value=m.Note||'';
  document.querySelector('#modalMacchina .modal-head h2').textContent='âœï¸ Modifica Macchina';
  openModal('modalMacchina');
}
function editAutomezzo(id){
  const f=(DATA.automezzi||[]).find(x=>x.ID===id);if(!f)return;
  EDITING.automezzo=id;
  $('naTarga').value=f.Targa||'';$('naDesc').value=f.Descrizione||'';
  $('naAllestimento').value=f.Allestimento||'';$('naStatus').value=f.Status||'disponibile';
  $('naControllo').value=f.ProssimoControllo||'';$('naAssegnatario').value=f.AssegnatarioID||'';
  $('naKm').value=f.KmAttuali||'';$('naNote').value=f.Note||'';
  document.querySelector('#modalAutomezzo .modal-head h2').textContent='âœï¸ Modifica Automezzo';
  openModal('modalAutomezzo');
}

// ============ RESET MODAL ON NEW ============
function openNewUtente(){EDITING.utente=null;['nuNome','nuCognome','nuUsername','nuPassword','nuBase','nuTelefono','nuEmail'].forEach(id=>{if($(id))$(id).value=''});$('nuRuolo').value='tecnico';$('nuSquadra').value='';$('nuAutomezzo').value='';$('resetPwdBox').style.display='none';document.querySelector('#modalUtente .modal-head h2').textContent='ğŸ‘¤ Nuovo Utente';openModal('modalUtente')}
function openNewCliente(){EDITING.cliente=null;['ncNome','ncCitta','ncProv','ncIndirizzo','ncCap','ncTelefono','ncEmail','ncContratto','ncNote'].forEach(id=>{if($(id))$(id).value=''});document.querySelector('#modalCliente .modal-head h2').textContent='ğŸ¢ Nuovo Cliente';openModal('modalCliente')}
function openNewMacchina(){EDITING.macchina=null;['nmTipo','nmModello','nmSeriale','nmAnno','nmOre','nmUltimoTag','nmProssTag','nmGaranzia','nmNote'].forEach(id=>{if($(id))$(id).value=''});$('nmCliente').value='';document.querySelector('#modalMacchina .modal-head h2').textContent='âš™ï¸ Nuova Macchina';openModal('modalMacchina')}
function openNewAutomezzo(){EDITING.automezzo=null;['naTarga','naDesc','naAllestimento','naKm','naControllo','naNote'].forEach(id=>{if($(id))$(id).value=''});$('naStatus').value='disponibile';$('naAssegnatario').value='';document.querySelector('#modalAutomezzo .modal-head h2').textContent='ğŸš Nuovo Automezzo';openModal('modalAutomezzo')}

// ============ SAVE FUNCTIONS (CREATE + UPDATE) ============
async function saveUtente(){
  const data={
    Nome:$('nuNome').value,
    Cognome:$('nuCognome').value,
    Username:$('nuUsername').value,
    Ruolo:$('nuRuolo').value,
    SquadraID:$('nuSquadra').value||null,
    AutomezzoID:$('nuAutomezzo').value||null,
    Base:$('nuBase').value||null,
    Telefono:$('nuTelefono').value||null,
    Email:$('nuEmail').value||null,
    TenantID:(DATA.utenti&&DATA.utenti[0])?DATA.utenti[0].TenantID:null
  };
  if(!data.Nome||!data.Cognome){toast('Compila nome e cognome','warn');return}
  try{
    if(EDITING.utente){
      data.id=EDITING.utente;
      if($('nuPassword').value) data.password=$('nuPassword').value;
      await apiCall('updateUtente',data,'POST');
      toast('Utente aggiornato!','ok');
    }else{
      if(!data.Username){toast('Inserisci username','warn');return}
      data.password=$('nuPassword').value;
      if(!data.password){toast('Inserisci una password','warn');return}
      await apiCall('createUtente',{data},'POST');
      toast('Utente creato!','ok');
    }
    closeModal('modalUtente');EDITING.utente=null;
    await refreshData(true);populateSelects();
  }catch(e){toast(e.message,'err')}
}

// Reset Password (admin)
async function doResetPassword(){
  if(!EDITING.utente){toast('Nessun utente selezionato','warn');return}
  const newPwd=$('nuResetPwd').value.trim();
  if(!newPwd||newPwd.length<6){toast('La password deve avere almeno 6 caratteri','warn');return}
  if(!confirm('Confermi il reset password per questo utente?'))return;
  try{
    await apiCall('resetPassword',{userId:EDITING.utente,newPassword:newPwd,operatoreId:USER?.ID},'POST');
    toast('âœ… Password resettata! Nuova pwd: '+newPwd,'ok');
    $('nuResetPwd').value='';
  }catch(e){toast('Errore reset: '+e.message,'err')}
}
function generateRandomPwd(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
  const specials='!@#$%';
  let pwd='';for(let i=0;i<8;i++)pwd+=chars.charAt(Math.floor(Math.random()*chars.length));
  pwd+=specials.charAt(Math.floor(Math.random()*specials.length));
  pwd+=Math.floor(Math.random()*90+10);
  $('nuResetPwd').value=pwd;
}

async function saveCliente(){
  const data={
    Nome:$('ncNome').value,
    Citta:$('ncCitta').value||null,Prov:$('ncProv').value||null,
    Indirizzo:$('ncIndirizzo').value||null,CAP:$('ncCap').value||null,
    Telefono:$('ncTelefono').value||null,Email:$('ncEmail').value||null,
    Contratto:$('ncContratto').value||null,Note:$('ncNote').value||null,
    TenantID:(DATA.utenti&&DATA.utenti[0])?DATA.utenti[0].TenantID:null
  };
  if(!data.Nome){toast('Inserisci il nome del cliente','warn');return}
  try{
    if(EDITING.cliente){
      data.id=EDITING.cliente;
      await apiCall('updateCliente',data,'POST');
      toast('Cliente aggiornato!','ok');
    }else{
      await apiCall('createCliente',{data},'POST');
      toast('Cliente creato!','ok');
    }
    closeModal('modalCliente');EDITING.cliente=null;
    await refreshData(true);populateSelects();
  }catch(e){toast(e.message,'err')}
}

async function saveMacchina(){
  const data={
    ClienteID:$('nmCliente').value,Tipo:$('nmTipo').value,Modello:$('nmModello').value,
    Seriale:$('nmSeriale').value||null,
    AnnoInstallazione:$('nmAnno').value?parseInt($('nmAnno').value):null,
    OreLavoro:$('nmOre').value?parseInt($('nmOre').value):null,
    UltimoTagliando:$('nmUltimoTag').value||null,ProssimoTagliando:$('nmProssTag').value||null,
    GaranziaFino:$('nmGaranzia').value||null,Note:$('nmNote').value||null,
    TenantID:(DATA.utenti&&DATA.utenti[0])?DATA.utenti[0].TenantID:null
  };
  if(!data.ClienteID||!data.Tipo||!data.Modello){toast('Compila cliente, tipo e modello','warn');return}
  try{
    if(EDITING.macchina){
      data.id=EDITING.macchina;
      await apiCall('updateMacchina',data,'POST');
      toast('Macchina aggiornata!','ok');
    }else{
      await apiCall('createMacchina',{data},'POST');
      toast('Macchina creata!','ok');
    }
    closeModal('modalMacchina');EDITING.macchina=null;
    await refreshData(true);populateSelects();
  }catch(e){toast(e.message,'err')}
}

async function saveAutomezzo(){
  const data={
    Targa:$('naTarga').value,Descrizione:$('naDesc').value,
    Allestimento:$('naAllestimento').value||null,Status:$('naStatus').value,
    ProssimoControllo:$('naControllo').value||null,
    AssegnatarioID:$('naAssegnatario').value||null,
    KmAttuali:$('naKm').value?parseInt($('naKm').value):null,
    Note:$('naNote').value||null,
    TenantID:(DATA.utenti&&DATA.utenti[0])?DATA.utenti[0].TenantID:null
  };
  if(!data.Targa||!data.Descrizione||!data.Status){toast('Compila targa, descrizione e status','warn');return}
  try{
    if(EDITING.automezzo){
      data.id=EDITING.automezzo;
      await apiCall('updateAutomezzo',data,'POST');
      toast('Automezzo aggiornato!','ok');
    }else{
      await apiCall('createAutomezzo',{data},'POST');
      toast('Automezzo creato!','ok');
    }
    closeModal('modalAutomezzo');EDITING.automezzo=null;
    await refreshData(true);populateSelects();
  }catch(e){toast(e.message,'err')}
}

// ============ SAVE FUNCTIONS ============
async function saveOrdine(){
  const data={Codice:$('moCodice').value,Descrizione:$('moDesc').value,Quantita:$('moQta').value,TecnicoID:$('moTecnico').value,ClienteID:$('moCliente').value,Note:$('moNote').value};
  if(!data.Codice){toast('Inserisci il codice ricambio','warn');return}
  try{await apiCall('createOrdine',{data},'POST');toast('Ordine creato!','ok');closeModal('modalOrdine');await refreshData(true)}catch(e){toast(e.message,'err')}
}

async function saveRep(){
  const data={TecnicoID:$('mrTecnico').value,DataInizio:$('mrDal').value,DataFine:$('mrAl').value,Turno:$('mrTurno').value,Tipo:$('mrTipo').value,Note:$('mrNote').value};
  if(!data.TecnicoID||!data.DataInizio||!data.DataFine){toast('Compila tecnico e date','warn');return}
  try{await apiCall('createReperibilita',{data},'POST');toast('Turno creato!','ok');closeModal('modalRep');await refreshData(true)}catch(e){toast(e.message,'err')}
}

async function saveTrasf(){
  const data={TecniciIDs:[...($('mtTecnici').selectedOptions||[])].map(o=>o.value),ClienteID:$('mtCliente').value,DataInizio:$('mtDal').value,DataFine:$('mtAl').value,AutomezzoID:$('mtAutomezzo').value,Motivo:$('mtMotivo').value};
  if(!data.TecniciIDs.length||!data.ClienteID||!data.DataInizio){toast('Compila tecnici, cliente e data inizio','warn');return}
  try{await apiCall('createTrasferta',{data},'POST');toast('Trasferta creata!','ok');closeModal('modalTrasf');await refreshData(true)}catch(e){toast(e.message,'err')}
}

async function saveNotifica(){
  const destIds=[...($('mnDest').selectedOptions||[])].map(o=>o.value); 
  const data={destinatariIds:destIds,tipo:$('mnTipo').value,oggetto:$('mnOgg').value,messaggio:$('mnMsg').value};
  if(!destIds.length||!data.oggetto){toast('Seleziona destinatari e oggetto','warn');return}
  try{await apiCall('createNotifica',data,'POST');toast('Notifica inviata!','ok');closeModal('modalNotifica');await refreshData(true)}catch(e){toast(e.message,'err')}
}

async function savePagellino(){
  const voci=[...$('pagVoci').querySelectorAll('.pag-voce')].map(div=>({
    voce:div.querySelector('.pv-voce')?.value||'',
    categoria:div.querySelector('.pv-cat')?.value||'generale',
    voto:parseFloat(div.querySelector('.pv-voto')?.value)||3,
    peso:parseFloat(div.querySelector('.pv-peso')?.value)||1
  })).filter(v=>v.voce.trim());
  const data={tecnicoId:$('mgTecnico').value,periodo:$('mgPeriodo').value,dataRilevazione:$('mgData').value||today(),valutatoreId:USER?.ID,notaComplessiva:$('mgNota').value,voci};
  if(!data.tecnicoId||voci.length===0){toast('Seleziona tecnico e aggiungi almeno una voce','warn');return}
  try{await apiCall('createPagellino',{data},'POST');toast('Pagellino creato!','ok');closeModal('modalPagellino');await refreshData(true)}catch(e){toast(e.message,'err')}
}



// showDetail Ã¨ definito piÃ¹ avanti con versione con editing

// ============ INIT DATE FIELDS ============
setTimeout(()=>{
  const d=today();
  if($('mpData'))$('mpData').value=d;
  if($('mgData'))$('mgData').value=d;
  if($('mrDal'))$('mrDal').value=d;
  if($('mtDal'))$('mtDal').value=d;
  if($('miDal'))$('miDal').value=d;
},100);

// ============ SAVE FUNCTIONS ============
async function savePiano(){
  try{
    const tecniciSel=Array.from($('mpTecnici').selectedOptions).map(o=>o.value);
    const data={
      Data:$('mpData').value,DataFine:$('mpDataFine').value||'',OraInizio:$('mpOra').value,
      DurataOre:parseFloat($('mpDurata').value)||2,
      TecnicoID:$('mpTecnico').value,TecniciIDs:tecniciSel,
      AutomezzoID:$('mpAutomezzo').value,ClienteID:$('mpCliente').value,
      MacchinaID:$('mpMacchina').value,TipoInterventoID:$('mpTipo').value,
      PrioritaID:$('mpPriorita').value,Note:$('mpNote').value,Stato:'pianificato'
    };
    if(!data.Data||!data.TecnicoID||!data.ClienteID){toast('Compila Data, Tecnico e Cliente','warn');return}
    await apiCall('createPiano',{data},'POST');
    toast('Intervento creato','ok');closeModal('modalPiano');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function saveUrgenza(){
  try{
    const data={ClienteID:$('muCliente').value,MacchinaID:$('muMacchina').value,
      Problema:$('muProblema').value,PrioritaID:$('muPriorita').value,Note:$('muNote').value,
      Stato:'aperta',SegnalatoDa:USER?.ID,DataSegnalazione:new Date().toISOString()};
    if(!data.ClienteID||!data.Problema){toast('Compila Cliente e Problema','warn');return}
    await apiCall('createUrgenza',{data},'POST');

    // Scheduling automatico in base a prioritÃ 
    const priId=$('muPriorita').value;
    const priObj=(DATA.priorita||[]).find(p=>p.ID===priId);
    const priLivello=priObj?.Livello||1;
    const priNome=priObj?.Nome||'Urgente';
    let dataInt;const d=new Date();
    if(priLivello<=2){dataInt=today()}
    else if(priLivello===3){d.setDate(d.getDate()+1);dataInt=d.toISOString().slice(0,10)}
    else{d.setDate(d.getDate()+2);dataInt=d.toISOString().slice(0,10)}
    const oraInt=priLivello<=2?new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit',hour12:false}):'08:00';
    try{
      await apiCall('createPiano',{data:{ClienteID:data.ClienteID,MacchinaID:data.MacchinaID||null,
        PrioritaID:priId,Data:dataInt,OraInizio:oraInt,OraFine:calcOraFine(oraInt,priLivello<=2?4:2),
        DurataOre:priLivello<=2?4:2,Note:'[URGENZA ADMIN]\nğŸš¨ PrioritÃ : '+priNome+'\n'+data.Problema,
        Stato:'pianificato'}},'POST');
    }catch(e){console.warn('Piano da urgenza:',e)}

    // Notifiche chat
    const nome=((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim();
    const cliNome=getName(DATA.clienti,data.ClienteID);
    try{await apiCall('sendChatMessage',{canale_id:'CH_URGENZE',testo:'ğŸš¨ URGENZA ('+priNome+') creata da '+nome+'\nğŸ¢ '+cliNome+'\nğŸ“… Schedulata: '+fmtDate(dataInt)+' '+oraInt+'\nğŸ“ '+data.Problema,userId:USER?.ID},'POST')}catch(e){}

    toast('Urgenza creata + schedulata il '+fmtDate(dataInt),'ok');closeModal('modalUrgenza');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function saveAssegna(){
  try{
    const urgId=$('maUrgId').value;
    const tecnicoAssegnato=$('maTecnico').value;
    const automezzoId=$('maAutomezzo').value;
    const dataPrevista=$('maData').value||today();
    const oraPrevista=$('maOra').value||'08:00';
    const creaIntervento=$('maCreaInt').checked;
    if(!tecnicoAssegnato){toast('Seleziona un tecnico','warn');return}
    const urg=(DATA.urgenze||[]).find(u=>u.ID===urgId);

    // 1. Assegna urgenza (cambia stato da in_attesa/aperta â†’ assegnata)
    await apiCall('assignUrgenza',{
      id:urgId,
      tecnicoAssegnato,
      tecniciIds:[tecnicoAssegnato],
      automezzoId,
      dataPrevista,
      oraPrevista,
      operatoreId:USER?.ID
    },'POST');

    // 2. Se checkbox attivo â†’ crea intervento nel piano
    let interventoId=null;
    if(creaIntervento){
      try{
        const priId=urg?.PrioritaID||null;
        const priObj=(DATA.priorita||[]).find(p=>p.ID===priId);
        const priNome=priObj?.Nome||'Urgenza';
        const durata=priObj?.Livello<=2?4:2;
        const result=await apiCall('createPiano',{data:{
          TecnicoID:tecnicoAssegnato,
          ClienteID:urg?.ClienteID||null,
          MacchinaID:urg?.MacchinaID||null,
          PrioritaID:priId,
          AutomezzoID:automezzoId||null,
          Data:dataPrevista,
          OraInizio:oraPrevista,
          OraFine:calcOraFine(oraPrevista,durata),
          DurataOre:durata,
          Note:'[DA URGENZA '+urgId+']\nğŸš¨ PrioritÃ : '+priNome+'\n'+(urg?.Problema||''),
          Stato:'pianificato'
        }},'POST');
        interventoId=result?.intervento?.ID||result?.id||null;
        // Aggiorna urgenza con riferimento all'intervento
        if(interventoId){
          try{await apiCall('updateUrgenza',{id:urgId,InterventoID:interventoId},'POST')}catch(e){}
        }
      }catch(e){console.warn('Piano da urgenza:',e)}
    }

    // 3. Notifica tecnico assegnato
    const tecNome=getName(DATA.utenti||[],tecnicoAssegnato);
    const cliNome=getName(DATA.clienti||[],urg?.ClienteID);
    const adminNome=((USER?.Nome||'')+' '+(USER?.Cognome||'')).trim();
    try{await apiCall('createNotifica',{data:{Tipo:'urgenza_assegnata',Oggetto:'ğŸš¨ Urgenza assegnata a te',Testo:adminNome+' ti ha assegnato un\'urgenza per '+cliNome+': '+(urg?.Problema||'')+'\nğŸ“… '+fmtDate(dataPrevista)+' '+oraPrevista,DestinatarioID:tecnicoAssegnato,Priorita:'alta'}},'POST')}catch(e){}
    try{await apiCall('sendChatMessage',{canale_id:'CH_ADMIN',testo:'âœ… URGENZA '+urgId+' assegnata a '+tecNome+' per '+cliNome+'\nğŸ“… '+fmtDate(dataPrevista)+' '+oraPrevista+(interventoId?'\nğŸ“‹ Intervento creato: '+interventoId:''),userId:USER?.ID},'POST')}catch(e){}

    toast('Urgenza assegnata'+(creaIntervento?' + intervento creato nel piano':'')+' a '+tecNome,'ok');
    closeModal('modalAssegna');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function saveOrdine(){
  try{
    const data={Codice:$('moCodice').value,Descrizione:$('moDesc').value,
      Quantita:parseInt($('moQta').value)||1,TecnicoID:$('moTecnico').value,
      ClienteID:$('moCliente').value,Note:$('moNote').value};
    if(!data.Codice){toast('Inserisci il codice ricambio','warn');return}
    await apiCall('createOrdine',{data},'POST');
    toast('Ordine creato','ok');closeModal('modalOrdine');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function saveRep(){
  try{
    const data={TecnicoID:$('mrTecnico').value,DataInizio:$('mrDal').value,
      DataFine:$('mrAl').value,Turno:$('mrTurno').value,Tipo:$('mrTipo').value,
      Note:$('mrNote').value};
    if(!data.TecnicoID||!data.DataInizio||!data.DataFine){toast('Compila Tecnico e Date','warn');return}
    await apiCall('createReperibilita',{data},'POST');
    toast('Turno creato','ok');closeModal('modalRep');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function saveTrasf(){
  try{
    const tecniciSel=Array.from($('mtTecnici').selectedOptions).map(o=>o.value);
    const data={TecniciIDs:tecniciSel,TecnicoID:tecniciSel[0]||'',
      ClienteID:$('mtCliente').value,DataInizio:$('mtDal').value,
      DataFine:$('mtAl').value,AutomezzoID:$('mtAutomezzo').value,
      Motivo:$('mtMotivo').value};
    if(!tecniciSel.length||!data.ClienteID||!data.DataInizio){toast('Compila Tecnici, Cliente e Data Inizio','warn');return}
    await apiCall('createTrasferta',{data},'POST');
    toast('Trasferta creata','ok');closeModal('modalTrasf');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function saveNotifica(){
  try{
    const destSel=Array.from($('mnDest').selectedOptions).map(o=>o.value);
    const data={destinatariIds:destSel,tipo:$('mnTipo').value,
      oggetto:$('mnOgg').value,messaggio:$('mnMsg').value};
    if(!destSel.length||!data.oggetto){toast('Seleziona destinatari e oggetto','warn');return}
    await apiCall('createNotifica',data,'POST');
    toast('Notifica inviata a '+destSel.length+' destinatari','ok');closeModal('modalNotifica');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function savePagellino(){
  try{
    const voci=[];
    document.querySelectorAll('.pag-voce').forEach(row=>{
      const voce=row.querySelector('.pv-voce')?.value;
      if(!voce)return;
      voci.push({voce,categoria:row.querySelector('.pv-cat')?.value||'generale',
        voto:parseInt(row.querySelector('.pv-voto')?.value)||3,
        peso:parseInt(row.querySelector('.pv-peso')?.value)||1});
    });
    const data={tecnicoId:$('mgTecnico').value,periodo:$('mgPeriodo').value,
      dataRilevazione:$('mgData').value||today(),valutatoreId:USER?.ID,
      notaComplessiva:$('mgNota').value,voci};
    if(!data.tecnicoId){toast('Seleziona un tecnico','warn');return}
    if(voci.length===0){toast('Aggiungi almeno una voce di valutazione','warn');return}
    await apiCall('createPagellino',{data},'POST');
    toast('Pagellino creato','ok');closeModal('modalPagellino');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function saveInstall(){
  try{
    const tecniciSel=Array.from($('miTecnici').selectedOptions).map(o=>o.value);
    const data={ClienteID:$('miCliente').value,MacchinaID:$('miMacchina').value,
      DataInizio:$('miDal').value,DataFinePrevista:$('miAl').value,
      TecniciIDs:tecniciSel,Note:$('miNote').value,Stato:'in_corso'};
    if(!data.ClienteID||!data.DataInizio){toast('Compila Cliente e Data Inizio','warn');return}
    await apiCall('createInstallazione',{data},'POST');
    toast('Installazione creata!','ok');closeModal('modalInstall');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

// ============ AI PLANNER ============
let AI_FILES=[];

function handleAIFiles(fileList){
  for(const f of fileList) AI_FILES.push(f);
  renderAIFileList();
}
function handleAIFileDrop(e){
  handleAIFiles(e.dataTransfer.files);
}
function removeAIFile(idx){
  AI_FILES.splice(idx,1);
  renderAIFileList();
}
function renderAIFileList(){
  const el=$('aiFileList');
  if(!AI_FILES.length){el.style.display='none';return}
  el.style.display='block';
  el.innerHTML=AI_FILES.map((f,i)=>{
    const icon=f.name.match(/\.xlsx?$/i)?'ğŸ“Š':f.name.match(/\.pdf$/i)?'ğŸ“„':f.name.match(/\.docx?$/i)?'ğŸ“':'ğŸ–¼ï¸';
    return `<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.1);padding:4px 10px;border-radius:20px;margin:2px;font-size:.8125rem">${icon} ${f.name} <span style="cursor:pointer;color:#ef4444" onclick="removeAIFile(${i})">âœ•</span></span>`;
  }).join('');
}

async function readFileAsText(file){
  // Per Excel: parse con SheetJS e restituisci come testo leggibile
  if(file.name.match(/\.xlsx?$/i)){
    return new Promise(async(resolve)=>{
      if(!window.XLSX){
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        document.head.appendChild(s);
        await new Promise(r=>{s.onload=r;s.onerror=()=>r()});
      }
      if(!window.XLSX){resolve('[Errore caricamento parser Excel]');return}
      const r=new FileReader();
      r.onload=()=>{
        try{
          const wb=XLSX.read(r.result,{type:'array',cellDates:true});
          let out='';
          wb.SheetNames.forEach(sn=>{
            const ws=wb.Sheets[sn];
            const csv=XLSX.utils.sheet_to_csv(ws,{FS:';',dateNF:'YYYY-MM-DD'});
            // Limita a 4000 chars per sheet per non esplodere il prompt
            out+=`\n--- FOGLIO: ${sn} ---\n${csv.substring(0,4000)}\n`;
          });
          resolve(out);
        }catch(e){resolve('[Errore parsing: '+e.message+']')}
      };
      r.readAsArrayBuffer(file);
    });
  }
  return new Promise((resolve)=>{
    if(file.name.match(/\.csv$/i)||file.name.match(/\.txt$/i)){
      const r=new FileReader();r.onload=()=>resolve(r.result);r.readAsText(file);
    } else {
      const r=new FileReader();r.onload=()=>resolve(r.result.split(',')[1]);r.readAsDataURL(file);
    }
  });
}

let EXCEL_PLAN_ROWS=[];
async function importPlanFromExcel(file){
  if(!file)return;
  toast('Parsing Excel...','info');
  // Load SheetJS if not loaded
  if(typeof XLSX==='undefined'){
    await new Promise(r=>{const s=document.createElement('script');s.onload=r;s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';document.head.appendChild(s)});
  }
  const buf=await file.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array',cellDates:true});
  const rows=[];
  const today=new Date().toISOString().split('T')[0];

  for(const sheetName of wb.SheetNames){
    // Only process month sheets
    if(!sheetName.match(/\d{4}$/))continue;
    const ws=wb.Sheets[sheetName];
    const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    let currentDate=null,currentWeek='';

    for(const row of data){
      const vals=row.map(v=>v instanceof Date?v.toISOString():String(v||'').trim());
      if(vals[1]&&vals[1].startsWith('SETTIMANA')){currentWeek=vals[1];continue}
      // Detect date
      if(vals[2]){
        try{
          const d=new Date(vals[2]);
          if(!isNaN(d)&&d.getFullYear()===2026){currentDate=d.toISOString().split('T')[0];continue}
        }catch{}
      }
      if(vals[1]==='furg.')continue;
      // Data row
      if(currentDate&&vals[2]&&vals[2]!=='NaN'){
        const note=vals[5]||'';const attivita=vals[4]||'';
        let tipo='service';
        if(/INSTALL/i.test(note+attivita))tipo='installazione';
        else if(/VECTOR/i.test(note)&&!/SERVICE/i.test(note))tipo='installazione';
        else if(/VARIE|SEDE/i.test(attivita)&&!note)tipo='supporto';
        else if(/COPERTURA/i.test(attivita))tipo='copertura';
        else if(/FERIE/i.test(attivita+note))tipo='ferie';
        else if(/SERVICE/i.test(note))tipo='tagliando';
        rows.push({
          data:currentDate,settimana:currentWeek,
          furgone:vals[1],tecnico_nome:vals[2],
          reperibilita:vals[3],cliente:attivita,
          tipo_lavoro:tipo,service_detail:note,
          note_complete:[attivita,note].filter(Boolean).join(' | ')
        });
      }
    }
  }

  // Filter: only from today forward (don't go back in time)
  EXCEL_PLAN_ROWS=rows.filter(r=>r.data>=today);
  const past=rows.filter(r=>r.data<today);

  // Show preview
  const preview=$('excelImportPreview');
  preview.style.display='block';
  let html=`<div style="background:rgba(255,255,255,.05);border-radius:var(--radius);padding:12px;max-height:300px;overflow-y:auto">`;
  html+=`<div style="margin-bottom:8px"><strong>ğŸ“Š File parsato:</strong> ${rows.length} righe totali, ${past.length} passate (escluse), <strong>${EXCEL_PLAN_ROWS.length} da importare</strong> (dal ${today})</div>`;
  if(EXCEL_PLAN_ROWS.length){
    // Group by date
    const byDate={};
    EXCEL_PLAN_ROWS.forEach(r=>{if(!byDate[r.data])byDate[r.data]=[];byDate[r.data].push(r)});
    html+='<table style="width:100%;font-size:.75rem;border-collapse:collapse"><thead><tr style="text-align:left;border-bottom:1px solid rgba(255,255,255,.1)"><th>Data</th><th>Furg</th><th>Tecnico</th><th>Rep</th><th>Cliente</th><th>Lavoro</th></tr></thead><tbody>';
    Object.entries(byDate).forEach(([d,items])=>{
      items.forEach((r,i)=>{
        html+=`<tr style="border-bottom:1px solid rgba(255,255,255,.05)"><td>${i===0?d:''}</td><td>${r.furgone}</td><td>${r.tecnico_nome}</td><td>${r.reperibilita}</td><td>${r.cliente}</td><td>${r.service_detail||r.tipo_lavoro}</td></tr>`;
      });
    });
    html+='</tbody></table>';
    html+=`<div style="margin-top:12px"><button class="btn btn-sm btn-ok" onclick="confirmImportExcelPlan()">âœ… Importa ${EXCEL_PLAN_ROWS.length} righe nel Piano</button> <button class="btn btn-sm btn-ghost" onclick="$('excelImportPreview').style.display='none'">Annulla</button></div>`;
  }
  html+='</div>';
  preview.innerHTML=html;
  toast(`${EXCEL_PLAN_ROWS.length} righe pronte per importazione`,'ok');
}

async function confirmImportExcelPlan(){
  if(!EXCEL_PLAN_ROWS.length){toast('Nessun dato da importare','warn');return}
  try{
    const result=await apiCall('importExcelPlan',{rows:EXCEL_PLAN_ROWS},'POST');
    toast(`Piano importato: ${result.created} interventi creati`+(result.errors?.length?`, ${result.errors.length} errori`:''),'ok');
    $('excelImportPreview').style.display='none';
    EXCEL_PLAN_ROWS=[];
    await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function runAI(){
  const prompt=$('aiPrompt').value.trim();
  if(!prompt&&!AI_FILES.length){toast('Scrivi i vincoli o allega documenti','warn');return}
  $('aiResult').style.display='block';
  $('aiResult').textContent='ğŸ¤– Generazione in corso...';

  // Prepare file data for API
  const filesData=[];
  for(const f of AI_FILES){
    const content=await readFileAsText(f);
    filesData.push({name:f.name, type:f.type, size:f.size, content});
  }

  try{
    const result=await apiCall('generateAIPlan',{vincoli:{testo:prompt, files:filesData}},'POST');
    AI_PLAN=result;
    if(!result||typeof result!=='object'||(!result.piano&&!result.summary)){
      $('aiResult').innerHTML='<div style="padding:16px;background:rgba(239,68,68,.1);border:1px solid var(--err);border-radius:var(--radius)"><strong>âŒ Errore</strong><br>Workers AI non ha generato un piano. Riprova con un prompt piÃ¹ specifico.</div>';
      return;
    }
    // â”€â”€â”€ RENDERING PREMIUM â”€â”€â”€
    let html='';
    const piano=result.piano||[];
    const nGiorni=[...new Set(piano.map(p=>p.data))].length;
    const nTecnici=[...new Set(piano.map(p=>p.tecnicoId||p.tecnico))].length;
    // Header con KPI
    html+=`<div style="background:linear-gradient(135deg,#009B83,#00C9A7);color:white;border-radius:var(--radius-lg);padding:24px;margin-bottom:16px">
      <h3 style="margin:0 0 4px;font-size:1.25rem">ğŸ“‹ Piano Generato con AI</h3>
      <p style="margin:0;opacity:.85;font-size:.85rem">${result.summary||''}</p>
      <div style="display:flex;gap:24px;margin-top:16px">
        <div><span style="font-size:1.75rem;font-weight:700">${piano.length}</span><br><span style="font-size:.75rem;opacity:.7">Interventi</span></div>
        <div><span style="font-size:1.75rem;font-weight:700">${nGiorni}</span><br><span style="font-size:.75rem;opacity:.7">Giorni</span></div>
        <div><span style="font-size:1.75rem;font-weight:700">${nTecnici}</span><br><span style="font-size:.75rem;opacity:.7">Tecnici</span></div>
      </div>
    </div>`;
    // Tabella per giorno con colori tecnico
    if(piano.length){
      const byDate={};
      piano.forEach(p=>{const d=p.data||'?';if(!byDate[d])byDate[d]=[];byDate[d].push(p)});
      const tecColors={};
      const palette=['#00C9A7','#3B7EF7','#10B981','#F59E0B','#8B5CF6','#EC4899','#06B6D4','#EF4444'];
      let ci=0;
      const giorni=['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
      for(const [dt,items] of Object.entries(byDate)){
        const d=new Date(dt+'T00:00:00');
        const dayName=isNaN(d)?dt:giorni[d.getDay()]+' '+dt.split('-').reverse().join('/');
        html+=`<div style="margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="background:var(--c1);color:white;padding:4px 12px;border-radius:20px;font-size:.8125rem;font-weight:600">ğŸ“… ${dayName}</span>
            <span style="font-size:.75rem;color:var(--gray)">${items.length} interventi</span>
          </div>
          <div style="display:grid;gap:8px">`;
        items.forEach(p=>{
          const tid=p.tecnicoId||p.tecnico||'?';
          if(!tecColors[tid])tecColors[tid]=palette[ci++%palette.length];
          const col=tecColors[tid];
          const tipoIcons={'tagliando':'ğŸ”§','service':'âš™ï¸','urgenza':'ğŸš¨','installazione':'ğŸ—ï¸','ispezione':'ğŸ”'};
          const ico=tipoIcons[p.tipo]||'ğŸ“‹';
          html+=`<div style="display:flex;gap:12px;padding:10px 14px;background:var(--white);border-left:4px solid ${col};border-radius:var(--radius-sm);box-shadow:var(--shadow)">
            <div style="flex:0 0 auto;text-align:center">
              <div style="font-size:1.25rem">${ico}</div>
              <div style="font-size:.7rem;color:var(--gray)">${p.oraInizio||'â€”'}</div>
              <div style="font-size:.65rem;color:var(--gray2)">${p.durataOre||'?'}h</div>
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;font-size:.85rem;margin-bottom:2px">${p.cliente||'â€”'}</div>
              <div style="font-size:.75rem;color:var(--gray)">
                <span style="color:${col};font-weight:600">ğŸ‘¤ ${p.tecnico||'â€”'}</span> Â· ${p.tipo||'â€”'}${p.note?' Â· <em>'+p.note+'</em>':''}
              </div>
            </div>
          </div>`;
        });
        html+='</div></div>';
      }
      // Legenda tecnici
      html+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin:16px 0;padding:12px;background:var(--gray5);border-radius:var(--radius-sm)">';
      html+='<span style="font-size:.75rem;font-weight:600;color:var(--gray);margin-right:8px">Tecnici:</span>';
      for(const [tid,col] of Object.entries(tecColors)){
        const tname=(DATA.utenti||[]).find(u=>u.ID===tid);
        html+=`<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 10px;background:${col}18;border:1px solid ${col}40;border-radius:12px;font-size:.75rem"><span style="width:8px;height:8px;border-radius:50%;background:${col}"></span>${tname?tname.Nome+' '+tname.Cognome:tid}</span>`;
      }
      html+='</div>';
    }
    // Warnings
    if(result.warnings&&result.warnings.length){
      html+=`<div style="padding:10px 14px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);border-radius:var(--radius-sm);margin-top:8px;font-size:.8125rem">
        âš ï¸ <strong>Avvisi:</strong> ${result.warnings.join(' Â· ')}
      </div>`;
    }
    // Raw fallback
    if(result.raw){
      html+=`<details style="margin-top:12px"><summary style="font-size:.75rem;color:var(--gray);cursor:pointer">Mostra risposta grezza</summary><pre style="font-size:.7rem;overflow-x:auto;padding:8px;background:var(--gray5);border-radius:var(--radius-sm);margin-top:4px">${result.raw}</pre></details>`;
    }
    $('aiResult').innerHTML=html;
    $('btnApplyAI').disabled=false;
    $('btnSubmitPlan').disabled=false;
    $('btnDownloadPlan').disabled=false;
    toast(`Piano generato: ${piano.length} interventi, ${nGiorni} giorni`,'ok');
  }catch(e){
    $('aiResult').innerHTML=`<div style="padding:16px;background:rgba(239,68,68,.1);border:1px solid var(--err);border-radius:var(--radius)">
      <strong>âŒ Errore</strong><br>${e.message}<br><span style="font-size:.75rem;color:var(--gray)">Prova con un prompt piÃ¹ breve o riprova tra qualche secondo.</span>
    </div>`;
    toast(e.message,'err');
  }
}

async function downloadAIPlanXlsx(){
  if(!AI_PLAN||!AI_PLAN.piano||!AI_PLAN.piano.length){toast('Genera prima un piano','warn');return}
  if(!window.XLSX){
    const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(s);await new Promise(r=>{s.onload=r;setTimeout(r,3000)});
  }
  if(!window.XLSX){toast('Errore caricamento libreria','err');return}

  const wb=XLSX.utils.book_new();

  // Header row
  const header=['Data','Giorno','Tecnico','Furgone','Cliente','Tipo Intervento','Ora Inizio','Durata (h)','Note'];
  const giorni=['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
  const rows=AI_PLAN.piano.map(r=>{
    const d=r.data?new Date(r.data+'T00:00:00'):null;
    const giorno=d?giorni[d.getDay()]:'';
    const tecNome=r.tecnico||getName(DATA.utenti||[],r.tecnicoId);
    // Trova furgone del tecnico
    const tec=(DATA.utenti||[]).find(u=>u.ID===r.tecnicoId||u.Nome===r.tecnico);
    const furg=tec?.AutomezzoID||'';
    return[r.data||'',giorno,tecNome,furg,r.cliente||'',r.tipo||'',r.oraInizio||'08:00',r.durataOre||2,r.note||''];
  });

  // Raggruppa per data
  const byDate={};
  AI_PLAN.piano.forEach((r,i)=>{const d=r.data||'?';if(!byDate[d])byDate[d]=[];byDate[d].push(rows[i])});

  // Piano completo
  const allRows=[header];
  Object.entries(byDate).sort(([a],[b])=>a.localeCompare(b)).forEach(([data,items])=>{
    items.forEach(r=>allRows.push(r));
    allRows.push([]); // riga vuota separatrice
  });

  const ws=XLSX.utils.aoa_to_sheet(allRows);
  // Larghezza colonne
  ws['!cols']=[{wch:12},{wch:5},{wch:14},{wch:8},{wch:20},{wch:16},{wch:10},{wch:10},{wch:30}];
  XLSX.utils.book_append_sheet(wb,ws,'Piano Generato');

  // Summary sheet
  if(AI_PLAN.summary||AI_PLAN.warnings){
    const sumRows=[['ğŸ“‹ RIEPILOGO PIANO AI'],[''],[AI_PLAN.summary||'']];
    if(AI_PLAN.warnings?.length){sumRows.push([''],['âš ï¸ AVVISI:']);AI_PLAN.warnings.forEach(w=>sumRows.push([w]))}
    const ws2=XLSX.utils.aoa_to_sheet(sumRows);
    ws2['!cols']=[{wch:80}];
    XLSX.utils.book_append_sheet(wb,ws2,'Riepilogo');
  }

  // Per tecnico
  const byTec={};
  AI_PLAN.piano.forEach((r,i)=>{const t=r.tecnico||r.tecnicoId||'?';if(!byTec[t])byTec[t]=[];byTec[t].push(rows[i])});
  Object.entries(byTec).forEach(([tec,items])=>{
    const tecRows=[['Data','Giorno','Cliente','Tipo','Ora','Durata','Note'],...items.map(r=>[r[0],r[1],r[4],r[5],r[6],r[7],r[8]])];
    const wst=XLSX.utils.aoa_to_sheet(tecRows);
    wst['!cols']=[{wch:12},{wch:5},{wch:20},{wch:16},{wch:8},{wch:8},{wch:30}];
    XLSX.utils.book_append_sheet(wb,wst,tec.substring(0,31));
  });

  XLSX.writeFile(wb,'Piano_AI_'+new Date().toISOString().slice(0,10)+'.xlsx');
  toast('Piano Excel scaricato!','ok');
}

async function applyAI(){
  if(!AI_PLAN){toast('Genera prima un piano','warn');return}
  try{
    const result=await apiCall('applyAIPlan',{piano:AI_PLAN},'POST');
    toast('Piano applicato: '+(result.created||0)+' interventi creati','ok');
    AI_PLAN=null;$('btnApplyAI').disabled=true;$('btnSubmitPlan').disabled=true;$('btnDownloadPlan').disabled=true;
    await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

// ============ WORKFLOW APPROVATIVO ============
async function submitAIPlanForApproval(){
  if(!AI_PLAN){toast('Genera prima un piano','warn');return}
  const currentUser=SESSION?.user||{};
  try{
    const id='APR_'+Date.now();
    await apiCall('createApproval',{
      id, piano:AI_PLAN,
      creato_da:currentUser.id||'admin',
      ruolo_creatore:currentUser.ruolo||'admin',
      stato:'in_attesa',
      data_creazione:new Date().toISOString()
    },'POST');
    toast('Piano inviato per approvazione!','ok');
    $('btnSubmitPlan').disabled=true;
    renderApprovalQueue();
  }catch(e){toast(e.message,'err')}
}

async function renderApprovalQueue(){
  const tbody=$('tblApproval');if(!tbody)return;
  const filter=$('approvalFilter')?.value||'';
  try{
    const approvals=await apiCall('getApprovals',{filter},'POST');
    if(!approvals||!approvals.length){
      tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--gray)">Nessun piano in iter approvativo</td></tr>';
      return;
    }
    tbody.innerHTML=approvals.map(a=>{
      const currentUser=SESSION?.user||{};
      const canApprove=(currentUser.ruolo==='admin'||currentUser.ruolo==='caposquadra')&&a.stato==='in_attesa';
      return `<tr>
        <td><code>${a.id}</code></td>
        <td>${fmtDate(a.data_creazione)}</td>
        <td>${a.creato_da_nome||a.creato_da||'?'}</td>
        <td>${statusTag(a.stato)}</td>
        <td>${a.approvato_da_nome||a.approvato_da||'â€”'}</td>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${a.note_approvazione||'â€”'}</td>
        <td>${canApprove?`<button class="btn btn-xs btn-ok" onclick="approveOrReject('${a.id}','approvato')">âœ…</button> <button class="btn btn-xs btn-err" onclick="approveOrReject('${a.id}','rifiutato')">âŒ</button>`:`<button class="btn btn-xs btn-ghost" onclick="viewApprovalPlan('${a.id}')">ğŸ‘ï¸</button>`}</td>
      </tr>`;
    }).join('');
  }catch(e){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--gray)">Approvazioni non ancora configurate</td></tr>';
  }
}

async function approveOrReject(id,stato){
  const note=stato==='rifiutato'?prompt('Motivo del rifiuto:'):null;
  if(stato==='rifiutato'&&note===null)return;
  const currentUser=SESSION?.user||{};
  try{
    await apiCall('updateApproval',{
      id, stato,
      approvato_da:currentUser.id||'admin',
      note_approvazione:note||'',
      data_approvazione:new Date().toISOString()
    },'POST');
    toast(stato==='approvato'?'Piano approvato!':'Piano rifiutato','ok');
    renderApprovalQueue();
    // Se approvato, notifica tecnici via Telegram
    if(stato==='approvato'){
      try{ await apiCall('notifyPlanApproved',{approval_id:id},'POST'); }catch(e){}
    }
  }catch(e){toast(e.message,'err')}
}

async function viewApprovalPlan(id){
  try{
    const data=await apiCall('getApproval',{id},'POST');
    if(data&&data.piano){
      AI_PLAN=data.piano;
      // Scroll to AI result and show
      $('aiResult').style.display='block';
      if(typeof data.piano==='object'&&data.piano.piano){
        let html='<h4>ğŸ“‹ Piano #'+id+'</h4>';
        if(Array.isArray(data.piano.piano)){
          html+='<table class="tbl" style="font-size:.8125rem"><thead><tr><th>Data</th><th>Tecnico</th><th>Cliente</th><th>Tipo</th></tr></thead><tbody>';
          data.piano.piano.forEach(r=>{html+=`<tr><td>${r.data||''}</td><td>${r.tecnico||''}</td><td>${r.cliente||''}</td><td>${r.tipo||''}</td></tr>`;});
          html+='</tbody></table>';
        }
        $('aiResult').innerHTML=html;
      } else {
        $('aiResult').textContent=JSON.stringify(data.piano,null,2);
      }
      $('btnApplyAI').disabled=data.stato!=='approvato';
    }
  }catch(e){toast(e.message,'err')}
}

// ============ VISTA TECNICO: PIANO PERSONALE ============
async function renderTecnicoPlan(){
  const grid=$('tecnicoPlanGrid');if(!grid)return;
  const view=$('tecViewSelect')?.value||'mio';
  const currentUser=SESSION?.user||{};
  const piano=(DATA.piano||[]).filter(p=>!p.Obsoleto);
  const utenti=DATA.utenti||[];

  if(view==='mio'){
    const myPlan=piano.filter(p=>p.TecnicoID===currentUser.id);
    if(!myPlan.length){grid.innerHTML='<p style="padding:24px;text-align:center;color:var(--gray)">Nessun intervento assegnato a te</p>';return}
    // Group by date
    const byDate={};
    myPlan.sort((a,b)=>(a.Data||'').localeCompare(b.Data||'')).forEach(p=>{
      const d=p.Data||'senza data';if(!byDate[d])byDate[d]=[];byDate[d].push(p);
    });
    let html='';
    Object.entries(byDate).forEach(([date,items])=>{
      html+=`<div style="padding:8px 16px;background:var(--gray1);font-weight:600;font-size:.8125rem;border-bottom:1px solid var(--gray2)">ğŸ“… ${fmtDate(date)} (${items.length} interventi)</div>`;
      items.forEach(p=>{
        html+=`<div style="padding:12px 16px;border-bottom:1px solid var(--gray1);display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:500">${getName(DATA.clienti||[],p.ClienteID)} â€” ${getName(DATA.tipiIntervento||[],p.TipoInterventoID)||'Intervento'}</div>
            <div style="font-size:.75rem;color:var(--gray);margin-top:2px">${p.OraInizio||'â€”'} Â· ${p.DurataOre||'?'}h Â· ${statusTag(p.Stato)}</div>
            ${p.Note?`<div style="font-size:.75rem;margin-top:4px">${p.Note}</div>`:''}
          </div>
          <div style="display:flex;gap:4px">
            ${p.Stato==='pianificato'?`<button class="btn btn-xs btn-warn" onclick="updatePianoStato('${p.ID}','in_corso')">âš¡ Inizia</button>`:''}
            ${p.Stato==='in_corso'?`<button class="btn btn-xs btn-ok" onclick="updatePianoStato('${p.ID}','completato')">âœ… Completa</button>`:''}
            <button class="btn btn-xs btn-ghost" onclick="showDetail('piano','${p.ID}')">ğŸ‘ï¸</button>
          </div>
        </div>`;
      });
    });
    grid.innerHTML=html;
  } else {
    // Tutti i piani â€” raggruppati per tecnico, sola lettura per gli altri
    const byTec={};
    piano.sort((a,b)=>(a.Data||'').localeCompare(b.Data||'')).forEach(p=>{
      const tId=p.TecnicoID||'non_assegnato';
      if(!byTec[tId])byTec[tId]=[];byTec[tId].push(p);
    });
    let html='';
    Object.entries(byTec).forEach(([tecId,items])=>{
      const tecName=getName(utenti,tecId)||tecId;
      const isMine=tecId===currentUser.id;
      html+=`<div style="padding:10px 16px;background:${isMine?'rgba(99,102,241,.1)':'var(--gray1)'};font-weight:600;font-size:.875rem;border-bottom:1px solid var(--gray2)">${isMine?'â­':'ğŸ‘·'} ${tecName} (${items.length}) ${isMine?'â€” Il tuo piano':''}</div>`;
      items.forEach(p=>{
        html+=`<div style="padding:8px 16px;border-bottom:1px solid var(--gray1);font-size:.8125rem;display:flex;justify-content:space-between;align-items:center">
          <div>${fmtDate(p.Data)} Â· ${getName(DATA.clienti||[],p.ClienteID)} Â· ${statusTag(p.Stato)}</div>
          <div style="display:flex;gap:4px">
            ${isMine&&p.Stato==='pianificato'?`<button class="btn btn-xs btn-warn" onclick="updatePianoStato('${p.ID}','in_corso')">âš¡</button>`:''}
            ${isMine&&p.Stato==='in_corso'?`<button class="btn btn-xs btn-ok" onclick="updatePianoStato('${p.ID}','completato')">âœ…</button>`:''}
            <button class="btn btn-xs btn-ghost" onclick="showDetail('piano','${p.ID}')">ğŸ‘ï¸</button>
          </div>
        </div>`;
      });
    });
    grid.innerHTML=html;
  }
}

// ============ DETAIL VIEW ============
function showDetail(type,id){
  let item,title='',html='',foot='';
  switch(type){
    case 'piano':
      item=(DATA.piano||[]).find(p=>p.ID===id);if(!item)return;
      title='ğŸ“‹ Intervento '+id;
      const intClienti=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
      const intTecnici=(DATA.utenti||[]).filter(u=>u.Attivo&&(u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
      const intFurgoni=(DATA.automezzi||[]).filter(f=>!f.Obsoleto);
      const intTipi=(DATA.tipiIntervento||[]).filter(t=>t.Attivo!==false);
      html=`<div class="grid-2 mb">
        <div><strong>Data:</strong> <input type="date" id="edIntData" class="inp" style="display:inline;width:auto" value="${item.Data||''}"></div>
        <div><strong>Ora:</strong> <input type="time" id="edIntOra" class="inp" style="display:inline;width:auto" value="${item.OraInizio||''}"> Â· Durata: ${item.DurataOre||'â€”'}h</div>
        <div><strong>Tecnico:</strong> <select id="edIntTecnico" class="inp" style="display:inline;width:auto">
          <option value="">â€”</option>
          ${intTecnici.map(t=>`<option value="${t.ID}" ${t.ID===item.TecnicoID?'selected':''}>${t.Nome} ${t.Cognome||''}</option>`).join('')}
        </select></div>
        <div><strong>Furgone:</strong> <select id="edIntFurgone" class="inp" style="display:inline;width:auto">
          <option value="">â€”</option>
          ${intFurgoni.map(f=>`<option value="${f.ID}" ${f.ID===item.AutomezzoID?'selected':''}>${f.Descrizione||f.Targa||f.ID}</option>`).join('')}
        </select></div>
        <div><strong>Cliente:</strong> <select id="edIntCliente" class="inp" style="display:inline;width:auto;min-width:180px">
          <option value="">â€” Seleziona â€”</option>
          ${intClienti.map(c=>`<option value="${c.CodiceM3||c.ID}" ${(c.CodiceM3||c.ID)===item.ClienteID?'selected':''}>${c.NomeInterno||c.NomeAccount||c.Nome}</option>`).join('')}
        </select></div>
        <div><strong>Tipo:</strong> <select id="edIntTipo" class="inp" style="display:inline;width:auto">
          <option value="">â€”</option>
          ${intTipi.map(t=>`<option value="${t.ID}" ${t.ID===item.TipoInterventoID?'selected':''}>${t.Nome}</option>`).join('')}
        </select></div>
        <div><strong>Stato:</strong> ${statusTag(item.Stato)}</div>
        <div><strong>Origine:</strong> ${item.Origine||'manuale'}</div>
        ${item.UrgenzaID?`<div><strong>Urgenza collegata:</strong> ${item.UrgenzaID}</div>`:''}
      </div>
      <div class="mb"><strong>Note:</strong><br><textarea id="edIntNote" class="inp" rows="2" style="width:100%">${item.Note||''}</textarea></div>
      ${item.NoteCompletamento?`<div class="mb"><strong>Note completamento:</strong><br>${item.NoteCompletamento}</div>`:''}`;
      foot=`<button class="btn btn-primary" onclick="saveInterventoEdit('${id}')">ğŸ’¾ Salva</button> `;
      if(item.Stato==='pianificato')foot+=`<button class="btn btn-warn" onclick="updatePianoStato('${id}','in_corso')">âš¡ Inizia</button> `;
      if(item.Stato==='in_corso')foot+=`<button class="btn btn-ok" onclick="updatePianoStato('${id}','completato')">âœ… Completa</button> `;
      foot+=`<button class="btn" style="background:#FEE2E2;color:#DC2626;border:1px solid #FECACA" onclick="if(confirm('Cancellare questo intervento?')){deletePlannerItem('piano','${id}');closeModal('modalDetail')}">ğŸ—‘ï¸ Cancella</button>`;
      break;

    case 'urgenza':
      item=(DATA.urgenze||[]).find(u=>u.ID===id);if(!item)return;
      title='ğŸš¨ Urgenza '+id;
      const urgClienti=(DATA.clienti||[]).filter(c=>!c.Obsoleto);
      const urgTecnici=(DATA.utenti||[]).filter(u=>u.Attivo&&(u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
      const urgPriorita=(DATA.priorita||[]).filter(p=>p.Attivo!==false);
      html=`<div class="grid-2 mb">
        <div><strong>Cliente:</strong> <select id="edUrgCliente" class="inp" style="display:inline;width:auto;min-width:180px">
          <option value="">â€” Seleziona â€”</option>
          ${urgClienti.map(c=>`<option value="${c.CodiceM3||c.ID}" ${(c.CodiceM3||c.ID)===item.ClienteID?'selected':''}>${c.NomeInterno||c.NomeAccount||c.Nome}</option>`).join('')}
        </select></div>
        <div><strong>Macchina:</strong> ${getName(DATA.macchine||[],item.MacchinaID,'Tipo')}</div>
        <div><strong>PrioritÃ :</strong> <select id="edUrgPriorita" class="inp" style="display:inline;width:auto">
          <option value="">â€”</option>
          ${urgPriorita.map(p=>`<option value="${p.ID}" ${p.ID===item.PrioritaID?'selected':''}>${p.Nome}</option>`).join('')}
        </select></div>
        <div><strong>Stato:</strong> ${statusTag(item.Stato)}</div>
        <div><strong>Tecnico:</strong> <select id="edUrgTecnico" class="inp" style="display:inline;width:auto">
          <option value="">â€” Non assegnato â€”</option>
          ${urgTecnici.map(t=>`<option value="${t.ID}" ${t.ID===item.TecnicoAssegnato?'selected':''}>${t.Nome} ${t.Cognome||''}</option>`).join('')}
        </select></div>
        <div><strong>Automezzo:</strong> ${item.AutomezzoID||'â€”'}</div>
        <div><strong>Segnalata:</strong> ${fmtDateTime(item.DataSegnalazione)}</div>
        <div><strong>Assegnata:</strong> ${fmtDateTime(item.DataAssegnazione)}</div>
        <div><strong>Data Prevista:</strong> <input type="date" id="edUrgDataPrev" class="inp" style="display:inline;width:auto" value="${item.DataPrevista||''}"> <input type="time" id="edUrgOraPrev" class="inp" style="display:inline;width:auto" value="${item.OraPrevista||''}"></div>
        <div><strong>Risolta:</strong> ${fmtDateTime(item.DataRisoluzione)}</div>
      </div>
      <div class="mb"><strong>Problema:</strong><br><textarea id="edUrgProblema" class="inp" rows="2" style="width:100%">${item.Problema||''}</textarea></div>
      <div class="mb"><strong>Note:</strong><br><textarea id="edUrgNote" class="inp" rows="2" style="width:100%">${item.Note||''}</textarea></div>
      <div class="mb"><strong>SLA:</strong> ${slaTag(item.SLAStatus)} ${item.SLAScadenza?'â€” Scadenza: '+fmtDateTime(item.SLAScadenza):''}</div>
      ${item.NoteAi?`<div class="mb" style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);border-radius:8px;padding:12px"><strong>ğŸ¤– Analisi AI:</strong><br>${item.NoteAi}${item.AiConfidence?` <span style="color:var(--gray);font-size:.8em">(Confidenza: ${Math.round((item.AiConfidence||0)*100)}%)</span>`:''}</div>`:''}
      ${item.InterventoID?`<div class="mb"><strong>Intervento collegato:</strong> ${item.InterventoID}</div>`:''}
      <div class="mb" id="aiVisionBlock_${id}" style="border:1px dashed rgba(124,58,237,0.4);border-radius:8px;padding:12px;background:rgba(124,58,237,0.05)">
        <strong>ğŸ“· Analisi Guasto con AI Vision</strong><br>
        <input type="file" id="aiVisionFile_${id}" accept="image/*" capture="environment" style="display:none" onchange="previewAIPhoto('${id}')">
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('aiVisionFile_${id}').click()" style="margin-top:8px">ğŸ“¸ Scatta / Carica Foto</button>
        <div id="aiVisionPreview_${id}" style="display:none;margin-top:8px">
          <img id="aiVisionImg_${id}" style="max-width:300px;max-height:200px;border-radius:8px;border:1px solid var(--border)">
          <div style="margin-top:6px">
            <button class="btn btn-primary btn-sm" onclick="runAIVision('${id}')">ğŸ¤– Analizza</button>
            <button class="btn btn-ghost btn-sm" onclick="cancelAIPhoto('${id}')">âœ• Annulla</button>
          </div>
        </div>
        <div id="aiVisionLoading_${id}" style="display:none;margin-top:8px"><span class="spinner"></span> Analisi in corso...</div>
        <div id="aiVisionResult_${id}" style="display:none;margin-top:8px"></div>
      </div>`;
      foot=`<button class="btn btn-primary" onclick="saveUrgenzaEdit('${id}')">ğŸ’¾ Salva Modifiche</button> `;
      if(item.Stato==='aperta')foot+=`<button class="btn btn-outline" onclick="closeModal('modalDetail');openAssegna('${id}')">ğŸ‘¤ Approva+Assegna</button> `;
      if(item.Stato==='assegnata'||item.Stato==='schedulata')foot+=`<button class="btn btn-warn" onclick="urgAction('${id}','startUrgenza');closeModal('modalDetail')">âš¡ Inizia</button> `;
      if(item.Stato==='in_corso')foot+=`<button class="btn btn-ok" onclick="urgAction('${id}','resolveUrgenza');closeModal('modalDetail')">âœ… Risolvi</button> `;
      if(item.Stato==='risolta')foot+=`<button class="btn" style="background:#E0F2FE;color:#0369A1" onclick="closeUrgenza('${id}')">ğŸ“ Chiudi Urgenza</button> `;
      break;

    case 'ordine':
      item=(DATA.ordini||[]).find(o=>o.ID===id);if(!item)return;
      title='ğŸ“¦ Ordine '+id;
      html=`<div class="mb">${renderOrdineWorkflow(item.Stato)}</div>
      <div class="grid-2 mb">
        <div><strong>Codice:</strong> ${item.Codice||'â€”'}</div>
        <div><strong>Descrizione:</strong> ${item.Descrizione||'â€”'}</div>
        <div><strong>QuantitÃ :</strong> ${item.Quantita||1}</div>
        <div><strong>Tecnico:</strong> ${getName(DATA.utenti||[],item.TecnicoID)}</div>
        <div><strong>Cliente:</strong> ${getName(DATA.clienti||[],item.ClienteID)}</div>
        <div><strong>Stato:</strong> ${statusTag(item.Stato)}</div>
        <div><strong>Richiesto:</strong> ${fmtDateTime(item.DataRichiesta)}</div>
        <div><strong>Preso in carico:</strong> ${fmtDateTime(item.DataPresaCarico)}</div>
        <div><strong>Ordinato:</strong> ${fmtDateTime(item.DataOrdine)}</div>
        <div><strong>ETA:</strong> ${fmtDate(item.DataArrivoPrevista)}</div>
        <div><strong>Arrivato:</strong> ${fmtDateTime(item.DataArrivo)}</div>
        <div><strong>Gestore:</strong> ${item.GestoreMagazzino||'â€”'}</div>
      </div>
      ${item.Note?`<div class="mb"><strong>Note:</strong><br>${item.Note}</div>`:''}`;
      foot=nextOrdAction(item);
      break;

    case 'pagellino':
      item=(DATA.pagellini||[]).find(p=>p.ID===id);if(!item)return;
      const voci=(DATA.pagelliniVoci||[]).filter(v=>v.PagellinoID===id).sort((a,b)=>a.Ordine-b.Ordine);
      title='ğŸ¯ Pagellino '+id;
      html=`<div class="grid-2 mb">
        <div><strong>Tecnico:</strong> ${getName(DATA.utenti||[],item.TecnicoID)}</div>
        <div><strong>Data:</strong> ${fmtDate(item.DataRilevazione)}</div>
        <div><strong>Periodo:</strong> ${item.Periodo}</div>
        <div><strong>Valutatore:</strong> ${getName(DATA.utenti||[],item.ValutatoreID)}</div>
        <div><strong>Media Voto:</strong> <span style="font-size:1.25rem;font-weight:700;color:${(parseFloat(item.MediaVoto)||0)>=4?'var(--ok)':(parseFloat(item.MediaVoto)||0)>=3?'var(--warn)':'var(--err)'}">${item.MediaVoto||'â€”'}/5</span></div>
        <div><strong>Stato:</strong> ${statusTag(item.Stato)}</div>
      </div>
      ${voci.length?`<h4 style="margin-bottom:8px">Voci di Valutazione</h4>
      <table class="tbl"><thead><tr><th>Voce</th><th>Categoria</th><th>Voto</th><th>Peso</th><th>Note</th></tr></thead><tbody>
      ${voci.map(v=>`<tr><td>${v.Voce}</td><td><span class="tag tag-info">${v.Categoria}</span></td><td><strong>${v.Voto}/5</strong></td><td>${v.Peso}</td><td>${v.Note||'â€”'}</td></tr>`).join('')}
      </tbody></table>`:''}
      ${item.NotaComplessiva?`<div class="mb" style="margin-top:16px"><strong>Nota Complessiva:</strong><br>${item.NotaComplessiva}</div>`:''}`;
      if(item.Stato==='bozza')foot=`<button class="btn btn-ok" onclick="approvePagellino('${id}');closeModal('modalDetail')">âœ… Approva</button>`;
      break;

    case 'cliente':
      item=(DATA.clienti||[]).find(c=>c.ID===id);if(!item)return;
      const macchCli=(DATA.macchine||[]).filter(m=>!m.Obsoleto&&m.ClienteID===id);
      const intCli=(DATA.piano||[]).filter(p=>!p.Obsoleto&&p.ClienteID===id);
      title='ğŸ¢ '+item.Nome;
      html=`<div class="grid-2 mb">
        <div><strong>CittÃ :</strong> ${item.Citta||'â€”'} (${item.Prov||'â€”'})</div>
        <div><strong>Indirizzo:</strong> ${item.Indirizzo||'â€”'} ${item.CAP||''}</div>
        <div><strong>Telefono:</strong> ${item.Telefono?`<a href="tel:${item.Telefono}">${item.Telefono}</a>`:'â€”'}</div>
        <div><strong>Email:</strong> ${item.Email||'â€”'}</div>
        <div><strong>Contratto:</strong> ${item.Contratto||'â€”'}</div>
        <div><strong>Coordinate:</strong> ${item.Latitudine&&item.Longitudine?item.Latitudine+', '+item.Longitudine:'<em>Non geocodificato</em>'}</div>
      </div>
      <h4 style="margin-bottom:8px">Macchine (${macchCli.length})</h4>
      ${macchCli.length?`<table class="tbl"><thead><tr><th>Tipo</th><th>Modello</th><th>Seriale</th><th>Ore</th></tr></thead><tbody>
      ${macchCli.map(m=>`<tr><td>${m.Tipo}</td><td>${m.Modello}</td><td>${m.Seriale||'â€”'}</td><td>${m.OreLavoro||'â€”'}</td></tr>`).join('')}</tbody></table>`:'<p style="color:var(--gray)">Nessuna macchina</p>'}
      <h4 style="margin:16px 0 8px">Ultimi Interventi (${Math.min(intCli.length,10)})</h4>
      ${intCli.length?`<table class="tbl"><thead><tr><th>Data</th><th>Tipo</th><th>Tecnico</th><th>Stato</th></tr></thead><tbody>
      ${intCli.sort((a,b)=>(b.Data||'').localeCompare(a.Data||'')).slice(0,10).map(p=>`<tr><td>${fmtDate(p.Data)}</td><td>${getName(DATA.tipiIntervento||[],p.TipoInterventoID)}</td><td>${getName(DATA.utenti||[],p.TecnicoID)}</td><td>${statusTag(p.Stato)}</td></tr>`).join('')}</tbody></table>`:'<p style="color:var(--gray)">Nessun intervento</p>'}`;
      break;

    default:return;
  }

  $('detailTitle').textContent=title;
  $('detailBody').innerHTML=html;
  $('detailFoot').innerHTML=foot+`<button class="btn btn-outline" onclick="closeModal('modalDetail')">Chiudi</button>`;
  openModal('modalDetail');
}

function renderOrdineWorkflow(statoCorrente){
  const stati=['richiesto','preso_in_carico','ordinato','in_arrivo','arrivato'];
  const labels=['ğŸ“ Richiesto','ğŸ‘‹ Preso in Carico','ğŸ“¦ Ordinato','ğŸšš In Arrivo','âœ… Arrivato'];
  const idx=stati.indexOf(statoCorrente);
  return '<div class="wf-steps">'+stati.map((s,i)=>{
    let cls='wf-step';
    if(i<idx)cls+=' done';
    else if(i===idx)cls+=' active';
    return `<span class="${cls}">${labels[i]}</span>${i<stati.length-1?'<span class="wf-arrow">â†’</span>':''}`;
  }).join('')+'</div>';
}

async function updatePianoStato(id,stato){
  try{await apiCall('updatePiano',{id,data:{Stato:stato},operatoreId:USER?.ID},'POST');toast('Stato aggiornato','ok');closeModal('modalDetail');await refreshData(true)}catch(e){toast(e.message,'err')}
}

// ============ FEATURE 29: CHECKLIST ============
function renderChecklist(){
  const templates=(DATA.checklistTemplate||DATA.ChecklistTemplate||[]).filter(t=>t.Attivo!==false&&t.Attivo!=='false');
  let html='<table class="data-table"><thead><tr><th>Nome</th><th>Tipo Intervento</th><th>Voci</th><th>Azioni</th></tr></thead><tbody>';
  if(!templates.length) html+='<tr><td colspan="4" style="text-align:center;color:var(--gray)">Nessun template. Crea il primo!</td></tr>';
  templates.forEach(t=>{
    const tipo=(DATA.tipiIntervento||[]).find(ti=>ti.ID===t.TipoInterventoID);
    let voci=[];try{voci=JSON.parse(t.Voci||'[]')}catch(e){}
    html+=`<tr><td><b>${t.Nome||''}</b></td><td>${tipo?tipo.Nome:'â€”'}</td><td>${voci.length} voci</td>
    <td><button class="btn btn-outline btn-sm" onclick="viewChecklistTemplate('${t.ID}')">ğŸ‘ï¸</button>
    <button class="btn btn-outline btn-sm" onclick="deleteChecklistTpl('${t.ID}')" style="color:var(--err)">ğŸ—‘ï¸</button></td></tr>`;
  });
  html+='</tbody></table>';
  $('tblChecklist').innerHTML=html;
  
  // Compilate
  const comp=(DATA.checklistCompilata||DATA.ChecklistCompilata||[]);
  let h2='<table class="data-table"><thead><tr><th>Intervento</th><th>Template</th><th>Completate</th><th>Data</th><th>Compilatore</th></tr></thead><tbody>';
  if(!comp.length) h2+='<tr><td colspan="5" style="text-align:center;color:var(--gray)">Nessuna checklist compilata</td></tr>';
  comp.slice(0,50).forEach(c=>{
    const tpl=templates.find(t=>t.ID===c.TemplateID);
    let done=[];try{done=JSON.parse(c.VociCompletate||'[]')}catch(e){}
    const user=(DATA.utenti||[]).find(u=>u.ID===c.CompilatoreID);
    h2+=`<tr><td>${c.InterventoID||''}</td><td>${tpl?tpl.Nome:c.TemplateID}</td><td>${done.filter(Boolean).length} completate</td><td>${(c.DataCompilazione||'').substring(0,10)}</td><td>${user?user.Nome+' '+user.Cognome:''}</td></tr>`;
  });
  h2+='</tbody></table>';
  $('tblChecklistCompilate').innerHTML=h2;
}

function viewChecklistTemplate(id){
  const t=(DATA.checklistTemplate||DATA.ChecklistTemplate||[]).find(x=>x.ID===id);
  if(!t)return;
  let voci=[];try{voci=JSON.parse(t.Voci||'[]')}catch(e){}
  const tipo=(DATA.tipiIntervento||[]).find(ti=>ti.ID===t.TipoInterventoID);
  let html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
    <div><span class="label">Nome</span><div>${t.Nome}</div></div>
    <div><span class="label">Tipo Intervento</span><div>${tipo?tipo.Nome:'Generico'}</div></div>
  </div><h4>Voci (${voci.length})</h4><ul style="list-style:none;padding:0">`;
  voci.forEach((v,i)=>{html+=`<li style="padding:8px 12px;background:${i%2===0?'#F9FAFB':'#fff'};border-radius:4px">â˜ ${v}</li>`});
  html+='</ul>';
  $('detailTitle').textContent='âœ… Template: '+t.Nome;
  $('detailBody').innerHTML=html;
  $('detailFoot').innerHTML='<button class="btn btn-outline" onclick="closeModal(\'modalDetail\')">Chiudi</button>';
  openModal('modalDetail');
}

let checklistVociCount=0;
function addChecklistVoce(){
  const div=document.createElement('div');
  div.style.cssText='display:flex;gap:6px;align-items:center';
  div.innerHTML=`<input type="text" class="mcl-voce" placeholder="Voce ${++checklistVociCount}" style="flex:1;padding:6px;border:1.5px solid var(--gray3);border-radius:var(--radius-sm);font-size:.8125rem"><button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;color:var(--err);font-size:1.1rem">âœ•</button>`;
  $('mclVociList').appendChild(div);
}

async function saveChecklistTemplate(){
  const voci=[...document.querySelectorAll('.mcl-voce')].map(i=>i.value.trim()).filter(Boolean);
  if(!$('mclNome').value||!voci.length){toast('Nome e almeno 1 voce richiesti','err');return}
  try{
    await apiCall('createChecklistTemplate',{Nome:$('mclNome').value,TipoInterventoID:$('mclTipo').value,Voci:JSON.stringify(voci)},'POST');
    toast('Template creato','ok');closeModal('modalChecklist');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function deleteChecklistTpl(id){
  if(!confirm('Disattivare questo template?'))return;
  try{await apiCall('deleteChecklistTemplate',{id},'POST');toast('Template disattivato','ok');await refreshData(true)}catch(e){toast(e.message,'err')}
}

// ============ FEATURE 30a: DOCUMENTI ============
function renderDocumenti(){
  const docs=(DATA.documenti||[]).filter(d=>!d.Obsoleto&&d.Obsoleto!=='true');
  const search=($('filtDocSearch')?.value||'').toLowerCase();
  const cat=$('filtDocCat')?.value||'';
  const filtered=docs.filter(d=>{
    if(search&&!(d.Nome||'').toLowerCase().includes(search)&&!(d.Tags||'').toLowerCase().includes(search)&&!(d.Descrizione||'').toLowerCase().includes(search))return false;
    if(cat&&d.Categoria!==cat)return false;
    return true;
  });
  let html='<table class="data-table"><thead><tr><th>Nome</th><th>Categoria</th><th>Tags</th><th>Data</th><th>Azioni</th></tr></thead><tbody>';
  if(!filtered.length) html+='<tr><td colspan="5" style="text-align:center;color:var(--gray)">Nessun documento trovato</td></tr>';
  filtered.forEach(d=>{
    html+=`<tr><td><b>${d.Nome||''}</b><br><span style="font-size:.75rem;color:var(--gray)">${d.Descrizione||''}</span></td>
    <td><span class="tag tag-info">${d.Categoria||'Altro'}</span></td>
    <td style="font-size:.75rem">${d.Tags||''}</td>
    <td style="font-size:.75rem">${(d.DataCaricamento||'').substring(0,10)}</td>
    <td>
      ${d.FileURL?`<a href="${d.FileURL}" target="_blank" class="btn btn-outline btn-sm">ğŸ”— Apri</a>`:''}
      <button class="btn btn-outline btn-sm" onclick="deleteDoc('${d.ID}')" style="color:var(--err)">ğŸ—‘ï¸</button>
    </td></tr>`;
  });
  html+='</tbody></table>';
  $('tblDocumenti').innerHTML=html;
}

async function saveDocumento(){
  if(!$('mdNome').value){toast('Nome richiesto','err');return}
  const file=$('mdFile')?.files[0];
  const url=$('mdUrl')?.value;
  if(!file&&!url){toast('Carica un file oppure inserisci un URL','err');return}
  showToast('Salvataggio...','info');
  try{
    let fileUrl=url,fileId='',mimeType='',dimKB=0;
    if(file){
      if(file.size>20*1024*1024){toast('File troppo grande (max 20MB)','err');return}
      const base64=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file)});
      const up=await apiCall('uploadFile',{base64,mimeType:file.type,fileName:file.name,userId:USER?.ID},'POST');
      if(!up.success)throw new Error(up.error||'Errore upload');
      fileUrl=up.data.fileUrl;fileId=up.data.fileId;mimeType=file.type;dimKB=Math.round(file.size/1024);
    }
    await apiCall('createDocumento',{Nome:$('mdNome').value,FileURL:fileUrl,FileID:fileId,MimeType:mimeType,DimensioneKB:dimKB,Categoria:$('mdCategoria').value,Descrizione:$('mdDescrizione').value,Tags:$('mdTags').value,Pubblico:$('mdPubblico').value},'POST');
    toast('Documento salvato!','ok');closeModal('modalDocumento');$('mdFile').value='';$('mdFileLabel').textContent='';await refreshData(true);
  }catch(e){toast(e.message,'err')}
}
// ============ FEATURE 30b: ALLEGATI ============
function renderAllegati(){
  const all=(DATA.allegati||[]).filter(a=>!a.Obsoleto&&a.Obsoleto!=='true');
  const filtTipo=$('filtAllTipo')?.value||'';
  const filtered=all.filter(a=>!filtTipo||a.RiferimentoTipo===filtTipo);
  let html='<table class="data-table"><thead><tr><th>Nome</th><th>Collegato a</th><th>ID Rif.</th><th>Data</th><th>Azioni</th></tr></thead><tbody>';
  if(!filtered.length) html+='<tr><td colspan="5" style="text-align:center;color:var(--gray)">Nessun allegato</td></tr>';
  filtered.forEach(a=>{
    html+=`<tr><td><b>${a.Nome||''}</b></td><td>${a.RiferimentoTipo||'â€”'}</td><td style="font-family:JetBrains Mono;font-size:.75rem">${a.RiferimentoID||'â€”'}</td><td style="font-size:.75rem">${(a.DataUpload||'').substring(0,10)}</td>
    <td>${a.FileURL?`<a href="${a.FileURL}" target="_blank" class="btn btn-outline btn-sm">ğŸ”—</a>`:''} <button class="btn btn-outline btn-sm" onclick="deleteAll('${a.ID}')" style="color:var(--err)">ğŸ—‘ï¸</button></td></tr>`;
  });
  html+='</tbody></table>';
  $('tblAllegati').innerHTML=html;
}

async function saveAllegato(){
  if(!$('maName').value||!$('maUrl').value){toast('Nome e URL richiesti','err');return}
  try{
    await apiCall('createAllegato',{Nome:$('maName').value,FileURL:$('maUrl').value,RiferimentoTipo:$('maRefTipo').value,RiferimentoID:$('maRefId').value,Note:$('maNote').value},'POST');
    toast('Allegato aggiunto','ok');closeModal('modalAllegato');await refreshData(true);
  }catch(e){toast(e.message,'err')}
}

async function deleteAll(id){
  if(!confirm('Eliminare allegato?'))return;
  try{await apiCall('deleteAllegato',{id},'POST');toast('Eliminato','ok');await refreshData(true)}catch(e){toast(e.message,'err')}
}

// ============ FEATURE 31: EMAIL CONFIG ============
function renderEmailConfig(){
  const config=DATA.config||{};
  $('cfgEmailEnabled').checked=(config.email_enabled==='true');
  const events=(config.email_events||'').split(',').map(s=>s.trim());
  $('evtUrgenza').checked=events.includes('urgenza_creata');
  $('evtIntervento').checked=events.includes('intervento_assegnato');
  $('evtRichiesta').checked=events.includes('richiesta_risposta');
}

async function saveEmailConfig(){
  const events=[];
  if($('evtUrgenza').checked)events.push('urgenza_creata');
  if($('evtIntervento').checked)events.push('intervento_assegnato');
  if($('evtRichiesta').checked)events.push('richiesta_risposta');
  try{
    await apiCall('updateConfig',{key:'email_enabled',value:$('cfgEmailEnabled').checked?'true':'false'},'POST');
    await apiCall('updateConfig',{key:'email_events',value:events.join(',')},'POST');
    toast('Config email salvata!','ok');
  }catch(e){toast('Errore: '+e.message,'err')}
}

async function sendTestEmail(){
  const addr=$('testEmailAddr').value;
  if(!addr){toast('Inserisci email','err');return}
  try{const r=await apiCall('testEmail',{destinatario:addr},'POST');toast(r.sent?'Email inviata!':'Errore: '+(r.error||''),'ok');
  }catch(e){toast(e.message,'err')}
}

// ============ FEATURE 32: REPORT BUILDER ============
async function generateReportAdmin(){
  const tipo=$('rptTipo').value;
  try{
   const r=await apiCall('generateReport',{tipo,filtri:{dataInizio:$('rptDa').value,dataFine:$('rptA').value,tecnicoId:$('rptTecnico').value},userId:USER?.ID},'POST');
    let html=`<h3 style="margin-bottom:12px">${r.titolo}</h3><p style="font-size:.75rem;color:var(--gray);margin-bottom:12px">Generato: ${(r.generato||'').substring(0,19)}</p>`;
    html+='<table class="data-table"><thead><tr>';
    r.colonne.forEach(c=>{html+='<th>'+c+'</th>'});
    html+='</tr></thead><tbody>';
    if(!r.righe.length)html+='<tr><td colspan="'+r.colonne.length+'" style="text-align:center">Nessun dato</td></tr>';
    r.righe.forEach(row=>{
      html+='<tr>';row.forEach(cell=>{html+='<td>'+cell+'</td>'});html+='</tr>';
    });
    html+='</tbody></table>';
    $('reportOutput').innerHTML=html;
  }catch(e){toast(e.message,'err')}
}

function printReport(){
  const content=$('reportOutput').innerHTML;
  if(!content||content.includes('Nessun dato')){toast('Genera prima un report','err');return}
  const w=window.open('','','width=800,height=600');
  w.document.write('<html><head><title>Report Syntoniqa</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse;margin-top:16px}th,td{border:1px solid #ddd;padding:8px;text-align:left;font-size:12px}th{background:#050C14;color:white}</style></head><body>'+content+'</body></html>');
  w.document.close();
  w.print();
}

// ============ FEATURE 33: TELEGRAM CONFIG ============
function renderTelegramConfig(){
  const config=DATA.config||{};
  $('cfgTgToken').value=config.telegram_bot_token||'';
  
  const tecnici=(DATA.utenti||[]).filter(u=>u.Attivo&&u.Attivo!=='false'&&['tecnico','team_leader'].includes(u.Ruolo));
  let html='<table class="data-table"><thead><tr><th>Tecnico</th><th>Ruolo</th><th>Chat ID Telegram</th><th>Test</th></tr></thead><tbody>';
  tecnici.forEach(t=>{
    const chatId=config['telegram_chatid_'+t.ID]||'';
    html+=`<tr><td>${t.Nome} ${t.Cognome}</td><td>${t.Ruolo}</td>
    <td><input type="text" id="tgchat_${t.ID}" value="${chatId}" placeholder="Chat ID" style="padding:4px 8px;border:1px solid var(--gray3);border-radius:4px;font-size:.75rem;width:140px;font-family:JetBrains Mono"></td>
    <td><button class="btn btn-outline btn-sm" onclick="testTgForTec('${t.ID}')">ğŸ“¤</button></td></tr>`;
  });
  html+='</tbody></table>';
  $('tblTelegramIds').innerHTML=html;
}

async function saveTelegramConfig(){
  const token = $('cfgTgToken').value.trim();
  if(!token){toast('Inserisci il bot token','err');return;}
  try {
    await apiCall('saveConfig',{key:'telegram_bot_token',value:token},'POST');
    toast('âœ… Bot token salvato!','ok');
  } catch(e){ toast('âŒ Errore: '+e.message,'err'); }

  // Salva anche i chat ID di ogni tecnico
  const tecnici=(DATA.utenti||[]).filter(
    u=>u.Attivo&&u.Attivo!=='false'
      &&['tecnico','team_leader'].includes(u.Ruolo));
  for(const t of tecnici){
    const el=document.getElementById('tgchat_'+t.ID);
    if(el && el.value.trim()){
      try {
        await apiCall('saveConfig',{
          key:'telegram_chatid_'+t.ID,
          value:el.value.trim()
        },'POST');
      } catch(e){ console.warn('Err save chatid '+t.ID,e); }
    }
  }
  toast('âœ… Configurazione Telegram completa!','ok');
}
async function sendTestTelegram(){
  const chatId=$('testTgChatId').value;
  if(!chatId){toast('Inserisci Chat ID','err');return}
  try{const r=await apiCall('testTelegram',{chatId},'POST');toast(r.sent?'Messaggio inviato!':'Errore: '+(r.reason||''),r.sent?'ok':'err')}catch(e){toast(e.message,'err')}
}

async function testTgForTec(tecId){
  const chatId=document.getElementById('tgchat_'+tecId)?.value?.trim();
  if(!chatId){toast('Inserisci Chat ID per questo tecnico','warn');return}
  try{const r=await apiCall('testTelegram',{chatId},'POST');toast(r.sent?'Test OK!':'Errore: '+(r.reason||''),r.sent?'ok':'err')}catch(e){toast(e.message,'err')}
}

// Telegram Broadcast
async function sendTelegramBroadcast(){
  const text=$('tgMsgText')?.value?.trim();
  if(!text){toast('Scrivi un messaggio','warn');return}
  const dest=$('tgMsgDest')?.value||'all';
  const config=DATA.config||{};
  const token=config.telegram_bot_token;
  if(!token){toast('Configura prima il Bot Token','err');return}
  const tecnici=(DATA.utenti||[]).filter(u=>u.Attivo&&u.Attivo!=='false'&&['tecnico','team_leader'].includes(u.Ruolo));
  let sent=0,fail=0;
  for(const t of tecnici){
    if(dest!=='all'&&t.ID!==dest)continue;
    const chatId=config['telegram_chatid_'+t.ID];
    if(!chatId)continue;
    try{
      const r=await apiCall('testTelegram',{chatId,message:text},'POST');
      if(r.sent)sent++;else fail++;
    }catch(e){fail++}
  }
  toast('Inviato a '+sent+' tecnici'+(fail?' ('+fail+' errori)':''),'ok');
  $('tgMsgText').value='';
}

// Telegram Group / Channel
async function saveTelegramGroup(){
  const group=$('cfgTgGroup')?.value?.trim();
  if(!group){toast('Inserisci link/ID gruppo','warn');return}
  try{
    await apiCall('saveConfig',{key:'telegram_group_generale',value:group},'POST');
    toast('Gruppo/Canale Telegram salvato!','ok');
  }catch(e){toast(e.message,'err')}
}

function openTelegramGroup(){
  const config=DATA.config||{};
  let group=config.telegram_group_generale||$('cfgTgGroup')?.value?.trim()||'';
  if(!group){toast('Configura prima il link del gruppo/canale','warn');return}
  if(group.startsWith('@'))group='https://t.me/'+group.substring(1);
  else if(!group.startsWith('http'))group='https://t.me/'+group;
  window.open(group,'_blank');
}

function openTelegramBot(){
  const config=DATA.config||{};
  const token=config.telegram_bot_token||'';
  if(!token){toast('Configura prima il Bot Token','warn');return}
  // Extract bot username from token (not possible directly, but user can set it)
  toast('Apri Telegram e cerca il tuo bot per avviare la chat','info');
}

// Populate Telegram dest select + group field on render
function renderTelegramExtras(){
  const config=DATA.config||{};
  const sel=$('tgMsgDest');
  if(sel){
    sel.innerHTML='<option value="all">ğŸ”” Tutti i tecnici con Chat ID</option>';
    const tecnici=(DATA.utenti||[]).filter(u=>u.Attivo&&u.Attivo!=='false'&&['tecnico','team_leader'].includes(u.Ruolo));
    tecnici.forEach(t=>{
      const chatId=config['telegram_chatid_'+t.ID];
      if(chatId)sel.innerHTML+='<option value="'+t.ID+'">'+t.Nome+' '+t.Cognome+'</option>';
    });
  }
  const grp=$('cfgTgGroup');
  if(grp)grp.value=config.telegram_group_generale||'';
  const btn=$('btnOpenTgBot');
  if(btn&&config.telegram_bot_token)btn.style.display='';
}

// ============ FEATURE 34: BACKUP ============
async function loadBackupHistory(){
  const config=DATA.config||{};
  $('cfgBackupFolder').value=config.backup_folder_id||'';
  try{
    const hist=await apiCall('getBackupHistory');
    if(!hist||!hist.length){$('tblBackupHistory').innerHTML='<div class="empty"><p>Nessun backup trovato. Configura la cartella e fai il primo backup.</p></div>';return}
    let html='<table class="data-table"><thead><tr><th>Nome</th><th>Data</th><th>Dimensione</th><th>Link</th></tr></thead><tbody>';
    hist.forEach(b=>{
      html+=`<tr><td>${b.name}</td><td>${(b.date||'').substring(0,16).replace('T',' ')}</td><td>${b.size} KB</td><td><a href="${b.url}" target="_blank" class="btn btn-outline btn-sm">ğŸ”— Apri</a></td></tr>`;
    });
    html+='</tbody></table>';
    $('tblBackupHistory').innerHTML=html;
  }catch(e){$('tblBackupHistory').innerHTML='<div class="empty"><p>'+e.message+'</p></div>'}
}

async function saveBackupConfig(){
  toast('Salva backup_folder_id nel foglio Config: '+$('cfgBackupFolder').value,'ok');
}

async function runBackupNow(){
  try{toast('Backup in corso...','ok');const r=await apiCall('backupNow',{},'POST');
    if(r.success)toast('Backup completato: '+r.name,'ok');else toast('Errore: '+(r.reason||''),'err');
    await loadBackupHistory();
  }catch(e){toast(e.message,'err')}
}

// ============ KEYBOARD SHORTCUTS ============
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){document.querySelectorAll('.modal-overlay.show').forEach(m=>m.classList.remove('show'))}
});


// ============ PLANNER VISUALE ============
let PLANNER_DATE = new Date();
let PLANNER_DRAGGING = null;

function initPlanner(){
  const d = new Date();
  const day = d.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  PLANNER_DATE = new Date(d);
  PLANNER_DATE.setDate(d.getDate() + diff);
  PLANNER_DATE.setHours(0,0,0,0);
  // Populate tecnici filter
  const sel = document.getElementById('plannerFiltroTec');
  if(sel){
    const tecs = (DATA.utenti||[]).filter(u => !u.Obsoleto && (u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
    tecs.forEach(t => {
      const o = document.createElement('option');
      o.value = t.ID;
      o.textContent = (t.Nome||'') + ' ' + (t.Cognome||'');
      sel.appendChild(o);
    });
  }
  renderPlanner();
}

function plannerNav(dir){
  PLANNER_DATE.setDate(PLANNER_DATE.getDate() + dir * 7);
  renderPlanner();
}

function renderPlanner(){
  if(!document.getElementById('plannerGrid')) return;
  const filtTec = document.getElementById('plannerFiltroTec')?.value || '';
  const showUrg = document.getElementById('plannerShowUrg')?.checked !== false;
  const showLiberi = document.getElementById('plannerShowLiberi')?.checked;

  const week = [];
  for(let i = 0; i < 7; i++){
    const d = new Date(PLANNER_DATE);
    d.setDate(PLANNER_DATE.getDate() + i);
    week.push(d);
  }

  const fmt = d => d.toLocaleDateString('it-IT', {day:'2-digit', month:'short'});
  const titleEl = document.getElementById('plannerTitle');
  if(titleEl) titleEl.textContent = fmt(week[0]) + ' - ' + fmt(week[6]) + ' ' + week[0].getFullYear();

  let tecnici = (DATA.utenti||[]).filter(u => !u.Obsoleto && (u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
  if(filtTec) tecnici = tecnici.filter(u => u.ID === filtTec);

  const weekStrs = week.map(d => d.toISOString().split('T')[0]);
  const piano = (DATA.piano||[]).filter(p => !p.Obsoleto && weekStrs.includes(p.Data));
  // Urgenze: usa DataPrevista (se presente), altrimenti DataScadenzaSLA
  const urgenze = showUrg ? (DATA.urgenze||[]).filter(u => {
    if(u.Obsoleto || u.Stato === 'risolta') return false;
    const dateStr = (u.DataPrevista || u.DataScadenzaSLA || '').split('T')[0];
    return weekStrs.includes(dateStr);
  }) : [];

  const statoColor = {
    'pianificato':'#6366F1','in_corso':'#2563EB','completato':'#10B981',
    'chiuso':'#6B7280','da_rivedere':'#F59E0B','annullato':'#EF4444'
  };
  const statoLabel = {
    'pianificato':'Pianificato','in_corso':'In corso','completato':'Completato',
    'chiuso':'Chiuso','da_rivedere':'Da rivedere','annullato':'Annullato'
  };
  const prioColor = {'1':'#7F1D1D','2':'#DC2626','3':'#D97706','4':'#65A30D','5':'#22C55E','CRITICA':'#7F1D1D','ALTA':'#DC2626','MEDIA':'#D97706','BASSA':'#65A30D'};
  const dayNames = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];
  const todayStr = today();

  let html = '<table style="width:100%;border-collapse:collapse;table-layout:fixed"><thead><tr>';
  html += '<th style="width:120px;padding:8px;background:#F9FAFB;border:1px solid #E5E7EB;font-size:.75rem;font-weight:600;color:#6B7280">Tecnico</th>';

  week.forEach((d, i) => {
    const ds = d.toISOString().split('T')[0];
    const isToday = ds === todayStr;
    const cnt = piano.filter(p => p.Data === ds).length;
    const cntU = urgenze.filter(u => (u.DataPrevista||u.DataScadenzaSLA||'').split('T')[0]===ds).length;
    html += '<th style="padding:8px 4px;background:' + (isToday?'#FEF3C7':'#F9FAFB') + ';border:1px solid #E5E7EB;font-size:.75rem;font-weight:600;color:' + (isToday?'#92400E':'#374151') + ';cursor:pointer" onclick="showPlannerDay(\''+ds+'\')"><div>' + dayNames[i] + ' ' + d.getDate() + '/' + (d.getMonth()+1) + '</div>';
    if(cnt>0) html += '<span style="background:#6366F1;color:white;border-radius:10px;padding:1px 6px;font-size:.6rem">' + cnt + '</span> ';
    if(cntU>0) html += '<span style="background:#DC2626;color:white;border-radius:10px;padding:1px 6px;font-size:.6rem">' + cntU + ' urg</span>';
    html += '</th>';
  });
  html += '</tr></thead><tbody>';

  tecnici.forEach(tec => {
    const totWeek = piano.filter(p => p.TecnicoID===tec.ID||(p.TecniciIDs||'').includes(tec.ID)).length;
    const nome = (tec.Nome||'') + ' ' + (tec.Cognome||'').substring(0,1) + '.';
    html += '<tr><td style="padding:6px 8px;border:1px solid #E5E7EB;font-size:.75rem;font-weight:500;background:#F9FAFB"><div style="display:flex;align-items:center;gap:6px"><div style="width:28px;height:28px;border-radius:50%;background:#00C9A7;color:#050C14;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;flex-shrink:0">' + (tec.Nome||'?').substring(0,1) + (tec.Cognome||'').substring(0,1) + '</div><div><div style="white-space:nowrap">' + nome + '</div><div style="color:#9CA3AF;font-size:.6rem">' + totWeek + ' int/sett</div></div></div></td>';

    week.forEach(d => {
      const ds = d.toISOString().split('T')[0];
      const dayItems = piano.filter(p => p.Data===ds && (p.TecnicoID===tec.ID||(p.TecniciIDs||'').includes(tec.ID)));
      const dayUrg = showUrg ? urgenze.filter(u => (u.TecnicoAssegnato||u.TecnicoID)===tec.ID && (u.DataPrevista||u.DataScadenzaSLA||'').split('T')[0]===ds) : [];
      const isEmpty = dayItems.length === 0 && dayUrg.length === 0;
      const isWeekend = d.getDay() === 0 || d.getDay() === 6;

      html += '<td style="padding:4px;border:1px solid #E5E7EB;vertical-align:top;min-height:70px;background:' + (isWeekend?'#F3F4F6':isEmpty&&showLiberi?'#F0FDF4':'white') + '" ondragover="event.preventDefault()" ondrop="onPlannerDrop(event,\'' + tec.ID + '\',\'' + ds + '\')">';

      dayUrg.forEach(u => {
        const prio = getName(DATA.priorita||[],u.PrioritaID);
        const col = prioColor[u.PrioritaID]||prioColor[prio]||'#6B7280';
        html += '<div draggable="true" ondragstart="onPlannerDragStart(event,\'urgenza\',\'' + u.ID + '\')" style="background:' + col + '22;border-left:3px solid ' + col + ';padding:3px 5px;margin-bottom:2px;border-radius:0 4px 4px 0;font-size:.67rem;cursor:grab;position:relative" onclick="showPlannerItem(\'urgenza\',\'' + u.ID + '\')" title="Urgenza: '+(u.Problema||'').replace(/"/g,'')+' â€” Clicca per dettagli, trascina per spostare">&#x1F6A8; ' + (u.Problema||'').substring(0,20) + '</div>';
      });

      dayItems.forEach(p => {
        const col = statoColor[p.Stato]||'#6366F1';
        const cli = getName(DATA.clienti||[], p.ClienteID);
        const tipoInt = getName(DATA.tipiIntervento||[], p.TipoInterventoID);
        html += '<div draggable="true" ondragstart="onPlannerDragStart(event,\'piano\',\'' + p.ID + '\')" style="background:' + col + '18;border-left:3px solid ' + col + ';padding:3px 5px;margin-bottom:2px;border-radius:0 4px 4px 0;font-size:.67rem;cursor:grab;position:relative" onclick="showPlannerItem(\'piano\',\'' + p.ID + '\')" title="'+cli+' â€” '+(statoLabel[p.Stato]||p.Stato)+' â€” Clicca per modificare/cancellare, trascina per spostare">' + (p.OraInizio?'<strong>'+p.OraInizio+'</strong> ':'') + cli.substring(0,20) + '</div>';
      });

      if(isEmpty && showLiberi && !isWeekend) html += '<div style="color:#86EFAC;font-size:.65rem;text-align:center;padding:6px 0">libero</div>';
      html += '</td>';
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('plannerGrid').innerHTML = html;

  // --- LEGENDA CHIARA E DETTAGLIATA ---
  const legEl = document.getElementById('plannerLegend');
  if(legEl){
    let leg = '<div style="display:flex;flex-direction:column;gap:10px;font-size:.8rem">';
    // Sezione 1: Stato interventi
    leg += '<div><strong style="font-size:.8125rem;color:#374151">Colori Stato Intervento:</strong><div style="display:flex;gap:14px;flex-wrap:wrap;margin-top:4px">';
    Object.entries(statoColor).forEach(([s,c]) => {
      leg += '<span style="display:flex;align-items:center;gap:5px"><span style="width:12px;height:12px;background:'+c+';border-radius:2px;display:inline-block;border:1px solid '+c+'"></span><span style="color:#4B5563">'+(statoLabel[s]||s)+'</span></span>';
    });
    leg += '</div></div>';
    // Sezione 2: Urgenze
    leg += '<div><strong style="font-size:.8125rem;color:#374151">PrioritÃ  Urgenze (&#x1F6A8;):</strong><div style="display:flex;gap:14px;flex-wrap:wrap;margin-top:4px">';
    const prioNames = {'1':'Critica','2':'Alta','3':'Media','4':'Bassa','5':'Molto Bassa'};
    ['1','2','3','4','5'].forEach(k => {
      const c = prioColor[k]||'#6B7280';
      leg += '<span style="display:flex;align-items:center;gap:5px"><span style="width:12px;height:12px;background:'+c+';border-radius:2px;display:inline-block"></span><span style="color:#4B5563">'+(prioNames[k]||k)+'</span></span>';
    });
    leg += '</div></div>';
    // Sezione 3: Istruzioni rapide
    leg += '<div style="color:#6B7280;font-size:.75rem;border-top:1px solid #E2E8F0;padding-top:8px">';
    leg += '<strong>Come usare:</strong> ';
    leg += '&#x1F446; <b>Clicca</b> su un intervento per modificarlo o cancellarlo Â· ';
    leg += '&#x270B; <b>Trascina</b> un intervento su un\'altra cella per spostarlo (cambia tecnico e/o giorno) Â· ';
    leg += '&#x1F4C5; <b>Clicca</b> sulla data in intestazione per vedere il riepilogo del giorno Â· ';
    leg += '&#x2795; Usa il bottone <b>\"+ Intervento\"</b> in alto per aggiungerne uno nuovo';
    leg += '</div>';
    leg += '</div>';
    legEl.innerHTML = leg;
  }
}

function onPlannerDragStart(e, type, id){
  PLANNER_DRAGGING = { type, id };
  e.dataTransfer.effectAllowed = 'move';
}

async function onPlannerDrop(e, tecnicoId, data){
  e.preventDefault();
  if(!PLANNER_DRAGGING) return;
  const { type, id } = PLANNER_DRAGGING;
  PLANNER_DRAGGING = null;
  try {
    if(type === 'piano'){
      await apiCall('updatePiano', { id, TecnicoID: tecnicoId, Data: data }, 'POST');
      toast('Intervento spostato a ' + data + ' â†’ ' + getName(DATA.utenti||[],tecnicoId), 'ok');
    } else if(type === 'urgenza'){
      await apiCall('updateUrgenza', { id, TecnicoAssegnato: tecnicoId, DataPrevista: data }, 'POST');
      toast('Urgenza spostata a ' + data + ' â†’ ' + getName(DATA.utenti||[],tecnicoId), 'ok');
    }
    await refreshData(true);
    renderPlanner();
  } catch(err){ toast(err.message, 'err') }
}

function showPlannerItem(type, id){ if(type==='piano') showDetail('piano',id); else showDetail('urgenza',id); }

function showPlannerDay(ds){
  const items = (DATA.piano||[]).filter(p => !p.Obsoleto && p.Data === ds);
  const urgs = (DATA.urgenze||[]).filter(u => !u.Obsoleto && (u.DataPrevista||u.DataScadenzaSLA||'').split('T')[0]===ds);
  let html = '<h4 style="margin-bottom:10px">ğŸ“… ' + fmtDate(ds) + ' â€” ' + items.length + ' interventi, ' + urgs.length + ' urgenze</h4>';
  if(items.length){
    html += '<div style="margin-bottom:8px">';
    html += items.sort((a,b)=>(a.OraInizio||'').localeCompare(b.OraInizio||'')).map(p=>{
      const tec = getName(DATA.utenti||[],p.TecnicoID);
      const cli = getName(DATA.clienti||[],p.ClienteID);
      const tipo = getName(DATA.tipiIntervento||[],p.TipoInterventoID);
      return '<div style="padding:8px 12px;border-left:3px solid #6366F1;margin-bottom:6px;background:#F5F3FF;border-radius:0 6px 6px 0;display:flex;justify-content:space-between;align-items:center"><div><strong>'+(p.OraInizio||'--:--')+'</strong> '+tec+' â†’ '+cli+' <span style="color:#6B7280;font-size:.75rem">('+tipo+')</span> '+statusTag(p.Stato)+'</div><div style="display:flex;gap:4px"><button class="btn btn-sm btn-outline" onclick="showPlannerItem(\'piano\',\''+p.ID+'\')" title="Modifica">âœï¸</button><button class="btn btn-sm" style="color:#EF4444;background:transparent;border:1px solid #FECACA" onclick="deletePlannerItem(\'piano\',\''+p.ID+'\')" title="Cancella">ğŸ—‘ï¸</button></div></div>';
    }).join('');
    html += '</div>';
  }
  if(urgs.length){
    html += '<hr style="margin:8px 0"><strong>ğŸš¨ Urgenze:</strong>';
    html += urgs.map(u=>{
      const prio = getName(DATA.priorita||[],u.PrioritaID);
      const cli = getName(DATA.clienti||[],u.ClienteID);
      return '<div style="padding:8px 12px;border-left:3px solid #DC2626;margin-bottom:4px;background:#FEF2F2;border-radius:0 6px 6px 0;display:flex;justify-content:space-between;align-items:center"><div>&#x1F6A8; <strong>'+prio+'</strong> â€” '+(u.Problema||'')+' â€” '+cli+'</div><div><button class="btn btn-sm btn-outline" onclick="showPlannerItem(\'urgenza\',\''+u.ID+'\')" title="Dettagli">ğŸ‘ï¸</button></div></div>';
    }).join('');
  }
  if(!items.length && !urgs.length) html = '<p style="color:var(--gray)">Nessun intervento pianificato per questo giorno. Usa \"+ Intervento\" per aggiungerne uno.</p>';
  const el = document.getElementById('plannerDayDetail');
  if(el) el.innerHTML = html;
}

async function deletePlannerItem(type, id){
  if(!confirm('Sei sicuro di voler cancellare questo '+(type==='piano'?'intervento':'urgenza')+'?')) return;
  try {
    if(type === 'piano'){
      await apiCall('updatePiano', { id, Obsoleto: true }, 'POST');
      toast('Intervento cancellato', 'ok');
    } else {
      await apiCall('updateUrgenza', { id, Obsoleto: true }, 'POST');
      toast('Urgenza cancellata', 'ok');
    }
    await refreshData(true);
    renderPlanner();
    const el = document.getElementById('plannerDayDetail');
    if(el) el.innerHTML = '<p style="color:var(--gray)">Elemento cancellato. Clicca su un giorno per aggiornare.</p>';
  } catch(err){ toast('Errore: '+err.message, 'err') }
}

async function runAIPlanner(){
  const week = [];
  for(let i=0;i<7;i++){ const d=new Date(PLANNER_DATE); d.setDate(d.getDate()+i); week.push(d.toISOString().split('T')[0]); }
  const urgenze = (DATA.urgenze||[]).filter(u=>!u.Obsoleto&&u.Stato!=='risolta');
  const tecnici = (DATA.utenti||[]).filter(u=>!u.Obsoleto&&(u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
  const prompt = 'Genera piano ottimizzato settimana '+week[0]+' - '+week[6]+'. Tecnici: '+tecnici.map(t=>t.Nome).join(', ')+'. Urgenze aperte: '+urgenze.length+' ('+urgenze.filter(u=>u.Priorita==='CRITICA').length+' CRITICHE). Rispetta SLA, ottimizza geo, distribuisci carico.';
  try {
    toast('AI sta generando il piano...','warn');
    const result = await apiCall('generateAIPlan',{vincoli:{testo:prompt}},'POST');
    AI_PLAN = result;
    const el = document.getElementById('aiResult');
    if(el){ el.style.display='block'; el.innerHTML='<h4>Piano AI generato dal Planner Visuale</h4><p style="font-size:.8125rem;color:var(--gray)">Settimana '+week[0]+' â€” '+week[6]+' Â· '+tecnici.length+' tecnici Â· '+(result.piano?.length||0)+' interventi</p><pre style="white-space:pre-wrap;font-size:.75rem;max-height:400px;overflow-y:auto">'+JSON.stringify(result,null,2)+'</pre>'; }
    const btn = document.getElementById('btnApplyAI');
    if(btn) btn.disabled = false;
    toast('Piano AI generato! Apro AI Planner...','ok');
    // Naviga alla sezione AI Planner per mostrare il risultato e applicarlo
    setTimeout(()=>showSec('ai'),800);
  } catch(e){ toast('Errore AI: '+e.message,'err') }
}

async function geocodeAllClienti(){
  try {
    toast('Geocodifica in corso... attendere 30-60 secondi','warn');
    const r = await apiCall('geocodeAll',{},'POST');
    toast('Geocodificati: '+r.updated+' clienti. Falliti: '+(r.errors||0),'ok');
    await refreshData(true);
    if(MAP) updateMap();
  } catch(e){ toast('Errore geocodifica: '+e.message,'err') }
}

// ============ KPI CON CHART.JS ============
let CHARTS = {};

async function loadKPIWithCharts(){
  await loadKPI();
  Object.values(CHARTS).forEach(c => { try{c.destroy()}catch(e){} });
  CHARTS = {};
  const piano = (DATA.piano||[]).filter(p => !p.Obsoleto);
  const filtTec = document.getElementById('kpiTecnico')?.value || '';
  const periodo = document.getElementById('kpiPeriodo')?.value || 'settimana';

  // Chart 1: Interventi per mese (last 7 months)
  const monthLabels = [], monthData = [];
  for(let i=6;i>=0;i--){
    const d=new Date(); d.setMonth(d.getMonth()-i);
    const ym=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    monthLabels.push(d.toLocaleDateString('it-IT',{month:'short',year:'2-digit'}));
    monthData.push(piano.filter(p=>p.Data?.startsWith(ym)&&(!filtTec||p.TecnicoID===filtTec)).length);
  }
  const ctxM = document.getElementById('chartMensile')?.getContext('2d');
  if(ctxM) CHARTS.mensile = new Chart(ctxM, {
    type:'bar', data:{ labels:monthLabels, datasets:[{ label:'Interventi', data:monthData, backgroundColor:'#00C9A7', borderRadius:6, borderSkipped:false }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
      scales:{ y:{ beginAtZero:true, ticks:{stepSize:1}, grid:{color:'#F3F4F6'} }, x:{grid:{display:false}} } }
  });

  // Chart 2: Doughnut stati
  const stati = {};
  piano.filter(p=>!filtTec||p.TecnicoID===filtTec).forEach(p=>{const s=p.Stato||'altro';stati[s]=(stati[s]||0)+1;});
  const statoColors = {'pianificato':'#6366F1','in_corso':'#2563EB','completato':'#10B981','chiuso':'#6B7280','da_rivedere':'#F59E0B','annullato':'#EF4444'};
  const ctxS = document.getElementById('chartStati')?.getContext('2d');
  if(ctxS && Object.keys(stati).length > 0) CHARTS.stati = new Chart(ctxS, {
    type:'doughnut', data:{ labels:Object.keys(stati), datasets:[{ data:Object.values(stati), backgroundColor:Object.keys(stati).map(s=>statoColors[s]||'#9CA3AF'), borderWidth:2, borderColor:'white' }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{font:{size:11},boxWidth:12} } } }
  });

  // Charts 3 & 4: Per tecnico
  // Calcolo KPI tecnici da DATA â€” no API call (risposta non compatibile con formato atteso)
  const allTecnici=(DATA.utenti||[]).filter(u=>!u.Obsoleto&&(u.Ruolo==='tecnico'||u.Ruolo==='caposquadra'));
  const kpiData=allTecnici.map(t=>{
    const tp=piano.filter(p=>p.TecnicoID===t.ID);
    const co=tp.filter(p=>p.Stato==='completato'||p.Stato==='chiuso').length;
    return {nome:(t.Nome||'').split(' ')[0],slaCompliance:tp.length>0?Math.round(co/tp.length*100):100,oreTotali:parseFloat(tp.reduce((s,p)=>s+parseFloat(p.DurataOre||0),0).toFixed(1))};
  }).filter(t=>t.oreTotali>0);
  if(kpiData.length>0){
    const tecNames=kpiData.map(t=>t.nome);
    const tecSLA=kpiData.map(t=>t.slaCompliance);
    const tecOre=kpiData.map(t=>t.oreTotali);
    const ctxSLA=document.getElementById('chartSLATec')?.getContext('2d');
    if(ctxSLA) CHARTS.sla=new Chart(ctxSLA,{
      type:'bar',data:{labels:tecNames,datasets:[{label:'SLA %',data:tecSLA,backgroundColor:tecSLA.map(v=>v>=90?'#10B981':v>=75?'#F59E0B':'#EF4444'),borderRadius:4}]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
        scales:{x:{min:0,max:100,ticks:{callback:v=>v+'%'},grid:{color:'#F3F4F6'}},y:{grid:{display:false}}}}
    });
    const ctxOre=document.getElementById('chartOreTec')?.getContext('2d');
    if(ctxOre) CHARTS.ore=new Chart(ctxOre,{
      type:'bar',data:{labels:tecNames,datasets:[{label:'Ore',data:tecOre,backgroundColor:'#6366F1',borderRadius:4,borderSkipped:false}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
        scales:{y:{beginAtZero:true,grid:{color:'#F3F4F6'}},x:{grid:{display:false}}}}
    });
  }
}

</script>

<!-- ============ SERVICE WORKER + PUSH NOTIFICATIONS (FIX F-30) ============ -->
<script>
// SW Registration
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(reg=>{
    console.log('[SW] Registered:', reg.scope);
    setInterval(()=>reg.update(), 30*60*1000);
    reg.addEventListener('updatefound',()=>{
      const nw=reg.installing;
      nw.addEventListener('statechange',()=>{
        if(nw.state==='installed'&&navigator.serviceWorker.controller){
          toast('ğŸ”„ Nuova versione disponibile â€” ricarica la pagina','warn');
          nw.postMessage('SKIP_WAITING');
        }
      });
    });
  }).catch(e=>console.warn('[SW] Registration failed:', e));
  navigator.serviceWorker.addEventListener('message',event=>{
    if(event.data.type==='SYNC_COMPLETE'){toast('âœ… '+event.data.message,'ok');refreshData()}
    if(event.data.type==='ACTION_QUEUED'){toast('ğŸ“¡ '+event.data.message,'warn')}
  });
}
window.addEventListener('online',()=>{toast('âœ… Online!','ok');if(navigator.serviceWorker?.controller)navigator.serviceWorker.controller.postMessage('ONLINE');refreshData()});
window.addEventListener('offline',()=>{toast('ğŸ“¡ Sei offline â€” le azioni verranno sincronizzate','warn')});

// Push Subscription Manager
const PushManager = {
  async init(){
    if(!('PushManager' in window) || !('serviceWorker' in navigator)) return;
    try {
      const reg = await navigator.serviceWorker.ready;
      const existing = await reg.pushManager.getSubscription();
      if(existing) { console.log('[Push] Already subscribed'); return; }
      // Get VAPID key from API
      const r = await apiCall('getVapidPublicKey', {});
      if(!r?.vapidPublicKey) { console.log('[Push] No VAPID key configured'); return; }
      this.vapidKey = r.vapidPublicKey;
    } catch(e){ console.warn('[Push] Init error:', e); }
  },
  
  async subscribe(){
    if(!this.vapidKey) { toast('Push non configurato sul server','warn'); return false; }
    try {
      if(Notification.permission === 'denied'){ toast('Notifiche bloccate dal browser','err'); return false; }
      const perm = await Notification.requestPermission();
      if(perm !== 'granted'){ toast('Permesso notifiche negato','warn'); return false; }
      
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: this.urlB64ToUint8(this.vapidKey)
      });
      
      // Save to server
      const subJson = sub.toJSON();
      await apiCall('savePushSubscription', {
        userId: USER?.ID,
        subscription: { endpoint: subJson.endpoint, keys: subJson.keys },
        userAgent: navigator.userAgent
      }, 'POST');
      
      toast('Notifiche push attivate âœ…','ok');
      return true;
    } catch(e){ toast('Errore attivazione push: ' + e.message,'err'); return false; }
  },
  
  async unsubscribe(){
    try {
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      if(sub){
        const endpoint = sub.endpoint;
        await sub.unsubscribe();
        await apiCall('removePushSubscription', { userId: USER?.ID, endpoint }, 'POST');
      }
      toast('Notifiche push disattivate','info');
    } catch(e){ toast('Errore: ' + e.message,'err'); }
  },
  
  async isSubscribed(){
    try {
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      return !!sub;
    } catch{ return false; }
  },
  
  urlB64ToUint8(base64String){
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g,'+').replace(/_/g,'/');
    const raw = atob(base64);
    return Uint8Array.from([...raw].map(c=>c.charCodeAt(0)));
  }
};

// Auto-init push after login
const origEnterApp = typeof enterApp === 'function' ? enterApp : null;
if(origEnterApp){
  const _origEnter = enterApp;
  enterApp = function(){
    _origEnter.apply(this, arguments);
    setTimeout(()=>PushManager.init(), 2000);
  };
}
</script>

<!-- ============ TOUCH DRAG & DROP POLYFILL (FIX F-27/F-28/B-005) ============ -->
<script>
(function(){
  // Touch Drag & Drop for Planner â€” replaces HTML5 drag API on touch devices
  let touchDragEl = null;
  let touchClone = null;
  let touchData = null;
  let longPressTimer = null;
  const LONG_PRESS_MS = 400;

  document.addEventListener('touchstart', function(e){
    const el = e.target.closest('[draggable="true"]');
    if(!el) return;
    
    const touch = e.touches[0];
    const startX = touch.clientX;
    const startY = touch.clientY;
    
    longPressTimer = setTimeout(function(){
      // Long press detected â€” start drag
      touchDragEl = el;
      
      // Extract drag data from ondragstart attribute
      const attr = el.getAttribute('ondragstart') || '';
      const match = attr.match(/onPlannerDragStart\(event,'(\w+)','([^']+)'\)/);
      if(match) touchData = { type: match[1], id: match[2] };
      
      // Create visual clone
      touchClone = el.cloneNode(true);
      touchClone.style.cssText = 'position:fixed;z-index:10000;pointer-events:none;opacity:0.85;transform:scale(1.05);box-shadow:0 8px 25px rgba(0,0,0,.25);transition:none;width:'+el.offsetWidth+'px;';
      touchClone.style.left = (startX - 20) + 'px';
      touchClone.style.top = (startY - 15) + 'px';
      document.body.appendChild(touchClone);
      
      // Vibrate feedback
      if(navigator.vibrate) navigator.vibrate(30);
      
      // Highlight drop targets
      document.querySelectorAll('[ondrop]').forEach(td=>{
        td.style.outline = '2px dashed var(--c1, #00C9A7)';
        td.style.outlineOffset = '-2px';
      });
      
      el.style.opacity = '0.3';
    }, LONG_PRESS_MS);
  }, {passive: true});

  document.addEventListener('touchmove', function(e){
    if(!touchClone) {
      // Cancel long press if finger moves too much
      if(longPressTimer){
        const touch = e.touches[0];
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      return;
    }
    e.preventDefault(); // Prevent scroll during drag
    const touch = e.touches[0];
    touchClone.style.left = (touch.clientX - 20) + 'px';
    touchClone.style.top = (touch.clientY - 15) + 'px';
    
    // Highlight cell under finger
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    document.querySelectorAll('[ondrop].touch-hover').forEach(td=>td.classList.remove('touch-hover'));
    const dropTarget = target?.closest?.('[ondrop]');
    if(dropTarget) dropTarget.classList.add('touch-hover');
  }, {passive: false});

  document.addEventListener('touchend', function(e){
    clearTimeout(longPressTimer);
    longPressTimer = null;
    
    if(!touchClone || !touchData) {
      cleanupTouchDrag();
      return;
    }
    
    const touch = e.changedTouches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    const dropTarget = target?.closest?.('[ondrop]');
    
    if(dropTarget && touchData) {
      // Extract drop handler params from ondrop attribute
      const attr = dropTarget.getAttribute('ondrop') || '';
      const match = attr.match(/onPlannerDrop\(event,'([^']+)','([^']+)'\)/);
      if(match) {
        const tecnicoId = match[1];
        const data = match[2];
        // Set PLANNER_DRAGGING and call drop handler
        if(typeof PLANNER_DRAGGING !== 'undefined') {
          PLANNER_DRAGGING = touchData;
        }
        // Call the drop function directly
        onPlannerDrop({ preventDefault:function(){} }, tecnicoId, data);
      }
    }
    
    cleanupTouchDrag();
  }, {passive: true});

  document.addEventListener('touchcancel', function(){
    clearTimeout(longPressTimer);
    longPressTimer = null;
    cleanupTouchDrag();
  }, {passive: true});

  function cleanupTouchDrag(){
    if(touchClone && touchClone.parentNode) touchClone.parentNode.removeChild(touchClone);
    if(touchDragEl) touchDragEl.style.opacity = '';
    touchClone = null;
    touchDragEl = null;
    touchData = null;
    // Remove highlights
    document.querySelectorAll('[ondrop]').forEach(td=>{
      td.style.outline = '';
      td.style.outlineOffset = '';
      td.classList.remove('touch-hover');
    });
  }
})();
</script>
</body>
</html>
