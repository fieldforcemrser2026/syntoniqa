{
  "version": 3,
  "sources": ["../../../cloudflare_worker.js"],
  "sourceRoot": "/sessions/quirky-vigilant-knuth/syntoniqa-deploy/.wrangler/tmp/deploy-xPyx8j",
  "sourcesContent": ["/**\n * Syntoniqa v2.0 \u2014 Cloudflare Worker\n * Zero-cost backend: CF Workers (free 100k req/day) + Supabase (free Postgres)\n * Sostituisce Google Apps Script (3531 righe \u2192 Worker modulare)\n * \n * ENV VARS (Cloudflare Dashboard \u2192 Settings \u2192 Variables):\n *   SUPABASE_URL        = https://xxxx.supabase.co\n *   SUPABASE_SERVICE_KEY= eyJ...  (service_role key)\n *   SQ_TOKEN            = MRS_Syntoniqa_2026_MBGOAT   (o custom per tenant)\n *   GEMINI_KEY          = AIza...\n *   TELEGRAM_BOT_TOKEN  = 123456:ABC...\n *   RESEND_API_KEY      = re_...  (email via Resend - free 3k/mese)\n */\n\n// ============ HELPERS ============\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type,Authorization,X-Token',\n};\n\nfunction json(data, status = 200) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: { 'Content-Type': 'application/json', ...corsHeaders },\n  });\n}\n\nfunction err(msg, status = 400) {\n  return json({ success: false, error: msg }, status);\n}\n\nfunction ok(data = {}) {\n  return json({ success: true, data });\n}\n\n// ============ FIX CRIT-02: PascalCase \u2194 snake_case TRANSFORM ============\n\nfunction toPascal(key) {\n  if (key === 'id') return 'ID';\n  return key.split('_').map(part => {\n    if (part === 'id') return 'ID';\n    if (part === 'ids') return 'IDs';\n    return part.charAt(0).toUpperCase() + part.slice(1);\n  }).join('');\n}\n\nfunction toSnake(key) {\n  if (key === 'ID') return 'id';\n  return key\n    .replace(/IDs$/g, '_ids')\n    .replace(/ID$/g, '_id')\n    .replace(/([A-Z])/g, '_$1')\n    .toLowerCase()\n    .replace(/^_/, '')\n    .replace(/__+/g, '_');\n}\n\nfunction pascalizeRecord(obj) {\n  if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return obj;\n  return Object.fromEntries(Object.entries(obj).map(([k, v]) => [toPascal(k), v]));\n}\n\nfunction pascalizeArrays(data) {\n  const result = {};\n  for (const [key, value] of Object.entries(data)) {\n    if (Array.isArray(value)) {\n      result[key] = value.map(item => item && typeof item === 'object' ? pascalizeRecord(item) : item);\n    } else {\n      result[key] = value;\n    }\n  }\n  return result;\n}\n\n// FIX CRIT-04: Extract data from frontend's {data:{...}} wrapping and convert PascalCase \u2192 snake_case\nfunction getFields(body) {\n  const source = (body.data && typeof body.data === 'object' && !Array.isArray(body.data)) ? body.data : body;\n  const skip = new Set(['action', 'userId', 'operatoreId', 'token', 'method']);\n  const result = {};\n  for (const [k, v] of Object.entries(source)) {\n    if (skip.has(k)) continue;\n    if (v === null || v === undefined || v === '') continue; // skip empty/null fields\n    result[toSnake(k)] = v;\n  }\n  return result;\n}\n\n// Pre-processing globale body POST: flatten wrapper, PascalCase\u2192snake_case, strip meta\nfunction normalizeBody(raw) {\n  const isDataWrapper = raw.data && typeof raw.data === 'object' && !Array.isArray(raw.data);\n  const dataObj = isDataWrapper ? raw.data : {};\n  // Convert nested data PascalCase \u2192 snake_case\n  const converted = {};\n  for (const [k, v] of Object.entries(dataObj)) {\n    converted[toSnake(k)] = v;\n  }\n  // Process top-level fields (skip meta that would pollute INSERT)\n  const { action, token, data, method, ...rest } = raw;\n  const result = {};\n  for (const [k, v] of Object.entries(rest)) {\n    if (k === 'userId' || k === 'operatoreId') {\n      result[k] = v; // Keep as-is for logging\n    } else {\n      result[toSnake(k)] = v;\n    }\n  }\n  // Keep 'data' if it was a primitive (e.g. date string \"2026-02-22\"), not a wrapper object\n  if (data !== undefined && !isDataWrapper) {\n    result.data = data;\n  }\n  // Overlay converted nested data (has priority)\n  Object.assign(result, converted);\n  return result;\n}\n\n// Supabase REST helper\nasync function sb(env, table, method = 'GET', body = null, params = '', extraHeaders = {}) {\n  const url = `${env.SUPABASE_URL}/rest/v1/${table}${params}`;\n  const res = await fetch(url, {\n    method,\n    headers: {\n      'apikey': env.SUPABASE_SERVICE_KEY,\n      'Authorization': `Bearer ${env.SUPABASE_SERVICE_KEY}`,\n      'Content-Type': 'application/json',\n      'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal',\n      ...extraHeaders,\n    },\n    body: body ? JSON.stringify(body) : null,\n  });\n  if (!res.ok) {\n    const text = await res.text();\n    throw new Error(`Supabase ${method} ${table}: ${res.status} ${text}`);\n  }\n  const text = await res.text();\n  if (!text) return null;\n  try { return JSON.parse(text); } catch { return text; }\n}\n\n// Hash SHA-256 (Web Crypto API disponibile in CF Workers)\nasync function hashPassword(password) {\n  const data = new TextEncoder().encode(password);\n  const hashBuffer = await crypto.subtle.digest('SHA-256', data);\n  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');\n}\n\n// Auth check\nfunction checkToken(request, env, bodyToken) {\n  const token = request.headers.get('X-Token') || new URL(request.url).searchParams.get('token') || bodyToken || '';\n  return token === env.SQ_TOKEN;\n}\n\n// ============ ROUTER ============\n\nexport default {\n  async fetch(request, env) {\n    if (request.method === 'OPTIONS') {\n      return new Response(null, { headers: corsHeaders });\n    }\n\n    const url = new URL(request.url);\n    const action = url.searchParams.get('action') || url.pathname.split('/').pop();\n\n    // Telegram webhook bypassa il token check (usa secret_token separato)\n    if (action === 'telegramWebhook') {\n      const body = await request.json().catch(() => ({}));\n      return await handlePost(action, body, env);\n    }\n\n    try {\n      if (request.method === 'GET') {\n        if (!checkToken(request, env)) return err('Token non valido', 401);\n        return await handleGet(action, url, env);\n      } else if (request.method === 'POST') {\n        const rawBody = await request.json().catch(() => ({}));\n        if (!checkToken(request, env, rawBody.token)) return err('Token non valido', 401);\n        // FIX: leggi action anche dal body POST (il frontend la manda l\u00EC)\n        const postAction = action || rawBody.action || '';\n        // FIX CRIT-04 (globale): Pre-process body per TUTTI gli handler\n        // 1. Estrai dati dal wrapper {data:{...}} se presente\n        // 2. Converti PascalCase \u2192 snake_case\n        // 3. Rimuovi meta-fields (action, token, method) che inquinerebbero gli INSERT\n        const body = normalizeBody(rawBody);\n        return await handlePost(postAction, body, env);\n      }\n      return err('Metodo non supportato', 405);\n    } catch (e) {\n      console.error('Worker error:', e);\n      return err(`Errore interno: ${e.message}`, 500);\n    }\n  }\n};\n\n// ============ GET HANDLERS ============\n\nasync function handleGet(action, url, env) {\n  switch (action) {\n\n    case 'getAll': {\n      // Carica tutti i dati per dashboard/login (equivalente GAS getAll)\n      const [\n        utenti, clienti, macchine, piano, urgenze, ordini,\n        reperibilita, trasferte, notifiche, richieste, installazioni,\n        pagellini, automezzi, tipi_intervento, priorita, squadre,\n        tagliandi, fasi_installazione, sla_config,\n        checklist_template, documenti, config\n      ] = await Promise.all([\n        sb(env, 'utenti',             'GET', null, '?select=*&obsoleto=eq.false&order=cognome'),\n        sb(env, 'clienti',            'GET', null, '?select=*&obsoleto=eq.false&order=nome'),\n        sb(env, 'macchine',           'GET', null, '?select=*&obsoleto=eq.false'),\n        sb(env, 'piano',              'GET', null, '?select=*&obsoleto=eq.false&order=data.desc&limit=500'),\n        sb(env, 'urgenze',            'GET', null, '?select=*&obsoleto=eq.false&order=data_segnalazione.desc&limit=200'),\n        sb(env, 'ordini',             'GET', null, '?select=*&obsoleto=eq.false&order=data_richiesta.desc&limit=300'),\n        sb(env, 'reperibilita',       'GET', null, '?select=*&obsoleto=eq.false&order=data_inizio.desc&limit=200'),\n        sb(env, 'trasferte',          'GET', null, '?select=*&obsoleto=eq.false&order=data_inizio.desc&limit=100'),\n        sb(env, 'notifiche',          'GET', null, '?select=*&obsoleto=eq.false&order=data_invio.desc&limit=200'),\n        sb(env, 'richieste',          'GET', null, '?select=*&obsoleto=eq.false&order=data_richiesta.desc'),\n        sb(env, 'installazioni',      'GET', null, '?select=*&obsoleto=eq.false'),\n        sb(env, 'pagellini',          'GET', null, '?select=*&obsoleto=eq.false&order=data_creazione.desc'),\n        sb(env, 'automezzi',          'GET', null, '?select=*&obsoleto=eq.false'),\n        sb(env, 'tipi_intervento',    'GET', null, '?select=*&attivo=eq.true'),\n        sb(env, 'priorita',           'GET', null, '?select=*&attivo=eq.true&order=livello'),\n        sb(env, 'squadre',            'GET', null, '?select=*&attivo=eq.true'),\n        sb(env, 'tagliandi',          'GET', null, '?select=*&attivo=eq.true'),\n        sb(env, 'fasi_installazione', 'GET', null, '?select=*&attivo=eq.true&order=ordine'),\n        sb(env, 'sla_config',         'GET', null, '?select=*&attivo=eq.true'),\n        sb(env, 'checklist_template', 'GET', null, '?select=*&attivo=eq.true'),\n        sb(env, 'documenti',          'GET', null, '?select=*&obsoleto=eq.false&order=data_caricamento.desc'),\n        sb(env, 'config',             'GET', null, '?select=chiave,valore'),\n      ]);\n      \n      // Rimuovi password_hash da utenti\n      const utentiSafe = utenti.map(u => { const {password_hash, ...rest} = u; return rest; });\n      \n      // FIX CRIT-02: Converti snake_case \u2192 PascalCase per compatibilit\u00E0 frontend\n      return ok(pascalizeArrays({\n        utenti: utentiSafe, clienti, macchine, piano, urgenze, ordini,\n        reperibilita, trasferte, notifiche, richieste, installazioni,\n        pagellini, automezzi, tipiIntervento: tipi_intervento,\n        priorita, squadre, tagliandi,\n        fasiInstallazione: fasi_installazione,\n        slaConfig: sla_config,\n        checklistTemplate: checklist_template,\n        documenti,\n        config: Object.fromEntries(config.map(c => [c.chiave, c.valore])),\n        timestamp: new Date().toISOString()\n      }));\n    }\n\n    case 'getKPI': {\n      const tecnicoId = url.searchParams.get('tecnicoId') || '';\n      const periodo   = url.searchParams.get('periodo') || 'mese';\n      \n      let dateFilter = '';\n      const now = new Date();\n      if (periodo === 'settimana') {\n        const d = new Date(now); d.setDate(d.getDate() - 7);\n        dateFilter = `&data=gte.${d.toISOString().split('T')[0]}`;\n      } else if (periodo === 'mese') {\n        dateFilter = `&data=gte.${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;\n      } else if (periodo === 'anno') {\n        dateFilter = `&data=gte.${now.getFullYear()}-01-01`;\n      }\n      \n      const tecnicoFilter = tecnicoId ? `&tecnico_id=eq.${tecnicoId}` : '';\n      const kpi = await sb(env, 'kpi_log', 'GET', null, `?select=*${dateFilter}${tecnicoFilter}`);\n      return ok({ kpi, periodo, tecnicoId });\n    }\n\n    case 'getKPITecnici': {\n      // Aggregazione KPI per tutti i tecnici dal piano\n      const mese = url.searchParams.get('mese') || new Date().toISOString().slice(0, 7);\n      const interventi = await sb(env, 'piano', 'GET', null, \n        `?select=tecnico_id,stato,ore_lavorate,km_percorsi&data=gte.${mese}-01&data=lte.${mese}-31`);\n      \n      const byTecnico = {};\n      interventi.forEach(i => {\n        if (!i.tecnico_id) return;\n        if (!byTecnico[i.tecnico_id]) byTecnico[i.tecnico_id] = { total: 0, completati: 0, ore: 0, km: 0 };\n        byTecnico[i.tecnico_id].total++;\n        if (i.stato === 'completato' || i.stato === 'chiuso') byTecnico[i.tecnico_id].completati++;\n        byTecnico[i.tecnico_id].ore += parseFloat(i.ore_lavorate || 0);\n        byTecnico[i.tecnico_id].km  += parseInt(i.km_percorsi || 0);\n      });\n      return ok({ kpiTecnici: byTecnico, mese });\n    }\n\n    case 'getBackupHistory': {\n      const backups = await sb(env, 'kpi_snapshot', 'GET', null,\n        '?tipo_snapshot=eq.backup&order=data.desc&limit=30');\n      return ok({ backups });\n    }\n\n    case 'getAuditLog': {\n      const entityType = url.searchParams.get('entityType') || '';\n      const userId     = url.searchParams.get('userId') || '';\n      const limit      = url.searchParams.get('limit') || '100';\n      let params = `?order=timestamp_at.desc&limit=${limit}`;\n      if (entityType) params += `&entity_type=eq.${entityType}`;\n      if (userId)     params += `&user_id=eq.${userId}`;\n      const logs = await sb(env, 'workflow_log', 'GET', null, params);\n      return ok({ logs });\n    }\n\n    case 'getChecklistTemplates': {\n      const templates = await sb(env, 'checklist_template', 'GET', null, '?attivo=eq.true');\n      return ok({ templates });\n    }\n\n    case 'getPagellini': {\n      const tecnicoId = url.searchParams.get('tecnicoId') || '';\n      const params = tecnicoId ? `?tecnico_id=eq.${tecnicoId}&obsoleto=eq.false` : '?obsoleto=eq.false';\n      const [pagellini, voci] = await Promise.all([\n        sb(env, 'pagellini', 'GET', null, params),\n        sb(env, 'pagellini_voci', 'GET', null, '?select=*'),\n      ]);\n      return ok({ pagellini, voci });\n    }\n\n    case 'exportPowerBI': {\n      const [piano, urgenze, utenti, clienti, macchine, kpiLog] = await Promise.all([\n        sb(env, 'piano',    'GET', null, '?select=*&obsoleto=eq.false&order=data.desc&limit=5000'),\n        sb(env, 'urgenze',  'GET', null, '?select=*&obsoleto=eq.false&order=data_segnalazione.desc&limit=2000'),\n        sb(env, 'utenti',   'GET', null, '?select=id,nome,cognome,ruolo,squadra_id&obsoleto=eq.false'),\n        sb(env, 'clienti',  'GET', null, '?select=id,nome,citta,prov&obsoleto=eq.false'),\n        sb(env, 'macchine', 'GET', null, '?select=id,cliente_id,tipo,modello&obsoleto=eq.false'),\n        sb(env, 'kpi_log',  'GET', null, '?order=data.desc&limit=1000'),\n      ]);\n      return ok({ fact_interventi: piano, fact_urgenze: urgenze, fact_kpi: kpiLog, dim_tecnici: utenti, dim_clienti: clienti, dim_macchine: macchine });\n    }\n\n    default:\n      return err(`Azione GET non trovata: ${action}`, 404);\n  }\n}\n\n// ============ POST HANDLERS ============\n\nasync function handlePost(action, body, env) {\n  // Wrapper per log workflow automatico\n  async function wlog(entityType, entityId, action, userId, note = '') {\n    await sb(env, 'workflow_log', 'POST', {\n      id: `WL_${Date.now()}`,\n      entity_type: entityType, entity_id: entityId,\n      action, user_id: userId, note,\n      timestamp_at: new Date().toISOString()\n    }).catch(() => {}); // non-blocking\n  }\n\n  switch (action) {\n\n    // -------- AUTH --------\n\n    case 'login': {\n      const { username, password } = body;\n      if (!username || !password) return err('Username e password richiesti');\n      \n      const utenti = await sb(env, 'utenti', 'GET', null,\n        `?username=eq.${encodeURIComponent(username)}&attivo=eq.true&obsoleto=eq.false`);\n      \n      if (!utenti.length) return err('Credenziali non valide', 401);\n      const utente = utenti[0];\n      \n      const hashed = await hashPassword(password);\n      const validHash  = utente.password_hash === hashed;\n      const validPlain = utente.password_hash === password; // fallback legacy\n      \n      if (!validHash && !validPlain) return err('Credenziali non valide', 401);\n      \n      // Migra a hash se era plain\n      if (validPlain && !validHash) {\n        await sb(env, `utenti?id=eq.${utente.id}`, 'PATCH', { password_hash: hashed });\n      }\n      \n      const { password_hash, ...utenteSafe } = utente;\n      await wlog('auth', utente.id, 'login', utente.id);\n      // FIX CRIT-01: Frontend aspetta 'user' non 'utente', + PascalCase record\n      return ok({ user: pascalizeRecord(utenteSafe) });\n    }\n\n    case 'resetPassword': {\n      const { userId, newPassword } = body;\n      const hashed = await hashPassword(newPassword);\n      await sb(env, `utenti?id=eq.${userId}`, 'PATCH', { password_hash: hashed, updated_at: new Date().toISOString() });\n      await wlog('utente', userId, 'reset_password', body.operatoreId || 'system');\n      return ok();\n    }\n\n    // -------- PIANO (INTERVENTI) --------\n\n    case 'createPiano': {\n      const id = 'INT_' + Date.now();\n      // FIX CRIT-04: Estrai e converti campi dal wrapper {data:{...PascalCase}}\n      const fields = getFields(body);\n      const row = { id, ...fields, stato: fields.stato || 'pianificato', created_at: new Date().toISOString(), updated_at: new Date().toISOString() };\n      const result = await sb(env, 'piano', 'POST', row);\n      await wlog('piano', id, 'created', body.operatoreId || body.userId);\n      await sendTelegramNotification(env, 'nuovo_intervento', row);\n      return ok({ intervento: pascalizeRecord(result[0]) });\n    }\n\n    case 'updatePiano': {\n      const id = body.id;\n      // FIX CRIT-04: Estrai e converti campi PascalCase \u2192 snake_case\n      const updates = getFields(body);\n      delete updates.id; // non aggiornare l'id\n      updates.updated_at = new Date().toISOString();\n      await sb(env, `piano?id=eq.${id}`, 'PATCH', updates);\n      await wlog('piano', id, `updated_stato_${updates.stato || 'unknown'}`, body.operatoreId || body.userId);\n      if (updates.stato === 'completato') {\n        await triggerKPISnapshot(env, id, updates.tecnico_id);\n      }\n      return ok();\n    }\n\n    // -------- URGENZE --------\n\n    case 'createUrgenza': {\n      const id = 'URG_' + Date.now();\n      // FIX CRIT-04: Estrai e converti campi PascalCase \u2192 snake_case\n      const fields = getFields(body);\n      // Calcola SLA scadenza\n      let slaScadenza = null;\n      const pId = fields.priorita_id;\n      if (pId) {\n        const sla = await sb(env, 'sla_config', 'GET', null, `?priorita_id=eq.${pId}&attivo=eq.true`);\n        if (sla.length && sla[0].tempo_risoluzione_ore) {\n          const d = new Date();\n          d.setHours(d.getHours() + sla[0].tempo_risoluzione_ore);\n          slaScadenza = d.toISOString();\n        }\n      }\n      const row = { id, ...fields, stato: 'aperta', sla_scadenza: slaScadenza, sla_status: 'ok', data_segnalazione: new Date().toISOString() };\n      const result = await sb(env, 'urgenze', 'POST', row);\n      await wlog('urgenza', id, 'created', body.operatoreId || body.userId);\n      await sendTelegramNotification(env, 'nuova_urgenza', row);\n      return ok({ urgenza: pascalizeRecord(result[0]) });\n    }\n\n    case 'assignUrgenza': {\n      const { id, tecnicoAssegnato, TecnicoID, tecniciIds, TecniciIDs, operatoreId, userId } = body;\n      const tecId = tecnicoAssegnato || TecnicoID;\n      const tecIds = tecniciIds || TecniciIDs;\n      await sb(env, `urgenze?id=eq.${id}`, 'PATCH', {\n        tecnico_assegnato: tecId,\n        tecnici_ids: tecIds,\n        stato: 'assegnata',\n        data_assegnazione: new Date().toISOString(),\n        updated_at: new Date().toISOString()\n      });\n      await wlog('urgenza', id, 'assigned', operatoreId || userId, `a ${tecId}`);\n      await sendTelegramNotification(env, 'urgenza_assegnata', { id, tecnicoAssegnato: tecId });\n      return ok();\n    }\n\n    // FIX CRIT-05: Aggiunta azione updateUrgenza (mancava completamente)\n    case 'updateUrgenza': {\n      const id = body.id;\n      const updates = getFields(body);\n      delete updates.id;\n      updates.updated_at = new Date().toISOString();\n      await sb(env, `urgenze?id=eq.${id}`, 'PATCH', updates);\n      await wlog('urgenza', id, 'updated', body.operatoreId || body.userId);\n      return ok();\n    }\n\n    // -------- ORDINI --------\n\n    case 'createOrdine': {\n      const id = 'ORD_' + Date.now();\n      // FIX CRIT-04: Estrai e converti campi\n      const fields = getFields(body);\n      // FIX CRIT-06 (B-008): Validazione quantit\u00E0\n      const qty = fields.quantita || fields.qty;\n      if (qty !== undefined && qty !== null && (isNaN(qty) || Number(qty) <= 0)) {\n        return err('Quantit\u00E0 non valida: deve essere un numero maggiore di 0');\n      }\n      const row = { id, ...fields, stato: 'richiesto', data_richiesta: new Date().toISOString() };\n      const result = await sb(env, 'ordini', 'POST', row);\n      await wlog('ordine', id, 'created', body.operatoreId || body.userId);\n      return ok({ ordine: pascalizeRecord(result[0]) });\n    }\n\n    case 'updateOrdineStato': {\n      const { id, stato, operatoreId, userId: _u2, ...rest } = body;\n      await sb(env, `ordini?id=eq.${id}`, 'PATCH', { stato, ...rest, updated_at: new Date().toISOString() });\n      await wlog('ordine', id, `stato_${stato}`, operatoreId);\n      return ok();\n    }\n\n    // -------- UTENTI --------\n\n    case 'createUtente': {\n      const id = 'TEC_' + String(Date.now()).slice(-3);\n      const hashed = await hashPassword(body.password || 'Syntoniqa2026!');\n      const row = { id, ...getFields(body), password_hash: hashed, created_at: new Date().toISOString(), updated_at: new Date().toISOString() };\n      delete row.password;\n      const result = await sb(env, 'utenti', 'POST', row);\n      // SYNC: se ha automezzo_id, aggiorna assegnatario_id nell'automezzo\n      if (row.automezzo_id) {\n        await sb(env, `automezzi?id=eq.${row.automezzo_id}`, 'PATCH', { assegnatario_id: id }).catch(() => {});\n      }\n      await wlog('utente', id, 'created', body.operatoreId);\n      const { password_hash, ...safe } = result[0];\n      return ok({ utente: safe });\n    }\n\n    case 'updateUtente': {\n      const { id, password, userId: _u3, operatoreId: _op3, tenant_id: _t, ...updates } = body;\n      if (password) updates.password_hash = await hashPassword(password);\n      updates.updated_at = new Date().toISOString();\n      // Remove null FK fields to avoid FK violations\n      for (const k of Object.keys(updates)) {\n        if (updates[k] === null && (k.endsWith('_id') || k === 'squadra_id' || k === 'automezzo_id')) delete updates[k];\n      }\n      // SYNC BIDIREZIONALE: se cambia automezzo_id, aggiorna anche l'automezzo\n      const newAutoId = updates.automezzo_id;\n      if (newAutoId) {\n        // Leggi vecchio automezzo assegnato a questo utente\n        const [oldUser] = await sb(env, 'utenti', 'GET', null, `?id=eq.${id}&select=automezzo_id`);\n        const oldAutoId = oldUser?.automezzo_id;\n        // Rimuovi assegnazione dal vecchio automezzo (se diverso)\n        if (oldAutoId && oldAutoId !== newAutoId) {\n          await sb(env, `automezzi?id=eq.${oldAutoId}`, 'PATCH', { assegnatario_id: null }).catch(() => {});\n        }\n        // Assegna il nuovo automezzo a questo utente\n        await sb(env, `automezzi?id=eq.${newAutoId}`, 'PATCH', { assegnatario_id: id }).catch(() => {});\n        // Rimuovi vecchio assegnatario dal nuovo automezzo (se un altro utente lo aveva)\n        const otherUsers = await sb(env, 'utenti', 'GET', null, `?automezzo_id=eq.${newAutoId}&id=neq.${id}&select=id`);\n        for (const ou of (otherUsers || [])) {\n          await sb(env, `utenti?id=eq.${ou.id}`, 'PATCH', { automezzo_id: null, updated_at: new Date().toISOString() }).catch(() => {});\n        }\n      }\n      await sb(env, `utenti?id=eq.${id}`, 'PATCH', updates);\n      await wlog('utente', id, 'updated', body.operatoreId);\n      return ok({ synced: !!newAutoId });\n    }\n\n    // -------- CLIENTI --------\n\n    case 'createCliente': {\n      const id = 'CLI_' + Date.now();\n      const row = { id, ...getFields(body), created_at: new Date().toISOString(), updated_at: new Date().toISOString() };\n      const result = await sb(env, 'clienti', 'POST', row);\n      return ok({ cliente: pascalizeRecord(result[0]) });\n    }\n\n    case 'updateCliente': {\n      const { id, userId: _u, operatoreId: _op, tenant_id: _t, ...updates } = body;\n      updates.updated_at = new Date().toISOString();\n      for (const k of Object.keys(updates)) { if (updates[k] === null && k.endsWith('_id')) delete updates[k]; }\n      await sb(env, `clienti?id=eq.${id}`, 'PATCH', updates);\n      return ok();\n    }\n\n    // -------- MACCHINE --------\n\n    case 'createMacchina': {\n      const id = 'MAC_' + Date.now();\n      const result = await sb(env, 'macchine', 'POST', { id, ...getFields(body), created_at: new Date().toISOString() });\n      return ok({ macchina: pascalizeRecord(result[0]) });\n    }\n\n    case 'updateMacchina': {\n      const { id, userId: _u, operatoreId: _op, tenant_id: _t, ...updates } = body;\n      for (const k of Object.keys(updates)) { if (updates[k] === null && k.endsWith('_id')) delete updates[k]; }\n      await sb(env, `macchine?id=eq.${id}`, 'PATCH', updates);\n      return ok();\n    }\n\n    // -------- AUTOMEZZI --------\n\n    case 'createAutomezzo': {\n      const id = 'AUT_' + Date.now();\n      const fields = getFields(body);\n      const result = await sb(env, 'automezzi', 'POST', { id, ...fields });\n      // SYNC: se ha assegnatario_id, aggiorna automezzo_id nell'utente\n      if (fields.assegnatario_id) {\n        await sb(env, `utenti?id=eq.${fields.assegnatario_id}`, 'PATCH', { automezzo_id: id, updated_at: new Date().toISOString() }).catch(() => {});\n      }\n      return ok({ automezzo: pascalizeRecord(result[0]) });\n    }\n\n    case 'updateAutomezzo': {\n      const { id, userId: _u, operatoreId: _op, tenant_id: _t, ...updates } = body;\n      for (const k of Object.keys(updates)) { if (updates[k] === null && k.endsWith('_id')) delete updates[k]; }\n      // SYNC BIDIREZIONALE: se cambia assegnatario_id, aggiorna anche l'utente\n      const newAssId = updates.assegnatario_id;\n      if (newAssId) {\n        // Leggi vecchio assegnatario di questo automezzo\n        const [oldAuto] = await sb(env, 'automezzi', 'GET', null, `?id=eq.${id}&select=assegnatario_id`);\n        const oldAssId = oldAuto?.assegnatario_id;\n        // Rimuovi automezzo dal vecchio assegnatario (se diverso)\n        if (oldAssId && oldAssId !== newAssId) {\n          await sb(env, `utenti?id=eq.${oldAssId}`, 'PATCH', { automezzo_id: null, updated_at: new Date().toISOString() }).catch(() => {});\n        }\n        // Assegna automezzo al nuovo assegnatario\n        await sb(env, `utenti?id=eq.${newAssId}`, 'PATCH', { automezzo_id: id, updated_at: new Date().toISOString() }).catch(() => {});\n        // Rimuovi questo automezzo da altri utenti che lo avevano\n        const otherUsers = await sb(env, 'utenti', 'GET', null, `?automezzo_id=eq.${id}&id=neq.${newAssId}&select=id`);\n        for (const ou of (otherUsers || [])) {\n          await sb(env, `utenti?id=eq.${ou.id}`, 'PATCH', { automezzo_id: null, updated_at: new Date().toISOString() }).catch(() => {});\n        }\n      }\n      await sb(env, `automezzi?id=eq.${id}`, 'PATCH', updates);\n      return ok({ synced: !!newAssId });\n    }\n\n    // -------- INSTALLAZIONI --------\n\n    case 'createInstallazione': {\n      const id = 'INS_' + Date.now();\n      const result = await sb(env, 'installazioni', 'POST', { id, ...getFields(body), stato: 'pianificata', created_at: new Date().toISOString() });\n      return ok({ installazione: pascalizeRecord(result[0]) });\n    }\n\n    case 'updateInstallazione': {\n      const { id, userId: _u, operatoreId: _op, ...updates } = body;\n      updates.updated_at = new Date().toISOString();\n      await sb(env, `installazioni?id=eq.${id}`, 'PATCH', updates);\n      return ok();\n    }\n\n    // -------- REPERIBILITA --------\n\n    case 'createReperibilita': {\n      const id = 'REP_' + Date.now();\n      const result = await sb(env, 'reperibilita', 'POST', { id, ...getFields(body), created_at: new Date().toISOString() });\n      return ok({ reperibilita: pascalizeRecord(result[0]) });\n    }\n\n    // -------- TRASFERTE --------\n\n    case 'createTrasferta': {\n      const id = 'TRA_' + Date.now();\n      const result = await sb(env, 'trasferte', 'POST', { id, ...getFields(body), created_at: new Date().toISOString() });\n      return ok({ trasferta: pascalizeRecord(result[0]) });\n    }\n\n    // -------- NOTIFICHE --------\n\n    case 'createNotifica': {\n      const id = 'NOT_' + Date.now();\n      const result = await sb(env, 'notifiche', 'POST', { id, ...getFields(body), data_invio: new Date().toISOString() });\n      return ok({ notifica: pascalizeRecord(result[0]) });\n    }\n\n    case 'markNotifica': {\n      const { id } = body;\n      await sb(env, `notifiche?id=eq.${id}`, 'PATCH', { stato: 'letta', data_lettura: new Date().toISOString() });\n      return ok();\n    }\n\n    case 'markAllRead': {\n      const { userId } = body;\n      await sb(env, `notifiche?destinatario_id=eq.${userId}&stato=eq.inviata`, 'PATCH', \n        { stato: 'letta', data_lettura: new Date().toISOString() });\n      return ok();\n    }\n\n    // -------- RICHIESTE --------\n\n    case 'createRichiesta': {\n      const id = 'RIC_' + Date.now();\n      const result = await sb(env, 'richieste', 'POST', { id, ...getFields(body), stato: 'in_attesa', data_richiesta: new Date().toISOString() });\n      return ok({ richiesta: pascalizeRecord(result[0]) });\n    }\n\n    case 'updateRichiesta': {\n      const { id, userId: _u, operatoreId: _op, ...updates } = body;\n      if (updates.stato !== 'in_attesa') updates.data_risposta = new Date().toISOString();\n      await sb(env, `richieste?id=eq.${id}`, 'PATCH', updates);\n      await sendTelegramNotification(env, 'richiesta_risposta', { id, stato: updates.stato });\n      return ok();\n    }\n\n    // -------- PAGELLINI --------\n\n    case 'createPagellino': {\n      const id = 'PAG_' + Date.now();\n      const result = await sb(env, 'pagellini', 'POST', { id, ...getFields(body), stato: 'bozza', data_creazione: new Date().toISOString() });\n      return ok({ pagellino: pascalizeRecord(result[0]) });\n    }\n\n    case 'approvaPagellino': {\n      const { id } = body;\n      await sb(env, `pagellini?id=eq.${id}`, 'PATCH', { stato: 'approvato', data_approvazione: new Date().toISOString() });\n      return ok();\n    }\n\n    // -------- CHECKLIST --------\n\n    case 'createChecklistTemplate': {\n      const id = 'CHK_' + Date.now();\n      const result = await sb(env, 'checklist_template', 'POST', { id, ...getFields(body), created_at: new Date().toISOString() });\n      return ok({ template: result[0] });\n    }\n\n    case 'updateChecklistTemplate': {\n      const { id, userId: _u, operatoreId: _op, ...updates } = body;\n      await sb(env, `checklist_template?id=eq.${id}`, 'PATCH', updates);\n      return ok();\n    }\n\n    case 'deleteChecklistTemplate': {\n      const { id } = body;\n      await sb(env, `checklist_template?id=eq.${id}`, 'PATCH', { attivo: false });\n      return ok();\n    }\n\n    case 'compileChecklist': {\n      const id = 'CKC_' + Date.now();\n      const result = await sb(env, 'checklist_compilata', 'POST', { id, ...getFields(body), data_compilazione: new Date().toISOString() });\n      // Aggiorna intervento con checklist_id\n      if (body.intervento_id) {\n        await sb(env, `piano?id=eq.${body.intervento_id}`, 'PATCH', { checklist_id: id });\n      }\n      return ok({ checklist: pascalizeRecord(result[0]) });\n    }\n\n    // -------- DOCUMENTI & ALLEGATI --------\n\n    case 'createDocumento': {\n      const id = 'DOC_' + Date.now();\n      const result = await sb(env, 'documenti', 'POST', { id, ...getFields(body), data_caricamento: new Date().toISOString() });\n      return ok({ documento: pascalizeRecord(result[0]) });\n    }\n\n    case 'deleteDocumento': {\n      const { id } = body;\n      await sb(env, `documenti?id=eq.${id}`, 'PATCH', { obsoleto: true });\n      return ok();\n    }\n\n    case 'createAllegato': {\n      const id = 'ALL_' + Date.now();\n      const result = await sb(env, 'allegati', 'POST', { id, ...getFields(body), data_upload: new Date().toISOString() });\n      return ok({ allegato: pascalizeRecord(result[0]) });\n    }\n\n    case 'deleteAllegato': {\n      const { id } = body;\n      await sb(env, `allegati?id=eq.${id}`, 'PATCH', { obsoleto: true });\n      return ok();\n    }\n\n    case 'uploadFile': {\n      // Upload a Supabase Storage\n      const { fileName, base64Data, mimeType, riferimentoTipo, riferimentoId, uploaderId } = body;\n      const bucket  = 'syntoniqa-allegati';\n      const path    = `${riferimentoTipo}/${riferimentoId}/${Date.now()}_${fileName}`;\n      const fileData = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));\n      \n      const uploadRes = await fetch(\n        `${env.SUPABASE_URL}/storage/v1/object/${bucket}/${path}`,\n        {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${env.SUPABASE_SERVICE_KEY}`,\n            'Content-Type': mimeType,\n          },\n          body: fileData,\n        }\n      );\n      if (!uploadRes.ok) throw new Error('Upload storage fallito');\n      \n      const fileUrl = `${env.SUPABASE_URL}/storage/v1/object/public/${bucket}/${path}`;\n      const id = 'ALL_' + Date.now();\n      await sb(env, 'allegati', 'POST', {\n        id, nome: fileName, file_url: fileUrl, mime_type: mimeType,\n        uploader_id: uploaderId, riferimento_tipo: riferimentoTipo, riferimento_id: riferimentoId,\n        data_upload: new Date().toISOString()\n      });\n      return ok({ url: fileUrl, id });\n    }\n\n    case 'uploadFotoProfilo': {\n      const { userId, base64Data, mimeType } = body;\n      const bucket = 'syntoniqa-profili';\n      const path   = `profili/${userId}.jpg`;\n      const fileData = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));\n      \n      await fetch(`${env.SUPABASE_URL}/storage/v1/object/${bucket}/${path}`, {\n        method: 'POST', headers: { 'Authorization': `Bearer ${env.SUPABASE_SERVICE_KEY}`, 'Content-Type': mimeType },\n        body: fileData\n      });\n      const url = `${env.SUPABASE_URL}/storage/v1/object/public/${bucket}/${path}`;\n      await sb(env, `utenti?id=eq.${userId}`, 'PATCH', { foto_url: url });\n      return ok({ url });\n    }\n\n    // -------- NOTIFICHE ESTERNE --------\n\n    case 'sendEmail': {\n      const { to, subject, html, text } = body;\n      if (!env.RESEND_API_KEY) return err('Email non configurata');\n      const res = await fetch('https://api.resend.com/emails', {\n        method: 'POST',\n        headers: { 'Authorization': `Bearer ${env.RESEND_API_KEY}`, 'Content-Type': 'application/json' },\n        body: JSON.stringify({ from: 'Syntoniqa <noreply@syntoniqa.app>', to, subject, html, text })\n      });\n      const result = await res.json();\n      return ok({ result });\n    }\n\n    case 'testEmail': {\n      return handlePost('sendEmail', { to: body.email, subject: 'Test Syntoniqa', html: '<h1>Test OK</h1>' }, env);\n    }\n\n    case 'sendTelegramMsg': {\n      const { chatId, text } = body;\n      const res = await sendTelegram(env, chatId, text);\n      return ok({ result: res });\n    }\n\n    case 'testTelegram': {\n      const res = await sendTelegram(env, body.chatId, '\uD83E\uDD16 Syntoniqa v2.0 \u2013 Telegram OK!');\n      return ok({ result: res });\n    }\n\n    // -------- PUSH NOTIFICATIONS (FIX F-30) --------\n\n    case 'getVapidPublicKey': {\n      if (!env.VAPID_PUBLIC_KEY) return err('VAPID non configurato');\n      return ok({ vapidPublicKey: env.VAPID_PUBLIC_KEY });\n    }\n\n    case 'savePushSubscription': {\n      const userId = body.userId || body.operatoreId;\n      const sub = body.subscription || body;\n      if (!sub.endpoint) return err('Subscription endpoint richiesto');\n      const keys = sub.keys || {};\n      const id = 'PUSH_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);\n      \n      // Upsert: remove old subscription for same endpoint\n      await sb(env, `push_subscriptions?user_id=eq.${encodeURIComponent(userId)}&endpoint=eq.${encodeURIComponent(sub.endpoint)}`, 'DELETE');\n      \n      await sb(env, 'push_subscriptions', 'POST', {\n        id,\n        user_id: userId,\n        endpoint: sub.endpoint,\n        p256dh: keys.p256dh || '',\n        auth: keys.auth || '',\n        user_agent: body.userAgent || '',\n        active: true,\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString()\n      });\n      await wlog('push', id, 'subscription_saved', userId);\n      return ok({ id });\n    }\n\n    case 'removePushSubscription': {\n      const userId = body.userId || body.operatoreId;\n      const endpoint = body.endpoint;\n      if (endpoint) {\n        await sb(env, `push_subscriptions?user_id=eq.${encodeURIComponent(userId)}&endpoint=eq.${encodeURIComponent(endpoint)}`, 'DELETE');\n      } else {\n        await sb(env, `push_subscriptions?user_id=eq.${encodeURIComponent(userId)}`, 'PATCH', { active: false, updated_at: new Date().toISOString() });\n      }\n      return ok();\n    }\n\n    case 'sendPush': {\n      // Invia push a uno o pi\u00F9 utenti\n      const { targetUserIds, title, body: pushBody, url, tag, actions } = body;\n      if (!env.VAPID_PUBLIC_KEY || !env.VAPID_PRIVATE_KEY) return err('VAPID keys non configurate');\n      if (!targetUserIds || !targetUserIds.length) return err('targetUserIds richiesti');\n\n      const subs = await sb(env, 'push_subscriptions', 'GET', null,\n        `?user_id=in.(${targetUserIds.map(id => encodeURIComponent(id)).join(',')})&active=eq.true`);\n      \n      const payload = JSON.stringify({\n        title: title || 'Syntoniqa',\n        body: pushBody || '',\n        url: url || './',\n        tag: tag || 'syntoniqa-' + Date.now(),\n        actions: actions || []\n      });\n\n      let sent = 0, failed = 0;\n      for (const sub of subs) {\n        try {\n          const res = await sendWebPush(env, {\n            endpoint: sub.endpoint,\n            keys: { p256dh: sub.p256dh, auth: sub.auth }\n          }, payload);\n          if (res.ok) { sent++; }\n          else if (res.status === 410 || res.status === 404) {\n            // Subscription scaduta, rimuovi\n            await sb(env, `push_subscriptions?id=eq.${sub.id}`, 'DELETE');\n            failed++;\n          } else { failed++; }\n        } catch (e) { failed++; }\n      }\n      return ok({ sent, failed, total: subs.length });\n    }\n\n    // -------- INTELLIGENCE --------\n\n    case 'generateAIPlan': {\n      if (!env.GEMINI_KEY) return err('Gemini API key non configurata');\n\n      const vincoli = body.vincoli || {};\n      const testo = vincoli.testo || '';\n      const files = vincoli.files || [];\n\n      // If called from old interface with urgenze/tecnici\n      const urgenze = body.urgenze || [];\n      const tecnici = body.tecnici || [];\n\n      // Load current data context\n      const [allTecnici, allUrgenze, allPiano, allClienti] = await Promise.all([\n        tecnici.length ? Promise.resolve(tecnici) : sb(env, 'utenti', 'GET', null, '?attivo=eq.true&ruolo=in.(tecnico,caposquadra)&select=id,nome,cognome,base,squadra_id').catch(()=>[]),\n        urgenze.length ? Promise.resolve(urgenze) : sb(env, 'urgenze', 'GET', null, '?stato=in.(aperta,assegnata)&order=data_segnalazione.desc&limit=50').catch(()=>[]),\n        sb(env, 'piano', 'GET', null, '?obsoleto=eq.false&order=data.desc&limit=100').catch(()=>[]),\n        sb(env, 'anagrafica_clienti', 'GET', null, '?select=codice_m3,nome_account,nome_interno,citta&limit=200').catch(()=>[])\n      ]);\n\n      // Build file descriptions for context\n      let fileContext = '';\n      for (const f of files) {\n        if (f.name.match(/\\.(csv|txt)$/i) && typeof f.content === 'string' && !f.content.includes('base64')) {\n          fileContext += `\\n--- FILE: ${f.name} ---\\n${f.content.substring(0, 3000)}\\n`;\n        } else {\n          fileContext += `\\n--- FILE: ${f.name} (${f.type}, ${Math.round((f.size||0)/1024)}KB) ---\\n[Documento allegato]\\n`;\n        }\n      }\n\n      const prompt = `Sei l'AI planner di Syntoniqa, il sistema FSM di MRS Lely Center Emilia Romagna.\nGenera un piano di interventi ottimizzato per la prossima settimana.\n\nVINCOLI UTENTE: ${testo || 'Nessun vincolo specificato'}\n\nTECNICI DISPONIBILI (${allTecnici.length}):\n${allTecnici.map(t => `- ${t.nome||''} ${t.cognome||''} (ID: ${t.id}, base: ${t.base||'?'}, squadra: ${t.squadra_id||'?'})`).join('\\n')}\n\nURGENZE APERTE (${allUrgenze.length}):\n${allUrgenze.slice(0,30).map(u => `- ${u.id}: ${u.problema||'?'} | Cliente: ${u.cliente_id||'?'} | Priorit\u00E0: ${u.priorita_id||'?'} | SLA: ${u.sla_scadenza||'?'}`).join('\\n')}\n\nINTERVENTI GI\u00C0 PIANIFICATI: ${allPiano.length}\n\nCLIENTI: ${allClienti.slice(0,50).map(c => `${c.nome_account||c.nome_interno} (${c.codice_m3}, ${c.citta||'?'})`).join(', ')}\n${fileContext ? '\\nDOCUMENTI ALLEGATI:' + fileContext : ''}\n\nGenera un piano ottimizzato che:\n1. Rispetti i vincoli dell'utente\n2. Prioritizzi le urgenze per SLA\n3. Minimizzi i km (raggruppa interventi per zona)\n4. Bilanci il carico tra tecnici\n5. Consideri i documenti allegati se presenti\n\nRispondi con JSON:\n{\n  \"summary\": \"breve riepilogo del piano\",\n  \"piano\": [\n    {\"data\":\"YYYY-MM-DD\",\"tecnico\":\"nome\",\"tecnicoId\":\"id\",\"cliente\":\"nome\",\"clienteId\":\"codice_m3\",\"tipo\":\"urgenza|tagliando|service|installazione\",\"oraInizio\":\"HH:MM\",\"durataOre\":2,\"note\":\"...\",\"urgenzaId\":\"se applicabile\"}\n  ],\n  \"warnings\": [\"eventuali avvisi/conflitti\"]\n}`;\n\n      const geminiRes = await fetch(\n        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${env.GEMINI_KEY}`,\n        {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })\n        }\n      );\n      const geminiData = await geminiRes.json();\n      const rawText = geminiData.candidates?.[0]?.content?.parts?.[0]?.text || '{}';\n      const cleanText = rawText.replace(/```json\\n?|\\n?```/g, '').trim();\n      try {\n        const result = JSON.parse(cleanText);\n        return ok(result);\n      } catch (e) {\n        return ok({ summary: 'Piano generato (testo)', piano: [], warnings: ['Risposta AI non parsabile'], raw: cleanText });\n      }\n    }\n\n    case 'applyAIPlan': {\n      const { piano, operatoreId } = body;\n      const created = [];\n      for (const item of piano) {\n        const id = 'INT_AI_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6);\n        await sb(env, 'piano', 'POST', {\n          id, tecnico_id: item.tecnicoId, data: item.data, ora_inizio: item.oraInizio,\n          urgenza_id: item.urgenzaId, stato: 'pianificato', origine: 'ai',\n          created_at: new Date().toISOString(), updated_at: new Date().toISOString()\n        });\n        if (item.urgenzaId) {\n          await sb(env, `urgenze?id=eq.${item.urgenzaId}`, 'PATCH', {\n            stato: 'assegnata', tecnico_assegnato: item.tecnicoId,\n            data_assegnazione: new Date().toISOString()\n          });\n        }\n        created.push(id);\n        await wlog('piano', id, 'ai_created', operatoreId, item.motivazione);\n      }\n      return ok({ created, count: created.length });\n    }\n\n    case 'importExcelPlan': {\n      // Import plan rows from parsed Excel data\n      const { rows, operatoreId } = body;\n      if (!rows || !rows.length) return err('rows richiesto');\n      // Get tecnici for name\u2192id mapping\n      const tecnici = await sb(env, 'utenti', 'GET', null, '?attivo=eq.true&select=id,nome,cognome');\n      const tecMap = {};\n      tecnici.forEach(t => {\n        const nome = (t.nome || '').toLowerCase();\n        const full = ((t.nome || '') + ' ' + (t.cognome || '')).toLowerCase().trim();\n        tecMap[nome] = t.id;\n        tecMap[full] = t.id;\n      });\n      const created = [], errors = [];\n      for (const row of rows) {\n        try {\n          const tecId = tecMap[(row.tecnico_nome || '').toLowerCase()] || null;\n          const id = 'INT_XLS_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6);\n          // Build note with all details\n          const noteParts = [row.cliente, row.service_detail, row.reperibilita ? 'REP: ' + row.reperibilita : ''].filter(Boolean);\n          await sb(env, 'piano', 'POST', {\n            id,\n            tecnico_id: tecId,\n            data: row.data,\n            stato: 'pianificato',\n            origine: 'excel_import',\n            note: noteParts.join(' | ') || row.note_complete || '',\n            automezzo_id: row.furgone ? 'FURG_' + row.furgone : null,\n            obsoleto: false,\n            tenant_id: env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045',\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n          });\n          created.push(id);\n        } catch (e) {\n          errors.push({ row: row.data + ' ' + row.tecnico_nome, err: e.message });\n        }\n      }\n      return ok({ created: created.length, errors });\n    }\n\n    // -------- WORKFLOW APPROVATIVO --------\n\n    case 'createApproval': {\n      const { id, piano, creato_da, ruolo_creatore, stato, data_creazione } = body;\n      // Store in config table as JSON (no separate table needed)\n      await sb(env, 'config', 'POST', {\n        chiave: `approval_${id}`,\n        valore: JSON.stringify({ id, piano, creato_da, ruolo_creatore, stato, data_creazione }),\n        tenant_id: env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045'\n      }, null, { 'Prefer': 'return=minimal,resolution=merge-duplicates' });\n      return ok({ id, stato });\n    }\n\n    case 'getApprovals': {\n      const filter = body.filter || '';\n      const configs = await sb(env, 'config', 'GET', null, `?chiave=like.approval_*&tenant_id=eq.${env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045'}`);\n      let approvals = configs.map(c => {\n        try { return JSON.parse(c.valore); } catch { return null; }\n      }).filter(Boolean);\n      if (filter) approvals = approvals.filter(a => a.stato === filter);\n      approvals.sort((a, b) => (b.data_creazione || '').localeCompare(a.data_creazione || ''));\n      // Enrich with user names\n      const userIds = [...new Set(approvals.map(a => a.creato_da).concat(approvals.map(a => a.approvato_da)).filter(Boolean))];\n      if (userIds.length) {\n        const users = await sb(env, 'utenti', 'GET', null, `?id=in.(${userIds.join(',')})&select=id,nome,cognome`).catch(() => []);\n        const userMap = Object.fromEntries(users.map(u => [u.id, (u.nome || '') + ' ' + (u.cognome || '')]));\n        approvals.forEach(a => {\n          a.creato_da_nome = userMap[a.creato_da] || a.creato_da;\n          a.approvato_da_nome = userMap[a.approvato_da] || '';\n        });\n      }\n      return ok(approvals);\n    }\n\n    case 'getApproval': {\n      const cfg = await sb(env, 'config', 'GET', null, `?chiave=eq.approval_${body.id}&tenant_id=eq.${env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045'}`);\n      if (!cfg.length) return err('Approvazione non trovata', 404);\n      return ok(JSON.parse(cfg[0].valore));\n    }\n\n    case 'updateApproval': {\n      const { id, stato, approvato_da, note_approvazione, data_approvazione } = body;\n      const cfg = await sb(env, 'config', 'GET', null, `?chiave=eq.approval_${id}&tenant_id=eq.${env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045'}`);\n      if (!cfg.length) return err('Approvazione non trovata', 404);\n      const approval = JSON.parse(cfg[0].valore);\n      approval.stato = stato;\n      approval.approvato_da = approvato_da;\n      approval.note_approvazione = note_approvazione;\n      approval.data_approvazione = data_approvazione;\n      await sb(env, `config?chiave=eq.approval_${id}&tenant_id=eq.${env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045'}`, 'PATCH', {\n        valore: JSON.stringify(approval)\n      });\n      return ok(approval);\n    }\n\n    case 'notifyPlanApproved': {\n      const { approval_id } = body;\n      const cfg = await sb(env, 'config', 'GET', null, `?chiave=eq.approval_${approval_id}&tenant_id=eq.${env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045'}`);\n      if (!cfg.length) return ok({ notified: 0 });\n      const approval = JSON.parse(cfg[0].valore);\n      if (approval.stato !== 'approvato') return ok({ notified: 0 });\n      // Notify all active technicians via Telegram\n      const tecnici = await sb(env, 'utenti', 'GET', null, '?attivo=eq.true&ruolo=in.(tecnico,caposquadra)&telegram_chat_id=not.is.null');\n      let notified = 0;\n      for (const tec of tecnici) {\n        if (tec.telegram_chat_id) {\n          await sendTelegram(env, tec.telegram_chat_id, `\uD83D\uDCCB *Piano approvato!*\\nIl piano \u00E8 stato approvato. Controlla i tuoi interventi su Syntoniqa.`);\n          notified++;\n        }\n      }\n      return ok({ notified });\n    }\n\n    case 'geocodeAll': {\n      // FIX B-V2-5: Geocoding Nominatim con retry, backoff esponenziale, error log\n      const batchSize = Math.min(parseInt(body?.limit) || 20, 50); // max 50\n      const clientiSenzaGeo = await sb(env, 'clienti', 'GET', null,\n        '?latitudine=is.null&obsoleto=eq.false&select=id,indirizzo,citta,prov,cap');\n\n      // Legge config email per User-Agent (Nominatim ToS richiede contatto)\n      const cfgArr = await sb(env, 'config', 'GET', null, '?tenant_id=eq.' + (env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045') + '&chiave=eq.email_mittente');\n      const contactEmail = cfgArr?.[0]?.valore || 'admin@syntoniqa.app';\n\n      // Helper: geocoda singolo indirizzo con retry + backoff\n      const geocodeOne = async (c, attempt = 0) => {\n        const query = [c.indirizzo, c.citta, c.prov, 'Italia'].filter(Boolean).join(', ');\n        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&addressdetails=0`;\n        try {\n          const res = await fetch(url, {\n            headers: {\n              'User-Agent': `Syntoniqa/2.0 (${contactEmail})`,\n              'Accept-Language': 'it',\n            }\n          });\n          if (res.status === 429) {\n            // Rate limited: backoff 2^attempt * 1.5s (max 3 tentativi)\n            if (attempt >= 3) return { ok: false, reason: 'rate_limit_exceeded' };\n            await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1500));\n            return geocodeOne(c, attempt + 1);\n          }\n          if (!res.ok) return { ok: false, reason: `http_${res.status}` };\n          const data = await res.json();\n          if (!data.length) return { ok: false, reason: 'no_results' };\n          return { ok: true, lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };\n        } catch (e) {\n          if (attempt < 2) {\n            await new Promise(r => setTimeout(r, 2000));\n            return geocodeOne(c, attempt + 1);\n          }\n          return { ok: false, reason: e.message };\n        }\n      };\n\n      let updated = 0;\n      const errors = [];\n      const batch = clientiSenzaGeo.slice(0, batchSize);\n\n      for (let i = 0; i < batch.length; i++) {\n        const c = batch[i];\n        const result = await geocodeOne(c);\n        if (result.ok) {\n          await sb(env, `clienti?id=eq.${c.id}`, 'PATCH', {\n            latitudine: result.lat, longitudine: result.lon\n          });\n          updated++;\n        } else {\n          errors.push({ id: c.id, citta: c.citta, reason: result.reason });\n          // Log in workflow_log per tracciabilit\u00E0\n          await wlog('clienti', c.id, 'geocode_failed', 'system', result.reason).catch(() => {});\n        }\n        // Rispetta ToS Nominatim: min 1.1s tra richieste (tranne ultimo)\n        if (i < batch.length - 1) {\n          await new Promise(r => setTimeout(r, 1200));\n        }\n      }\n\n      return ok({\n        updated,\n        failed: errors.length,\n        skipped: Math.max(0, clientiSenzaGeo.length - batchSize),\n        total_senza_geo: clientiSenzaGeo.length,\n        errors: errors.slice(0, 10), // max 10 errori nel response\n        message: errors.length\n          ? `${updated} geocodificati, ${errors.length} falliti. Controlla audit log per dettagli.`\n          : `${updated} clienti geocodificati con successo.`\n      });\n    }\n\n    case 'generateReport': {\n      const { tipo, dateFrom, dateTo, tecnicoId } = body;\n      let filter = `?data=gte.${dateFrom}&data=lte.${dateTo}`;\n      if (tecnicoId) filter += `&tecnico_id=eq.${tecnicoId}`;\n      \n      const [interventi, urgenze] = await Promise.all([\n        sb(env, 'piano',   'GET', null, filter + '&obsoleto=eq.false'),\n        sb(env, 'urgenze', 'GET', null, `?data_segnalazione=gte.${dateFrom}&obsoleto=eq.false`),\n      ]);\n      \n      const report = {\n        periodo: { from: dateFrom, to: dateTo },\n        interventi: { totale: interventi.length, completati: interventi.filter(i => i.stato === 'completato' || i.stato === 'chiuso').length },\n        urgenze:    { totale: urgenze.length,    risolte: urgenze.filter(u => u.stato === 'risolta').length },\n        ore_totali: interventi.reduce((s, i) => s + parseFloat(i.ore_lavorate || 0), 0),\n        km_totali:  interventi.reduce((s, i) => s + parseInt(i.km_percorsi || 0), 0),\n      };\n      return ok({ report });\n    }\n\n    case 'logKPISnapshot': {\n      const id = 'KSN_' + Date.now();\n      await sb(env, 'kpi_snapshot', 'POST', { id, ...getFields(body), data: new Date().toISOString().split('T')[0], ora: new Date().toTimeString().split(' ')[0] });\n      return ok({ id });\n    }\n\n    case 'updateSLAStatus': {\n      // Aggiorna stato SLA su tutte le urgenze aperte\n      const urgenze = await sb(env, 'urgenze', 'GET', null, '?stato=in.(aperta,assegnata,in_corso)&sla_scadenza=not.is.null');\n      const now = new Date();\n      let updated = 0;\n      for (const u of urgenze) {\n        const scadenza = new Date(u.sla_scadenza);\n        const diffOre = (scadenza - now) / 3600000;\n        let newStatus = 'ok';\n        if (diffOre < 0)  newStatus = 'scaduto';\n        else if (diffOre < 2)  newStatus = 'critical';\n        else if (diffOre < 6)  newStatus = 'warning';\n        if (newStatus !== u.sla_status) {\n          await sb(env, `urgenze?id=eq.${u.id}`, 'PATCH', { sla_status: newStatus });\n          updated++;\n        }\n      }\n      return ok({ updated, total: urgenze.length });\n    }\n\n    case 'saveConfig':\n    case 'updateConfig': {\n      const { config } = body;\n      for (const [chiave, valore] of Object.entries(config)) {\n        await sb(env, 'config', 'POST', { chiave, valore }).catch(async () => {\n          await sb(env, `config?chiave=eq.${chiave}`, 'PATCH', { valore });\n        });\n      }\n      return ok();\n    }\n\n    case 'backupNow': {\n      // Snapshot di tutti i dati critici in kpi_snapshot\n      const [piano, urgenze, ordini] = await Promise.all([\n        sb(env, 'piano',   'GET', null, '?obsoleto=eq.false&order=created_at.desc&limit=1000'),\n        sb(env, 'urgenze', 'GET', null, '?obsoleto=eq.false&stato=in.(aperta,assegnata,in_corso)'),\n        sb(env, 'ordini',  'GET', null, '?obsoleto=eq.false&stato=in.(richiesto,preso_in_carico,ordinato)'),\n      ]);\n      const id = 'BAK_' + Date.now();\n      await sb(env, 'kpi_snapshot', 'POST', {\n        id, tipo_snapshot: 'backup',\n        data: new Date().toISOString().split('T')[0],\n        ora: new Date().toTimeString().split(' ')[0],\n        dati: { piano_count: piano.length, urgenze_aperte: urgenze.length, ordini_attivi: ordini.length }\n      });\n      return ok({ backupId: id, piano: piano.length, urgenze: urgenze.length, ordini: ordini.length });\n    }\n\n    case 'setupWebhook': {\n      const { webhookUrl } = body;\n      const res = await fetch(`https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/setWebhook?url=${encodeURIComponent(webhookUrl)}`);\n      const data = await res.json();\n      return ok({ telegram: data });\n    }\n\n    case 'removeWebhook': {\n      const res = await fetch(`https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/deleteWebhook`);\n      const data = await res.json();\n      return ok({ telegram: data });\n    }\n\n    // -------- TELEGRAM BOT (webhook) --------\n\n    case 'telegramWebhook': {\n      const update = body;\n      if (!update.message && !update.callback_query) return ok();\n      try {\n\n      // Handle callback queries (inline button responses)\n      if (update.callback_query) {\n        const cb = update.callback_query;\n        const cbChatId = cb.message?.chat?.id;\n        const cbData = cb.data || '';\n        try {\n          await fetch(`https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/answerCallbackQuery`, {\n            method: 'POST', headers: {'Content-Type':'application/json'},\n            body: JSON.stringify({ callback_query_id: cb.id })\n          });\n          // Callback data format: \"confirm:type:encodedId\" or \"cancel:x:x\"\n          const [cbAction] = cbData.split(':');\n          if (cbAction === 'cancel') {\n            await sendTelegram(env, cbChatId, '\u274C Azione annullata.');\n          }\n          // Note: confirm actions are handled by the original message creating the record directly\n          // The buttons are just UX feedback - actions are created immediately on AI parse\n        } catch(e) { console.error('CB error:', e.message); }\n        return ok();\n      }\n\n      const msg     = update.message;\n      const chatId  = msg.chat.id;\n      const fromId  = msg.from?.id || null; // Telegram user ID (individual)\n      const text    = msg.text || msg.caption || '';\n      const parts   = text.split(' ');\n      const cmd     = parts[0]?.toLowerCase() || '';\n\n      // Trova utente: prima per telegram_chat_id (= Telegram user from.id), poi match fuzzy per nome\n      let utente = null;\n      if (fromId) {\n        const byChatId = await sb(env, 'utenti', 'GET', null, `?telegram_chat_id=eq.${fromId}&attivo=eq.true`).catch(()=>[]);\n        utente = byChatId[0] || null;\n      }\n      // In gruppo MRS noto: se non troviamo utente, usa il nome Telegram per match fuzzy\n      if (!utente) {\n        const firstName = (msg.from?.first_name || '').toLowerCase();\n        const lastName = (msg.from?.last_name || '').toLowerCase();\n        if (firstName) {\n          const allUtenti = await sb(env, 'utenti', 'GET', null, '?attivo=eq.true&select=id,nome,cognome,ruolo').catch(()=>[]);\n          utente = allUtenti.find(u => (u.nome||'').toLowerCase() === firstName && (!lastName || (u.cognome||'').toLowerCase().startsWith(lastName))) || null;\n          // Auto-save telegram user id in telegram_chat_id for future fast lookups\n          if (utente && fromId) {\n            await sb(env, `utenti?id=eq.${utente.id}`, 'PATCH', { telegram_chat_id: String(fromId) }).catch(()=>{});\n          }\n        }\n      }\n\n      // /start \u00E8 permesso anche senza utente registrato\n      if (!utente && cmd !== '/start') {\n        const nome = msg.from?.first_name || 'utente';\n        await sendTelegram(env, chatId, `\u274C Ciao ${nome}, non ti trovo nel sistema. Chiedi all'admin di aggiungere il tuo Telegram ID (${fromId}) nel profilo Syntoniqa.`);\n        return ok();\n      }\n\n      // ---- Helper: download Telegram file and store URL ----\n      async function getTelegramFileUrl(fileId) {\n        const res = await fetch(`https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/getFile?file_id=${fileId}`);\n        const d = await res.json();\n        return d.ok ? `https://api.telegram.org/file/bot${env.TELEGRAM_BOT_TOKEN}/${d.result.file_path}` : null;\n      }\n\n      // ---- Helper: send with inline keyboard ----\n      async function sendTelegramWithButtons(chatId, text, buttons) {\n        return fetch(`https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/sendMessage`, {\n          method: 'POST', headers: {'Content-Type':'application/json'},\n          body: JSON.stringify({\n            chat_id: chatId, text, parse_mode: 'Markdown',\n            reply_markup: { inline_keyboard: buttons }\n          })\n        }).then(r=>r.json()).catch(()=>null);\n      }\n\n      // ---- Helper: AI parse message with Gemini ----\n      async function aiParseMessage(text, mediaUrl, mediaType) {\n        if (!env.GEMINI_KEY) return null;\n        // Get clients list for context\n        const clienti = await sb(env, 'anagrafica_clienti', 'GET', null, '?select=codice_m3,nome_account,nome_interno&limit=200').catch(()=>[]);\n        const clientiList = clienti.map(c => `${c.nome_account||c.nome_interno} (${c.codice_m3})`).join(', ');\n\n        const systemPrompt = `Sei l'assistente AI di Syntoniqa, il sistema FSM di MRS Lely Center.\nAnalizza il messaggio e determina il tipo di azione da creare.\n\nCLIENTI DISPONIBILI: ${clientiList}\n\nTIPI DI AZIONE:\n1. \"urgenza\" - Problema tecnico urgente su un robot/macchina (robot fermo, errore, guasto)\n2. \"ordine\" - Richiesta ricambi (codici tipo X.XXXX.XXXX.X, quantit\u00E0, destinazione)\n3. \"intervento\" - Intervento programmato (manutenzione, service, installazione)\n4. \"nota\" - Informazione generica, aggiornamento stato, nessuna azione specifica\n\nCODICI RICAMBI LELY: formato X.XXXX.XXXX.X (es. 9.1189.0283.0)\n\nRispondi SOLO con JSON valido:\n{\n  \"tipo\": \"urgenza|ordine|intervento|nota\",\n  \"cliente\": \"nome cliente pi\u00F9 probabile o null\",\n  \"codice_m3\": \"codice M3 del cliente o null\",\n  \"problema\": \"descrizione sintetica del problema\",\n  \"macchina\": \"tipo macchina (Astronaut/Juno/Vector/Discovery/etc) o null\",\n  \"robot_id\": \"numero robot (101-108) o null\",\n  \"priorita\": \"alta|media|bassa\",\n  \"ricambi\": [{\"codice\":\"X.XXXX.XXXX.X\",\"quantita\":1,\"descrizione\":\"...\"}] o [],\n  \"note\": \"eventuali note aggiuntive\"\n}`;\n\n        const contentParts = [{ text: systemPrompt + '\\n\\nMESSAGGIO UTENTE: ' + text }];\n        // If there's a photo, use vision model\n        if (mediaUrl && mediaType === 'photo') {\n          try {\n            const imgRes = await fetch(mediaUrl);\n            const imgBuf = await imgRes.arrayBuffer();\n            const b64 = btoa(String.fromCharCode(...new Uint8Array(imgBuf)));\n            contentParts.push({ inline_data: { mime_type: 'image/jpeg', data: b64 } });\n          } catch(e) { /* ignore image fetch errors */ }\n        }\n\n        const geminiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${env.GEMINI_KEY}`, {\n          method: 'POST', headers: {'Content-Type':'application/json'},\n          body: JSON.stringify({ contents: [{ parts: contentParts }] })\n        });\n        const gd = await geminiRes.json();\n        const raw = gd.candidates?.[0]?.content?.parts?.[0]?.text?.replace(/```json\\n?|\\n?```/g, '').trim();\n        try { return JSON.parse(raw); } catch { return null; }\n      }\n\n      // ---- Handle media uploads (photo, document, video, audio) ----\n      let mediaUrl = null, mediaType = null, fileName = null;\n\n      if (msg.photo && msg.photo.length) {\n        const photo = msg.photo[msg.photo.length - 1]; // Highest resolution\n        mediaUrl = await getTelegramFileUrl(photo.file_id);\n        mediaType = 'photo';\n      } else if (msg.document) {\n        mediaUrl = await getTelegramFileUrl(msg.document.file_id);\n        mediaType = 'document';\n        fileName = msg.document.file_name || 'file';\n      } else if (msg.video) {\n        mediaUrl = await getTelegramFileUrl(msg.video.file_id);\n        mediaType = 'video';\n      } else if (msg.voice || msg.audio) {\n        const audio = msg.voice || msg.audio;\n        mediaUrl = await getTelegramFileUrl(audio.file_id);\n        mediaType = 'audio';\n      }\n\n      let reply = '';\n\n      // ---- SLASH COMMANDS ----\n      switch (cmd) {\n        case '/start':\n          reply = `\uD83D\uDC4B Benvenuto in *Syntoniqa MRS*!\\n\\n\uD83D\uDCE4 Puoi inviarmi:\\n\u2022 Testo con problemi/ordini\\n\u2022 \uD83D\uDCF7 Foto di guasti o ricambi\\n\u2022 \uD83D\uDCC4 Documenti (PDF, Excel)\\n\u2022 \uD83C\uDFA4 Audio/Video\\n\\n\uD83E\uDD16 L'AI analizzer\u00E0 tutto e creer\u00E0 le azioni giuste!\\n\\nInvia /help per i comandi.`;\n          break;\n        case '/help':\n          reply = `\uD83D\uDCCB *Comandi Syntoniqa:*\\n\\n\uD83D\uDEA8 *Urgenze:*\\n/stato - Urgenze aperte\\n/vado - Prendi urgenza\\n/incorso - Segna in corso\\n/risolto [note] - Chiudi urgenza\\n\\n\uD83D\uDCC5 *Interventi:*\\n/oggi - I tuoi interventi oggi\\n/settimana - Piano settimanale\\n\\n\uD83D\uDCE6 *Ordini:*\\n/ordine [cod] [qt] [cliente] - Ordine ricambio\\n/servepezz [desc] - Ricambio generico\\n\\n\uD83D\uDCE4 *Upload:*\\nInvia foto, PDF, Excel, audio \u2192 l'AI analizza e crea azioni automaticamente!\\n\\n\uD83D\uDCA1 Puoi anche scrivere testo libero, es: \"Bondioli 102 fermo, errore laser\"`;\n          break;\n        case '/stato': {\n          const urg = await sb(env, 'urgenze', 'GET', null, '?stato=in.(aperta,assegnata,in_corso)&order=data_segnalazione.desc&limit=10');\n          reply = urg.length ? `\uD83D\uDEA8 *${urg.length} urgenze attive:*\\n` + urg.map(u => `\u2022 ${u.id}: ${u.problema} [${u.stato}]`).join('\\n') : '\u2705 Nessuna urgenza attiva';\n          break;\n        }\n        case '/oggi': {\n          const oggi = new Date().toISOString().split('T')[0];\n          const intv = await sb(env, 'piano', 'GET', null, `?data=eq.${oggi}&tecnico_id=eq.${utente.id}&obsoleto=eq.false`);\n          reply = intv.length ? `\uD83D\uDCC5 *Interventi oggi (${intv.length}):*\\n` + intv.map(i => `\u2022 ${i.id}: ${i.stato} \u2013 Cliente ${i.cliente_id}`).join('\\n') : '\uD83D\uDCC5 Nessun intervento programmato oggi';\n          break;\n        }\n        case '/settimana': {\n          const oggi = new Date();\n          const lun = new Date(oggi); lun.setDate(oggi.getDate() - oggi.getDay() + 1);\n          const dom = new Date(lun); dom.setDate(lun.getDate() + 6);\n          const intv = await sb(env, 'piano', 'GET', null, `?data=gte.${lun.toISOString().split('T')[0]}&data=lte.${dom.toISOString().split('T')[0]}&tecnico_id=eq.${utente.id}&obsoleto=eq.false&order=data.asc`);\n          if (!intv.length) { reply = '\uD83D\uDCC5 Nessun intervento questa settimana'; break; }\n          const byDay = {};\n          intv.forEach(i => { const d = i.data; if (!byDay[d]) byDay[d] = []; byDay[d].push(i); });\n          reply = `\uD83D\uDCC5 *Piano settimanale (${intv.length} interventi):*\\n` + Object.entries(byDay).map(([d, items]) => `\\n*${d}:*\\n` + items.map(i => `  \u2022 ${i.stato} \u2013 ${i.cliente_id}`).join('\\n')).join('');\n          break;\n        }\n        case '/vado': {\n          const urg = await sb(env, 'urgenze', 'GET', null, '?stato=eq.aperta&order=data_segnalazione.asc&limit=1');\n          if (!urg.length) { reply = '\u2705 Nessuna urgenza da prendere in carico'; break; }\n          await sb(env, `urgenze?id=eq.${urg[0].id}`, 'PATCH', { stato: 'assegnata', tecnico_assegnato: utente.id, data_assegnazione: new Date().toISOString() });\n          reply = `\u2705 Urgenza *${urg[0].id}* assegnata a te!\\nProblema: ${urg[0].problema}`;\n          await sendTelegramNotification(env, 'urgenza_assegnata', { id: urg[0].id, tecnicoAssegnato: utente.id });\n          break;\n        }\n        case '/incorso': {\n          const urg = await sb(env, 'urgenze', 'GET', null, `?tecnico_assegnato=eq.${utente.id}&stato=eq.assegnata&limit=1`);\n          if (!urg.length) { reply = 'Nessuna urgenza assegnata'; break; }\n          await sb(env, `urgenze?id=eq.${urg[0].id}`, 'PATCH', { stato: 'in_corso', data_inizio: new Date().toISOString() });\n          reply = `\uD83D\uDD27 Urgenza *${urg[0].id}* segnata come IN CORSO`;\n          break;\n        }\n        case '/risolto': {\n          const note = parts.slice(1).join(' ');\n          const urg = await sb(env, 'urgenze', 'GET', null, `?tecnico_assegnato=eq.${utente.id}&stato=in.(assegnata,in_corso)&limit=1`);\n          if (!urg.length) { reply = 'Nessuna urgenza in corso'; break; }\n          await sb(env, `urgenze?id=eq.${urg[0].id}`, 'PATCH', { stato: 'risolta', data_risoluzione: new Date().toISOString(), note });\n          reply = `\u2705 Urgenza *${urg[0].id}* RISOLTA${note ? '\\nNote: ' + note : ''}`;\n          break;\n        }\n        case '/ordine': {\n          // /ordine 9.1189.0283.0 2 Bondioli\n          const codice = parts[1] || '';\n          const qt = parseInt(parts[2]) || 1;\n          const cliente = parts.slice(3).join(' ') || 'non specificato';\n          if (!codice || !/^\\d\\.\\d{4}\\.\\d{4}\\.\\d$/.test(codice)) {\n            reply = '\uD83D\uDCE6 Formato: /ordine [codice] [quantit\u00E0] [cliente]\\nEs: /ordine 9.1189.0283.0 2 Bondioli';\n            break;\n          }\n          const ordId = 'ORD_TG_' + Date.now();\n          const ordTid = env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045';\n          await sb(env, 'ordini', 'POST', { id: ordId, tenant_id: ordTid, tecnico_id: utente?.id || null, codice, descrizione: `${codice} x${qt} - ${cliente}`, quantita: qt, stato: 'richiesto', data_richiesta: new Date().toISOString() });\n          reply = `\uD83D\uDCE6 Ordine *${ordId}* creato:\\nCodice: \\`${codice}\\` x${qt}\\nCliente: ${cliente}`;\n          break;\n        }\n        case '/servepezz': {\n          const desc2 = parts.slice(1).join(' ');\n          if (!desc2) { reply = 'Usa: /servepezz [descrizione ricambio]'; break; }\n          const spId = 'ORD_TG_' + Date.now();\n          const spTid = env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045';\n          await sb(env, 'ordini', 'POST', { id: spId, tenant_id: spTid, tecnico_id: utente?.id || null, descrizione: desc2, stato: 'richiesto', data_richiesta: new Date().toISOString() });\n          reply = `\uD83D\uDCE6 Ordine ricambio *${spId}* creato:\\n_${desc2}_`;\n          break;\n        }\n        default: {\n          // ---- FREE TEXT + MEDIA: AI ANALYSIS ----\n          if (text.length < 3 && !mediaUrl) { reply = '\uD83E\uDD14 Messaggio troppo breve. Scrivi il problema o invia /help'; break; }\n\n          // Store media metadata for later attachment\n          let mediaInfo = null;\n          if (mediaUrl) {\n            mediaInfo = { url: mediaUrl, type: mediaType, fileName, telegramFileId: msg.photo?.[msg.photo.length-1]?.file_id || msg.document?.file_id || msg.video?.file_id || msg.voice?.file_id || null };\n            if (!text && mediaType === 'photo') {\n              await sendTelegram(env, chatId, '\uD83D\uDCF7 Foto ricevuta! Aggiungi una descrizione o la analizzo con AI...');\n            }\n            if (!text && mediaType === 'document') {\n              await sendTelegram(env, chatId, `\uD83D\uDCC4 Documento *${fileName}* ricevuto! Aggiungi una descrizione oppure lo salvo come allegato.`);\n            }\n          }\n\n          // AI Parse\n          const aiResult = await aiParseMessage(text || `[${mediaType} allegato: ${fileName || 'foto'}]`, mediaUrl, mediaType);\n\n          if (!aiResult) { reply = '\uD83E\uDD14 Non riesco ad analizzare. Prova con /help'; break; }\n\n          if (aiResult.tipo === 'nota') {\n            reply = `\uD83D\uDCDD *Nota registrata*\\n${aiResult.problema || text}`;\n            if (aiResult.cliente) reply += `\\nCliente: ${aiResult.cliente}`;\n            break;\n          }\n\n          // Create action directly based on AI analysis\n          const now = new Date().toISOString();\n          let payload = {}, actionReply = '';\n\n          const tid = env.TENANT_ID || '785d94d0-b947-4a00-9c4e-3b67833e7045';\n          if (aiResult.tipo === 'urgenza') {\n            payload = {\n              id: 'URG_TG_' + Date.now(),\n              tenant_id: tid,\n              problema: aiResult.problema,\n              cliente_id: aiResult.codice_m3 || null,\n              macchina_id: aiResult.robot_id ? `${aiResult.macchina || 'ROBOT'}_${aiResult.robot_id}` : null,\n              priorita_id: null,\n              stato: 'aperta',\n              data_segnalazione: now,\n              tecnico_assegnato: null,\n              note: `[Telegram ${utente?.nome || ''}] ${aiResult.macchina || ''} ${aiResult.robot_id || ''} - Priorit\u00E0: ${aiResult.priorita}${mediaUrl ? ' - Allegato: ' + mediaUrl : ''}`\n            };\n            try {\n              await sb(env, 'urgenze', 'POST', payload);\n              actionReply = `\uD83D\uDEA8 *URGENZA CREATA*\\nID: \\`${payload.id}\\`\\nCliente: ${aiResult.cliente || '?'}\\nProblema: ${aiResult.problema}\\nMacchina: ${aiResult.macchina || '?'} ${aiResult.robot_id || ''}\\nPriorit\u00E0: ${aiResult.priorita}${mediaUrl ? '\\n\uD83D\uDCCE Allegato salvato' : ''}`;\n              await sendTelegramNotification(env, 'nuova_urgenza', payload);\n            } catch(e) { actionReply = '\u274C Errore creazione urgenza: ' + e.message; }\n          } else if (aiResult.tipo === 'ordine') {\n            const ricambiDesc = (aiResult.ricambi || []).map(r => `${r.codice} x${r.quantita}`).join(', ') || aiResult.problema;\n            payload = {\n              id: 'ORD_TG_' + Date.now(),\n              tenant_id: tid,\n              tecnico_id: utente?.id || null,\n              cliente_id: aiResult.codice_m3 || null,\n              descrizione: ricambiDesc,\n              stato: 'richiesto',\n              data_richiesta: now,\n              note: `[Telegram ${utente?.nome || ''}] ${aiResult.cliente || ''}${mediaUrl ? ' - Allegato: ' + mediaUrl : ''}`\n            };\n            try {\n              await sb(env, 'ordini', 'POST', payload);\n              actionReply = `\uD83D\uDCE6 *ORDINE CREATO*\\nID: \\`${payload.id}\\`\\nCliente: ${aiResult.cliente || '?'}\\nRicambi: ${ricambiDesc}${mediaUrl ? '\\n\uD83D\uDCCE Allegato salvato' : ''}`;\n            } catch(e) { actionReply = '\u274C Errore creazione ordine: ' + e.message; }\n          } else if (aiResult.tipo === 'intervento') {\n            payload = {\n              id: 'INT_TG_' + Date.now(),\n              tenant_id: tid,\n              cliente_id: aiResult.codice_m3 || null,\n              tecnico_id: utente?.id || null,\n              stato: 'pianificato',\n              data: now.split('T')[0],\n              note: `[Telegram ${utente?.nome || ''}] ${aiResult.problema}${mediaUrl ? ' - Allegato: ' + mediaUrl : ''}`,\n              obsoleto: false\n            };\n            try {\n              await sb(env, 'piano', 'POST', payload);\n              actionReply = `\uD83D\uDCC5 *INTERVENTO PIANIFICATO*\\nID: \\`${payload.id}\\`\\nCliente: ${aiResult.cliente || '?'}\\nDescrizione: ${aiResult.problema}${mediaUrl ? '\\n\uD83D\uDCCE Allegato salvato' : ''}`;\n              await sendTelegramNotification(env, 'nuovo_intervento', payload);\n            } catch(e) { actionReply = '\u274C Errore creazione intervento: ' + e.message; }\n          }\n\n          if (actionReply) {\n            reply = actionReply;\n            if (aiResult.note) reply += `\\n\\n\uD83D\uDCA1 _${aiResult.note}_`;\n          }\n        }\n      }\n\n      if (reply) {\n        try { await sendTelegram(env, chatId, reply); } catch(e) { console.error('TG send error:', e.message); }\n      }\n      return ok();\n      } catch (tgErr) {\n        console.error('Telegram handler error:', tgErr.message, tgErr.stack);\n        try {\n          const errChatId = body?.message?.chat?.id;\n          if (errChatId) await sendTelegram(env, errChatId, `\u26A0\uFE0F Errore bot: ${tgErr.message}`);\n        } catch(e2) {}\n        return ok();\n      }\n    }\n\n    // -------- CHAT INTERNA --------\n\n    case 'getChatCanali': {\n      const userId = body.userId || body.user_id || '';\n      // Canali di cui l'utente \u00E8 membro + canali pubblici\n      const canali = await sb(env, 'chat_canali', 'GET', null, '?attivo=eq.true&order=nome');\n      const membri = userId ? await sb(env, 'chat_membri', 'GET', null, `?utente_id=eq.${userId}&select=canale_id,ultimo_letto`) : [];\n      const membroMap = {};\n      (membri || []).forEach(m => { membroMap[m.canale_id] = m; });\n      // Per ogni canale, conta messaggi non letti\n      const result = [];\n      for (const c of (canali || [])) {\n        const ultimoLetto = membroMap[c.id]?.ultimo_letto || '1970-01-01';\n        const nonLetti = await sb(env, 'chat_messaggi', 'GET', null,\n          `?canale_id=eq.${c.id}&created_at=gt.${ultimoLetto}&eliminato=eq.false&select=id`).catch(() => []);\n        result.push({ ...pascalizeRecord(c), nonLetti: (nonLetti || []).length, isMembro: !!membroMap[c.id] });\n      }\n      return ok({ canali: result });\n    }\n\n    case 'getChatMessaggi': {\n      const { canale_id, limit: lim } = body;\n      if (!canale_id) return err('canale_id richiesto');\n      const messaggi = await sb(env, 'chat_messaggi', 'GET', null,\n        `?canale_id=eq.${canale_id}&eliminato=eq.false&order=created_at.desc&limit=${lim || 50}`);\n      // Segna come letto\n      const userId = body.userId || body.user_id;\n      if (userId) {\n        await sb(env, 'chat_membri', 'POST', { id: `${canale_id}_${userId}`, canale_id, utente_id: userId, ultimo_letto: new Date().toISOString() })\n          .catch(() => sb(env, `chat_membri?canale_id=eq.${canale_id}&utente_id=eq.${userId}`, 'PATCH', { ultimo_letto: new Date().toISOString() }));\n      }\n      return ok({ messaggi: (messaggi || []).reverse().map(pascalizeRecord) });\n    }\n\n    case 'sendChatMessage': {\n      const { canale_id, testo, tipo, rispondi_a } = body;\n      const mittente = body.userId || body.user_id || body.mittente_id;\n      if (!canale_id || !testo) return err('canale_id e testo richiesti');\n      const id = 'MSG_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6);\n      const msg = { id, canale_id, mittente_id: mittente, testo, tipo: tipo || 'testo', rispondi_a: rispondi_a || null, created_at: new Date().toISOString() };\n      const result = await sb(env, 'chat_messaggi', 'POST', msg);\n      // Auto-join se non \u00E8 membro\n      if (mittente) {\n        await sb(env, 'chat_membri', 'POST', { id: `${canale_id}_${mittente}`, canale_id, utente_id: mittente, ultimo_letto: new Date().toISOString() }).catch(() => {});\n      }\n      return ok({ messaggio: pascalizeRecord(result[0]) });\n    }\n\n    case 'createChatCanale': {\n      const { nome, tipo, descrizione, icona, solo_admin, membri_ids } = body;\n      if (!nome) return err('nome richiesto');\n      const id = 'CH_' + Date.now();\n      const canale = { id, nome, tipo: tipo || 'gruppo', descrizione: descrizione || null, icona: icona || '\uD83D\uDCAC', solo_admin: solo_admin || false, creato_da: body.userId || null, created_at: new Date().toISOString() };\n      // Cerca tenant_id\n      const utenti = await sb(env, 'utenti', 'GET', null, '?select=tenant_id&limit=1');\n      if (utenti?.[0]?.tenant_id) canale.tenant_id = utenti[0].tenant_id;\n      const result = await sb(env, 'chat_canali', 'POST', canale);\n      // Aggiungi membri iniziali\n      if (membri_ids && Array.isArray(membri_ids)) {\n        for (const uid of membri_ids) {\n          await sb(env, 'chat_membri', 'POST', { id: `${id}_${uid}`, canale_id: id, utente_id: uid, ruolo: uid === body.userId ? 'admin' : 'membro' }).catch(() => {});\n        }\n      }\n      return ok({ canale: pascalizeRecord(result[0]) });\n    }\n\n    case 'joinChatCanale': {\n      const { canale_id } = body;\n      const userId = body.userId || body.user_id;\n      if (!canale_id || !userId) return err('canale_id e userId richiesti');\n      await sb(env, 'chat_membri', 'POST', { id: `${canale_id}_${userId}`, canale_id, utente_id: userId }).catch(() => {});\n      return ok();\n    }\n\n    // ============ ANAGRAFICA (Clienti + Assets) ============\n\n    case 'getAnagraficaClienti': {\n      const search = body.search || '';\n      let url = 'anagrafica_clienti?select=*&order=nome_account.asc&limit=500';\n      if (search) url += `&or=(nome_account.ilike.*${search}*,nome_interno.ilike.*${search}*,codice_m3.ilike.*${search}*,citta_fatturazione.ilike.*${search}*)`;\n      const data = await sb(env, url, 'GET');\n      return ok(data.map(pascalizeRecord));\n    }\n\n    case 'getAnagraficaCliente': {\n      const { id, codice_m3 } = body;\n      let url = 'anagrafica_clienti?select=*';\n      if (id) url += `&id=eq.${id}`;\n      else if (codice_m3) url += `&codice_m3=eq.${codice_m3}`;\n      else return err('id o codice_m3 richiesto');\n      const data = await sb(env, url, 'GET');\n      if (!data.length) return err('Cliente non trovato', 404);\n      return ok(pascalizeRecord(data[0]));\n    }\n\n    case 'getAnagraficaAssets': {\n      const { codice_m3, search, all } = body;\n      let base = 'anagrafica_assets?select=*&order=gruppo_attrezzatura.asc,nome_asset.asc';\n      if (codice_m3) base += `&codice_m3=eq.${codice_m3}`;\n      if (search && search.trim()) base += `&or=(nome_asset.ilike.*${search}*,numero_serie.ilike.*${search}*,modello.ilike.*${search}*,nome_account.ilike.*${search}*)`;\n      if (!all) {\n        const data = await sb(env, base + '&limit=2000', 'GET');\n        return ok(data.map(pascalizeRecord));\n      }\n      // Paginate: Supabase PostgREST caps at 1000 rows per request\n      let allData = [];\n      let offset = 0;\n      const pageSize = 1000;\n      while (true) {\n        const page = await sb(env, base, 'GET', null, '', { 'Range': `${offset}-${offset + pageSize - 1}`, 'Prefer': 'count=exact' });\n        if (!Array.isArray(page) || page.length === 0) break;\n        allData = allData.concat(page);\n        if (page.length < pageSize) break;\n        offset += pageSize;\n      }\n      return ok(allData.map(pascalizeRecord));\n    }\n\n    case 'importAnagraficaClienti': {\n      const rows = body.rows || [];\n      if (!rows.length) return err('rows richiesto (array)');\n      const results = { inserted: 0, errors: [] };\n      for (const row of rows) {\n        const fields = {};\n        for (const [k, v] of Object.entries(row)) {\n          if (v !== null && v !== undefined && v !== '') fields[toSnake(k)] = v;\n        }\n        try {\n          await sb(env, 'anagrafica_clienti', 'POST', fields, null, { 'Prefer': 'return=minimal,resolution=merge-duplicates' });\n          results.inserted++;\n        } catch (e) {\n          results.errors.push({ nome: fields.nome_account || '?', err: e.message });\n        }\n      }\n      return ok(results);\n    }\n\n    case 'importAnagraficaAssets': {\n      const rows = body.rows || [];\n      if (!rows.length) return err('rows richiesto (array)');\n      // Verify existing codice_m3\n      const clienti = await sb(env, 'anagrafica_clienti?select=codice_m3', 'GET');\n      const validM3 = new Set(clienti.filter(c => c.codice_m3).map(c => c.codice_m3));\n      const results = { inserted: 0, skipped: 0, errors: [] };\n      // Batch insert\n      const batch = [];\n      const allKeys = new Set();\n      for (const row of rows) {\n        const fields = {};\n        for (const [k, v] of Object.entries(row)) {\n          const sk = toSnake(k);\n          fields[sk] = (v !== null && v !== undefined && v !== '') ? v : null;\n          allKeys.add(sk);\n        }\n        if (fields.codice_m3 && !validM3.has(fields.codice_m3)) {\n          fields.codice_m3 = null;\n        }\n        batch.push(fields);\n      }\n      // Ensure all objects have uniform keys (Supabase requires it)\n      const keyList = [...allKeys];\n      for (const row of batch) {\n        for (const k of keyList) {\n          if (!(k in row)) row[k] = null;\n        }\n      }\n      // Insert in chunks of 100\n      for (let i = 0; i < batch.length; i += 100) {\n        const chunk = batch.slice(i, i + 100);\n        try {\n          await sb(env, 'anagrafica_assets', 'POST', chunk, null, { 'Prefer': 'return=minimal' });\n          results.inserted += chunk.length;\n        } catch (e) {\n          // Fallback: one by one\n          for (const row of chunk) {\n            try {\n              await sb(env, 'anagrafica_assets', 'POST', row, null, { 'Prefer': 'return=minimal' });\n              results.inserted++;\n            } catch (e2) {\n              results.skipped++;\n              results.errors.push({ serie: row.numero_serie || '?', err: e2.message });\n            }\n          }\n        }\n      }\n      return ok(results);\n    }\n\n    case 'clearAnagrafica': {\n      // Admin only: delete all anagrafica data for re-import\n      await sb(env, 'anagrafica_assets?id=neq.00000000-0000-0000-0000-000000000000', 'DELETE');\n      await sb(env, 'anagrafica_clienti?id=neq.00000000-0000-0000-0000-000000000000', 'DELETE');\n      return ok({ cleared: true });\n    }\n\n    default:\n      return err(`Azione POST non trovata: ${action}`, 404);\n  }\n}\n\n// ============ UTILITIES ============\n\n// ============ WEB PUSH (VAPID) ============\n\nfunction urlBase64ToUint8Array(base64String) {\n  const padding = '='.repeat((4 - base64String.length % 4) % 4);\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');\n  const rawData = atob(base64);\n  return new Uint8Array([...rawData].map(c => c.charCodeAt(0)));\n}\n\nfunction arrayBufferToBase64Url(buffer) {\n  const bytes = new Uint8Array(buffer);\n  let str = '';\n  for (const b of bytes) str += String.fromCharCode(b);\n  return btoa(str).replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n}\n\nasync function createVapidJwt(env, audience) {\n  // Create VAPID JWT token for Web Push authentication\n  const header = { typ: 'JWT', alg: 'ES256' };\n  const now = Math.floor(Date.now() / 1000);\n  const payload = {\n    aud: audience,\n    exp: now + 86400,\n    sub: env.VAPID_SUBJECT || 'mailto:admin@syntoniqa.app'\n  };\n\n  const headerB64 = arrayBufferToBase64Url(new TextEncoder().encode(JSON.stringify(header)));\n  const payloadB64 = arrayBufferToBase64Url(new TextEncoder().encode(JSON.stringify(payload)));\n  const unsignedToken = `${headerB64}.${payloadB64}`;\n\n  // Import private key\n  const privateKeyBytes = urlBase64ToUint8Array(env.VAPID_PRIVATE_KEY);\n  const key = await crypto.subtle.importKey(\n    'pkcs8',\n    privateKeyBytes,\n    { name: 'ECDSA', namedCurve: 'P-256' },\n    false,\n    ['sign']\n  ).catch(() => {\n    // Try JWK format if PKCS8 fails\n    return crypto.subtle.importKey(\n      'raw',\n      privateKeyBytes,\n      { name: 'ECDSA', namedCurve: 'P-256' },\n      false,\n      ['sign']\n    );\n  });\n\n  const signature = await crypto.subtle.sign(\n    { name: 'ECDSA', hash: { name: 'SHA-256' } },\n    key,\n    new TextEncoder().encode(unsignedToken)\n  );\n\n  return `${unsignedToken}.${arrayBufferToBase64Url(signature)}`;\n}\n\nasync function sendWebPush(env, subscription, payload) {\n  const endpoint = new URL(subscription.endpoint);\n  const audience = `${endpoint.protocol}//${endpoint.host}`;\n\n  try {\n    const jwt = await createVapidJwt(env, audience);\n    const vapidPublicKey = env.VAPID_PUBLIC_KEY;\n\n    const response = await fetch(subscription.endpoint, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/octet-stream',\n        'Content-Encoding': 'aes128gcm',\n        'TTL': '86400',\n        'Authorization': `vapid t=${jwt}, k=${vapidPublicKey}`,\n        'Urgency': 'high'\n      },\n      body: payload\n    });\n    return response;\n  } catch (e) {\n    return { ok: false, status: 0, statusText: e.message };\n  }\n}\n\nasync function sendTelegram(env, chatId, text) {\n  if (!env.TELEGRAM_BOT_TOKEN || !chatId) return null;\n  return fetch(`https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/sendMessage`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ chat_id: chatId, text, parse_mode: 'Markdown' })\n  }).then(r => r.json()).catch(() => null);\n}\n\nasync function sendTelegramNotification(env, event, data) {\n  // Notifiche automatiche al gruppo generale\n  const configRes = await sb(env, 'config', 'GET', null, '?chiave=in.(telegram_group_generale,telegram_bot_token)').catch(() => []);\n  const cfg = Object.fromEntries(configRes.map(c => [c.chiave, c.valore]));\n  const group = cfg.telegram_group_generale;\n  if (group) {\n    const messages = {\n      nuova_urgenza:      `\uD83D\uDEA8 *NUOVA URGENZA*\\nID: ${data.id}\\nProblema: ${data.problema}\\nPriorit\u00E0: ${data.priorita_id}`,\n      nuovo_intervento:   `\uD83D\uDCC5 *NUOVO INTERVENTO* ${data.id}\\nData: ${data.data} | Tecnico: ${data.tecnico_id}`,\n      urgenza_assegnata:  `\u2705 Urgenza *${data.id}* assegnata a ${data.tecnicoAssegnato}`,\n      richiesta_risposta: `\uD83D\uDCCB Richiesta *${data.id}* \u2192 ${data.stato}`,\n    };\n    const msg = messages[event];\n    if (msg) await sendTelegram(env, group, msg);\n  }\n  \n  // FIX F-30: Invia anche push notification ai tecnici coinvolti\n  if (env.VAPID_PUBLIC_KEY && env.VAPID_PRIVATE_KEY) {\n    try {\n      const pushMessages = {\n        nuova_urgenza:      { title: '\uD83D\uDEA8 Nuova Urgenza', body: data.problema || 'Nuova urgenza ricevuta', tag: 'urgenza-' + data.id },\n        nuovo_intervento:   { title: '\uD83D\uDCC5 Nuovo Intervento', body: `Intervento ${data.id} pianificato`, tag: 'intervento-' + data.id },\n        urgenza_assegnata:  { title: '\u2705 Urgenza Assegnata', body: `Urgenza ${data.id} assegnata a te`, tag: 'assegnazione-' + data.id },\n        richiesta_risposta: { title: '\uD83D\uDCCB Risposta Richiesta', body: `Richiesta ${data.id}: ${data.stato}`, tag: 'richiesta-' + data.id },\n      };\n      const pushMsg = pushMessages[event];\n      if (pushMsg) {\n        // Determine target users\n        let targetUsers = [];\n        if (data.tecnico_id) targetUsers.push(data.tecnico_id);\n        if (data.tecnico_assegnato) targetUsers.push(data.tecnico_assegnato);\n        if (data.tecnicoAssegnato) targetUsers.push(data.tecnicoAssegnato);\n        if (data.tecnici_ids) {\n          try { targetUsers = targetUsers.concat(JSON.parse(data.tecnici_ids)); } catch {}\n        }\n        targetUsers = [...new Set(targetUsers.filter(Boolean))];\n        \n        if (targetUsers.length) {\n          const subs = await sb(env, 'push_subscriptions', 'GET', null,\n            `?user_id=in.(${targetUsers.join(',')})&active=eq.true`).catch(() => []);\n          const payload = JSON.stringify({ ...pushMsg, url: './' });\n          for (const sub of subs) {\n            sendWebPush(env, { endpoint: sub.endpoint, keys: { p256dh: sub.p256dh, auth: sub.auth } }, payload).catch(() => {});\n          }\n        }\n      }\n    } catch (e) { /* Push failure shouldn't block main flow */ }\n  }\n}\n\nasync function triggerKPISnapshot(env, interventoId, tecnicoId) {\n  if (!tecnicoId) return;\n  const oggi = new Date().toISOString().split('T')[0];\n  const mese = oggi.slice(0, 7);\n  const completati = await sb(env, 'piano', 'GET', null, `?tecnico_id=eq.${tecnicoId}&stato=in.(completato,chiuso)&data=gte.${mese}-01`);\n  await sb(env, 'kpi_log', 'POST', {\n    id: 'KPI_' + Date.now(),\n    data: oggi, tecnico_id: tecnicoId,\n    metrica: 'interventi_completati_mese', valore: completati.length, unita: 'n', periodo: mese\n  }).catch(() => {});\n}\n"],
  "mappings": "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",
  "names": ["text", "action", "chatId", "mediaUrl", "mediaType"]
}
